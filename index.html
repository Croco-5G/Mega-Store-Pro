<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mega Store | System</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%236366f1' d='M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z'/%3E%3C/svg%3E">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Ù…Ù†Ø¹ ÙˆÙ…Ø¶Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø§Ù„Ù…Ø²Ø¹Ø¬Ø© ÙÙˆØ± ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        if(localStorage.getItem("darkMode") === "true") { document.documentElement.classList.add("dark-mode"); }
        if(localStorage.getItem("isDemoMode") === "true") { document.documentElement.classList.add("demo-mode"); }
    </script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6366f1; 
            --primary-dark: #4f46e5; 
            --primary-light: #e0e7ff;
            --accent: #f59e0b;
            --success: #10b981; 
            --danger: #ef4444;
            --info: #3b82f6;
            
            --bg-body: #f1f5f9; 
            --bg-card: #ffffff; 
            --bg-input: #f8fafc; 
            --bg-sidebar: #0f172a;
            
            --text-main: #1e293b; 
            --text-muted: #64748b; 
            --border-color: #e2e8f0;
            
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --yellow-bg: #fefce8; --yellow-border: #fde047; --yellow-text: #854d0e;
            --yellow-item-bg: #fffbeb; --yellow-item-border: #eab308; --yellow-item-text: #713f12;
            --yellow-btn-bg: #eab308; --yellow-btn-hover: #ca8a04;
        }

        html.dark-mode, html.dark-mode body {
            --bg-body: #0f172a; 
            --bg-card: #1e293b; 
            --bg-input: #0f172a; 
            --bg-sidebar: #020617;
            
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --border-color: #475569; 
            
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);

            --yellow-bg: rgba(234, 179, 8, 0.1); --yellow-border: rgba(234, 179, 8, 0.3);
            --yellow-text: #fde047; --yellow-item-bg: rgba(234, 179, 8, 0.15);
            --yellow-item-border: #eab308; --yellow-item-text: #fef08a;
            --yellow-btn-bg: #eab308; --yellow-btn-hover: #ca8a04;
        }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        * { box-sizing: border-box; font-family: 'Tajawal', 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; position: relative; }
        body { 
            background: var(--bg-body); 
            margin: 0; 
            color: var(--text-main); 
            display: flex; 
            min-height: 100vh; 
            transition: background 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        html.dark-mode ::-webkit-scrollbar-thumb { background-color: #475569; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }

        /* --- LAYOUT STRUCTURE --- */
        .main-content { 
            flex: 1; 
            margin-right: 280px; 
            padding: 30px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            width: 100%; 
            max-width: 100%; 
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; 
            background: var(--bg-sidebar); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            height: 100dvh; 
            right: 0; 
            top: 0; 
            z-index: 1000; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: -5px 0 25px rgba(0,0,0,0.2); 
            border-left: 1px solid var(--border-color); 
            padding-bottom: 20px;
        }
        .brand { 
            padding: 30px 20px 20px 20px; 
            text-align: center; 
            font-size: 20px; 
            font-weight: 900; 
            background: linear-gradient(135deg, var(--primary), #a855f7); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            letter-spacing: -0.5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 10px;
        }
        .menu-items { padding: 10px; flex-grow: 1; overflow-y: auto; }
        .sidebar button { 
            width: 100%; 
            padding: 14px 18px; 
            margin-bottom: 6px; 
            border: none; 
            border-radius: var(--radius-md); 
            background: transparent; 
            color: #94a3b8; 
            font-size: 15px; 
            font-weight: 600; 
            cursor: pointer; 
            text-align: right; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.2s; 
        }
        .sidebar button:hover { background: rgba(255,255,255,0.08); color: #fff; transform: translateX(-3px); }
        .sidebar button.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); 
        }
        .sidebar button i { width: 20px; text-align: center; }

        /* --- CARDS & CONTAINERS --- */
        .card { 
            background: var(--bg-card); 
            border-radius: var(--radius-xl); 
            padding: 30px; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            margin-bottom: 30px; 
            animation: fadeIn 0.4s ease-out; 
            position: relative; 
        }
        .card:hover { box-shadow: var(--card-hover-shadow); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .inner-box { 
            background: var(--bg-input) !important; 
            border: 1px solid var(--border-color) !important; 
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        /* --- STATS GRID --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: var(--bg-card); 
            padding: 24px; 
            border-radius: var(--radius-lg); 
            display: flex; 
            align-items: center; 
            gap: 18px; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon { 
            width: 56px; 
            height: 56px; 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
        }

        /* ICON COLORS & DARK MODE FIX */
        .icon-bg-primary { background: #e0e7ff; color: var(--primary); }
        .icon-bg-success { background: #dcfce7; color: var(--success); }
        .icon-bg-warning { background: #fef3c7; color: var(--accent); }
        
        html.dark-mode .icon-bg-primary { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
        html.dark-mode .icon-bg-success { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
        html.dark-mode .icon-bg-warning { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }

        /* --- FORMS & INPUTS --- */
        .input-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--text-muted); font-size: 13px; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px 16px; 
            border-radius: var(--radius-md); 
            border: 2px solid var(--border-color); 
            background: var(--bg-input); 
            color: var(--text-main); 
            font-size: 15px; 
            transition: all 0.3s; 
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
            background: var(--bg-card);
        }
        input[readonly] { opacity: 0.8; cursor: not-allowed; }
        
        /* --- BUTTONS --- */
        .btn { 
            padding: 12px 24px; 
            border-radius: var(--radius-md); 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: none; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-size: 14px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        
        .btn-warning { background: rgba(245, 158, 11, 0.1); color: #d97706; }
        .btn-warning:hover { background: #f59e0b; color: white; }

        .btn-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .btn-success:hover { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        
        .btn-whatsapp { background: #25D366; color: white; font-size: 13px; padding: 8px 16px; }
        .btn-whatsapp:hover { background: #128C7E; transform: scale(1.05); }

        /* --- TABLES --- */
        .table-container { 
            overflow-x: auto; 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--border-color); 
            width: 100%; 
            background: var(--bg-card);
        }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { 
            background: var(--bg-input); 
            padding: 18px; 
            text-align: center; 
            color: var(--text-muted); 
            font-weight: 800; 
            font-size: 13px;
            white-space: nowrap;
        }
        td { 
            padding: 16px; 
            border-bottom: 1px solid var(--border-color); 
            text-align: center; 
            color: var(--text-main); 
            font-size: 14px;
            vertical-align: middle;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: rgba(99, 102, 241, 0.02); }
        tr.reminded td { background-color: rgba(16, 185, 129, 0.08); }

        .wide-col { min-width: 250px; max-width: 400px; word-break: break-word; white-space: pre-wrap; direction: ltr; }

        /* --- BADGES --- */
        .badge { padding: 6px 12px; border-radius: 30px; font-size: 12px; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; }
        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: #d97706; }

        /* --- MODAL STYLES --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.7); z-index: 2000; 
            display: flex; justify-content: center; align-items: center; 
            backdrop-filter: blur(6px); animation: fadeIn 0.2s; padding: 20px;
        }
        .modal-content { 
            background: var(--bg-card); width: 100%; max-width: 500px; 
            padding: 30px; border-radius: var(--radius-xl); 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
            border: 1px solid var(--border-color); color: var(--text-main); 
            transform: translateY(20px); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
            max-height: 90vh; overflow-y: auto; 
        }
        @keyframes slideUp { to { transform: translateY(0); } }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        
        #modalBody { word-break: break-word; white-space: pre-wrap; overflow-wrap: anywhere; }

        /* --- LOGIN & CLOUD --- */
        .login-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: radial-gradient(circle at top right, #4338ca, #1e1b4b); 
            z-index: 3000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 20px; 
        }
        .login-card { 
            background: rgba(255, 255, 255, 0.9); padding: 50px 40px; 
            border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            width: 100%; max-width: 420px; text-align: center; 
            position: relative; backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.4); 
            animation: slideUpFade 0.6s forwards;
        }
        html.dark-mode .login-card { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes breathe {
            0% { transform: scale(1) rotate(-5deg); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3); }
            50% { transform: scale(1.1) rotate(0deg); box-shadow: 0 20px 40px rgba(99, 102, 241, 0.6); }
            100% { transform: scale(1) rotate(-5deg); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3); }
        }

        .login-icon-wrap { 
            width: 80px; height: 80px; 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            border-radius: 24px; display: flex; align-items: center; justify-content: center; 
            margin: 0 auto 25px auto; color: white; font-size: 32px; 
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3); 
            transform: rotate(-5deg);
            animation: breathe 3s ease-in-out infinite;
        }
        
        .custom-input { position: relative; margin-bottom: 20px; }
        .custom-input i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; z-index: 10;}
        .custom-input input { padding-right: 45px; }

        /* --- DIALOG MODALS --- */
        .dialog-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 5000; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(4px); animation: fadeIn 0.2s; padding: 20px; }
        .dialog-box { background: var(--bg-card); border-radius: var(--radius-xl); padding: 35px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); border: 1px solid var(--border-color); animation: slideUp 0.2s forwards; text-align: center; }
        .dialog-icon { font-size: 48px; margin-bottom: 20px; color: var(--primary); display: flex; justify-content: center; }
        .dialog-actions { display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap; }
        .dialog-actions .btn { flex: 1; min-width: 100px; padding: 12px; }

        /* --- RESPONSIVE UTILS --- */
        .mobile-menu-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 1001; background: var(--bg-card); color: var(--primary); border: 1px solid var(--border-color); padding: 10px; border-radius: 12px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(2px); }
        .hidden { display: none !important; }
        
        /* GRID HELPERS */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); right: 0; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-right: 0; padding: 80px 15px 30px 15px; }
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .grid-2 { grid-template-columns: 1fr; gap: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .dialog-box { padding: 25px; }
            #syncStatus { top: 20px; left: 15px; }
        }

        /* --- OTHER COMPONENTS --- */
        @keyframes slideIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        #notification { position: fixed; bottom: 30px; left: 30px; padding: 16px 25px; border-radius: 16px; color: white; font-weight: 700; z-index: 6000; display: none; animation: slideIn 0.3s ease-out; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.3); align-items: center; gap: 10px; }
        #syncStatus { position: fixed; top: 25px; left: 30px; padding: 8px 16px; border-radius: 50px; font-size: 13px; font-weight: 700; z-index: 1001; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; transition: all 0.3s; cursor: pointer; }
        .theme-switch-container { display: flex; justify-content: center; align-items: center; padding-bottom: 10px; gap: 10px; font-size: 14px; color: #94a3b8; }
        .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        /* Loading Spinner */
        .loading-spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        .btn.loading .loading-spinner { display: block; } 
        .btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .todo-item { display: flex; align-items: center; justify-content: space-between; background: var(--yellow-item-bg); padding: 15px; border-radius: 12px; border-right: 4px solid var(--yellow-item-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; color: var(--yellow-item-text); }
        .todo-item > div { word-break: break-word; white-space: pre-wrap; overflow-wrap: anywhere; }
        #generalNotesBox .todo-item { background: var(--bg-input); border-right: 4px solid var(--primary); color: var(--text-main); }
        
        /* Demo Mode Strip */
        #demoBanner { display:none; position:fixed; top:0; left:0; width:100%; height:4px; background:repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #b91c1c 10px, #b91c1c 20px); z-index:99999; }
        html.demo-mode #demoBanner { display:block; }
        html.demo-mode #syncStatus { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; color: #ef4444; }
        
        /* Blur Lock */
        body.locked .main-content, body.locked .sidebar, body.locked .mobile-menu-btn, body.locked #syncStatus { filter: blur(10px); pointer-events: none; user-select: none; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-input); cursor: pointer; font-weight: 600; color: var(--text-muted); transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Pagination */
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 15px; align-items: center; flex-wrap: wrap; }
        .page-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); cursor: pointer; font-size: 13px; font-weight: 700; color: var(--text-muted); transition: 0.2s; outline:none; }
        .page-btn:hover:not(.disabled) { background: var(--bg-input); color: var(--primary); }
        .page-btn.disabled { opacity: 0.5; pointer-events: none; }
        .page-info { display: flex; align-items: center; font-size: 13px; font-weight: 700; color: var(--text-main); margin: 0 10px; }

        /* â”€â”€â”€ Flatpickr Custom Theme â”€â”€â”€ */
        .flatpickr-calendar {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--card-hover-shadow) !important;
            font-family: 'Tajawal', sans-serif !important;
            direction: rtl;
        }
        .flatpickr-calendar.arrowTop:before, .flatpickr-calendar.arrowTop:after { border-bottom-color: var(--border-color) !important; }
        .flatpickr-months { background: var(--primary) !important; border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important; padding: 8px 0; }
        .flatpickr-months .flatpickr-month { color: white !important; fill: white !important; }
        .flatpickr-current-month { color: white !important; font-size: 15px !important; font-weight: 700 !important; }
        .flatpickr-current-month input.cur-year { color: white !important; font-weight: 700 !important; }
        .flatpickr-current-month .flatpickr-monthDropdown-months { 
            background: var(--primary) !important; color: white !important; 
            border: none !important; font-family: 'Tajawal', sans-serif !important; font-weight: 700;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months option { background: var(--bg-card) !important; color: var(--text-main) !important; }
        .flatpickr-prev-month, .flatpickr-next-month { color: white !important; fill: white !important; padding: 8px !important; }
        .flatpickr-prev-month:hover svg, .flatpickr-next-month:hover svg { fill: rgba(255,255,255,0.7) !important; }
        .flatpickr-weekdays { background: var(--bg-input) !important; }
        .flatpickr-weekday { 
            background: var(--bg-input) !important; 
            color: var(--text-muted) !important; 
            font-family: 'Tajawal', sans-serif !important;
            font-weight: 700 !important;
        }
        .flatpickr-day { 
            color: var(--text-main) !important; 
            border-radius: var(--radius-md) !important;
            font-family: 'Tajawal', sans-serif !important;
            font-weight: 600 !important;
        }
        .flatpickr-day:hover { background: var(--primary-light) !important; color: var(--primary) !important; border-color: transparent !important; }
        .flatpickr-day.selected, .flatpickr-day.selected:hover { 
            background: var(--primary) !important; 
            border-color: var(--primary) !important; 
            color: white !important; 
        }
        .flatpickr-day.today { border-color: var(--primary) !important; color: var(--primary) !important; font-weight: 800 !important; }
        .flatpickr-day.today:hover { background: var(--primary) !important; color: white !important; }
        .flatpickr-day.flatpickr-disabled { color: var(--border-color) !important; }
        .flatpickr-innerContainer { background: var(--bg-card) !important; }
        .flatpickr-rContainer { background: var(--bg-card) !important; }
        .numInputWrapper:hover { background: var(--bg-input) !important; }
        .numInputWrapper span { border-color: var(--border-color) !important; }
        .numInputWrapper span svg { fill: var(--text-muted) !important; }
        html.dark-mode .flatpickr-day:hover { background: rgba(99,102,241,0.2) !important; }
    </style>
</head>

<body class="locked">

<div id="demoBanner" title="ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ"></div>

<div id="syncStatus">
    <i class="fas fa-cloud"></i> <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
</div>

<div id="loginLayer" class="login-overlay">
    <div style="position: absolute; top: 20px; right: 20px;">
        <label class="theme-switch">
            <input type="checkbox" id="loginThemeCheck" onchange="toggleDarkMode()">
            <span class="slider"></span>
        </label>
    </div>

    <div id="loginCard" class="login-card">
        <div class="login-icon-wrap"><i class="fas fa-shield-alt"></i></div>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:30px">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Mega Store</p>
        
        <div id="demoLoginBanner" style="display:none; background:rgba(245,158,11,0.15); border:1px solid #f59e0b; border-radius:10px; padding:10px 14px; margin-bottom:18px; font-size:13px; color:#d97706; font-weight:700; text-align:center;">
            <i class="fas fa-flask"></i> ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
        </div>
        
        <div class="custom-input">
            <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" oninput="document.getElementById('loginError').style.display='none'; this.style.borderColor='';">
            <i class="fas fa-user"></i>
        </div>
        <div class="custom-input">
            <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" oninput="document.getElementById('loginError').style.display='none'; this.style.borderColor='';">
            <i class="fas fa-lock"></i>
        </div>
        
        <button class="btn btn-primary" style="width:100%; justify-content:center; padding:15px;" id="btnLogin" onclick="attemptLogin()">
            <div class="loading-spinner"></div>
            <span><i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</span>
        </button>

        <div id="loginError" style="display:none; margin-top:18px; padding:14px 18px; border-radius:12px; font-size:14px; font-weight:700; text-align:center;"></div>
    </div>
</div>

<div id="detailsModal" class="modal-overlay hidden" onclick="closeModal(event)">
    <div class="modal-content">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-info-circle" style="color:var(--primary)"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©
        </h3>
        <div id="modalBody"></div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="closeModal('force')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<button class="mobile-menu-btn" id="menuBtn" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="customConfirmDialog" class="dialog-modal" style="display:none;">
    <div class="dialog-box">
        <div id="cdIcon" class="dialog-icon"></div>
        <h3 id="cdTitle" style="font-size:18px; margin-top:0;"></h3>
        <p id="cdMsg" style="color:var(--text-muted); margin-bottom:25px; font-size:14px; line-height:1.6"></p>
        <div class="dialog-actions">
            <button id="cdOkBtn" class="btn btn-primary"></button>
            <button id="cdThirdBtn" class="btn btn-warning" style="display:none;"></button>
            <button id="cdCancelBtn" class="btn btn-danger" style="background:transparent; border:1px solid var(--danger); color:var(--danger)" onclick="resolveConfirm(false)"></button>
        </div>
    </div>
</div>

<div id="customPromptDialog" class="dialog-modal" style="display:none;">
    <div class="dialog-box">
        <div id="pdIcon" class="dialog-icon"></div>
        <h3 id="pdTitle" style="font-size:18px; margin-top:0;"></h3>
        <p id="pdMsg" style="color:var(--text-muted); margin-bottom:15px; font-size:14px;"></p>
        <div id="pdInputContainer" style="width:100%;"></div>
        <div class="dialog-actions">
            <button class="btn btn-primary" onclick="resolvePrompt(true)">ØªØ£ÙƒÙŠØ¯</button>
            <button class="btn" style="background:transparent; border:1px solid var(--border-color); color:var(--text-muted);" onclick="resolvePrompt(false)">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="purchaseConfirmModal" class="dialog-modal" style="display:none;">
    <div class="dialog-box" style="text-align:right; max-width:480px">
        <div style="text-align:center; font-size:48px; margin-bottom:15px; color:var(--success);"><i class="fas fa-shopping-cart"></i></div>
        <h3 style="text-align:center; margin-top:0; margin-bottom:5px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        <div id="purchaseConfirmBody" style="background:var(--bg-input); border-radius:14px; padding:20px; margin:15px 0; font-size:14px; line-height:1.8; border:1px dashed var(--border-color);"></div>
        <div class="dialog-actions">
            <button class="btn btn-primary" id="purchaseConfirmOkBtn"><i class="fas fa-check"></i> Ø¥ØªÙ…Ø§Ù… ÙˆØ­ÙØ¸</button>
            <button class="btn btn-danger" onclick="document.getElementById('purchaseConfirmModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="stockConfirmModal" class="dialog-modal" style="display:none;">
    <div class="dialog-box" style="text-align:right; max-width:480px">
        <div style="text-align:center; font-size:48px; margin-bottom:15px; color:var(--primary);"><i class="fas fa-cubes"></i></div>
        <h3 style="text-align:center; margin-top:0; margin-bottom:5px;">ØªØ£ÙƒÙŠØ¯ Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
        <div id="stockConfirmBody" style="background:var(--bg-input); border-radius:14px; padding:20px; margin:15px 0; font-size:14px; line-height:1.8; border:1px dashed var(--border-color);"></div>
        <div class="dialog-actions">
            <button class="btn btn-primary" id="stockConfirmOkBtn"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯</button>
            <button class="btn btn-danger" onclick="document.getElementById('stockConfirmModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="transferConfirmModal" class="dialog-modal" style="display:none;">
    <div class="dialog-box" style="text-align:right; max-width:500px">
        <div style="text-align:center; font-size:48px; margin-bottom:15px; color:var(--primary);"><i class="fas fa-exchange-alt"></i></div>
        <h3 style="text-align:center; margin-top:0; margin-bottom:5px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
        <div id="transferConfirmBody" style="background:var(--bg-input); border-radius:14px; padding:20px; margin:15px 0; font-size:14px; line-height:1.8; border:1px dashed var(--border-color);"></div>
        <div class="dialog-actions">
            <button class="btn btn-primary" id="transferConfirmOkBtn"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
            <button class="btn btn-danger" style="background:transparent; border:1px solid var(--danger); color:var(--danger);" onclick="document.getElementById('transferConfirmModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="couponModal" class="dialog-modal" style="display:none;">
    <div class="dialog-box" style="text-align:center; max-width:400px">
        <div style="font-size:50px; color:var(--accent); margin-bottom:15px"><i class="fas fa-gift"></i></div>
        <h3 style="margin-top:0;">Ù…Ø¨Ø§Ø±Ùƒ! ÙƒÙˆØ¯ Ø®ØµÙ… Ø¬Ø¯ÙŠØ¯</h3>
        <p id="couponModalMsg" style="color:var(--text-muted); font-size:14px; margin-bottom:20px"></p>
        
        <div style="background:var(--yellow-bg); border:2px dashed var(--yellow-border); padding:15px; border-radius:12px; margin-bottom:20px;">
            <h2 id="couponModalCode" style="margin:0; color:var(--yellow-text); letter-spacing:3px;"></h2>
            <div style="color:var(--yellow-text); font-weight:bold; margin-top:5px;" id="couponModalPct"></div>
            <div style="color:var(--text-muted); font-size:12px; margin-top:5px;" id="couponModalDays"></div>
        </div>

        <p style="font-size:14px; font-weight:bold; margin-bottom:15px;" id="couponModalQuestion"></p>

        <div style="display:flex; flex-direction:column; gap:10px;">
            <a id="couponWhatsAppBtn" target="_blank" class="btn btn-success" style="background:#25D366; color:white; width:100%"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</a>
            <button class="btn btn-danger" style="background:transparent; border:1px solid var(--danger); color:var(--danger)" onclick="document.getElementById('couponModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<div id="manualCouponModal" class="dialog-modal" style="display:none;">
    <div class="dialog-box" style="text-align:right; max-width:400px">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px;"><i class="fas fa-ticket-alt" style="color:var(--primary)"></i> ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø®ØµÙ… ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
        
        <div id="mcInputs">
            <div class="input-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="mcCustomer" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            </div>
            <div class="grid-2">
                <div class="input-group">
                    <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label>
                    <input type="number" id="mcPct" placeholder="Ù…Ø«Ø§Ù„: 15">
                </div>
                <div class="input-group">
                    <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label>
                    <input type="number" id="mcDays" placeholder="Ù…Ø«Ø§Ù„: 30">
                </div>
            </div>
            <div class="input-group">
                <label>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)</label>
                <input type="number" id="mcUses" placeholder="Ù…Ø«Ø§Ù„: 5" value="1">
            </div>
        </div>
        
        <div id="mcPreview" style="display:none; background:var(--yellow-bg); border:2px dashed var(--yellow-border); padding:15px; border-radius:12px; margin-bottom:20px; text-align:center;">
            <h2 id="mcCodePreview" style="margin:0; color:var(--yellow-text); letter-spacing:3px;"></h2>
            <div id="mcDetailsPreview" style="font-size:13px; color:var(--text-muted); margin-top:8px;"></div>
        </div>

        <div class="dialog-actions">
            <button class="btn btn-primary" id="btnGenerateMC" onclick="generateManualCoupon()"><i class="fas fa-magic"></i> Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒÙˆØ¯</button>
            <button class="btn btn-danger" id="btnBackMC" style="display:none; background:transparent; border:1px solid var(--danger); color:var(--danger);" onclick="backManualCoupon()"><i class="fas fa-undo"></i> ØªØ±Ø§Ø¬Ø¹ ÙˆØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btn-success" id="btnSaveMC" style="display:none; background:var(--success); color:#fff;" onclick="saveManualCoupon()"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸</button>
            <button class="btn" id="btnCancelMC" style="background:transparent; border:1px solid var(--border-color); color:var(--text-muted)" onclick="document.getElementById('manualCouponModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div class="sidebar" id="mySidebar">
    <div class="brand"><i class="fas fa-rocket"></i> MEGA STORE</div>
    
    <div class="theme-switch-container">
        <i class="fas fa-moon"></i>
        <label class="theme-switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
        <i class="fas fa-sun"></i>
    </div>
    <div id="currentUserDisplay" style="text-align:center; padding: 0 10px 15px 10px; font-size:12px; color: var(--text-muted);"></div>

    <div class="menu-items">
        <button onclick="showPage('purchase', this)" class="active" id="btnPurchase"><i class="fas fa-cart-plus"></i> Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</button>
        <button onclick="showPage('stock', this)" id="btnStock" class="hidden"><i class="fas fa-cubes"></i> Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
        <button onclick="showPage('expiring', this)" id="btnExpiring"><i class="fas fa-hourglass-half"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª <span id="expiryBadge" class="notif-badge" style="background:var(--danger); color:white; padding:2px 6px; border-radius:10px; font-size:10px; display:none"></span></button>
        <button onclick="showPage('discounts', this)" id="btnDiscounts"><i class="fas fa-ticket-alt"></i> Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª <span id="discountBadge" style="background:var(--accent); color:white; padding:2px 6px; border-radius:10px; font-size:10px; display:none; margin-right:4px;"></span></button>
        <button onclick="showPage('wallets', this)" id="btnWallets"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø­Ø§ÙØ¸</button>
        <button onclick="showPage('history', this)" id="btnHistory"><i class="fas fa-history"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
        <button onclick="showPage('analytics', this)" id="btnAnalytics"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button onclick="showPage('investment', this)" id="btnInvestment"><i class="fas fa-hand-holding-usd"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
        <button onclick="showPage('generalNotes', this)" id="btnNotes"><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
        <button onclick="showPage('security', this)" id="btnSecurity" class="hidden"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button onclick="showPage('logs', this)" id="btnLogs" class="hidden"><i class="fas fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</button>
        <button onclick="showPage('backup', this)" id="btnBackup"><i class="fas fa-database"></i> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
        <button onclick="showPage('modify', this)" id="btnSettings"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button onclick="logout()" style="color:var(--danger); margin-top:10px"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div class="main-content">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon icon-bg-primary"><i class="fas fa-dollar-sign"></i></div>
            <div><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</label><div id="statDollar" style="font-size: 22px; font-weight: 800;">0.00 $</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-bg-success"><i class="fas fa-coins"></i></div>
            <div><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙŠÙƒÙ„</label><div id="statShekel" style="font-size: 22px; font-weight: 800;">0.00 â‚ª</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-bg-warning"><i class="fas fa-shopping-bag"></i></div>
            <div><label>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</label><div id="statSales" style="font-size: 22px; font-weight: 800;">0</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:rgba(168,85,247,0.15); color:#a855f7;"><i class="fas fa-calendar-alt"></i></div>
            <div><label>Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</label><div id="statMonthSales" style="font-size: 22px; font-weight: 800;">0</div></div>
        </div>
    </div>

    <div id="notification"></div>

    <div id="purchase" class="card">
        <h3><i class="fas fa-cart-plus" style="color:var(--primary)"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
        <div class="grid-2">
            <div class="input-group"><label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</label>
                <select id="sub" onchange="syncPurchaseDuration()"><option value="">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­...</option></select>
            </div>
            <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="customer" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"></div>
        </div>
        <div class="grid-2">
            <div class="input-group"><label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©)</label><input id="customerPhone" placeholder="+97xxxxxxxxxx" oninput="validatePhoneInput(this)" dir="ltr" style="text-align:right;"></div>
            <div class="input-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label><div style="display:flex; gap:10px"><input type="number" id="paidAmount" placeholder="0.00"><select id="paidCurrency" style="width:100px"><option value="â‚ª">â‚ª Ø´ÙŠÙƒÙ„</option><option value="$">$ Ø¯ÙˆÙ„Ø§Ø±</option></select></div></div>
        </div>
        <div class="grid-2">
            <div class="input-group"><label>ÙŠÙÙˆØ¯Ø¹ ÙÙŠ Ù…Ø­ÙØ¸Ø©:</label><select id="wallet"></select></div>
        </div>
        
        <div class="grid-2" style="margin-top:10px; padding-top:20px; border-top:1px dashed var(--border-color)">
            <div class="input-group">
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 32px;">
                    <input type="checkbox" id="isCompensation" style="width:20px; height:20px; margin:0; accent-color:var(--danger)">
                    <label for="isCompensation" style="margin:0; color:var(--danger); font-weight:800; cursor:pointer">ØªØ³Ø¬ÙŠÙ„ ÙƒØªØ¹ÙˆÙŠØ¶</label>
                </div>
            </div>
            <div class="input-group">
                <label>ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø¥Ù† ÙˆØ¬Ø¯)</label>
                <input id="discountCodeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…" style="border-color:var(--accent)">
            </div>
        </div>
        <input type="hidden" id="subDuration" value="1">
        <button class="btn btn-primary" id="btnSubmitPurchase" style="width:100%; margin-top:25px; padding: 16px; font-size:16px;" onclick="addPurchase()"><i class="fas fa-check-circle"></i> Ø¥ØªÙ…Ø§Ù… ÙˆØ­ÙØ¸</button>
    </div>

    <div id="discounts" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; flex-wrap:wrap; gap:10px">
            <h3 style="margin-bottom:0"><i class="fas fa-ticket-alt" style="color:var(--primary)"></i> Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ÙØ¹Ø§Ù„Ø©</h3>
            <div style="display:flex; gap:10px;">
                <button id="btnGenerateCoupon" class="btn btn-success hidden" onclick="openManualCouponModal()"><i class="fas fa-plus"></i> ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¨ÙˆÙ†</button>
                <button id="btnDeleteAllDiscounts" class="btn btn-danger hidden" onclick="deleteAllDiscounts()"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="discountSearch" onkeyup="currentPage.discounts=1; refreshDiscounts()" placeholder="Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th style="text-align:center;">ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…</th><th style="text-align:center;">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th style="text-align:center;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…</th><th style="text-align:center;">Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª</th><th style="text-align:center;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th style="text-align:center;">Ø­Ø°Ù</th></tr></thead>
                <tbody id="discountsBody"></tbody>
            </table>
        </div>
        <div id="discountsPagination" class="pagination"></div>
    </div>

    <div id="security" class="card hidden">
        <h3><i class="fas fa-user-shield" style="color:var(--primary)"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <div class="inner-box" style="margin-bottom:30px;">
            <h4 style="margin-top:0"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px;">
                <input id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input id="newUserPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <select id="newUserRole">
                    <option value="viewer">Ù…Ø´Ø§Ù‡Ø¯ Ø¹Ø§Ø¯ÙŠ (Ù…Ù‚ÙŠØ¯)</option>
                    <option value="viewer_plus">Ù…Ø´Ø§Ù‡Ø¯ Ù…ØªÙ‚Ø¯Ù…</option>
                    <option value="employee">Ù…ÙˆØ¸Ù (Employee)</option>
                    <option value="admin">Ø£Ø¯Ù…Ù† (Admin)</option>
                </select>
                <button class="btn btn-primary" onclick="addNewUser()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logs" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h3><i class="fas fa-clipboard-list" style="color:var(--primary)"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
            <div style="display:flex; gap:10px">
                <button id="btnVisLogs" class="btn btn-warning hidden" onclick="window.changeLogsVis()" style="padding: 8px 15px; font-size:13px"><i class="fas fa-eye"></i> Ø§Ù„Ø®ØµÙˆØµÙŠØ©</button>
                <button id="btnClearLogs" class="btn btn-danger hidden" onclick="clearLogs()" style="padding: 8px 15px; font-size:13px"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchLogsTab('financial', this)">ğŸ’° Ø­Ø±ÙƒØ§Øª Ù…Ø§Ù„ÙŠØ© ÙˆØªÙØµÙŠÙ„ÙŠØ©</button>
            <button class="tab-btn" onclick="switchLogsTab('danger', this)">ğŸ”´ Ø­Ø±ÙƒØ§Øª Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø®Ø·Ø±Ø©</button>
            <button class="tab-btn" onclick="switchLogsTab('general', this)">ğŸ“‹ Ø­Ø±ÙƒØ§Øª Ø¹Ø§Ù…Ø©</button>
        </div>
        
        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="logsSearch" onkeyup="currentPage.logs=1; refreshLogs()" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th style="width:180px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="width:150px">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead>
                <tbody id="logsTableBody"></tbody>
            </table>
        </div>
        <div id="logsPagination" class="pagination"></div>
    </div>

    <div id="expiring" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin-bottom:0"><i class="fas fa-hourglass-half" style="color:var(--accent)"></i> ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</h3>
            <button id="btnHideExpired" class="btn btn-danger" onclick="deleteExpired()" style="font-size:13px;"><i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ù…Ø±Ø§Ø³Ù„Ø©</th></tr></thead>
                <tbody id="expiringBody"></tbody>
            </table>
        </div>
        <div id="expiringPagination" class="pagination"></div>
    </div>

    <div id="stock" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin-bottom:0"><i class="fas fa-cubes" style="color:var(--primary)"></i> Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
            <button id="btnAddStock" class="btn btn-primary" onclick="openAddStockModal()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:20px;">
            <div class="tabs" style="margin-bottom:0;">
                <button class="tab-btn active" onclick="switchStockTab('active', this)">Ù„Ù… ÙŠØªÙ… Ø¨ÙŠØ¹Ù‡ (Ù…ØªØ§Ø­)</button>
                <button class="tab-btn" onclick="switchStockTab('sold', this)">ØªÙ… Ø¨ÙŠØ¹Ù‡</button>
            </div>
            <button id="btnDeleteAllSold" class="btn btn-danger hidden" onclick="deleteAllSoldStock()"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„Ù…Ø¨Ø§Ø¹</button>
        </div>

        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="stockSearch" onkeyup="currentPage.stock=1; filterStock()" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>

        <div class="table-container">
            <table id="stockTable">
                <thead id="stockHead">
                    </thead>
                <tbody id="stockBody"></tbody>
            </table>
        </div>
        <div id="stockPagination" class="pagination"></div>
    </div>

    <div id="analytics" class="card hidden">
        <h3><i class="fas fa-chart-bar" style="color:var(--primary)"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div class="inner-box" style="padding: 20px;"><div class="chart-wrapper" style="height:300px"><canvas id="profitChart"></canvas></div></div>
            <div class="inner-box" style="padding: 20px;"><div class="chart-wrapper" style="height:300px"><canvas id="salesChart"></canvas></div></div>
        </div>
    </div>

    <div id="wallets" class="card hidden">
        <h3><i class="fas fa-wallet" style="color:var(--primary)"></i> Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th><th>Ø§Ù„Ø¹Ù…Ù„Ø©</th><th style="text-align:center">Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="walletList"></tbody>
            </table>
        </div>
    </div>

    <div id="history" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; gap:10px">
            <h3 style="margin:0"><i class="fas fa-list-ul" style="color:var(--primary)"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button id="btnUndo" class="btn btn-primary" onclick="undoLastPurchase()"><i class="fas fa-undo"></i> ØªØ±Ø§Ø¬Ø¹</button>
                <button class="btn btn-success" onclick="exportHistoryCSV()" style="font-size:13px; padding:10px 16px;"><i class="fas fa-file-csv"></i> ØªØµØ¯ÙŠØ± CSV</button>
                <button id="btnClearHistory" class="btn btn-danger" onclick="clearHistory()"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            </div>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="historySearch" onkeyup="currentPage.history=1; filterHistory()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø©..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
            <div class="input-group" style="margin-bottom:0; flex:1; min-width:140px;">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <div style="position:relative;">
                    <input type="text" id="historyFromDate" placeholder="YYYY-MM-DD" readonly style="padding-right:42px; cursor:pointer;">
                    <i class="fas fa-calendar-alt" style="position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--text-muted); pointer-events:none;"></i>
                </div>
            </div>
            <div class="input-group" style="margin-bottom:0; flex:1; min-width:140px;">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <div style="position:relative;">
                    <input type="text" id="historyToDate" placeholder="YYYY-MM-DD" readonly style="padding-right:42px; cursor:pointer;">
                    <i class="fas fa-calendar-alt" style="position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--text-muted); pointer-events:none;"></i>
                </div>
            </div>
            <button class="btn btn-primary" onclick="clearDateFilter()" style="height:48px; padding:0 18px; flex-shrink:0; margin-bottom:0;" title="Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±"><i class="fas fa-undo"></i> Ù…Ø³Ø­</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        <div id="historyPagination" class="pagination"></div>
    </div>

    <div id="investment" class="card hidden">
        <h3><i class="fas fa-chart-pie" style="color:var(--primary)"></i> Ø­ØµØµ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</h3>
        <div id="investBox" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
        
        <div class="inner-box" style="margin-top:40px; border-color:var(--danger)!important">
            <h4 style="margin-top:0; color:var(--danger)"><i class="fas fa-money-check-alt"></i> Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­</h4>
            <div style="margin-bottom:15px; font-size:13px; color:var(--text-muted);">
                <i class="fas fa-info-circle"></i> Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:20px">
                
                <div class="input-group">
                    <label>Ø³Ø­Ø¨ Ù…Ù†: Ø£Ø­Ù…Ø¯</label>
                    <div style="display:flex; flex-direction:column; gap:10px">
                        <select id="wWalletAhmad" style="width:100%"></select>
                        <input id="withdrawAhmad" type="number" placeholder="0.00">
                        <button class="btn btn-danger" onclick="withdrawPartial('ahmad')" style="width:100%">Ø³Ø­Ø¨</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ø³Ø­Ø¨ Ù…Ù†: Ù…Ø­Ù…Ø¯</label>
                    <div style="display:flex; flex-direction:column; gap:10px">
                        <select id="wWalletMohamed" style="width:100%"></select>
                        <input id="withdrawMohamed" type="number" placeholder="0.00">
                        <button class="btn btn-danger" onclick="withdrawPartial('mohamed')" style="width:100%">Ø³Ø­Ø¨</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ø³Ø­Ø¨ Ù…Ù†: Ø§Ù„Ù…ØªØ¬Ø±</label>
                    <div style="display:flex; flex-direction:column; gap:10px">
                        <select id="wWalletStore" style="width:100%"></select>
                        <input id="withdrawStore" type="number" placeholder="0.00">
                        <button class="btn btn-danger" onclick="withdrawPartial('store')" style="width:100%">Ø³Ø­Ø¨</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modify" class="card hidden">
        
        <div id="sec-storage" style="background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 25px; margin-bottom: 20px;">
            <h3 style="color: var(--text-main); margin-top:0"><i class="fas fa-cloud" style="color:var(--primary)"></i> Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (1MB Limit)</h3>
            <div style="background: var(--bg-input); border-radius: 10px; padding: 15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; font-weight:700;">
                    <span><i class="fas fa-database"></i> Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <span id="storageUsed" style="color:var(--primary)">0</span></span>
                    <span id="storageFree">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ..</span>
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px; color:var(--text-muted);">
                    <span id="storageSizeText">0 KB / 1024 KB</span>
                    <span id="storagePercentText">0%</span>
                </div>

                <div style="width:100%; background:var(--border-color); height:12px; border-radius:10px; overflow:hidden; margin-bottom:8px;">
                    <div id="storageBar" style="width:0%; background:var(--success); height:100%; transition: width 0.5s ease;"></div>
                </div>
                
                <p style="font-size:11px; color:var(--text-muted); margin:0;">
                    ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø³ØªÙ†Ø¯ Ù‡Ùˆ 1 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª. Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ 90% Ù‚Ù… Ø¨Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.
                </p>
            </div>
        </div>

        <div id="demo-mode-section" style="background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 25px; border-radius: var(--radius-lg); margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="color: white; margin-bottom: 5px; margin-top:0"><i class="fas fa-flask"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ (Sandbox)</h3>
                    <p style="font-size: 13px; color: #94a3b8; margin: 0;">Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©.</p>
                </div>
                <label class="theme-switch" style="width: 60px; height: 30px;">
                    <input type="checkbox" id="demoModeToggle" onchange="toggleDemoMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.08);">
                <button class="btn btn-danger" onclick="resetDemoData()" style="font-size:13px; padding:8px 18px;"><i class="fas fa-undo-alt"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
                <p style="font-size: 12px; color: #64748b; margin: 8px 0 0 0;">ÙŠØ¹ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.</p>
            </div>
        </div>

        <h3><i class="fas fa-key" style="color:var(--primary)"></i> ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
        <div class="inner-box" style="margin-bottom:40px">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input type="password" id="changePassInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" style="flex:1">
                <button class="btn btn-primary" onclick="changeMyPassword()">ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>

        <div id="sec-discount-settings">
            <h3><i class="fas fa-ticket-alt" style="color:var(--primary)"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…</h3>
            <div class="inner-box" style="margin-bottom:40px;">
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="setDiscountEnabled" style="width: 20px; height: 20px; margin:0;">
                    <label for="setDiscountEnabled" style="margin-bottom: 0;">ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ù†ØªØ§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŸ</label>
                </div>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ (%)</label>
                        <input type="number" id="setDiscountChance" placeholder="Ù…Ø«Ø§Ù„: 25">
                    </div>
                    <div class="input-group">
                        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ø§ØªØ¬Ø© (%)</label>
                        <div style="display:flex; gap:10px">
                            <input type="number" id="setDiscountMin" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (10)">
                            <input type="number" id="setDiscountMax" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (20)">
                        </div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label>
                        <div style="display:flex; gap:10px">
                            <input type="number" id="setValidityMin" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (15)">
                            <input type="number" id="setValidityMax" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (45)">
                        </div>
                    </div>
                    <div class="input-group" style="display:flex; align-items:flex-end;">
                        <button class="btn btn-primary" style="width:100%; height:48px;" onclick="saveDiscountSettings()">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ…</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-manage-services">
            <h3><i class="fas fa-tags" style="color:var(--primary)"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3>
            <div class="inner-box" style="margin-bottom:40px">
                <div style="display:flex; gap:10px; margin-bottom:15px">
                    <input id="newServiceName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹: ChatGPT)">
                    <button class="btn btn-primary" onclick="addService()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="servicesList" style="display:flex; flex-wrap:wrap; gap:10px"></div>
            </div>
        </div>

        <div id="sec-manual-wallet">
            <h3 style="margin-top:0"><i class="fas fa-exchange-alt" style="color:var(--primary)"></i> Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙØ¸</h3>
            
            <div class="inner-box" style="margin-bottom:40px">
                <div class="grid-2">
                    <div class="input-group"><label>Ù…Ù† (Ø§Ù„Ù…ØµØ¯Ø±)</label><select id="tfFromWallet"></select></div>
                    <div class="input-group"><label>Ø¥Ù„Ù‰ (Ø§Ù„Ù…Ø³ØªÙ„Ù…)</label><select id="tfToWallet"></select></div>
                </div>
                
                <div class="grid-2">
                    <div class="input-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="tfAmount" placeholder="0.00" oninput="calculateTransfer()"></div>
                    <div class="input-group">
                        <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±)</label>
                        <input type="number" id="tfFee" placeholder="0.00" value="0" oninput="calculateTransfer()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (1$ = ØŸ â‚ª)</label>
                    <input type="number" id="tfRate" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3.50" value="1" oninput="calculateTransfer()">
                </div>

                <div class="input-group" style="background:var(--yellow-bg); padding:15px; border-radius:12px; border:1px solid var(--yellow-border);">
                    <label style="color:var(--yellow-text)">Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„Ù…Ø³ØªÙ„Ù…:</label>
                    <input type="number" id="tfResult" placeholder="0.00" style="background:var(--bg-card); border:1px solid var(--yellow-border); font-weight:800; font-size:18px; color:var(--yellow-text); padding:8px 12px; border-radius:var(--radius-md); width:100%; box-sizing:border-box;">
                </div>

                <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="confirmTransfer()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
            </div>
        </div>

        <div id="sec-set-wallet-balance">
            <h3><i class="fas fa-edit" style="color:var(--primary)"></i> ØªØ¹ÙŠÙŠÙ† Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ</h3>
            <div class="inner-box" style="margin-bottom:40px; border-style:dashed!important;">
                <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                    <div class="input-group" style="flex:2; min-width:200px"><label>Ø§Ù„Ù…Ø­ÙØ¸Ø©</label><select id="modWallet"></select></div>
                    <div class="input-group" style="flex:1; min-width:100px"><label>Ø§Ù„Ø±ØµÙŠØ¯</label><input id="modAmount" type="number" placeholder="0.00"></div>
                    <button class="btn btn-primary" style="height:48px; margin-bottom:18px" onclick="setWallet()">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>

        <div id="sec-set-profit-share">
            <h3><i class="fas fa-sliders-h" style="color:var(--primary)"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØµ ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
            <div class="inner-box" style="margin-bottom:40px; border-style:dashed!important;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end">
                    <div class="input-group" style="flex:1; min-width:150px">
                        <label>Ø§Ù„Ø´Ø±ÙŠÙƒ</label>
                        <select id="setSharePerson"><option value="ahmad">Ø£Ø­Ù…Ø¯</option><option value="mohamed">Ù…Ø­Ù…Ø¯</option><option value="store">Ø§Ù„Ù…ØªØ¬Ø±</option></select>
                    </div>
                    <div class="input-group" style="width:100px">
                        <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                        <select id="setShareCurrency"><option value="d">Ø¯ÙˆÙ„Ø§Ø± $</option><option value="s">Ø´ÙŠÙƒÙ„ â‚ª</option></select>
                    </div>
                    <div class="input-group" style="flex:1; min-width:150px">
                        <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                        <input id="setShareAmount" type="number" placeholder="0.00">
                    </div>
                    <button class="btn btn-primary" style="height:48px; margin-bottom:18px" onclick="setProfitShare()">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>

        <div id="sec-manage-wallets">
            <h3><i class="fas fa-plus-circle" style="color:var(--primary)"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div class="inner-box" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:40px">
                <input id="newWalletName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©" style="flex:2">
                <select id="newWalletCurrency" style="width:120px"><option value="$">$ Ø¯ÙˆÙ„Ø§Ø±</option><option value="â‚ª">â‚ª Ø´ÙŠÙƒÙ„</option></select>
                <button class="btn btn-primary" onclick="addNewWallet()">Ø¥Ù†Ø´Ø§Ø¡</button>
            </div>
        </div>

        <div id="sec-rename-wallet">
            <h3><i class="fas fa-edit" style="color:var(--primary)"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© (ØªØ¹Ø¯ÙŠÙ„)</h3>
            <div class="inner-box" style="margin-bottom:40px">
                <div class="input-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©</label><select id="renameWalletSelect" onchange="fillWalletEditData()"></select></div>
                <div class="grid-2">
                    <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label><input id="renameWalletInput" placeholder="Ø§Ù„Ø§Ø³Ù…"></div>
                    <div class="input-group"><label>Ø§Ù„Ø¹Ù…Ù„Ø©</label><select id="renameWalletCur"><option value="$">$ Ø¯ÙˆÙ„Ø§Ø±</option><option value="â‚ª">â‚ª Ø´ÙŠÙƒÙ„</option></select></div>
                </div>
                <div class="input-group">
                    <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="renameWalletStatus"><option value="true">Ù†Ø´Ø· (Active)</option><option value="false">ØºÙŠØ± Ù†Ø´Ø· (Inactive)</option></select>
                </div>
                <button class="btn btn-danger" style="width:100%; margin-bottom:10px" onclick="deleteWallet()"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
                <button class="btn btn-warning" style="width:100%" onclick="updateWalletData()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>

        <div id="sec-profit-settings">
            <h3><i class="fas fa-percent" style="color:var(--primary)"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø¨</h3>
            <div class="inner-box" style="margin-bottom:40px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px;">
                    <div class="input-group"><label>Ø£Ø­Ù…Ø¯ (%)</label><input type="number" id="setAhmadProp" placeholder="35"></div>
                    <div class="input-group"><label>Ù…Ø­Ù…Ø¯ (%)</label><input type="number" id="setMohamedProp" placeholder="35"></div>
                    <div class="input-group"><label>Ø§Ù„Ù…ØªØ¬Ø± (%)</label><input type="number" id="setStoreProp" placeholder="30"></div>
                </div>
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="setDeductCost" style="width: 20px; height: 20px; margin:0;">
                    <label for="setDeductCost" style="margin-bottom: 0;">Ø®ØµÙ… Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ²ÙŠØ¹ØŸ</label>
                </div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
                <div class="input-group">
                    <label>Ø³Ø¹Ø± ØµØ±Ù Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø«Ø§Ø¨Øª (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ)</label>
                    <div style="display:flex; align-items:center; gap:10px">
                        <input type="number" id="setExchangeRate" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ù„Ø§Ù‹ 3.5)">
                        <button class="btn btn-primary" onclick="saveProfitSettings()">Ø­ÙØ¸</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="todoSection" style="background-color: var(--yellow-bg); border: 1px solid var(--yellow-border); border-radius: var(--radius-lg); padding: 25px; margin-bottom: 20px;">
            <h3 style="color: var(--yellow-text); margin-top:0"><i class="fas fa-tasks"></i> Ø§Ù„Ù…Ù‡Ø§Ù… (To-Do)</h3>
            <div id="todoInputArea" style="display:flex; gap:10px; margin-bottom:20px">
                <input id="todoInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø©..." style="background:white; border-color:var(--yellow-border)">
                <button class="btn" style="background:var(--yellow-btn-bg); color:white" onclick="addTodo()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="todoBox"></div>
        </div>
    </div>

    <div id="generalNotes" class="card hidden">
        <h3><i class="fas fa-pen-fancy" style="color:var(--primary)"></i> Ø§Ù„Ù…ÙÙƒØ±Ø©</h3>
        <div style="display:flex; gap:15px; flex-direction: column;">
            <textarea id="gnText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø©..." style="height: 100px; resize:vertical;"></textarea>
            <button class="btn btn-primary" onclick="addGeneralNote()" style="align-self: flex-start;">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        </div>
        <div id="generalNotesBox" style="margin-top:30px;"></div>
    </div>

    <div id="backup" class="card hidden">
        <h3><i class="fas fa-shield-alt" style="color:var(--primary)"></i> Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div style="text-align:center; padding:50px 20px; border:2px dashed var(--border-color); border-radius:30px; background:var(--bg-input);">
            <i class="fas fa-cloud-download-alt" style="font-size:60px; color:var(--primary); margin-bottom:20px; opacity:0.8;"></i>
            <p style="color:var(--text-main); font-weight:700; margin-bottom:25px;">Ø§Ø­ØªÙØ¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹.</p>
            <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            
            <div style="margin: 40px auto; width: 80%; border-top:1px solid var(--border-color)"></div>
            
            <div style="display:flex; gap:15px; align-items:center; justify-content:center; flex-wrap:wrap;">
                <input type="file" id="importFile" style="width:auto; padding:10px;">
                <button class="btn btn-danger" style="background:transparent; color:var(--text-muted); border:1px solid var(--border-color)" onclick="importData()">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
            </div>
        </div>
    </div>

</div>

<div id="editUserModal" class="modal-overlay hidden" onclick="closeEditUserModal(event)">
    <div class="modal-content">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px;"><i class="fas fa-user-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <input type="hidden" id="editUserId">
        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="editUserName" readonly style="background:#f1f5f9; color:#94a3b8"></div>
        <div class="input-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input id="editUserPassInput" type="password" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±"></div>
        <div class="input-group"><label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
            <select id="editUserRoleSelect">
                <option value="viewer">Ù…Ø´Ø§Ù‡Ø¯ Ø¹Ø§Ø¯ÙŠ (Ù…Ù‚ÙŠØ¯)</option>
                <option value="viewer_plus">Ù…Ø´Ø§Ù‡Ø¯ Ù…ØªÙ‚Ø¯Ù…</option>
                <option value="employee">Ù…ÙˆØ¸Ù</option>
                <option value="admin">Ø£Ø¯Ù…Ù†</option>
            </select>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="saveUserEdit()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn" style="width:100%; margin-top:10px; background:transparent; color:var(--text-muted); border:1px solid var(--border-color)" onclick="closeEditUserModal('force')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="stockModal" class="modal-overlay hidden" onclick="closeStockModal(event)">
    <div class="modal-content">
        <h3 id="stockModalTitle" style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px;">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
        <input type="hidden" id="stockIndexId">
        <div class="input-group"><label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
            <select id="stService"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©...</option></select>
        </div>
        
        <div id="stockPurchaseInputs">
            <div class="input-group" style="background:var(--yellow-bg); padding:10px; border-radius:8px; border:1px solid var(--yellow-border)">
                <label style="color:var(--yellow-text)">Ø¯ÙØ¹ Ø§Ù„ØªÙƒÙ„ÙØ© Ù…Ù† Ù…Ø­ÙØ¸Ø©:</label>
                <select id="stWallet"></select>
            </div>
            <div class="input-group" style="background:var(--yellow-bg); padding:10px; border-radius:8px; border:1px solid var(--yellow-border)">
                <label style="color:var(--yellow-text)">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (ÙŠØ®ØµÙ… ÙÙˆØ±Ø§Ù‹):</label>
                <input type="number" id="stCost" placeholder="0.00">
            </div>
        </div>

        <div class="input-group"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª (Ø­Ø³Ø§Ø¨Ø§Øª)</label>
            <input type="number" id="stProfiles" min="1" step="1" value="1" oninput="this.value = Math.max(1, Math.floor(this.value||1))">
        </div>
        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹</label><input id="stVendor" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹"></div>
        <div class="input-group"><label>Ø§Ù„Ù…Ø¯Ø©</label>
            <select id="stDuration"><option value="0">Ø¨Ø¯ÙˆÙ† Ù…Ø¯Ø©</option><option value="1">1 Ø´Ù‡Ø±</option><option value="2">2 Ø´Ù‡Ø±</option><option value="3">3 Ø´Ù‡ÙˆØ±</option><option value="6">6 Ø´Ù‡ÙˆØ±</option><option value="12">12 Ø´Ù‡Ø±</option></select>
        </div>
        <div class="input-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><div style="display:flex; gap:8px;"><input id="stEmail" placeholder="email@example.com" style="flex:1"><button type="button" class="btn btn-primary" style="padding:10px 14px; flex-shrink:0;" onclick="copyField('stEmail', this)" title="Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"><i class="fas fa-copy"></i></button></div></div>
        <div class="input-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><div style="display:flex; gap:8px;"><input id="stPass" placeholder="Password" style="flex:1"><button type="button" class="btn btn-primary" style="padding:10px 14px; flex-shrink:0;" onclick="copyField('stPass', this)" title="Ù†Ø³Ø® ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><i class="fas fa-copy"></i></button></div></div>
        <div class="input-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹)</label><textarea id="stNotes" style="height:80px; resize:vertical;"></textarea></div>
        
        <button id="btnSaveStock" class="btn btn-primary" style="width:100%; margin-top:10px" onclick="verifyStockAdd()"><i class="fas fa-save"></i> Ø­ÙØ¸ ÙˆØ´Ø±Ø§Ø¡</button>
        <button id="btnUpdateNote" class="btn btn-warning hidden" style="width:100%; margin-top:10px" onclick="updateStockNote()"><i class="fas fa-edit"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ‚Ø·</button>
        
        <button class="btn" style="width:100%; margin-top:10px; background:transparent; color:var(--text-muted); border:1px solid var(--border-color)" onclick="closeStockModal('force')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEGA STORE SYSTEM â€” v5.0 (Atomic Race-Condition Fix)
//  ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµÙ„Ø§Ø­: 2026-02-23
//
//  âœ… wallets + invest: Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ØªØ³ØªØ®Ø¯Ù…
//     FieldValue.increment() â€” Ø¹Ù…Ù„ÙŠØ§Øª Ø°Ø±ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ
//     Ù…Ø³ØªØ­ÙŠÙ„ ÙŠØ­Ø¯Ø« Race Condition Ø­ØªÙ‰ Ù…Ø¹ 100 Ù…ÙˆØ¸Ù Ù…ØªØ²Ø§Ù…Ù†
//
//  âœ… stock + purchases + logs: Subcollections Ø¨Ù€ Diff algorithm
//
//  âœ… fbAtomicWalletInvest(): Ø¯Ø§Ù„Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// --- GLOBAL DEFINITIONS & UTILS ---
let migrationRun = false; 

window.changeLogsVis = async function() {
    if(!currentUser || currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
    let s = safeJSON(store.settings, {});
    let current = s.logsVis || 'all';
    let opts = `
        <option value="all" ${current==='all'?'selected':''}>Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
        <option value="no_viewer" ${current==='no_viewer'?'selected':''}>Ù…Ù†Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</option>
        <option value="no_employee" ${current==='no_employee'?'selected':''}>Ù…Ù†Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</option>
        <option value="admin_only" ${current==='admin_only'?'selected':''}>Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·</option>
    `;
    let res = await showPrompt("ØµÙ„Ø§Ø­ÙŠØ§Øª Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¬Ù„", "Ø§Ø®ØªØ± Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø±Ø¤ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·:", "", '<i class="fas fa-eye-slash" style="color:var(--warning)"></i>', true, opts);
    
    if(res) {
        s.logsVis = res;
        store.settings = JSON.stringify(s); fbSave("settings", s);
        logAction(`ØªØ¹Ø¯ÙŠÙ„ Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰: ${res}`, 'general');
        notify("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        applyRBAC();
    }
};

const fix = n => Number(n).toFixed(2);
function safeJSON(str, fallback) {
    try { return str ? JSON.parse(str) : fallback; }
    catch(e) { console.warn("JSON parse error:", e); return fallback; }
}
function esc(s) { 
    if(typeof s !== 'string') return s; 
    return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); 
}

const DEFAULT_USER = {
    id: "id_admin_0000",
    username: "Mohamed Ahmed",
    password: "0000",
    role: "admin", 
    status: "active",
    lastLogin: "-",
    deviceInfo: "-"
};

// â”€â”€â”€ Firebase Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
    apiKey: "AIzaSyBDCTQSHeRD7gG4XdyG1nQxAD1ECQHzxNE",
    authDomain: "mega-store-58cc6.firebaseapp.com",
    projectId: "mega-store-58cc6",
    storageBucket: "mega-store-58cc6.firebasestorage.app",
    messagingSenderId: "477692639493",
    appId: "1:477692639493:web:3520e16e20fa0fda089f6c",
    measurementId: "G-PBR93L70M1"
};

// â”€â”€â”€ In-Memory Store (replaces localStorage for app data) â”€â”€â”€â”€â”€â”€â”€â”€
let store = {};
let db = null;                   // Ù…Ø±Ø¬Ø¹ Firestore Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
let fbDocRef = null;             // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ megastore/data
let fbConnected = false;
let lastServerState = {};        // Ø¢Ø®Ø± Ø­Ø§Ù„Ø© Ù…Ø¤ÙƒØ¯Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… â€” Ø£Ø³Ø§Ø³ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù€ Diff
let _syncStatusTimer = null;
let _pendingWritesTimer = null;
let _refreshAllTimer = null;     // Ù„Ù€ Debounce Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª refreshAll Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
let _collectionsLoaded = {};     // ÙŠØªØªØ¨Ø¹ Ø£ÙŠ Subcollections Ø£ØªÙ…Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
let myProfitChart = null;
let mySalesChart = null;
let currentUser = null; 
let isDemoMode = false;
let currentStockTab = 'active';
let currentLogsTab = 'financial';
let currentPage = { logs: 1, expiring: 1, stock: 1, history: 1, discounts: 1 };
const ITEMS_PER_PAGE = 50;

// â”€â”€â”€ ØªØµÙ†ÙŠÙ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCALAR: ÙŠÙØ®Ø²ÙÙ‘Ù† ÙƒØ­Ù‚Ù„ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (wallets Ùˆinvest Ùˆsettings)
// ARRAY:  ÙŠÙØ®Ø²ÙÙ‘Ù† ÙƒÙ€ Subcollection â€” ÙƒÙ„ Ø¹Ù†ØµØ± ÙˆØ«ÙŠÙ‚Ø© Firestore Ù…Ø³ØªÙ‚Ù„Ø©
// services: Ù…ØµÙÙˆÙØ© strings Ø¨Ø³ÙŠØ·Ø© â† ØªÙØ®Ø²ÙÙ‘Ù† ÙƒØ­Ù‚Ù„ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Scalar)
// Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ IDs ÙÙ„Ø§ ØªØµÙ„Ø­ ÙƒÙ€ Subcollection
const SCALAR_KEYS = ["wallets", "settings", "invest", "services"];
const ARRAY_KEYS  = ["purchases", "stock", "users", "activityLog",
                     "todoList", "generalNotes", "discounts"];
const STORE_KEYS  = [...SCALAR_KEYS, ...ARRAY_KEYS];

// --- UPDATED DIALOG SYSTEM ---
let _confirmResolve = null;
let _promptResolve = null;

function showConfirm(title, msg, okText = "ØªØ£ÙƒÙŠØ¯", cancelText = "Ø¥Ù„ØºØ§Ø¡", iconHtml = '<i class="fas fa-exclamation-triangle"></i>', thirdText = null) {
    return new Promise(resolve => {
        _confirmResolve = resolve;
        document.getElementById("cdIcon").innerHTML = iconHtml; 
        document.getElementById("cdTitle").textContent = title;
        document.getElementById("cdMsg").textContent = msg;
        document.getElementById("cdOkBtn").innerHTML = okText;
        document.getElementById("cdCancelBtn").innerHTML = cancelText;
        
        let tBtn = document.getElementById("cdThirdBtn");
        if(thirdText) {
            tBtn.innerHTML = thirdText;
            tBtn.style.display = "block";
            tBtn.onclick = () => resolveConfirm('third');
        } else {
            tBtn.style.display = "none";
        }
        
        document.getElementById("cdOkBtn").onclick = () => resolveConfirm(true);
        document.getElementById("customConfirmDialog").style.display = "flex";
    });
}
function resolveConfirm(val) {
    document.getElementById("customConfirmDialog").style.display = "none";
    if(_confirmResolve) { _confirmResolve(val); _confirmResolve = null; }
}

function showPrompt(title, msg = "", placeholder = "", iconHtml = '<i class="fas fa-pen"></i>', isSelect = false, selectOptions = "", requireReason = false) {
    return new Promise(resolve => {
        _promptResolve = resolve;
        document.getElementById("pdIcon").innerHTML = iconHtml; 
        document.getElementById("pdTitle").textContent = title;
        document.getElementById("pdMsg").textContent = msg;
        document.getElementById("customPromptDialog")._requireReason = requireReason && !isSelect;
        
        if (isSelect) {
            document.getElementById("pdInputContainer").innerHTML = `<select id="logsVisSelect" style="width:100%; padding:12px; border-radius:10px; border:2px solid var(--border-color); outline:none; background:var(--bg-input); color:var(--text-main); font-weight:bold;">${selectOptions}</select>`;
        } else {
            document.getElementById("pdInputContainer").innerHTML = `<input id="pdInput" class="dialog-input" style="width:100%; padding:12px; border-radius:10px; border:2px solid ${requireReason ? 'var(--danger)' : 'var(--border-color)'}; outline:none; background:var(--bg-input); color:var(--text-main);" placeholder="${placeholder}">`;
        }
        
        document.getElementById("customPromptDialog").style.display = "flex";
        if(!isSelect) setTimeout(() => { let input = document.getElementById("pdInput"); if(input) { input.focus(); input.addEventListener('input', () => { if(input.value.trim()) input.style.borderColor = 'var(--success)'; else if(requireReason) input.style.borderColor = 'var(--danger)'; }); } }, 100);
    });
}
function resolvePrompt(ok) {
    let input = document.getElementById("pdInput");
    let select = document.getElementById("logsVisSelect");
    
    // Ø¥Ø°Ø§ Ø¶ØºØ· ØªØ£ÙƒÙŠØ¯ ÙˆÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ù†ØµÙŠØ§Ù‹ ÙˆØ¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ ÙˆÙØ§Ø±ØºØ§Ù‹ - Ø£Ø¸Ù‡Ø± Ø®Ø·Ø£ ÙˆÙ„Ø§ ØªØºÙ„Ù‚
    if(ok && input && document.getElementById("customPromptDialog")._requireReason) {
        let val = input.value.trim();
        if(!val) {
            notify("Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹", "error");
            input.style.borderColor = "var(--danger)";
            input.focus();
            return; // Ù„Ø§ ØªØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        }
    }
    
    document.getElementById("customPromptDialog").style.display = "none";
    document.getElementById("customPromptDialog")._requireReason = false;
    let val = null;
    if(ok) {
        if (input) val = input.value.trim();
        else if (select) val = select.value;
    }
    if(_promptResolve) { _promptResolve(val); _promptResolve = null; }
}

document.addEventListener("keydown", e => {
    if(e.key === "Enter") {
        if(document.getElementById("customPromptDialog").style.display === "flex") resolvePrompt(true);
        if(document.getElementById("customConfirmDialog").style.display === "flex" && document.getElementById("cdThirdBtn").style.display === "none") resolveConfirm(true);
    }
    if(e.key === "Escape") {
        if(document.getElementById("customPromptDialog").style.display === "flex") resolvePrompt(false);
        if(document.getElementById("customConfirmDialog").style.display === "flex") resolveConfirm(false);
        if(document.getElementById("purchaseConfirmModal").style.display === "flex") document.getElementById("purchaseConfirmModal").style.display = "none";
        if(document.getElementById("stockConfirmModal").style.display === "flex") document.getElementById("stockConfirmModal").style.display = "none";
        if(document.getElementById("transferConfirmModal").style.display === "flex") document.getElementById("transferConfirmModal").style.display = "none";
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠ V2
//  - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (wallets/settings/invest) â† Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
//  - Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â† Subcollections (ÙƒÙ„ Ø¹Ù†ØµØ± ÙˆØ«ÙŠÙ‚Ø© Ù…Ø³ØªÙ‚Ù„Ø©)
//  - Ø±ÙØ¹: ÙŠÙØ­Ø³Ø¨ Ø§Ù„Ù€ Diff ÙˆÙŠÙØ±Ø³ÙÙ„ Ù…Ø§ ØªØºÙŠÙ‘Ø± ÙÙ‚Ø· (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)
//  - Ø§Ø³ØªÙ‚Ø¨Ø§Ù„: docChanges() ÙŠÙØ·Ø¨Ù‘Ù‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© ÙÙ‚Ø· Ø¹Ù„Ù‰ store
//  - ØªØ±Ø­ÙŠÙ„: migrateToV2() ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Ø£Ø¯Ø§Ø© Ù…Ø´ØªØ±ÙƒØ©: Ù…ÙØ¹Ø±ÙÙ‘Ù ÙØ±ÙŠØ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// â”€â”€ Debounce Ù„Ù€ refreshAll (ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©) â”€â”€â”€â”€â”€â”€â”€â”€
function debouncedRefreshAll() {
    clearTimeout(_refreshAllTimer);
    _refreshAllTimer = setTimeout(() => { if (currentUser) refreshAll(); }, 120);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  fbSave â€” Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø­ÙØ¸
//  ÙŠÙÙˆØ¬ÙÙ‘Ù‡ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙØªØ§Ø­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fbSave(key, val) {
    if (isDemoMode) {
        // ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: Ø­ÙØ¸ ÙÙŠ localStorage ÙÙ‚Ø·
        localStorage.setItem('demo_' + key, JSON.stringify(val));
        return;
    }
    if (!fbDocRef) return;
    if (SCALAR_KEYS.includes(key)) {
        _fbSaveScalar(key, val);
    } else if (ARRAY_KEYS.includes(key)) {
        _fbSaveArrayDiff(key, Array.isArray(val) ? val : []);
    }
}

// â”€â”€ Ø­ÙØ¸ Ù…ØªØ¹Ø¯Ø¯ ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ (Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØªÙØ¹Ø¯ÙÙ‘Ù„ Ø¹Ø¯Ø© Ù…ÙØ§ØªÙŠØ­ Ø¯ÙØ¹Ø©) â”€
function fbSaveMultiple(updates) {
    if (isDemoMode) {
        Object.entries(updates).forEach(([key, val]) => {
            localStorage.setItem('demo_' + key, JSON.stringify(val));
        });
        return;
    }
    if (!fbDocRef) return;

    _startSyncTimer();

    const scalarUpdates = {};
    const allBatchOps   = [];

    Object.entries(updates).forEach(([key, val]) => {
        if (SCALAR_KEYS.includes(key)) {
            scalarUpdates[key] = val;
        } else if (ARRAY_KEYS.includes(key)) {
            const oldArr  = lastServerState[key] || [];
            const newArr  = Array.isArray(val) ? val : [];
            const collRef = fbDocRef.collection(key);

            newArr.forEach(item => {
                if (!item.id) item.id = genId();
                const old = oldArr.find(x => x.id === item.id);
                if (!old || JSON.stringify(old) !== JSON.stringify(item)) {
                    allBatchOps.push({ type: 'set', ref: collRef.doc(item.id), data: item });
                }
            });
            oldArr.forEach(item => {
                if (item.id && !newArr.find(x => x.id === item.id)) {
                    allBatchOps.push({ type: 'delete', ref: collRef.doc(item.id) });
                }
            });
        }
    });

    const promises = [];

    if (Object.keys(scalarUpdates).length > 0) {
        promises.push(fbDocRef.set(scalarUpdates, { merge: true }));
    }

    // Firestore batch limit = 500 Ø¹Ù…Ù„ÙŠØ©
    for (let i = 0; i < allBatchOps.length; i += 400) {
        const batch = db.batch();
        allBatchOps.slice(i, i + 400).forEach(op => {
            if (op.type === 'set') batch.set(op.ref, op.data);
            else                   batch.delete(op.ref);
        });
        promises.push(batch.commit());
    }

    if (promises.length === 0) { clearTimeout(_pendingWritesTimer); return; }

    Promise.all(promises)
        .then(() => {
            clearTimeout(_pendingWritesTimer);
            Object.entries(updates).forEach(([k, v]) => {
                lastServerState[k] = JSON.parse(JSON.stringify(v));
            });
            updateSyncStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success");
        })
        .catch(e => {
            clearTimeout(_pendingWritesTimer);
            console.error("fbSaveMultiple error:", e);
            updateSyncStatus("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” ØºÙŠØ± Ù…ØªØµÙ„", "error");
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  fbAtomicWalletInvest â€” ØªØ­Ø¯ÙŠØ« Ø°Ø±ÙŠ (Atomic) Ù„Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ§Ù„Ø­ØµØµ
//  ÙŠØ³ØªØ®Ø¯Ù… FieldValue.increment() Ù„Ù…Ù†Ø¹ Race Condition Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
//  Ù„Ø§ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© â€” Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
//
//  walletIncs  : { "Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©": delta }          â† ÙŠÙØ·Ø¨ÙÙ‘Ù‚ Ø¹Ù„Ù‰ .bal
//  investIncs  : { "ahmad.d": delta, "store.s": delta, ... }
//  localW/localI: Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù…Ø­Ø¯ÙÙ‘Ø«Ø© Ù„Ù„Ù€ UI (optimistic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fbAtomicWalletInvest(walletIncs, investIncs, localW, localI) {
    if (isDemoMode) {
        // ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: Ø§Ù„Ù€ store ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ÙÙ‚Ø· Ø§Ø­ÙØ¸ ÙÙŠ localStorage
        if (localW) localStorage.setItem('demo_wallets', JSON.stringify(localW));
        if (localI) localStorage.setItem('demo_invest', JSON.stringify(localI));
        return Promise.resolve();
    }
    if (!fbDocRef) return Promise.resolve();

    _startSyncTimer();

    const updateObj = {};

    // wallets.<name>.bal += delta
    if (walletIncs) {
        Object.entries(walletIncs).forEach(([name, delta]) => {
            if (delta !== 0) {
                updateObj[`wallets.${name}.bal`] =
                    firebase.firestore.FieldValue.increment(delta);
            }
        });
    }

    // invest.<person>.<currency> += delta  (e.g. "ahmad.d", "store.s")
    if (investIncs) {
        Object.entries(investIncs).forEach(([path, delta]) => {
            if (delta !== 0) {
                updateObj[`invest.${path}`] =
                    firebase.firestore.FieldValue.increment(delta);
            }
        });
    }

    if (Object.keys(updateObj).length === 0) {
        clearTimeout(_pendingWritesTimer);
        return Promise.resolve();
    }

    return fbDocRef.update(updateObj)
        .then(() => {
            clearTimeout(_pendingWritesTimer);
            // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙŠ lastServerState Ù„Ù…Ù†Ø¹ overwrite Ù…Ù† Ø§Ù„Ù€ Diff
            if (localW) lastServerState['wallets'] = JSON.parse(JSON.stringify(localW));
            if (localI) lastServerState['invest']  = JSON.parse(JSON.stringify(localI));
            updateSyncStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success");
        })
        .catch(e => {
            clearTimeout(_pendingWritesTimer);
            console.error("fbAtomicWalletInvest error:", e);
            updateSyncStatus("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” ØºÙŠØ± Ù…ØªØµÙ„", "error");
        });
}

// â”€â”€ Ø­ÙØ¸ Ø­Ù‚Ù„ Ù‚ÙŠØ§Ø³ÙŠ (object Ø£Ùˆ array) ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ â”€â”€â”€â”€â”€â”€â”€â”€
function _fbSaveScalar(key, val) {
    _startSyncTimer();
    fbDocRef.set({ [key]: val }, { merge: true })
        .then(() => {
            clearTimeout(_pendingWritesTimer);
            lastServerState[key] = JSON.parse(JSON.stringify(val));
            updateSyncStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success");
        })
        .catch(e => {
            clearTimeout(_pendingWritesTimer);
            console.error("fbSave scalar error:", e);
            updateSyncStatus("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” ØºÙŠØ± Ù…ØªØµÙ„", "error");
        });
}

// â”€â”€ Ø­ÙØ¸ Ù…ØµÙÙˆÙØ©: ÙŠØ­Ø³Ø¨ Ø§Ù„Ù€ Diff ÙˆÙŠØ±Ø³Ù„ Ù…Ø§ ØªØºÙŠÙ‘Ø± ÙÙ‚Ø· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _fbSaveArrayDiff(key, newArr) {
    const oldArr  = lastServerState[key] || [];
    const collRef = fbDocRef.collection(key);

    const toWrite  = [];
    const toDelete = [];

    newArr.forEach(item => {
        if (!item.id) item.id = genId();
        const old = oldArr.find(x => x.id === item.id);
        if (!old || JSON.stringify(old) !== JSON.stringify(item)) {
            toWrite.push(item);
        }
    });
    oldArr.forEach(item => {
        if (item.id && !newArr.find(x => x.id === item.id)) {
            toDelete.push(item.id);
        }
    });

    if (toWrite.length === 0 && toDelete.length === 0) return;

    _startSyncTimer();

    const allOps = [
        ...toWrite.map(item => ({ type: 'set',    ref: collRef.doc(item.id), data: item })),
        ...toDelete.map(id   => ({ type: 'delete', ref: collRef.doc(id) }))
    ];

    const batches = [];
    for (let i = 0; i < allOps.length; i += 400) {
        const batch = db.batch();
        allOps.slice(i, i + 400).forEach(op => {
            if (op.type === 'set') batch.set(op.ref, op.data);
            else                   batch.delete(op.ref);
        });
        batches.push(batch.commit());
    }

    Promise.all(batches)
        .then(() => {
            clearTimeout(_pendingWritesTimer);
            lastServerState[key] = JSON.parse(JSON.stringify(newArr));
            updateSyncStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success");
        })
        .catch(e => {
            clearTimeout(_pendingWritesTimer);
            console.error(`fbSave array (${key}) error:`, e);
            updateSyncStatus("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” ØºÙŠØ± Ù…ØªØµÙ„", "error");
        });
}

// â”€â”€ Ù…Ø¤Ù‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±Ùƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _startSyncTimer() {
    updateSyncStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", "loading");
    clearTimeout(_pendingWritesTimer);
    _pendingWritesTimer = setTimeout(() => {
        updateSyncStatus("ØªØ£Ø®Ø± ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
    }, 10000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  runSilentMigration â€” Ø¶Ù…Ø§Ù† IDs ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (V1 â†’ V1.1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runSilentMigration() {
    let changed = false;
    let p = safeJSON(store.purchases, []);
    let s = safeJSON(store.stock, []);
    let n = safeJSON(store.generalNotes, []);
    let t = safeJSON(store.todoList, []);
    let u = safeJSON(store.users, []);

    const fixDate = (dStr) => {
        if (!dStr) return dStr;
        let parts = dStr.split('-');
        if (parts.length === 3) {
            let m = parts[1].length === 1 ? '0' + parts[1] : parts[1];
            let d = parts[2].length === 1 ? '0' + parts[2] : parts[2];
            return `${parts[0]}-${m}-${d}`;
        }
        return dStr;
    };

    const ensureId = (item) => {
        if (!item.id) { item.id = genId(); return true; }
        return false;
    };

    // Ø¶Ù…Ø§Ù† Ø­Ù‚Ù„ _ts Ù„ØªØ±ØªÙŠØ¨ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
    let logs = safeJSON(store.activityLog, []);
    let logChanged = false;
    logs.forEach(x => {
        if (!x.id)  { x.id  = genId();     logChanged = true; }
        if (!x._ts) { x._ts = Date.now();  logChanged = true; }
    });

    p.forEach(x => {
        let fd = fixDate(x.date);
        if (fd !== x.date) { x.date = fd; changed = true; }
        if (ensureId(x)) changed = true;
    });
    s.forEach(x => {
        let fd = fixDate(x.soldDate);
        if (x.soldDate && fd !== x.soldDate) { x.soldDate = fd; changed = true; }
        if (ensureId(x)) changed = true;
    });
    n.forEach(x => { if (ensureId(x)) changed = true; });
    t.forEach(x => { if (ensureId(x)) changed = true; });
    u.forEach(x => { if (ensureId(x)) changed = true; });

    if (changed) {
        store.purchases    = JSON.stringify(p); fbSave("purchases",    p);
        store.stock        = JSON.stringify(s); fbSave("stock",        s);
        store.generalNotes = JSON.stringify(n); fbSave("generalNotes", n);
        store.todoList     = JSON.stringify(t); fbSave("todoList",     t);
        store.users        = JSON.stringify(u); fbSave("users",        u);
    }
    if (logChanged) {
        store.activityLog = JSON.stringify(logs); fbSave("activityLog", logs);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  migrateToV2 â€” ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Flat â†’ Subcollections)
//  ÙŠØ¹Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function migrateToV2(oldData) {
    console.log("â³ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ø¥Ù„Ù‰ V2 (Subcollections)...");
    updateSyncStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø­ÙŠÙ„...", "loading");

    try {
        // ÙÙ‚Ø· ARRAY_KEYS Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ø¨Ø¯ÙˆÙ† services)
        const MIGRATE_KEYS = ARRAY_KEYS;

        for (const key of MIGRATE_KEYS) {
            const arr = oldData[key];
            if (!Array.isArray(arr) || arr.length === 0) continue;

            // Ø¶Ù…Ø§Ù† IDs Ù„ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            arr.forEach(item => { if (!item.id) item.id = genId(); });
            // Ø¶Ù…Ø§Ù† _ts Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
            if (key === 'activityLog') {
                arr.forEach(item => { if (!item._ts) item._ts = Date.now(); });
            }

            const collRef = fbDocRef.collection(key);
            for (let i = 0; i < arr.length; i += 400) {
                const batch = db.batch();
                arr.slice(i, i + 400).forEach(item => batch.set(collRef.doc(item.id), item));
                await batch.commit();
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ store ÙˆØ§Ù„Ù€ lastServerState ÙÙˆØ±Ø§Ù‹
            const sorted = _sortCollection(key, arr);
            store[key]           = JSON.stringify(sorted);
            lastServerState[key] = JSON.parse(JSON.stringify(sorted));
        }

        // Ø­Ø°Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ±Ø­ÙŠÙ„
        const cleanupObj = { _v2migrated: true };
        MIGRATE_KEYS.forEach(k => {
            if (oldData[k] !== undefined)
                cleanupObj[k] = firebase.firestore.FieldValue.delete();
        });
        // services ÙƒØ§Ù†Øª Ù…ØµÙÙˆÙØ© strings ÙÙŠ V1 â†’ ØªØ¨Ù‚Ù‰ ÙƒÙ€ scalar field
        if (Array.isArray(oldData.services)) {
            cleanupObj.services = oldData.services;
            store.services = JSON.stringify(oldData.services);
            lastServerState['services'] = JSON.parse(JSON.stringify(oldData.services));
        }
        await fbDocRef.update(cleanupObj);

        console.log("âœ… Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ø¥Ù„Ù‰ V2 Ø§ÙƒØªÙ…Ù„!");
        runSilentMigration(); // ØªØ´ØºÙŠÙ„ Ù‡Ø¬Ø±Ø© V1.1 Ø¨Ø¹Ø¯ V2
        updateSyncStatus("ØªÙ… Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­", "success");

    } catch (e) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø­ÙŠÙ„:", e);
        updateSyncStatus("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„", "error");
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ØªØ±ØªÙŠØ¨ Subcollection Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _sortCollection(key, arr) {
    if (key === 'activityLog') {
        return arr.slice().sort((a, b) => (b._ts || 0) - (a._ts || 0));
    }
    if (key === 'purchases') {
        return arr.slice().sort((a, b) => {
            if (a.date && b.date && a.date !== b.date) return b.date.localeCompare(a.date);
            return (b.id || '').localeCompare(a.id || '');
        });
    }
    // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ù‡Ø§Ù…: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù€ id (ÙŠØ­ØªÙˆÙŠ timestamp)
    if (key === 'generalNotes' || key === 'todoList') {
        return arr.slice().sort((a, b) => (b.id || '').localeCompare(a.id || ''));
    }
    return arr;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  initFirebase â€” ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFirebase() {
    const app = firebase.initializeApp(firebaseConfig);
    db       = firebase.firestore(app);
    fbDocRef = db.collection("megastore").doc("data");

    updateSyncStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...", "loading");

    // â”€â”€ 1. Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (wallets / settings / invest) â”€
    fbDocRef.onSnapshot(
        { includeMetadataChanges: true },
        async (doc) => {
            const fromCache      = doc.metadata.fromCache;
            const hasPendingWrites = doc.metadata.hasPendingWrites;

            if (!fromCache) fbConnected = true;

            if (doc.exists) {
                const data = doc.data();

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ store Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© ÙÙ‚Ø· (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ services)
                SCALAR_KEYS.forEach(k => {
                    if (data[k] !== undefined) {
                        const newStr = JSON.stringify(data[k]);
                        if (store[k] !== newStr) {
                            store[k] = newStr;
                            if (!fromCache) lastServerState[k] = JSON.parse(JSON.stringify(data[k]));
                        }
                    }
                });

                // â”€ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ÙŠØ¹Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) â”€
                if (!fromCache && !migrationRun) {
                    migrationRun = true;
                    if (!data._v2migrated) {
                        // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©: ØªØ±Ø­ÙŠÙ„ Ø¥Ù„Ù‰ V2
                        await migrateToV2(data);
                    } else {
                        // Ù‚Ø§Ø¹Ø¯Ø© V2: Ù‡Ø¬Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø© ÙÙ‚Ø·
                        runSilentMigration();
                    }
                }

                // â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ â”€
                if (currentUser && !fromCache && !hasPendingWrites) {
                    _validateCurrentUser();
                }

            } else if (!fromCache) {
                // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© â€” Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                _initNewDatabase();
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            if (!hasPendingWrites && !fromCache) {
                clearTimeout(_pendingWritesTimer);
                updateSyncStatus("Ù…ØªØ²Ø§Ù…Ù†", "success");
            } else if (fromCache && !fbConnected) {
                updateSyncStatus("ØºÙŠØ± Ù…ØªØµÙ„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©)", "warning");
            }

            updateStorageUI();

            // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (document.getElementById("loginLayer").style.display !== "none") {
                document.getElementById("loginCard").style.display = "";
            }
        },
        (error) => {
            console.error("Firestore scalar error:", error);
            fbConnected = false;
            updateSyncStatus("ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ØªØµÙ„ (Ù…Ø­Ù…ÙŠ)", "warning");
            updateStorageUI();
        }
    );

    // â”€â”€ 2. Ù…Ø³ØªÙ…Ø¹Ùˆ Subcollections (ÙƒÙ„ Ù…ÙØªØ§Ø­ Ù…ØµÙÙˆÙØ© Ù…Ø³ØªÙ…Ø¹ Ù…Ø³ØªÙ‚Ù„) â”€
    ARRAY_KEYS.forEach(key => {
        _collectionsLoaded[key] = false;
        lastServerState[key]    = [];

        fbDocRef.collection(key).onSnapshot(
            { includeMetadataChanges: true },
            (snapshot) => {
                const fromCache      = snapshot.metadata.fromCache;
                const hasPendingWrites = snapshot.metadata.hasPendingWrites;

                if (!fromCache) fbConnected = true;

                let arr = safeJSON(store[key], []);

                if (!_collectionsLoaded[key]) {
                    // â”€â”€â”€â”€ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ: Ø§Ø³ØªÙŠØ¹Ø§Ø¨ ÙƒÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ â”€â”€â”€â”€
                    _collectionsLoaded[key] = true;
                    arr = snapshot.docs.map(d => d.data());
                } else {
                    // â”€â”€â”€â”€ ØªØ­Ø¯ÙŠØ« ØªØ¯Ø±ÙŠØ¬ÙŠ: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙ‚Ø· â”€â”€â”€â”€
                    snapshot.docChanges().forEach(change => {
                        const item = change.doc.data();
                        if (change.type === 'added' || change.type === 'modified') {
                            const idx = arr.findIndex(x => x.id === item.id);
                            if (idx !== -1) arr[idx] = item;
                            else arr.push(item);
                        } else if (change.type === 'removed') {
                            arr = arr.filter(x => x.id !== change.doc.id);
                        }
                    });
                }

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡Ø§
                arr = _sortCollection(key, arr);

                store[key] = JSON.stringify(arr);
                if (!fromCache) {
                    lastServerState[key] = JSON.parse(JSON.stringify(arr));
                }

                // â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø¬Ø¯ÙˆÙ„ users â”€
                if (key === 'users' && !fromCache && !hasPendingWrites && currentUser) {
                    _validateCurrentUser();
                }

                // â”€ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… â”€
                if (!fromCache && !hasPendingWrites && currentUser) {
                    debouncedRefreshAll();
                }

                updateStorageUI();
            },
            (error) => {
                console.error(`Firestore collection (${key}) error:`, error);
            }
        );
    });

    // â”€â”€ 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§ØªØµØ§Ù„ / Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('online', () => {
        fbConnected = false;
        updateSyncStatus("Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...", "loading");
        fbDocRef.get({ source: 'server' }).catch(() => {});
    });
    window.addEventListener('offline', () => {
        fbConnected = false;
        clearTimeout(_pendingWritesTimer);
        updateSyncStatus("ØºÙŠØ± Ù…ØªØµÙ„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©)", "warning");
        updateStorageUI();
    });
}

// â”€â”€ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù€ initFirebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _validateCurrentUser() {
    let latestUsers = safeJSON(store.users, []);
    let me = latestUsers.find(x => x.username === currentUser.username);
    if (!me || me.status === 'banned' || me.password !== currentUser.password) {
        alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… ØªØºÙŠÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ø£Ùˆ ØªÙ… Ø­Ø¸Ø±Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†.");
        location.reload();
        return;
    }
    if (me.role !== currentUser.role) {
        currentUser.role = me.role;
        applyRBAC();
    }
    debouncedRefreshAll();
}

function _initNewDatabase() {
    // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© â€” Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const defaults = getDefaultData();
    fbDocRef.set({
        wallets:      defaults.wallets,
        settings:     defaults.settings,
        invest:       defaults.invest,
        services:     defaults.services,
        _v2migrated:  true
    }, { merge: true }).catch(e => console.error(e));

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Subcollection users
    fbDocRef.collection('users').doc(DEFAULT_USER.id).set(DEFAULT_USER).catch(e => console.error(e));
}

function getDefaultData() {
    // ÙÙŠ V2 ØªÙØ®Ø²ÙÙ‘Ù† Ø§Ù„Ù…ØµÙÙˆÙØ§Øª ÙƒÙ€ SubcollectionsØŒ ÙˆÙ‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© ÙÙ‚Ø·
    return {
        wallets:  safeJSON(store.wallets,  {"Ø¬ÙˆØ§Ù„ Ø¨Ø§ÙŠ â€” Ø³Ø¹Ø§Ø¯":{bal:0,cur:"â‚ª",active:true},"Ø¬ÙˆØ§Ù„ Ø¨Ø§ÙŠ â€” Ù…Ø­Ù…Ø¯":{bal:0,cur:"â‚ª",active:true},"Ø¨Ø§Ù„ Ø¨Ø§ÙŠ â€” Ø£Ø­Ù…Ø¯":{bal:0,cur:"â‚ª",active:true},"Ø¨Ø§ÙŠÙ†Ù†Ø³ â€” Ø§Ø­Ù…Ø¯":{bal:0,cur:"$",active:true}}),
        invest:   safeJSON(store.invest,   {ahmad:{d:0,s:0},mohamed:{d:0,s:0},store:{d:0,s:0}}),
        settings: safeJSON(store.settings, {ahmad:35,mohamed:35,store:30,deductCost:true,exchangeRate:0,logsVis:"all",discountEnabled:true,discountChance:25,discountMin:10,discountMax:20,validityMin:15,validityMax:45}),
        services: safeJSON(store.services, [])
    };
}

function showModalDetails(details) {
    if(!details) return;
    const body = document.getElementById("modalBody");
    body.innerHTML = "";
    
    if(details.type === 'manual') {
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø©");
        body.innerHTML += row("Ø§Ù„Ø³Ø¨Ø¨", esc(details.reason));
        body.innerHTML += row("Ø§Ù„Ù…Ø­ÙØ¸Ø©", esc(details.wallet));
        body.innerHTML += row("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚", fix(details.before), false);
        body.innerHTML += row("Ø§Ù„ØªØºÙŠÙŠØ±", (details.diff >= 0 ? "+"+details.diff : details.diff), true, details.diff >= 0);
        body.innerHTML += row("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯", fix(details.after), false);
        if(details.syncedShare) body.innerHTML += `<div style="padding:5px; margin-top:5px; text-align:center; background:var(--yellow-bg); color:var(--yellow-text); font-size:12px; border-radius:5px;">Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…ØºÙ„Ù‚) ÙˆØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ù„Ù‰ Ø­ØµØ©: ${details.syncedShare}</div>`;
    } 
    else if(details.type === 'manual_invest') {
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ© Ø´Ø±ÙŠÙƒ");
        body.innerHTML += row("Ø§Ù„Ø´Ø±ÙŠÙƒ", esc(details.person));
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„Ø©", details.currency === 'd' ? 'Ø¯ÙˆÙ„Ø§Ø±' : 'Ø´ÙŠÙƒÙ„');
        body.innerHTML += row("Ø§Ù„Ø³Ø¨Ø¨", esc(details.reason));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„", fix(details.before));
        body.innerHTML += row("Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„", fix(details.after));
        if(details.syncedWallet) body.innerHTML += `<div style="padding:5px; margin-top:5px; text-align:center; background:var(--yellow-bg); color:var(--yellow-text); font-size:12px; border-radius:5px;">Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…ØºÙ„Ù‚) ÙˆØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ù„Ù‰ Ù…Ø­ÙØ¸Ø©: ${details.syncedWallet}</div>`;
    }
    else if (details.type === 'transfer') {
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "ØªØ­ÙˆÙŠÙ„ Ø£Ø±ØµØ¯Ø©");
        body.innerHTML += row("Ù…Ù†", esc(details.from));
        body.innerHTML += row("Ø¥Ù„Ù‰", esc(details.to));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ", details.amount + " (" + details.fromCur + ")");
        body.innerHTML += row("Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©", details.fee + " (" + details.fromCur + ")", true, false);
        if(details.fromCur !== details.toCur) {
             body.innerHTML += `<div style="padding:10px; background:var(--yellow-bg); border-radius:8px; margin:5px 0; font-size:13px; color:var(--yellow-text)"><i class="fas fa-exchange-alt"></i> ØªÙ… Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø­ØµØ© Ø§Ù„Ù…ØªØ¬Ø± (ØªØºÙŠÙŠØ± Ø¹Ù…Ù„Ø©)</div>`;
        } else {
             body.innerHTML += row("Ø®ØµÙ… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ù…Ù†", "Ø­ØµØ© Ø§Ù„Ù…ØªØ¬Ø± (Capital)");
        }
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„", details.netAmount);
        body.innerHTML += row("Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±", details.rate);
        body.innerHTML += row("Ø§Ù„Ù…ÙˆØ¯Ø¹ (Ù…Ø³ØªÙ„Ù…)", "+"+details.result + " (" + details.toCur + ")", true, true);
    } else if (details.type === 'purchase') {
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡");
        body.innerHTML += row("Ø§Ù„Ø¹Ù…ÙŠÙ„", esc(details.customer));
        body.innerHTML += row("Ø§Ù„Ø®Ø¯Ù…Ø©", esc(details.sub));
        if(details.isComp) body.innerHTML += `<div style="color:var(--danger); font-weight:bold; text-align:center; padding:5px; border:1px solid var(--danger); border-radius:5px; margin:5px 0;">Ø¹Ù…Ù„ÙŠØ© ØªØ¹ÙˆÙŠØ¶ÙŠØ©</div>`;
        if(details.appliedDiscountPct > 0) body.innerHTML += `<div style="color:var(--success); font-weight:bold; text-align:center; padding:5px; border:1px solid var(--success); border-radius:5px; margin:5px 0;">ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø®ØµÙ…: ${details.appliedDiscountPct}%</div>`;
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶", "+"+details.paid, true, true);
        body.innerHTML += row("ÙÙŠ Ù…Ø­ÙØ¸Ø©", esc(details.toName));
        body.innerHTML += row("Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„", fix(details.tBefore));
        body.innerHTML += row("Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯", fix(details.tAfter));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒÙ„ÙØ©:</b>`;
        body.innerHTML += row("Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹", "Ø®ØµÙ… Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø¹");
        body.innerHTML += row("Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙØ©", details.costVal);
        body.innerHTML += row("Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù„Ù„Ù…ØªØ¬Ø±", "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„");
    } else if (details.type === 'withdraw') {
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­");
        body.innerHTML += row("Ø§Ù„Ø´Ø±ÙŠÙƒ/Ø§Ù„Ø¬Ù‡Ø©", esc(details.person));
        body.innerHTML += row("Ø§Ù„Ø³Ø¨Ø¨", esc(details.reason));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<h4>Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø­Ø¨: ${esc(details.walletName)}</h4>`;
        body.innerHTML += row("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ…", "-"+fix(details.amount) + " " + (details.currency==='$'?'$':'â‚ª'), true, false);
        body.innerHTML += row("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ø¹Ø¯", fix(details.walletAfter));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<h4>Ø±ØµÙŠØ¯ Ø§Ù„Ø­ØµØ©</h4>`;
        body.innerHTML += row("Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨", fix(details.shareBefore));
        body.innerHTML += row("Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨", fix(details.shareAfter));
        
    } else if (details.type === 'undo') {
        body.innerHTML += `<div style="text-align:center; color:var(--accent); margin-bottom:10px"><i class="fas fa-undo"></i> ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¹Ù…Ù„ÙŠØ©</div>`;
        body.innerHTML += `<p style="text-align:center; font-size:13px">ØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø© Ù„ÙˆØ¶Ø¹Ù‡Ø§ Ø§Ù„Ø³Ø§Ø¨Ù‚:</p>`;
        if(details.data) {
             body.innerHTML += row("Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù„ØºØ§Ø©", esc(details.data.sub));
             body.innerHTML += row("Ø§Ù„Ø¹Ù…ÙŠÙ„", esc(details.data.customer));
             body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
             body.innerHTML += row(`Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ù† (${esc(details.data.wallet)})`, "-"+parseFloat(details.data.paid), true, false);
             if(details.data.usedDiscountObj) {
                 body.innerHTML += `<div style="padding:5px; margin-top:5px; text-align:center; background:var(--success); color:#fff; font-size:12px; border-radius:5px;">ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>`;
             }
        }
    } else if (details.type === 'stock_add') {
        body.innerHTML += row("Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "Ø´Ø±Ø§Ø¡ Ù…Ø®Ø²ÙˆÙ†");
        body.innerHTML += row("Ø§Ù„Ø®Ø¯Ù…Ø©", esc(details.item));
        body.innerHTML += row("Ø§Ù„ØªÙƒÙ„ÙØ©", details.cost + " (" + details.currency + ")", true, false);
        body.innerHTML += row("Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¯ÙØ¹", esc(details.wallet));
        body.innerHTML += row("Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø¨Ù„", fix(details.wBefore));
        body.innerHTML += row("Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯", fix(details.wAfter));
        body.innerHTML += `<br><small>ØªÙ… Ø®ØµÙ… Ø§Ù„ØªÙƒÙ„ÙØ© Ø£ÙŠØ¶Ø§Ù‹ Ù…Ù† Ø±Ø£Ø³ Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ¬Ø±</small>`;
    } else {
        body.innerHTML += `<p>${esc(JSON.stringify(details))}</p>`;
    }
    
    document.getElementById("detailsModal").classList.remove("hidden");
}

function row(label, value, colored=false, positive=true) {
    let colorStyle = colored ? (positive ? "color:var(--success)" : "color:var(--danger)") : "";
    return `<div class="detail-row"><span class="detail-label">${label}</span><span class="detail-value" style="${colorStyle}">${value}</span></div>`;
}

function closeModal(e) {
    if(e === 'force' || e.target.id === 'detailsModal') {
        document.getElementById("detailsModal").classList.add("hidden");
        document.getElementById("modalBody").innerHTML = ""; 
    }
}

function updateSyncStatus(msg, type="loading") {
    const el = document.getElementById("syncStatus");
    if(isDemoMode) {
         el.innerHTML = `<i class="fas fa-flask"></i> <span>ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ</span>`;
         return;
    }
    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ø³Ø§Ø¨Ù‚ Ù„ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
    clearTimeout(_syncStatusTimer);
    if(type==="loading") {
        el.innerHTML = `<i class="fas fa-circle-notch fa-spin" style="color:var(--primary)"></i> <span>${msg}</span>`;
        el.style.borderColor = "";
    } else if (type==="success") {
        el.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> <span style="color:var(--success)">${msg}</span>`;
        el.style.borderColor = "var(--success)";
        _syncStatusTimer = setTimeout(() => {
            el.innerHTML = `<i class="fas fa-cloud" style="color:var(--text-muted)"></i> <span>Ù…ØªØ²Ø§Ù…Ù†</span>`;
            el.style.borderColor = "";
        }, 3000);
    } else if (type==="error") {
        el.innerHTML = `<i class="fas fa-exclamation-circle" style="color:var(--danger)"></i> <span style="color:var(--danger)">${msg}</span>`;
        el.style.borderColor = "var(--danger)";
    } else if (type==="warning") {
        el.innerHTML = `<i class="fas fa-cloud-upload-alt" style="color:#d97706"></i> <span style="color:#d97706">${msg}</span>`;
        el.style.borderColor = "#d97706";
    } else {
        el.innerHTML = `<i class="fas fa-cloud" style="color:var(--text-muted)"></i> <span>${msg}</span>`;
        el.style.borderColor = "";
    }
}

function logAction(actionDescription, type='general', details=null) {
    if(!currentUser) return;
    let logs = safeJSON(store.activityLog, []);
    logs.unshift({
        id:      genId(),
        _ts:     Date.now(),
        user:    currentUser.username,
        action:  actionDescription,
        time:    new Date().toLocaleString("ar-EG"),
        logType: type,
        details: details 
    });
    if(logs.length > 500) logs = logs.slice(0, 500);
    store.activityLog = JSON.stringify(logs); fbSave("activityLog", logs);
    if(document.getElementById("logs").classList.contains("hidden") === false) {
        currentPage.logs = 1;
        refreshLogs();
    }
}

function init(){
    if(!store.users) store.users = JSON.stringify([DEFAULT_USER]);
    if(!store.wallets){
        store.wallets = JSON.stringify({
            "Ø¬ÙˆØ§Ù„ Ø¨Ø§ÙŠ â€” Ø³Ø¹Ø§Ø¯":{bal:0, cur:"â‚ª", active:true},
            "Ø¬ÙˆØ§Ù„ Ø¨Ø§ÙŠ â€” Ù…Ø­Ù…Ø¯":{bal:0, cur:"â‚ª", active:true},
            "Ø¨Ø§Ù„ Ø¨Ø§ÙŠ â€” Ø£Ø­Ù…Ø¯":{bal:0, cur:"â‚ª", active:true},
            "Ø¨Ø§ÙŠÙ†Ù†Ø³ â€” Ø§Ø­Ù…Ø¯":{bal:0, cur:"$", active:true}
        });
    }
    if(!store.purchases) store.purchases = "[]"; 
    if(!store.invest) store.invest = JSON.stringify({ahmad:{d:0,s:0},mohamed:{d:0,s:0},store:{d:0,s:0}}); 
    if(!store.generalNotes) store.generalNotes = "[]"; 
    if(!store.todoList) store.todoList = "[]"; 
    if(!store.settings) store.settings = JSON.stringify({ahmad: 35, mohamed: 35, store: 30, deductCost: true, exchangeRate: 0, logsVis: 'all', discountEnabled:true, discountChance:25, discountMin:10, discountMax:20, validityMin:15, validityMax:45}); 
    if(!store.activityLog) store.activityLog = "[]"; 
    if(!store.stock) store.stock = "[]"; 
    if(!store.services) store.services = "[]";
    if(!store.discounts) store.discounts = "[]"; 

    let isDark = localStorage.getItem("darkMode") === "true";
    if(document.getElementById("darkModeToggle")) document.getElementById("darkModeToggle").checked = isDark;
    if(document.getElementById("loginThemeCheck")) document.getElementById("loginThemeCheck").checked = isDark;

    if(localStorage.getItem("isDemoMode") === "true") {
        isDemoMode = true;
        if(document.getElementById("demoModeToggle")) document.getElementById("demoModeToggle").checked = true;
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        let demoBanner = document.getElementById("demoLoginBanner");
        if(demoBanner) demoBanner.style.display = "block";
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ù† localStorage
        STORE_KEYS.forEach(k => {
            let saved = localStorage.getItem('demo_' + k);
            if(saved) store[k] = saved;
        });
        updateSyncStatus("ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ (ØºÙŠØ± Ù…ØªØµÙ„)", "warning");
    } else {
        initFirebase();
    }
    
    updateStorageUI();
}

function updateStorageUI() {
    let totalRecords = 0;
    ["purchases","activityLog","stock","users","todoList","generalNotes","discounts"].forEach(k => {
        let arr = safeJSON(store[k], []);
        if(Array.isArray(arr)) totalRecords += arr.length;
        else totalRecords += Object.keys(arr).length;
    });

    let statusEl = document.getElementById("storageFree");
    if(statusEl) {
        statusEl.innerText = fbConnected ? "Ù…ØªØµÙ„ (Online)" : "ØºÙŠØ± Ù…ØªØµÙ„ (Offline)";
        statusEl.style.color = fbConnected ? "var(--success)" : "var(--danger)";
    }
    
    let usedEl = document.getElementById("storageUsed");
    if(usedEl) usedEl.innerText = totalRecords;

    let dataString = JSON.stringify({
        users: store.users, wallets: store.wallets, purchases: store.purchases, invest: store.invest, settings: store.settings, generalNotes: store.generalNotes, todoList: store.todoList, activityLog: store.activityLog, stock: store.stock, services: store.services, discounts: store.discounts
    });

    let sizeInBytes = new Blob([dataString]).size; 
    let limitInBytes = 1048576; 
    
    let sizeInKB = (sizeInBytes / 1024).toFixed(2);
    let percentage = ((sizeInBytes / limitInBytes) * 100).toFixed(1);

    let sizeText = document.getElementById("storageSizeText");
    let percentText = document.getElementById("storagePercentText");
    let bar = document.getElementById("storageBar");

    if(sizeText) sizeText.innerText = `${sizeInKB} KB Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù…Ù† 1024 KB`;
    if(percentText) percentText.innerText = `${percentage}%`;
    
    if(bar) {
        bar.style.width = `${Math.min(percentage, 100)}%`;
        if(percentage < 50) bar.style.background = "var(--success)"; 
        else if (percentage < 85) bar.style.background = "var(--accent)"; 
        else bar.style.background = "var(--danger)"; 
    }
}

async function toggleDemoMode() {
    let current = localStorage.getItem("isDemoMode") === "true";
    let newState = !current;
    
    if (newState) {
        let ok = await showConfirm("ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ", "Ø³ÙŠØªÙˆÙ‚Ù Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø¨Ø­Ø±ÙŠØ©. Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©.", "ØªÙØ¹ÙŠÙ„", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-flask"></i>');
        if(!ok) { document.getElementById("demoModeToggle").checked = false; return; }
        localStorage.setItem("isDemoMode", "true");
        logAction("ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ (Demo Mode)", 'general');
        location.reload();
    } else {
        let ok = await showConfirm("Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ", "Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ­Ø°Ù Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù‚Ù…Øª Ø¨Ù‡Ø§ Ø§Ù„Ø¢Ù†.", "Ø¥ÙŠÙ‚Ø§Ù", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-cloud-download-alt"></i>');
        if(!ok) { document.getElementById("demoModeToggle").checked = true; return; }
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
        STORE_KEYS.forEach(k => localStorage.removeItem('demo_' + k));
        localStorage.setItem("isDemoMode", "false");
        location.reload();
    }
}

async function resetDemoData() {
    if(!isDemoMode) return notify("Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙ‚Ø·", "error");
    let ok = await showConfirm("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ¶Ø¹Ù‡Ø§ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.", "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-undo-alt"></i>');
    if(!ok) return;
    STORE_KEYS.forEach(k => localStorage.removeItem('demo_' + k));
    location.reload();
}

async function attemptLogin() {
    const btn = document.getElementById("btnLogin");
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value.trim();
    let users = safeJSON(store.users, []);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø§Ø¨Ù‚
    const errEl = document.getElementById("loginError");
    errEl.style.display = "none";

    btn.classList.add('loading'); 

    await new Promise(r => setTimeout(r, 800));

    // â”€â”€â”€ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: Ø£ÙŠ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ£ÙŠ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (isDemoMode) {
        if (!u || !p) {
            errEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.';
            errEl.style.background = 'rgba(239,68,68,0.12)';
            errEl.style.color = '#ef4444';
            errEl.style.border = '1.5px solid rgba(239,68,68,0.35)';
            errEl.style.display = 'block';
            btn.classList.remove('loading');
            return;
        }
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„ (Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…ÙŠÙ†)
        let demoUser = {
            id: 'id_demo_user',
            username: u,
            password: p,
            role: "admin",
            status: "active",
            lastLogin: new Date().toLocaleString("ar-EG"),
            deviceInfo: getOS()
        };
        let newUsers = [demoUser];
        store.users = JSON.stringify(newUsers);
        localStorage.setItem('demo_users', JSON.stringify(newUsers));
        currentUser = demoUser;
        document.getElementById("loginLayer").style.display = "none";
        document.body.classList.remove("locked");
        loadWallets(); loadProfitSettings(); loadServices(); loadPurchaseStock(); refreshAll(); applyRBAC();
        document.getElementById("currentUserDisplay").innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${esc(currentUser.username)} (${getRoleName(currentUser.role)})`;
        resetSessionTimer();
        checkExpiringOnLogin();
        checkExpiredCouponsOnLogin();
        btn.classList.remove('loading');
        return;
    }

    let userObj = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);

    if (userObj) {
        if(userObj.username === "Mohamed Ahmed") {
            userObj.role = "admin"; userObj.status = "active";
            store.users = JSON.stringify(users); fbSave("users", users);
        }

        if(userObj.status === "banned") { 
            errEl.innerHTML = '<i class="fas fa-ban"></i> ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.';
            errEl.style.background = 'rgba(239,68,68,0.12)';
            errEl.style.color = '#ef4444';
            errEl.style.border = '1.5px solid rgba(239,68,68,0.35)';
            errEl.style.display = 'block';
            document.getElementById("loginPass").value = "";
            document.getElementById("loginPass").style.borderColor = "var(--danger)";
            btn.classList.remove('loading');
            return; 
        }
        currentUser = userObj;
        userObj.lastLogin = new Date().toLocaleString("ar-EG");
        userObj.deviceInfo = getOS();
        store.users = JSON.stringify(users); fbSave("users", users);
        
        logAction("ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…", 'general');

        document.getElementById("loginLayer").style.display = "none";
        document.body.classList.remove("locked");
        loadWallets(); loadProfitSettings(); loadServices(); loadPurchaseStock(); refreshAll(); applyRBAC();
        document.getElementById("currentUserDisplay").innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${esc(currentUser.username)} (${getRoleName(currentUser.role)})`;
        resetSessionTimer();
        checkExpiringOnLogin();
        checkExpiredCouponsOnLogin();
    } else { 
        errEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
        errEl.style.background = 'rgba(239,68,68,0.12)';
        errEl.style.color = '#ef4444';
        errEl.style.border = '1.5px solid rgba(239,68,68,0.35)';
        errEl.style.display = 'block';
        document.getElementById("loginPass").value = "";
        document.getElementById("loginUser").style.borderColor = "var(--danger)";
        document.getElementById("loginPass").style.borderColor = "var(--danger)";
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù„Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
        setTimeout(() => {
            document.getElementById("loginUser").style.borderColor = "";
            document.getElementById("loginPass").style.borderColor = "";
        }, 3000);
        // ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„Ø©
        let failedUsers = safeJSON(store.users, []);
        let tempUser = { username: u };
        let _savedUser = currentUser;
        currentUser = { username: u || 'Ù…Ø¬Ù‡ÙˆÙ„' };
        logAction(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø© Ù„Ù„Ø­Ø³Ø§Ø¨: ${u || 'Ø§Ø³Ù… ÙØ§Ø±Øº'}`, 'danger', { attempted: u, time: new Date().toLocaleString("ar-EG") });
        currentUser = _savedUser;
    }
    
    btn.classList.remove('loading'); 
}

function checkExpiringOnLogin() {
    let p = safeJSON(store.purchases, []);
    let now = new Date().getTime(), days3 = 3 * 86400000;
    let expiringCount = p.filter(x => x.expiry && !x.expiryDismissed && !x.reminded && !x.isComp && (x.expiry - now < days3 && x.expiry - now > -2592000000)).length;
    if(expiringCount > 0) notify(`ÙŠÙˆØ¬Ø¯ ${expiringCount} Ø§Ø´ØªØ±Ø§Ùƒ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ (ØºÙŠØ± Ù…Ù†Ø¨Ù‡)`, "warning");
}

function checkExpiredCouponsOnLogin() {
    if(currentUser && currentUser.role === 'admin') {
        let dList = safeJSON(store.discounts, []);
        let now = new Date().getTime();
        let newlyExpired = 0;
        let updated = false;
        
        let localNotified = safeJSON(localStorage.getItem("notified_coupons_" + currentUser.username) || "[]", []);

        for (let i = dList.length - 1; i >= 0; i--) {
            let c = dList[i];
            if(now > c.expiry) {
                if (!localNotified.includes(c.id)) {
                    newlyExpired++;
                    localNotified.push(c.id);
                }
                if (now > c.expiry + (30 * 86400000)) {
                    dList.splice(i, 1);
                    updated = true;
                }
            } else if ((c.usedCount || 0) >= (c.maxUses || 1)) {
                dList.splice(i, 1);
                updated = true;
            }
        }
        
        if(newlyExpired > 0) {
            localStorage.setItem("notified_coupons_" + currentUser.username, JSON.stringify(localNotified));
            setTimeout(() => notify(`ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø£Ø¯Ù…Ù†: ÙŠÙˆØ¬Ø¯ ${newlyExpired} ÙƒÙˆØ¯ Ø®ØµÙ… Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ Ù„Ù„ØªÙˆ!`, "warning"), 4000);
        }
        
        if(updated) {
            store.discounts = JSON.stringify(dList);
            fbSave("discounts", dList);
        }
    }
}

function getOS() {
    let platform = window.navigator.platform, os = null;
    if (['Macintosh', 'MacIntel'].indexOf(platform) !== -1) os = 'Mac OS';
    else if (['iPhone', 'iPad'].indexOf(platform) !== -1) os = 'iOS';
    else if (['Win32', 'Win64', 'Windows'].indexOf(platform) !== -1) os = 'Windows';
    else if (/Android/.test(window.navigator.userAgent)) os = 'Android';
    else if (/Linux/.test(platform)) os = 'Linux';
    return os || "Unknown";
}

function logout() { clearTimeout(_sessionTimer); logAction("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…", 'general'); currentUser = null; location.reload(); }
function getRoleName(role) { 
    if(role==='admin') return 'Ø£Ø¯Ù…Ù†';
    if(role==='employee') return 'Ù…ÙˆØ¸Ù';
    if(role==='viewer_plus') return 'Ù…Ø´Ø§Ù‡Ø¯ Ù…ØªÙ‚Ø¯Ù…';
    return 'Ù…Ø´Ø§Ù‡Ø¯ Ø¹Ø§Ø¯ÙŠ'; 
}

function applyRBAC() {
    const role = currentUser.role;
    
    document.getElementById("btnSecurity").classList.add("hidden");
    document.getElementById("btnBackup").classList.add("hidden");
    document.getElementById("btnLogs").classList.add("hidden");
    document.getElementById("demo-mode-section").classList.add("hidden");
    document.getElementById("btnInvestment").classList.add("hidden"); 
    
    document.getElementById("sec-manual-wallet").classList.add("hidden");
    document.getElementById("sec-set-wallet-balance").classList.add("hidden");
    document.getElementById("sec-set-profit-share").classList.add("hidden");
    document.getElementById("sec-manage-wallets").classList.add("hidden");
    document.getElementById("sec-rename-wallet").classList.add("hidden");
    document.getElementById("sec-profit-settings").classList.add("hidden");
    document.getElementById("sec-discount-settings").classList.add("hidden");
    document.getElementById("todoSection").classList.add("hidden");
    document.getElementById("todoInputArea").classList.add("hidden");
    document.getElementById("btnAddStock").classList.add("hidden");
    document.getElementById("sec-manage-services").classList.add("hidden");

    document.getElementById("btnSettings").classList.remove("hidden");
    document.getElementById("btnClearLogs").classList.add("hidden");
    document.getElementById("btnVisLogs").classList.add("hidden");
    
    document.getElementById("btnDeleteAllDiscounts").classList.add("hidden");
    document.getElementById("btnGenerateCoupon").classList.add("hidden");

    let tfRes = document.getElementById("tfResult");
    if(tfRes) tfRes.readOnly = false;

    let settings = safeJSON(store.settings, {});
    let logsVis = settings.logsVis || 'all';

    if (role === 'admin') {
        document.getElementById("btnSecurity").classList.remove("hidden");
        document.getElementById("btnBackup").classList.remove("hidden");
        document.getElementById("btnLogs").classList.remove("hidden"); 
        document.getElementById("btnClearLogs").classList.remove("hidden"); 
        document.getElementById("btnVisLogs").classList.remove("hidden"); 
        document.getElementById("demo-mode-section").classList.remove("hidden");
        document.getElementById("btnInvestment").classList.remove("hidden");
        
        document.getElementById("sec-manual-wallet").classList.remove("hidden");
        document.getElementById("sec-set-wallet-balance").classList.remove("hidden");
        document.getElementById("sec-set-profit-share").classList.remove("hidden");
        document.getElementById("sec-manage-wallets").classList.remove("hidden");
        document.getElementById("sec-rename-wallet").classList.remove("hidden");
        document.getElementById("sec-profit-settings").classList.remove("hidden");
        document.getElementById("sec-discount-settings").classList.remove("hidden");
        document.getElementById("sec-manage-services").classList.remove("hidden");
        
        document.getElementById("todoSection").classList.remove("hidden");
        document.getElementById("todoInputArea").classList.remove("hidden");
        document.getElementById("btnAddStock").classList.remove("hidden");
        
        document.getElementById("btnStock").classList.remove("hidden");
        document.getElementById("btnUndo").classList.remove("hidden");
        document.getElementById("btnClearHistory").classList.remove("hidden");
        document.getElementById("btnHideExpired").classList.remove("hidden");
        
        document.getElementById("btnDeleteAllDiscounts").classList.remove("hidden");
        document.getElementById("btnGenerateCoupon").classList.remove("hidden");
    } 
    else if (role === 'employee') {
        if(tfRes) tfRes.readOnly = true;

        if(logsVis !== 'no_employee' && logsVis !== 'admin_only') {
            document.getElementById("btnLogs").classList.remove("hidden");
        }
        document.getElementById("demo-mode-section").classList.remove("hidden");
        
        document.getElementById("sec-manual-wallet").classList.remove("hidden");
        
        document.getElementById("todoSection").classList.remove("hidden");
        document.getElementById("todoInputArea").classList.remove("hidden");
        document.getElementById("sec-manage-services").classList.remove("hidden"); 
        
        document.getElementById("btnStock").classList.remove("hidden");
        document.getElementById("btnUndo").classList.remove("hidden");
        document.getElementById("btnHideExpired").classList.remove("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
    }
    else if (role === 'viewer_plus') {
        if(tfRes) tfRes.readOnly = true;
        if(logsVis !== 'no_viewer' && logsVis !== 'admin_only') {
            document.getElementById("btnLogs").classList.remove("hidden");
        }
        document.getElementById("btnPurchase").classList.add("hidden");
        
        document.getElementById("todoSection").classList.remove("hidden");
        document.getElementById("todoInputArea").classList.add("hidden");
        document.getElementById("sec-manage-services").classList.remove("hidden");
        
        document.getElementById("btnUndo").classList.add("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
        document.getElementById("btnHideExpired").classList.add("hidden");
        document.getElementById("btnStock").classList.add("hidden"); 

        document.querySelector("#generalNotes textarea").style.display = "none";
        document.querySelector("#generalNotes button").style.display = "none";

        showPage('history', document.getElementById('btnHistory'));
    }
    else if (role === 'viewer') {
        if(tfRes) tfRes.readOnly = true;
        if(logsVis !== 'no_viewer' && logsVis !== 'admin_only') {
            document.getElementById("btnLogs").classList.remove("hidden");
        }
        document.getElementById("btnPurchase").classList.add("hidden");
        document.getElementById("sec-manage-services").classList.remove("hidden");
        
        document.getElementById("btnUndo").classList.add("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
        document.getElementById("btnHideExpired").classList.add("hidden");
        document.getElementById("btnStock").classList.add("hidden"); 
        
        document.querySelector("#generalNotes textarea").style.display = "none";
        document.querySelector("#generalNotes button").style.display = "none";

        showPage('history', document.getElementById('btnHistory'));
    }
}

function renderUsersTable() {
    if(!currentUser || currentUser.role !== 'admin') return;
    const users = safeJSON(store.users, []);
    const tbody = document.getElementById("usersTableBody"); 
    if(!tbody) return;
    let rows = "";
    users.forEach((u) => {
        let actions = "";
        if(u.username !== currentUser.username) {
            let banBtn = u.status === 'active' ? `<button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="toggleBan('${u.id}')">Ø­Ø¸Ø±</button>` : `<button class="btn btn-success" style="padding:5px 10px; font-size:12px; background:var(--success); color:white" onclick="toggleBan('${u.id}')">ÙÙƒ Ø­Ø¸Ø±</button>`;
            actions = `<div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap"><button class="btn btn-primary" style="padding:5px 10px; font-size:12px" onclick="openEditUserModal('${u.id}')"><i class="fas fa-edit"></i></button>${banBtn}<button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="deleteUser('${u.id}')"><i class="fas fa-trash-alt"></i></button></div>`;
        } else { actions = "<small>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</small>"; }
        let statusClass = u.status === 'active' ? 'security-status-active' : 'security-status-banned';
        let statusText = u.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø­Ø¸ÙˆØ±';
        rows += `<tr><td>${esc(u.username)}</td><td><span class="badge badge-info">${getRoleName(u.role)}</span></td><td class="${statusClass}">${statusText}</td><td style="font-size:12px">${u.lastLogin}</td><td style="font-size:12px">${u.deviceInfo}</td><td>${actions}</td></tr>`;
    });
    tbody.innerHTML = rows;
}

function renderPagination(totalItems, pageKey, renderFunc, containerId) {
    let totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE) || 1;
    let container = document.getElementById(containerId);
    if(!container) return;
    
    if(currentPage[pageKey] > totalPages) currentPage[pageKey] = totalPages;
    if(currentPage[pageKey] < 1) currentPage[pageKey] = 1;

    let html = `
        <button class="page-btn ${currentPage[pageKey] === 1 ? 'disabled' : ''}" onclick="changePage('${pageKey}', -1, ${renderFunc.name})">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <div class="page-info">ØµÙØ­Ø© ${currentPage[pageKey]} Ù…Ù† ${totalPages}</div>
        <button class="page-btn ${currentPage[pageKey] === totalPages ? 'disabled' : ''}" onclick="changePage('${pageKey}', 1, ${renderFunc.name})">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    `;
    container.innerHTML = html;
}

function changePage(key, dir, func) {
    currentPage[key] += dir;
    func();
}

function switchLogsTab(tab, btn) {
    currentLogsTab = tab;
    document.querySelectorAll('#logs .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentPage.logs = 1;
    refreshLogs();
}

function getLogType(log) {
    if(log.logType) return log.logType;
    // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    return log.details != null ? 'financial' : 'general';
}

function refreshLogs() {
    let logs = safeJSON(store.activityLog, []);
    let search = document.getElementById("logsSearch").value.toLowerCase();
    const tbody = document.getElementById("logsTableBody");
    let isViewer = currentUser && currentUser.role === 'viewer';
    
    let tabFiltered = logs.filter(log => getLogType(log) === currentLogsTab);

    let filtered = tabFiltered.filter(log => {
        return !search || log.user.toLowerCase().includes(search) || log.action.toLowerCase().includes(search);
    });

    renderPagination(filtered.length, 'logs', refreshLogs, 'logsPagination');
    let paginated = filtered.slice((currentPage.logs - 1) * ITEMS_PER_PAGE, currentPage.logs * ITEMS_PER_PAGE);

    let rows = "";
    paginated.forEach((log, i) => {
        const uid = `log_${log.id || i}`;
        let typeIcon = '';
        if(currentLogsTab === 'financial') typeIcon = '<span style="color:var(--success); margin-left:5px;">ğŸ’°</span>';
        else if(currentLogsTab === 'danger') typeIcon = '<span style="color:var(--danger); margin-left:5px;">ğŸ”´</span>';
        else typeIcon = '<span style="color:var(--primary); margin-left:5px;">ğŸ“‹</span>';

        let detailsBtn = "";
        if(log.details && !isViewer) {
            detailsBtn = `<button class="btn btn-primary" style="padding:5px 10px; font-size:12px" onclick="toggleLogDetails('${uid}')"><i class="fas fa-chevron-down" id="icon_${uid}"></i></button>`;
        } else {
            detailsBtn = `<span style="color:var(--text-muted); font-size:12px;">-</span>`;
        }

        rows += `<tr><td style="direction:ltr; text-align:right">${log.time}</td><td><b>${esc(log.user)}</b></td><td>${typeIcon}${esc(log.action)}</td><td>${detailsBtn}</td></tr>`;

        if(log.details && !isViewer) {
            let detailRows = Object.entries(log.details).map(([k,v]) => {
                if(v === null || v === undefined || v === '') return '';
                let displayKey = {
                    type:'Ø§Ù„Ù†ÙˆØ¹', customer:'Ø§Ù„Ø¹Ù…ÙŠÙ„', sub:'Ø§Ù„Ø®Ø¯Ù…Ø©', paid:'Ø§Ù„Ù…Ø¯ÙÙˆØ¹', costVal:'Ø§Ù„ØªÙƒÙ„ÙØ©',
                    toName:'Ø§Ù„Ù…Ø­ÙØ¸Ø©', tBefore:'Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø¨Ù„', tAfter:'Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯', isComp:'ØªØ¹ÙˆÙŠØ¶',
                    appliedDiscountPct:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…', wallet:'Ø§Ù„Ù…Ø­ÙØ¸Ø©', reason:'Ø§Ù„Ø³Ø¨Ø¨', before:'Ù‚Ø¨Ù„',
                    after:'Ø¨Ø¹Ø¯', diff:'Ø§Ù„ÙØ§Ø±Ù‚', syncedShare:'Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©', person:'Ø§Ù„Ø´Ø±ÙŠÙƒ',
                    currency:'Ø§Ù„Ø¹Ù…Ù„Ø©', syncedWallet:'Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©', from:'Ù…Ù†', to:'Ø¥Ù„Ù‰',
                    amount:'Ø§Ù„Ù…Ø¨Ù„Øº', fee:'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©', result:'Ø§Ù„ØµØ§ÙÙŠ', fromCur:'Ø¹Ù…Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±',
                    toCur:'Ø¹Ù…Ù„Ø© Ø§Ù„Ù‡Ø¯Ù', item:'Ø§Ù„Ø¹Ù†ØµØ±', cost:'Ø§Ù„ØªÙƒÙ„ÙØ©', wBefore:'Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚Ø¨Ù„',
                    wAfter:'Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ø¹Ø¯', deducted:'Ø§Ù„Ù…Ø®ØµÙˆÙ…', attempted:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ¯Ø®Ù„',
                    code:'Ø§Ù„ÙƒÙˆØ¯', search:'Ø§Ù„Ø¨Ø­Ø«', count:'Ø§Ù„Ø¹Ø¯Ø¯', fromDate:'Ù…Ù† ØªØ§Ø±ÙŠØ®', toDate:'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®',
                    shareBefore:'Ø§Ù„Ø­ØµØ© Ù‚Ø¨Ù„', shareAfter:'Ø§Ù„Ø­ØµØ© Ø¨Ø¹Ø¯', walletBefore:'Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚Ø¨Ù„',
                    walletAfter:'Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ø¹Ø¯', deductedFromWallet:'Ø§Ù„Ù…Ø®ØµÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©',
                    walletName:'Ø§Ù„Ù…Ø­ÙØ¸Ø©', netAmount:'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ',
                    service: 'Ø§Ù„Ø®Ø¯Ù…Ø©'
                }[k] || k;
                let displayVal = typeof v === 'boolean' ? (v ? 'Ù†Ø¹Ù…' : 'Ù„Ø§') : 
                                 typeof v === 'object' ? JSON.stringify(v).substring(0, 80) + (JSON.stringify(v).length > 80 ? '...' : '') : 
                                 String(v).substring(0, 120);
                if(displayVal === 'null' || displayVal === '') return '';
                return `<div style="display:flex; gap:10px; padding:4px 0; border-bottom:1px dashed var(--border-color); flex-wrap:wrap;"><span style="color:var(--text-muted); min-width:120px; font-weight:700;">${displayKey}:</span><span style="color:var(--text-main);">${esc(String(displayVal))}</span></div>`;
            }).filter(Boolean).join('');

            rows += `<tr id="${uid}" style="display:none; background:var(--bg-input);">
                <td colspan="4" style="padding:15px 20px;">
                    <div style="background:var(--bg-card); border-radius:10px; padding:15px; border:1px solid var(--border-color); font-size:13px;">
                        <div style="font-weight:800; margin-bottom:10px; color:var(--primary);">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©</div>
                        ${detailRows || '<span style="color:var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</span>'}
                    </div>
                </td>
            </tr>`;
        }
    });
    tbody.innerHTML = rows || `<tr><td colspan='4' style='text-align:center; padding:20px; color:var(--text-muted)'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
}

function toggleLogDetails(uid) {
    let row = document.getElementById(uid);
    let icon = document.getElementById('icon_' + uid);
    if(!row) return;
    let isHidden = row.style.display === 'none';
    row.style.display = isHidden ? 'table-row' : 'none';
    if(icon) icon.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
}



async function clearLogs() {
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
    
    const tabNames = { financial: "Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©", danger: "Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø®Ø·Ø±Ø©", general: "Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©" };
    let tabName = tabNames[currentLogsTab] || "Ø§Ù„Ø³Ø¬Ù„Ø§Øª";
    let res = await showConfirm(`Ù…Ø³Ø­ ${tabName}`, `Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª ${tabName} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`, "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>', "Ù…Ø³Ø­ Ø£Ù‚Ø¯Ù… ØµÙØ­Ø©");
    if(!res) return;
    
    let allLogs = safeJSON(store.activityLog, []);
    let targetLogs = allLogs.filter(log => getLogType(log) === currentLogsTab);
    
    let logsToSave = [];
    if(res === 'third') {
        let itemsToRemove = targetLogs.slice(-ITEMS_PER_PAGE);
        logsToSave = allLogs.filter(l => !itemsToRemove.includes(l));
    } else {
        logsToSave = allLogs.filter(log => getLogType(log) !== currentLogsTab);
    }
    
    store.activityLog = JSON.stringify(logsToSave); fbSave("activityLog", logsToSave);
    
    logAction(`Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø³Ø­ ${res === 'third' ? 'Ø£Ù‚Ø¯Ù… 50 Ø³Ø¬Ù„ Ù…Ù†' : 'ÙƒØ§ÙØ©'} ${tabName}`, 'danger');
    
    currentPage.logs = 1;
    refreshLogs();
    
    notify("ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­");
}

function addNewUser() {
    const u = document.getElementById("newUserName").value.trim(), p = document.getElementById("newUserPass").value.trim(), r = document.getElementById("newUserRole").value;
    if(!u || !p) return notify("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    let users = safeJSON(store.users, []);
    if(users.some(x => x.username.toLowerCase() === u.toLowerCase())) return notify("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯", "error");
    users.push({ id: 'id_' + Date.now() + Math.random().toString(36).substr(2,5), username: u, password: p, role: r, status: "active", lastLogin: "-", deviceInfo: "-" });
    store.users = JSON.stringify(users); fbSave("users", users);
    logAction(`Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: ${u} Ø¨ØµÙ„Ø§Ø­ÙŠØ© ${r}`, 'danger');
    document.getElementById("newUserName").value = ""; document.getElementById("newUserPass").value = "";
    renderUsersTable();  notify("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
}

function toggleBan(id) {
    let users = safeJSON(store.users, []);
    let index = users.findIndex(x => x.id === id);
    if(index !== -1) {
        let newState = users[index].status === 'active' ? 'banned' : 'active';
        users[index].status = newState;
        store.users = JSON.stringify(users); fbSave("users", users);
        logAction(`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${users[index].username} Ø¥Ù„Ù‰ ${newState}`, 'danger');
        renderUsersTable(); 
    }
}

async function deleteUser(id) {
    let ok = await showConfirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", "Ø­Ø°Ù", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-user-times"></i>');
    if(!ok) return;
    let users = safeJSON(store.users, []);
    let index = users.findIndex(x => x.id === id);
    if(index !== -1) {
        logAction(`Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${users[index].username}`, 'danger');
        users.splice(index, 1);
        store.users = JSON.stringify(users); fbSave("users", users);
        renderUsersTable(); 
    }
}

function changeMyPassword() {
    let newP = document.getElementById("changePassInput").value.trim();
    if(!newP) return notify("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "error");
    let users = safeJSON(store.users, []);
    let myIndex = users.findIndex(u => u.username === currentUser.username);
    if(myIndex !== -1) {
        users[myIndex].password = newP;
        currentUser.password = newP; 
        store.users = JSON.stringify(users); fbSave("users", users);
        document.getElementById("changePassInput").value = "";
        logAction("Ù‚Ø§Ù… Ø¨ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡", 'danger');
         notify("ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
    }
}

function showPage(id, btn){
    if(currentUser) {
        if((currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') && (id === 'purchase' || id === 'security' || id === 'backup')) return notify("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©", "error");
        if(currentUser.role === 'employee' && (id === 'security' || id === 'backup')) return notify("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©", "error");
        
        if(id === 'investment' && currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
        if(id === 'stock' && (currentUser.role === 'viewer' || currentUser.role === 'viewer_plus')) return notify("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©", "error");
    }
    document.querySelectorAll(".card").forEach(x=>x.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    if(window.innerWidth <= 768) { let sidebar = document.getElementById("mySidebar"); if(sidebar.classList.contains("active")) toggleSidebar(); }
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    if(btn) btn.classList.add("active");
    
    if(id === 'purchase') { loadServices(); loadPurchaseStock(); }
    if(id === 'generalNotes') refreshGeneralNotes();
    if(id === 'investment') refreshInvestment();
    if(id === 'history') { refreshHistory(); initDatePickers(); }
    if(id === 'wallets') refreshWallets();
    if(id === 'expiring') refreshExpiring();
    if(id === 'discounts') refreshDiscounts();
    if(id === 'analytics') refreshAnalytics();
    if(id === 'security') renderUsersTable();
    if(id === 'logs') refreshLogs();
    if(id === 'stock') refreshStock();
    if(id === 'modify') { refreshTodoList(); renderServicesSettings(); updateStorageUI(); loadProfitSettings(); }
}

function toggleSidebar() {
    let sidebar = document.getElementById("mySidebar"), overlay = document.querySelector(".sidebar-overlay"), btnIcon = document.querySelector("#menuBtn i");
    sidebar.classList.toggle("active"); overlay.classList.toggle("active");
    if(sidebar.classList.contains("active")){ btnIcon.classList.remove("fa-bars"); btnIcon.classList.add("fa-times"); } else { btnIcon.classList.remove("fa-times"); btnIcon.classList.add("fa-bars"); }
}

function toggleDarkMode() {
    document.documentElement.classList.toggle("dark-mode");
    let isDark = document.documentElement.classList.contains("dark-mode");
    localStorage.setItem("darkMode", isDark);
    
    if(document.getElementById("darkModeToggle")) document.getElementById("darkModeToggle").checked = isDark;
    if(document.getElementById("loginThemeCheck")) document.getElementById("loginThemeCheck").checked = isDark;
}

let _notifyQueue = [];
let _notifyBusy = false;
function notify(msg, type="success") {
    _notifyQueue.push({msg, type});
    if(!_notifyBusy) _processNotifyQueue();
}
function _processNotifyQueue() {
    if(_notifyQueue.length === 0) { _notifyBusy = false; return; }
    _notifyBusy = true;
    let {msg, type} = _notifyQueue.shift();
    let n = document.getElementById("notification");
    n.innerHTML = (type==='success' ? '<i class="fas fa-check-circle"></i> ' : '<i class="fas fa-exclamation-triangle"></i> ') + msg;
    n.style.background = type === "success" ? "#10b981" : type === "warning" ? "#f59e0b" : "#ef4444";
    n.style.display = "flex";
    setTimeout(() => { n.style.display = "none"; setTimeout(_processNotifyQueue, 200); }, 2800);
}

function loadWallets(){
    let wallets=safeJSON(store.wallets, {});
    const selects = [
        document.getElementById("wallet"), document.getElementById("stWallet"), 
        document.getElementById("modWallet"), document.getElementById("renameWalletSelect"), 
        document.getElementById("tfFromWallet"), document.getElementById("tfToWallet"), 
        document.getElementById("wWalletAhmad"), document.getElementById("wWalletMohamed"), document.getElementById("wWalletStore")
    ];
    selects.forEach(s => { 
        if(s) { 
            s.innerHTML = s.id.startsWith("wWallet") ? '<option value="">Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø­Ø¨</option>' : ""; 
            Object.keys(wallets).sort((a,b) => a.localeCompare(b, 'ar')).forEach(w=>{ 
                let o=document.createElement("option"); 
                o.value=w; o.text=w + ` (${wallets[w].cur})`; 
                s.appendChild(o); 
            }); 
        } 
    });
}
function loadServices() {
    let services = safeJSON(store.services, []);
    let selStock = document.getElementById("stService");
    
    let html = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©...</option>';
    services.forEach(s => { html += `<option value="${esc(s)}">${esc(s)}</option>`; });
    if(selStock) selStock.innerHTML = html;
}
function loadPurchaseStock() {
    let stock = safeJSON(store.stock, []);
    let selPurchase = document.getElementById("sub");
    if(selPurchase) {
        let html = '<option value="">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­...</option>';
        stock.filter(s => s.status === 'active').forEach(s => {
            let pDur = parseInt(s.duration) || 0;
            let isExpired = false;
            if(pDur > 0) {
                let expD = new Date(s.timestamp);
                expD.setMonth(expD.getMonth() + pDur);
                if(expD.getDate() !== new Date(s.timestamp).getDate()) expD.setDate(0);
                if(expD.getTime() <= new Date().getTime()) isExpired = true;
            }
            
            if(!isExpired) {
                let sp = s.soldProfiles || 0;
                let tp = s.totalProfiles || 1;
                html += `<option value="${s.id}">${esc(s.displayName || s.service)} (${sp}/${tp})</option>`;
            }
        });
        selPurchase.innerHTML = html;
    }
}

function syncPurchaseDuration() {
    let stockId = document.getElementById("sub").value;
    let durDropdown = document.getElementById("subDuration");
    if (!stockId) {
        durDropdown.value = "1"; 
        return;
    }
    let stockList = safeJSON(store.stock, []);
    let stItem = stockList.find(x => x.id === stockId);
    if (stItem && stItem.duration !== undefined) {
        durDropdown.value = stItem.duration; 
    }
}

function loadProfitSettings(){
    let s = safeJSON(store.settings, {});
    document.getElementById("setAhmadProp").value = s.ahmad; 
    document.getElementById("setMohamedProp").value = s.mohamed; 
    document.getElementById("setStoreProp").value = s.store;
    document.getElementById("setDeductCost").checked = s.deductCost; 
    document.getElementById("setExchangeRate").value = s.exchangeRate || 0;
    
    document.getElementById("setDiscountEnabled").checked = s.discountEnabled !== false;
    document.getElementById("setDiscountChance").value = s.discountChance ?? 25;
    document.getElementById("setDiscountMin").value = s.discountMin ?? 10;
    document.getElementById("setDiscountMax").value = s.discountMax ?? 20;
    document.getElementById("setValidityMin").value = s.validityMin ?? 15;
    document.getElementById("setValidityMax").value = s.validityMax ?? 45;
}
function saveProfitSettings(){
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
    let a = +document.getElementById("setAhmadProp").value;
    let m = +document.getElementById("setMohamedProp").value;
    let s = +document.getElementById("setStoreProp").value;
    if(a + m + s !== 100){ notify("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ 100%","error"); return; }
    let sObj = safeJSON(store.settings, {});
    sObj.ahmad = a; sObj.mohamed = m; sObj.store = s; sObj.deductCost = document.getElementById("setDeductCost").checked; sObj.exchangeRate = +document.getElementById("setExchangeRate").value;
    store.settings = JSON.stringify(sObj); fbSave("settings", sObj);
    logAction("ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­", 'general');
     notify("ØªÙ… Ø§Ù„Ø­ÙØ¸");
}

function saveDiscountSettings(){
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·","error");
    let sObj = safeJSON(store.settings, {});
    sObj.discountEnabled = document.getElementById("setDiscountEnabled").checked;
    sObj.discountChance = +document.getElementById("setDiscountChance").value || 0;
    sObj.discountMin = +document.getElementById("setDiscountMin").value || 0;
    sObj.discountMax = +document.getElementById("setDiscountMax").value || 0;
    sObj.validityMin = +document.getElementById("setValidityMin").value || 0;
    sObj.validityMax = +document.getElementById("setValidityMax").value || 0;
    
    store.settings = JSON.stringify(sObj); fbSave("settings", sObj);
    logAction("ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…", 'general');
    notify("ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ…");
}

function validatePhoneInput(el) {
    let v = el.value.trim();
    if(!v) { el.style.borderColor = ""; return; }
    if(/^\+97\d{10}$/.test(v)) el.style.borderColor = "var(--success)";
    else el.style.borderColor = "var(--danger)";
}

// --- NEW PURCHASE LOGIC ---
function addPurchase(){
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return;
    
    let paidVal = document.getElementById("paidAmount").value;
    let paid = parseFloat(paidVal);
    
    if(isNaN(paid) || paid < 0 || paidVal === "") { 
        notify("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶", "error"); 
        return; 
    }
    
    let stockId = document.getElementById("sub").value;
    if(!stockId) { notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†","error"); return; }
    
    let stockList = safeJSON(store.stock, []);
    let stItem = stockList.find(x => x.id === stockId);
    if(!stItem || stItem.status !== 'active') { notify("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù… ÙŠØ¹Ø¯ Ù…ØªØ§Ø­Ø§Ù‹","error"); return; }
    
    let pDur = parseInt(stItem.duration) || 0;
    if(pDur > 0) {
        let expD = new Date(stItem.timestamp);
        expD.setMonth(expD.getMonth() + pDur);
        if(expD.getDate() !== new Date(stItem.timestamp).getDate()) expD.setDate(0);
        if(expD.getTime() <= new Date().getTime()) return notify("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¨ÙŠØ¹Ù‡", "error");
    }

    let customerPhoneVal = document.getElementById("customerPhone").value.trim();
    if(customerPhoneVal && !/^\+97\d{10}$/.test(customerPhoneVal)) return notify("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ +97 ÙˆÙŠÙ„ÙŠÙ‡ 10 Ø£Ø±Ù‚Ø§Ù…", "error");

    let paidCur = document.getElementById("paidCurrency").value;
    let duration = pDur;
    let settings = safeJSON(store.settings, {});
    let rate = settings.exchangeRate && settings.exchangeRate > 0 ? settings.exchangeRate : 1;
    
    let discountCodeInput = document.getElementById("discountCodeInput").value.trim();
    let appliedDiscountPct = 0;
    let usedDiscountObj = null;
    let isComp = document.getElementById("isCompensation").checked;

    if (discountCodeInput) {
        if(isComp) {
            return notify("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø®ØµÙ… ÙÙŠ Ø¹Ù…Ù„ÙŠØ© ØªØ¹ÙˆÙŠØ¶", "error");
        }
        let discountsList = safeJSON(store.discounts, []);
        let dObj = discountsList.find(x => x.code === discountCodeInput);
        if (!dObj || new Date().getTime() > dObj.expiry || (dObj.usedCount || 0) >= (dObj.maxUses || 1)) {
            let reason = !dObj ? 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' : (new Date().getTime() > dObj.expiry ? 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' : 'ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
            logAction(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø®ØµÙ… ØºÙŠØ± ØµØ§Ù„Ø­: ${discountCodeInput}`, 'danger', { code: discountCodeInput, reason: reason });
            return notify("Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± Ù…ØªÙˆÙØ± Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©", "error");
        }
        appliedDiscountPct = dObj.percentage;
        usedDiscountObj = dObj;
    }

    let originalCost = parseFloat(stItem.cost) || 0;
    let originalCostCur = stItem.costCurrency || 'â‚ª';
    let totalProfiles = parseInt(stItem.totalProfiles) || 1;
    
    let fractionalCostOriginal = originalCost / totalProfiles;
    let calculatedCost = 0;
    
    if (!isComp) {
        if (paidCur === originalCostCur) {
            calculatedCost = fractionalCostOriginal;
        } else {
            if (paidCur === '$' && originalCostCur === 'â‚ª') {
                calculatedCost = fractionalCostOriginal / rate;
            } else if (paidCur === 'â‚ª' && originalCostCur === '$') {
                calculatedCost = fractionalCostOriginal * rate;
            }
        }
    }
    
    let cleanName = stItem.service + (totalProfiles > 1 ? " Shared" : "");
    let customerVal = document.getElementById("customer").value;
    let walletVal = document.getElementById("wallet").value;
    
    if(!walletVal) { notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø©", "error"); return; }

    document.getElementById("purchaseConfirmBody").innerHTML = `
        <div style="display:grid; gap:8px;">
            <div><i class="fas fa-tag"></i> <b>Ø§Ù„Ø®Ø¯Ù…Ø©:</b> ${esc(cleanName)}</div>
            <div><i class="fas fa-user"></i> <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${esc(customerVal)||'â€”'} ${customerPhoneVal?'('+esc(customerPhoneVal)+')':''}</div>
            <div><i class="fas fa-calendar"></i> <b>Ø§Ù„Ù…Ø¯Ø©:</b> ${duration === 0 ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø¯Ø©' : duration + ' Ø´Ù‡Ø±'}</div>
            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed var(--border-color)">
                <span style="color:var(--success)"><i class="fas fa-money-bill-wave"></i> Ù…Ø¯ÙÙˆØ¹: ${paid}${paidCur}</span>
            </div>
            ${isComp ? `<div style="color:var(--danger); font-weight:bold; text-align:center; padding:5px; background:var(--yellow-bg); border-radius:5px; margin:5px 0;"><i class="fas fa-exclamation-circle"></i> Ø¹Ù…Ù„ÙŠØ© ØªØ¹ÙˆÙŠØ¶ (Ø§Ù„Ù…ØªØ¬Ø± Ø³ÙŠØªØ­Ù…Ù„ ØªÙƒÙ„ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)</div>` : ''}
            ${appliedDiscountPct > 0 ? `<div style="color:var(--success); font-weight:bold; text-align:center; padding:5px; border:1px solid var(--success); border-radius:5px; margin:5px 0;"><i class="fas fa-ticket-alt"></i> ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¯ Ø®ØµÙ…: ${appliedDiscountPct}%</div>` : ''}
            <div><i class="fas fa-info-circle"></i> <b>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</b> <span style="color:var(--danger)">Ø³ÙŠØªÙ… Ø®ØµÙ… ${fix(calculatedCost)} ${paidCur} ÙƒØªÙƒÙ„ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span></div>
            <div style="font-size:12px; margin-top:6px; color:var(--text-muted)"><i class="fas fa-arrow-right"></i> Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ: ${esc(walletVal)}</div>
        </div>`;
    
    document.getElementById("purchaseConfirmModal").style.display = "flex";
    document.getElementById("purchaseConfirmOkBtn").onclick = () => {
        document.getElementById("purchaseConfirmModal").style.display = "none";
        _executePurchase(paid, paidCur, duration, settings, stItem, cleanName, calculatedCost, rate, usedDiscountObj, appliedDiscountPct, isComp, customerVal, customerPhoneVal, walletVal);
    };
}

function _executePurchase(paid, paidCur, duration, settings, stItem, cleanName, calculatedCost, rate, usedDiscountObj, appliedDiscountPct, isComp, customerVal, customerPhoneVal, walletVal) {
    let wallets = safeJSON(store.wallets, {}), invest = safeJSON(store.invest, {}), purchases = safeJSON(store.purchases, []);
    
    if(!wallets[walletVal]) { notify("Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "error"); return; }
    
    let tBefore = wallets[walletVal].bal;
    let invest_before_profit = JSON.parse(JSON.stringify(invest));
    
    wallets[walletVal].bal += paid;
    
    let distributableProfit = paid;
    let recoupAmount = 0;

    if (settings.deductCost && !isComp) {
        recoupAmount = calculatedCost; 
        distributableProfit = paid - calculatedCost;
    } else if (settings.deductCost && isComp) {
        let oC = (parseFloat(stItem.cost) || 0) / (parseInt(stItem.totalProfiles) || 1);
        let sT = stItem.costCurrency === '$' ? 'd' : 's';
        invest.store[sT] -= oC;
    }

    let shareType = (paidCur === '$') ? 'd' : 's';
    
    if(!isComp) {
        invest.store[shareType] += recoupAmount;

        if (distributableProfit >= 0) {
            let aP = +(distributableProfit * (settings.ahmad/100)).toFixed(2);
            let mP = +(distributableProfit * (settings.mohamed/100)).toFixed(2);
            let sP = +(distributableProfit * (settings.store/100)).toFixed(2);
            invest.ahmad[shareType] += aP; invest.mohamed[shareType] += mP; invest.store[shareType] += sP;
        } else {
            invest.store[shareType] += distributableProfit; 
        }
    }
    
    let d = new Date(stItem.timestamp || Date.now()), exp = null;
    if (duration > 0) {
        exp = new Date(d);
        exp.setMonth(exp.getMonth() + duration);
        if(exp.getDate() !== d.getDate()) exp.setDate(0);
    }
    
    let buyerInfo = (customerVal ? customerVal : "Ø¹Ù…ÙŠÙ„") + (customerPhoneVal ? ` - ${customerPhoneVal}` : "");
    if(!stItem.buyers) stItem.buyers = [];
    stItem.buyers.push(buyerInfo);
    
    stItem.soldProfiles = (stItem.soldProfiles || 0) + 1;
    if(stItem.soldProfiles >= (stItem.totalProfiles || 1)) {
        stItem.status = 'sold';
        let nd = new Date();
        let mm = (nd.getMonth()+1).toString().padStart(2,'0');
        let dd = nd.getDate().toString().padStart(2,'0');
        stItem.soldDate = `${nd.getFullYear()}-${mm}-${dd}`;
    }
    let stockList = safeJSON(store.stock, []);
    let stIdx = stockList.findIndex(x => x.id === stItem.id);
    if(stIdx !== -1) stockList[stIdx] = stItem;
    let nd = new Date();
    let nmm = (nd.getMonth()+1).toString().padStart(2,'0');
    let ndd = nd.getDate().toString().padStart(2,'0');

    purchases.forEach(p => p.canBeUndone = false);

    purchases.push({
        id: 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2,5),
        date: `${nd.getFullYear()}-${nmm}-${ndd}`,
        customer: customerVal||"Ø¹Ù…ÙŠÙ„",
        phone: customerPhoneVal||"-",
        sub: cleanName,
        stockId: stItem.id,
        duration: duration,
        paid: paid+paidCur,
        cost: isComp ? "0" + (stItem.costCurrency || "â‚ª") : fix(calculatedCost) + paidCur,
        wallet: walletVal,
        expiry: exp ? exp.getTime() : null,
        investSnapshot: invest_before_profit,
        isComp: isComp,
        usedDiscountObj: usedDiscountObj,
        canBeUndone: true
    });

    // â”€â”€â”€ Ø­ÙØ¸ Ø°Ø±ÙŠ (Atomic) Ù„Ù…Ù†Ø¹ Race Condition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // wallets + invest â† FieldValue.increment() Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø©
    // stock + purchases â† Subcollections Ø¹Ø§Ø¯ÙŠØ©
    store.stock     = JSON.stringify(stockList);
    store.wallets   = JSON.stringify(wallets);
    store.invest    = JSON.stringify(invest);
    store.purchases = JSON.stringify(purchases);

    // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ù…ÙˆØ³ increment Ù„Ù€ wallets
    const _wIncs = { [walletVal]: paid };

    // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ù…ÙˆØ³ increment Ù„Ù€ invest
    const _iIncs = {};
    if (!isComp) {
        // Ø§Ù„Ù…ØªØ¬Ø± ÙŠØ³ØªØ±Ø¯ Ø§Ù„ØªÙƒÙ„ÙØ© + Ø­ØµØªÙ‡ Ù…Ù† Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ
        const _storeTotal = recoupAmount + (distributableProfit >= 0
            ? +(distributableProfit * (settings.store / 100)).toFixed(2)
            : distributableProfit);
        _iIncs[`store.${shareType}`]   = _storeTotal;
        if (distributableProfit >= 0) {
            _iIncs[`ahmad.${shareType}`]   = +(distributableProfit * (settings.ahmad / 100)).toFixed(2);
            _iIncs[`mohamed.${shareType}`] = +(distributableProfit * (settings.mohamed / 100)).toFixed(2);
        }
    } else if (settings.deductCost) {
        // ØªØ¹ÙˆÙŠØ¶: Ø®ØµÙ… ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ù† Ø­ØµØ© Ø§Ù„Ù…ØªØ¬Ø±
        let _oC  = (parseFloat(stItem.cost) || 0) / (parseInt(stItem.totalProfiles) || 1);
        let _sT  = stItem.costCurrency === '$' ? 'd' : 's';
        _iIncs[`store.${_sT}`] = -_oC;
    }

    fbAtomicWalletInvest(_wIncs, _iIncs, wallets, invest);
    fbSaveMultiple({ stock: stockList, purchases: purchases });
    
    logAction(`Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡: ${cleanName} Ù„Ù„Ø¹Ù…ÙŠÙ„ ${customerVal}`, 'financial', {
        type: 'purchase',
        customer: customerVal||"Ø¹Ù…ÙŠÙ„",
        sub: cleanName,
        paid: paid+paidCur,
        costVal: isComp ? "0" : fix(calculatedCost) + paidCur,
        isFirstProfile: !isComp,
        toName: walletVal, tBefore: tBefore, tAfter: wallets[walletVal].bal,
        appliedDiscountPct: appliedDiscountPct,
        isComp: isComp
    });

    if (usedDiscountObj) {
        let dList = safeJSON(store.discounts, []);
        let dIdx = dList.findIndex(x => x.id === usedDiscountObj.id);
        if(dIdx !== -1) {
            dList[dIdx].usedCount = (dList[dIdx].usedCount || 0) + 1;
            store.discounts = JSON.stringify(dList);
            fbSave("discounts", dList);
        }
    }

    let dEnabled = settings.discountEnabled !== false;
    let dChance = settings.discountChance !== undefined ? settings.discountChance : 25;
    
    if (dEnabled && !isComp && paid > 0 && appliedDiscountPct === 0) {
        let rand = Math.random() * 100;
        if (rand <= dChance) {
            let dMin = settings.discountMin !== undefined ? settings.discountMin : 10;
            let dMax = settings.discountMax !== undefined ? settings.discountMax : 20;
            let vMin = settings.validityMin !== undefined ? settings.validityMin : 15;
            let vMax = settings.validityMax !== undefined ? settings.validityMax : 45;

            let dList = safeJSON(store.discounts, []);
            let code;
            do { code = Math.floor(100000000 + Math.random() * 900000000).toString(); } 
            while (dList.some(x => x.code === code));
            
            let pct = Math.floor(Math.random() * (dMax - dMin + 1)) + dMin;
            let days = Math.floor(Math.random() * (vMax - vMin + 1)) + vMin;
            let expTime = new Date().getTime() + (days * 86400000);

            let generatedCoupon = {
                id: 'id_' + Date.now().toString(),
                code: code,
                customer: customerVal || "Ø¹Ù…ÙŠÙ„",
                service: cleanName,
                percentage: pct,
                expiry: expTime,
                days: days,
                maxUses: 1,
                usedCount: 0,
                notified: false
            };

            dList.unshift(generatedCoupon);
            store.discounts = JSON.stringify(dList);
            fbSave("discounts", dList);

            showCouponModal(generatedCoupon, customerPhoneVal);
        }
    }
    
    currentPage.history = 1;
    loadPurchaseStock();
    refreshAll();  notify("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
    
    document.getElementById("paidAmount").value=""; 
    document.getElementById("customer").value=""; 
    document.getElementById("sub").value=""; 
    document.getElementById("customerPhone").value=""; 
    document.getElementById("discountCodeInput").value="";
    document.getElementById("isCompensation").checked = false;
    document.getElementById("customerPhone").style.borderColor = "";
}

function showCouponModal(coupon, phone) {
    document.getElementById("couponModalMsg").textContent = `ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø®ØµÙ… Ù„Ù„Ø¹Ù…ÙŠÙ„ ${coupon.customer} Ø¨Ù†Ø¬Ø§Ø­.`;
    document.getElementById("couponModalCode").textContent = coupon.code;
    document.getElementById("couponModalPct").textContent = `Ø®ØµÙ… Ø¨Ù‚ÙŠÙ…Ø© ${coupon.percentage}%`;
    document.getElementById("couponModalDays").textContent = `ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© ${coupon.days} ÙŠÙˆÙ…`;
    document.getElementById("couponModalQuestion").textContent = `Ø­ØµÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ "${coupon.customer}" Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø®ØµÙ…ØŒ Ù‡Ù„ ØªÙˆØ¯ Ø¥Ø®Ø¨Ø§Ø±Ù‡ØŸ`;

    let msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${coupon.customer}\nØ­ØµÙ„Øª Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø®ØµÙ… ${coupon.percentage}% Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø¯Ù…Ø© Ø¨ØªØ®ØªØ§Ø±Ù‡Ø§ Ù…Ù† Ø®Ø¯Ù…Ø§ØªÙ†Ø§\nØµÙ„Ø§Ø­ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…: ${coupon.days} ÙŠÙˆÙ…\nÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…: ${coupon.code}`;
    let cleanPhone = (phone || '').replace(/\D/g, '');
    
    let waLink = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
    let waBtn = document.getElementById("couponWhatsAppBtn");
    waBtn.href = waLink;
    if (!cleanPhone) {
        waBtn.style.display = "none";
    } else {
        waBtn.style.display = "flex";
        waBtn.onclick = () => { document.getElementById('couponModal').style.display='none'; };
    }

    document.getElementById("couponModal").style.display = "flex";
}

let tempMC = null;
function openManualCouponModal() {
    document.getElementById("mcCustomer").value = "";
    document.getElementById("mcPct").value = "";
    document.getElementById("mcDays").value = "";
    document.getElementById("mcUses").value = "1";
    document.getElementById("mcInputs").style.display = "block";
    document.getElementById("mcPreview").style.display = "none";
    document.getElementById("btnGenerateMC").style.display = "block";
    document.getElementById("btnBackMC").style.display = "none";
    document.getElementById("btnSaveMC").style.display = "none";
    document.getElementById("manualCouponModal").style.display = "flex";
    tempMC = null;
}

function generateManualCoupon() {
    let cust = document.getElementById("mcCustomer").value.trim() || "Ø¹Ù…ÙŠÙ„ Ø¹Ø§Ù…";
    let pct = parseInt(document.getElementById("mcPct").value);
    let days = parseInt(document.getElementById("mcDays").value);
    let uses = parseInt(document.getElementById("mcUses").value) || 1;
    
    if(isNaN(pct) || pct <= 0 || pct > 100) return notify("Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "error");
    if(isNaN(days) || days <= 0) return notify("Ø£Ø¯Ø®Ù„ Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "error");
    if(uses <= 0) return notify("Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
    
    let dList = safeJSON(store.discounts, []);
    let code;
    do { code = Math.floor(100000000 + Math.random() * 900000000).toString(); } 
    while (dList.some(x => x.code === code));
    
    let expTime = new Date().getTime() + (days * 86400000);
    
    tempMC = {
        id: 'id_' + Date.now().toString(),
        code: code,
        customer: cust,
        service: "ØªÙˆÙ„ÙŠØ¯ ÙŠØ¯ÙˆÙŠ",
        percentage: pct,
        expiry: expTime,
        days: days,
        maxUses: uses,
        usedCount: 0,
        notified: false
    };
    
    document.getElementById("mcCodePreview").innerText = code;
    document.getElementById("mcDetailsPreview").innerText = `Ø®ØµÙ… ${pct}% | ØµØ§Ù„Ø­ Ù„Ù€ ${days} ÙŠÙˆÙ… | ${uses} Ø§Ø³ØªØ¹Ù…Ø§Ù„Ø§Øª`;
    document.getElementById("mcInputs").style.display = "none";
    document.getElementById("mcPreview").style.display = "block";
    document.getElementById("btnGenerateMC").style.display = "none";
    document.getElementById("btnBackMC").style.display = "block";
    document.getElementById("btnSaveMC").style.display = "block";
}

function backManualCoupon() {
    document.getElementById("mcInputs").style.display = "block";
    document.getElementById("mcPreview").style.display = "none";
    document.getElementById("btnGenerateMC").style.display = "block";
    document.getElementById("btnBackMC").style.display = "none";
    document.getElementById("btnSaveMC").style.display = "none";
}

function saveManualCoupon() {
    if(!tempMC) return;
    let dList = safeJSON(store.discounts, []);
    dList.unshift(tempMC);
    store.discounts = JSON.stringify(dList); fbSave("discounts", dList);
    logAction(`Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø®ØµÙ… ÙŠØ¯ÙˆÙŠ Ø¨Ù†Ø³Ø¨Ø© ${tempMC.percentage}% Ù„Ù„Ø¹Ù…ÙŠÙ„ ${tempMC.customer}`, 'financial');
    document.getElementById("manualCouponModal").style.display = "none";
    refreshDiscounts();
    notify("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­");
}

function refreshAll(){
    refreshWallets();
    let p = safeJSON(store.purchases, []);
    let now = new Date();
    let nmm = (now.getMonth()+1).toString().padStart(2,'0');
    let ndd = now.getDate().toString().padStart(2,'0');
    let todayStr = `${now.getFullYear()}-${nmm}-${ndd}`;
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    document.getElementById("statSales").textContent = p.filter(x => x.date && x.date.includes(todayStr) && !x.isComp).length;
    if(isRestricted) {
        document.getElementById("statDollar").textContent = "****";
        document.getElementById("statShekel").textContent = "****";
    }
    
    
    const visMap = {
        'history': refreshHistory,
        'investment': refreshInvestment,
        'generalNotes': refreshGeneralNotes,
        'expiring': refreshExpiring,
        'analytics': refreshAnalytics,
        'logs': refreshLogs,
        'stock': refreshStock,
        'discounts': refreshDiscounts,
        'modify': () => { refreshTodoList(); renderServicesSettings(); updateStorageUI(); loadProfitSettings(); }
    };
    
    updateDiscountBadge();
    updateMonthSalesStat();
    
    // ØªØ­Ø¯ÙŠØ« badge Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
    let days3 = 3 * 86400000, nowMs2 = now.getTime();
    let expiryBadge2 = document.getElementById("expiryBadge");
    if(expiryBadge2) {
        let expiringCount2 = p.filter(x => x.expiry && !x.expiryDismissed && !x.reminded && !x.isComp && (x.expiry - nowMs2 < days3 && x.expiry - nowMs2 > -2592000000)).length;
        expiryBadge2.textContent = expiringCount2;
        expiryBadge2.style.display = expiringCount2 > 0 ? "inline-flex" : "none";
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙÙ‚Ø· (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ ØµÙØ­Ø©)
    document.querySelectorAll(".main-content > .card:not(.hidden)").forEach(card => {
        let id = card.id;
        if(visMap[id]) visMap[id]();
    });
}

function refreshDiscounts() {
    let list = safeJSON(store.discounts, []);
    let search = document.getElementById("discountSearch").value.toLowerCase();
    
    let filtered = list.filter(item => {
        return ((item.usedCount || 0) < (item.maxUses || 1)) && (!search || item.customer.toLowerCase().includes(search) || item.code.includes(search));
    });

    renderPagination(filtered.length, 'discounts', refreshDiscounts, 'discountsPagination');
    let paginated = filtered.slice((currentPage.discounts - 1) * ITEMS_PER_PAGE, currentPage.discounts * ITEMS_PER_PAGE);
    
    let tbody = document.getElementById("discountsBody");
    let rows = "";
    let now = new Date().getTime();
    let isAdmin = currentUser && currentUser.role === 'admin';
    let isViewer = currentUser && currentUser.role === 'viewer'; 

    paginated.forEach(item => {
        let daysLeft = Math.ceil((item.expiry - now) / 86400000);
        let timeBadge = daysLeft > 0 ? `<span class="badge badge-success">${daysLeft} ÙŠÙˆÙ…</span>` : `<span class="badge badge-danger">Ù…Ù†ØªÙ‡ÙŠ</span>`;
        
        let delBtn = isAdmin ? `<button class="btn btn-danger" style="padding:5px 10px" onclick="deleteSingleDiscount('${item.id}')"><i class="fas fa-trash-alt"></i></button>` : '-';
        let displayCode = isViewer ? '*********' : item.code;
        
        let usageStr = `${item.usedCount || 0}/${item.maxUses || 1}`;
        
        rows += `<tr>
            <td style="font-weight:bold; color:var(--primary); letter-spacing:1px; text-align:center;">${displayCode}</td>
            <td style="text-align:center;">${esc(item.customer)}</td>
            <td style="text-align:center; font-weight:bold;">${item.percentage}%</td>
            <td class="eng-num" style="font-weight:bold; text-align:center;">${usageStr}</td>
            <td style="text-align:center;">${timeBadge}</td>
            <td style="text-align:center;">${delBtn}</td>
        </tr>`;
    });
    tbody.innerHTML = rows || `<tr><td colspan='6' style='text-align:center; padding:20px; color:var(--text-muted)'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø®ØµÙ…</td></tr>`;
}

async function deleteSingleDiscount(id) {
    let ok = await showConfirm("Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ù‡Ø°Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", "Ø­Ø°Ù", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>');
    if(!ok) return;
    
    let dList = safeJSON(store.discounts, []);
    dList = dList.filter(x => x.id !== id);
    store.discounts = JSON.stringify(dList);
    fbSave("discounts", dList);
    
    logAction(`Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø­Ø°Ù ÙƒÙˆØ¯ Ø®ØµÙ… ÙŠØ¯ÙˆÙŠØ§Ù‹`, 'danger');
    refreshDiscounts();
    notify("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯");
}

async function deleteAllDiscounts() {
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·","error");
    let ok = await showConfirm("Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-exclamation-triangle"></i>');
    if(!ok) return;
    
    store.discounts = "[]";
    fbSave("discounts", []);
    logAction("Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…", 'danger');
    currentPage.discounts = 1;
    refreshDiscounts();
    notify("ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯");
}

function refreshExpiring() {
    let p = safeJSON(store.purchases, []);
    let body = document.getElementById("expiringBody"); 
    if(!body) return;
    let now = new Date().getTime(), days3 = 3 * 86400000;
    
    let filtered = p.map((d, i) => ({ d, i })).filter(x => x.d.expiry && !x.d.expiryDismissed && !x.d.isComp && (x.d.expiry - now < days3 && x.d.expiry - now > -2592000000));
    filtered.sort((a, b) => a.d.expiry - b.d.expiry);
    
    renderPagination(filtered.length, 'expiring', refreshExpiring, 'expiringPagination');
    let paginated = filtered.slice((currentPage.expiring - 1) * ITEMS_PER_PAGE, currentPage.expiring * ITEMS_PER_PAGE);
    
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let isViewer = currentUser ? (currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') : true;
    
    let rows = "";
    
    let currentHour = new Date().getHours();
    let greeting = currentHour < 12 ? 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±' : 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±';

    paginated.forEach(x => {
        let item = x.d, daysLeft = Math.ceil((item.expiry - now) / 86400000);
        let status = daysLeft <= 0 ? 'Ù…Ù†ØªÙ‡ÙŠ' : daysLeft + ' ÙŠÙˆÙ…';
        let cleanPhone = (item.phone||'').replace(/\D/g, '');
        
        let expiryPhrase = daysLeft <= 0 ? 'Ù…Ù†ØªÙ‡ÙŠ' : `Ø¨Ø§Ù‚ÙŠ Ø¹Ù„Ù‰ Ø¥Ù†ØªÙ‡Ø§Ø¦Ù‡ ${status}`;
        let waMsg = `${greeting} ${item.customer}\nØ­Ø§Ø¨ÙŠÙ† Ù†Ø°ÙƒØ±Ùƒ Ø§Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ ${item.sub} ${expiryPhrase}\nÙ‡Ù„ Ø¹Ø¬Ø¨ØªÙƒ Ø§Ù„Ø®Ø¯Ù…Ø© Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ¬Ø¯Ø¯ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù…Ø±Ø© ØªØ§Ù†ÙŠØ©ØŸ`;
        
        let wa = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(waMsg)}`;
        
        let btnHTML = isViewer ? '' : `<a href="${wa}" target="_blank" onclick="markAsReminded('${item.id}')" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> ØªØ°ÙƒÙŠØ±</a>`;
        let phoneDisplay = isRestricted ? '----' : esc(item.phone);
        let serviceDisplay = isRestricted ? '----' : `<b>${esc(item.sub)}</b>`;
        rows += `<tr class="${item.reminded?'reminded':''}"><td>${serviceDisplay}</td><td>${esc(item.customer)}</td><td>${phoneDisplay}</td><td>${new Date(item.expiry).toLocaleDateString('ar-EG')}</td><td><span class="badge ${daysLeft<=0?'badge-danger':'badge-warning'}">${status}</span></td><td>${btnHTML}</td></tr>`;
    });
    body.innerHTML = rows || "<tr><td colspan='6' style='text-align:center; padding:30px; color:var(--text-muted)'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</td></tr>";
    
    let nonRemindedCount = filtered.filter(x => !x.d.reminded).length;
    let badge = document.getElementById("expiryBadge");
    if(badge) { badge.textContent = nonRemindedCount; badge.style.display = nonRemindedCount > 0 ? "inline-flex" : "none"; }
}
function markAsReminded(id) { 
    let p = safeJSON(store.purchases, []); 
    let idx = p.findIndex(x => x.id === id);
    if(idx !== -1) {
        let customer = p[idx].customer || 'Ø¹Ù…ÙŠÙ„';
        p[idx].reminded = true; store.purchases = JSON.stringify(p); fbSave("purchases", p); 
        logAction(`Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„: ${customer}`, 'general', { customer: customer, service: p[idx].sub || '' });
        refreshExpiring();  
    }
}
async function deleteExpired() { 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; 
    let ok = await showConfirm("Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©", "Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", "Ø¥Ø®ÙØ§Ø¡", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-eye-slash"></i>');
    if(!ok) return;
    let p = safeJSON(store.purchases, []), now = new Date().getTime(); 
    p.forEach(x => { if(x.expiry && x.expiry < now) x.expiryDismissed = true; }); 
    store.purchases = JSON.stringify(p); fbSave("purchases", p); logAction("Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©", 'danger'); currentPage.expiring = 1; refreshAll();  
}
function refreshWallets(){
    let w=safeJSON(store.wallets, {}), td=0, ts=0;
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let rows="";
    let sortedKeys = Object.keys(w).sort((a,b) => a.localeCompare(b, 'ar'));
    for(let k of sortedKeys){
        let act = w[k].active !== false;
        let balDisplay = isRestricted ? '****' : fix(w[k].bal);
        
        let displayKey = k;
        if(currentUser && currentUser.role === 'viewer') {
            displayKey = k.substring(0,3) + '***********';
        }

        rows+=`<tr><td><b>${esc(displayKey)}</b></td><td><span class="badge ${w[k].cur=='$'?'badge-success':'badge-info'}">${w[k].cur}</span></td><td style="text-align:center; font-weight:800">${balDisplay}</td><td>${act?'<i class="fas fa-check-circle" style="color:var(--success)"></i>':'<i class="fas fa-times-circle" style="color:var(--danger)"></i>'}</td></tr>`;
        if(w[k].cur=="$") td+=w[k].bal; else ts+=w[k].bal;
    }
    document.getElementById("walletList").innerHTML=rows;
    if(!isRestricted) {
        document.getElementById("statDollar").textContent=fix(td)+" $"; document.getElementById("statShekel").textContent=fix(ts)+" â‚ª";
    }
}
function refreshHistory(){
    let p = safeJSON(store.purchases, []);
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let v = document.getElementById("historySearch").value.toLowerCase();
    let fromDate = document.getElementById("historyFromDate") ? document.getElementById("historyFromDate").value : "";
    let toDate = document.getElementById("historyToDate") ? document.getElementById("historyToDate").value : "";
    
    let filtered = p.slice().filter(item => {
        let matchesSearch = !v || (item.customer||'').toLowerCase().includes(v) || (item.sub||'').toLowerCase().includes(v) || (item.phone||'').includes(v);
        let matchesFrom = !fromDate || (item.date && item.date >= fromDate);
        let matchesTo = !toDate || (item.date && item.date <= toDate);
        return matchesSearch && matchesFrom && matchesTo;
    });
    
    renderPagination(filtered.length, 'history', refreshHistory, 'historyPagination');
    let paginated = filtered.slice((currentPage.history - 1) * ITEMS_PER_PAGE, currentPage.history * ITEMS_PER_PAGE);
    
    let rows = "";
    paginated.forEach(item => {
        let phoneD = isRestricted ? '----' : esc(item.phone);
        let subD = isRestricted ? '----' : `<span class="badge badge-info">${esc(item.sub)}</span>`;
        let paidD = isRestricted ? '----' : esc(item.paid);
        let costD = isRestricted ? '----' : esc(item.cost);
        
        let walletD = esc(item.wallet);
        if (currentUser && currentUser.role === 'viewer') {
            walletD = esc((item.wallet || '').substring(0,3)) + '***********';
        } else if (isRestricted) {
            walletD = '----';
        }
        
        let colorStyle = item.isComp ? "color:var(--danger);" : "";
        
        let parsedDur = parseInt(item.duration);
        let durStr = (parsedDur === 0) ? "Ø¨Ø¯ÙˆÙ† Ù…Ø¯Ø©" : (isNaN(parsedDur) ? "-" : parsedDur + " Ø´Ù‡Ø±");
        let durBadge = (parsedDur === 0) ? "badge-success" : "badge-warning";
        
        rows+=`<tr><td>${item.date}</td><td style="${colorStyle}"><b>${esc(item.customer)}</b></td><td style="${colorStyle}">${phoneD}</td><td>${subD}</td><td><span class="badge ${durBadge}">${durStr}</span></td><td style="color:var(--success)">${paidD}</td><td style="color:var(--danger)">${costD}</td><td>${walletD}</td></tr>`;
    });
    document.getElementById("historyBody").innerHTML = rows || `<tr><td colspan='8' style='text-align:center; padding:20px; color:var(--text-muted)'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
}
function filterHistory() { refreshHistory(); }

function refreshInvestment(){
    let i=safeJSON(store.invest, {});
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let aD = isRestricted ? "****" : `${fix(i.ahmad.d)}$ | ${fix(i.ahmad.s)}â‚ª`;
    let mD = isRestricted ? "****" : `${fix(i.mohamed.d)}$ | ${fix(i.mohamed.s)}â‚ª`;
    let sD = isRestricted ? "****" : `${fix(i.store.d)}$ | ${fix(i.store.s)}â‚ª`;
    
    document.getElementById("investBox").innerHTML=`
    <div class="stat-card" style="border-right:5px solid #10b981; flex-direction:column; align-items:flex-start">
        <div style="font-size:14px; color:var(--text-muted)">Ø­ØµØ© Ø£Ø­Ù…Ø¯</div>
        <div style="font-size:20px; font-weight:800">${aD}</div>
    </div>
    <div class="stat-card" style="border-right:5px solid #f59e0b; flex-direction:column; align-items:flex-start">
        <div style="font-size:14px; color:var(--text-muted)">Ø­ØµØ© Ù…Ø­Ù…Ø¯</div>
        <div style="font-size:20px; font-weight:800">${mD}</div>
    </div>
    <div class="stat-card" style="border-right:5px solid #6366f1; flex-direction:column; align-items:flex-start">
        <div style="font-size:14px; color:var(--text-muted)">Ø±Ø£Ø³ Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ¬Ø±</div>
        <div style="font-size:20px; font-weight:800">${sD}</div>
    </div>`;
}
function refreshAnalytics() {
    let invest = safeJSON(store.invest, {}), purchases = safeJSON(store.purchases, []);
    if (myProfitChart) myProfitChart.destroy();
    
    if(currentUser && currentUser.role !== 'viewer') {
        myProfitChart = new Chart(document.getElementById('profitChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Ø£Ø­Ù…Ø¯', 'Ù…Ø­Ù…Ø¯', 'Ø§Ù„Ù…ØªØ¬Ø±'], datasets: [{ data: [invest.ahmad.d*3.5+invest.ahmad.s, invest.mohamed.d*3.5+invest.mohamed.s, invest.store.d*3.5+invest.store.s], backgroundColor: ['#10b981', '#f59e0b', '#6366f1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    
    let months = {}, labels = [], data = [];
    for(let i=5; i>=0; i--){ let d = new Date(); d.setMonth(d.getMonth() - i); let mm = (d.getMonth()+1).toString().padStart(2,'0'); labels.push(mm+'/'+d.getFullYear()); months[labels[labels.length-1]] = 0; }
    purchases.forEach(p => { 
        if(p.date && !p.isComp) {
            let parts = p.date.split('-');
            if(parts.length===3) {
               let k = parts[1]+'/'+parts[0]; 
               if(months[k] !== undefined) months[k]++; 
            }
        }
    });
    labels.forEach(l => data.push(months[l]));
    
    if (mySalesChart) mySalesChart.destroy();
    mySalesChart = new Chart(document.getElementById('salesChart').getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Ù…Ø¨ÙŠØ¹Ø§Øª', data: data, backgroundColor: '#6366f1', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
}
function addGeneralNote(){ 
    let gnTextVal = document.getElementById("gnText").value.trim(); 
    if(!gnTextVal)return; 
    let n=safeJSON(store.generalNotes, []); 
    n.push({id: 'id_'+Date.now(), text:gnTextVal, date:new Date().toLocaleString("ar-EG")}); 
    store.generalNotes = JSON.stringify(n); fbSave("generalNotes", n); 
    document.getElementById("gnText").value=""; 
    logAction("Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©", 'general'); refreshGeneralNotes();  
}
function refreshGeneralNotes(){ 
    let n = safeJSON(store.generalNotes, []); 
    let box = document.getElementById("generalNotesBox");
    if(!box) return; 
    if(currentUser && currentUser.role === 'viewer') { box.innerHTML = ""; return; }
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù€ id Ø§Ù„Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ timestamp)
    let sorted = n.slice().sort((a, b) => (b.id || '').localeCompare(a.id || ''));
    let rows = "";
    sorted.forEach(x => {
        let isViewerPlus = currentUser ? (currentUser.role === 'viewer_plus') : true;
        let delBtn = isViewerPlus ? '' : `<i class="fas fa-trash-alt" onclick="deleteNote('${x.id}')" style="color:var(--danger); cursor:pointer"></i>`;
        rows += `<div class="todo-item" style="border-right-color:var(--primary)"><div><small>${x.date}</small><div>${esc(x.text)}</div></div>${delBtn}</div>`; 
    });
    box.innerHTML = rows;
}
function deleteNote(id){ 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; 
    let n=safeJSON(store.generalNotes, []); 
    n = n.filter(x => x.id !== id); 
    store.generalNotes = JSON.stringify(n); fbSave("generalNotes", n); 
    logAction("Ø­Ø°Ù Ù…Ù„Ø§Ø­Ø¸Ø©", 'danger'); refreshGeneralNotes();  
}
function addTodo(){ 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; 
    let todoInputVal = document.getElementById("todoInput").value.trim(); 
    if(!todoInputVal)return; 
    let l=safeJSON(store.todoList, []); 
    l.push({id:'id_'+Date.now(), text:todoInputVal, date:new Date().toLocaleString("ar-EG")}); 
    store.todoList = JSON.stringify(l); fbSave("todoList", l); 
    document.getElementById("todoInput").value=""; 
    logAction("Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©", 'general'); refreshTodoList();  
}
function refreshTodoList(){ 
    let l=safeJSON(store.todoList, []).slice().sort((a,b)=>(b.id||'').localeCompare(a.id||'')); 
    let rows=""; 
    let canEdit = currentUser ? (currentUser.role === 'admin' || currentUser.role === 'employee') : false;
    l.forEach((x)=>{ 
        let btnHtml = canEdit ? `<button class="btn btn-primary" style="padding:5px 10px; font-size:12px;" onclick="completeTodo('${x.id}')">ØªÙ…Øª</button>` : '';
        rows+=`<div class="todo-item"><div>${esc(x.text)}</div>${btnHtml}</div>`; 
    }); 
    document.getElementById("todoBox").innerHTML=rows;
}
function completeTodo(id){ 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; 
    let l=safeJSON(store.todoList, []); 
    let idx = l.findIndex(x=>x.id===id);
    if(idx!==-1) {
        logAction(`Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø©: ${esc(l[idx].text)}`, 'general'); 
        l.splice(idx,1); 
        store.todoList = JSON.stringify(l); fbSave("todoList", l); 
        refreshTodoList();  
    }
}

async function withdrawPartial(p){ 
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·","error");
    
    let input = document.getElementById(p==='ahmad'?'withdrawAhmad':p==='mohamed'?'withdrawMohamed':'withdrawStore');
    let walletSelect = document.getElementById(p==='ahmad'?'wWalletAhmad':p==='mohamed'?'wWalletMohamed':'wWalletStore');
    
    let amount = +input.value;
    let walletName = walletSelect.value;

    if(!amount) return notify("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº","error");
    if(!walletName) return notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø©","error");

    let reason = await showPrompt("Ø³Ø¨Ø¨ Ø§Ù„Ø³Ø­Ø¨", "Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", "Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø³Ø­Ø¨...", '<i class="fas fa-money-bill-wave"></i>', false, "", true);
    if(!reason) return notify("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡: Ø§Ù„Ø³Ø¨Ø¨ Ù…Ø·Ù„ÙˆØ¨","error");

    let i = safeJSON(store.invest, {});
    let w = safeJSON(store.wallets, {});
    
    let wallet = w[walletName];
    let currency = wallet.cur;
    let shareType = (currency === '$') ? 'd' : 's';

    let currentShare = Number(i[p][shareType].toFixed(2));
    let currentWallet = Number(wallet.bal.toFixed(2));

    if(currentShare < amount) { notify(`Ø±ØµÙŠØ¯ Ø§Ù„Ø­ØµØ© (${currency}) ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ø³Ø­Ø¨`,"error"); return; }
    if(currentWallet < amount) { notify(`Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© (${walletName}) ØºÙŠØ± ÙƒØ§ÙÙŠ.`, "error"); return; }

    let shareBefore = i[p][shareType];
    let walletBefore = wallet.bal;

    i[p][shareType] -= amount; 
    w[walletName].bal -= amount; 

    // â”€â”€â”€ Atomic: Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    store.invest = JSON.stringify(i);
    store.wallets = JSON.stringify(w);
    fbAtomicWalletInvest(
        { [walletName]: -amount },
        { [`${p}.${shareType}`]: -amount },
        w, i
    );

    logAction(`Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† Ø­ØµØ© ${p} Ø¹Ø¨Ø± ${walletName}`, 'financial', {
        type: 'withdraw',
        person: p,
        amount: amount,
        currency: currency,
        walletName: walletName,
        deductedFromWallet: amount,
        reason: reason,
        shareBefore: shareBefore,
        shareAfter: i[p][shareType],
        walletBefore: walletBefore,
        walletAfter: w[walletName].bal
    });

    refreshInvestment(); refreshWallets(); input.value=""; 
     notify("ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
}

function addNewWallet(){ 
    let n=document.getElementById("newWalletName").value.trim();
    let c=document.getElementById("newWalletCurrency").value;
    let w=safeJSON(store.wallets, {}); 
    if(!n||w[n]) return notify("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§Ø³Ù…","error"); 
    w[n]={bal:0, cur:c, active:true}; 
    store.wallets = JSON.stringify(w); fbSave("wallets", w); 
    loadWallets(); refreshWallets(); 
    document.getElementById("newWalletName").value=""; 
    logAction(`Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${n}`, 'financial');  notify("ØªÙ…Øª"); 
}

function fillWalletEditData() {
    let name = document.getElementById("renameWalletSelect").value;
    let w = safeJSON(store.wallets, {});
    let wallet = w[name];
    if(wallet) {
        document.getElementById("renameWalletInput").value = name;
        document.getElementById("renameWalletCur").value = wallet.cur;
        document.getElementById("renameWalletStatus").value = (wallet.active !== false).toString();
    }
}

function updateWalletData(){ 
    let oldName = document.getElementById("renameWalletSelect").value;
    let newName = document.getElementById("renameWalletInput").value.trim();
    let newCur = document.getElementById("renameWalletCur").value;
    let newStatus = document.getElementById("renameWalletStatus").value === "true";
    
    let w = safeJSON(store.wallets, {}); 
    
    if(!oldName) return notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹","error");
    if(!w[oldName]) return notify("Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "error");

    // Ø¥Ø°Ø§ ØªØ±Ùƒ Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±ØºØ§Ù‹ Ù†Ø¨Ù‚ÙŠÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ
    if(!newName) newName = oldName;

    if(newName !== oldName) {
        if(w[newName]) return notify("ÙŠÙˆØ¬Ø¯ Ù…Ø­ÙØ¸Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹", "error");
        w[newName] = w[oldName];
        delete w[oldName];
        
        let p = safeJSON(store.purchases, []); 
        p.forEach(x => { if(x.wallet === oldName) x.wallet = newName; }); 
        store.purchases = JSON.stringify(p); fbSave("purchases", p);
        
        logAction(`ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­ÙØ¸Ø©: ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù…Ù† ${oldName} Ø¥Ù„Ù‰ ${newName}`, 'financial');
    }

    w[newName].cur = newCur;
    w[newName].active = newStatus;
    
    store.wallets = JSON.stringify(w); fbSave("wallets", w); 
    
    loadWallets(); 
    refreshAll(); 
    document.getElementById("renameWalletInput").value = ""; 
    notify("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©"); 
}

function calculateTransfer() {
    let amount = parseFloat(document.getElementById("tfAmount").value) || 0;
    let fee = parseFloat(document.getElementById("tfFee").value) || 0;
    let rate = parseFloat(document.getElementById("tfRate").value) || 1;
    let net = amount - fee;
    
    let from = document.getElementById("tfFromWallet").value;
    let to = document.getElementById("tfToWallet").value;
    let w = safeJSON(store.wallets, {});
    
    let result = 0;
    if(from && to && w[from] && w[to]) {
        let fromCur = w[from].cur;
        let toCur = w[to].cur;
        
        if(fromCur === toCur) {
            result = net; 
        } else if (fromCur === '$' && toCur === 'â‚ª') {
            result = net * rate;
        } else if (fromCur === 'â‚ª' && toCur === '$') {
            result = net / rate;
        }
    }
    
    document.getElementById("tfResult").value = result.toFixed(2);
}

function confirmTransfer() {
    let from = document.getElementById("tfFromWallet").value;
    let to = document.getElementById("tfToWallet").value;
    let amount = parseFloat(document.getElementById("tfAmount").value);
    let fee = parseFloat(document.getElementById("tfFee").value) || 0;
    let rate = parseFloat(document.getElementById("tfRate").value) || 1;
    let result = parseFloat(document.getElementById("tfResult").value);

    if(!amount || !from || !to) return notify("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    if(isNaN(result) || result < 0) return notify("Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ§ÙÙŠ ØºÙŠØ± ØµØ§Ù„Ø­Ø©", "error");
    if(from === to) return notify("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø­ÙØ¸Ø©", "error");

    let w = safeJSON(store.wallets, {});
    if(!w[from] || !w[to]) return notify("Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "error");
    if(w[from].bal < amount) return notify("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ", "error");

    let fromBefore = w[from].bal;
    let toBefore = w[to].bal;
    let fromAfter = fromBefore - amount;
    let toAfter = toBefore + result;
    let fromCur = w[from].cur;
    let toCur = w[to].cur;

    function fmtBal(val, cur) { return fix(val) + ' ' + cur; }

    let body = `<div style="display:grid; gap:10px;">`;

    body += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div style="background:var(--bg-card); border-radius:10px; padding:12px; border:1px solid var(--border-color);">
            <div style="font-weight:800; color:var(--primary); margin-bottom:8px;"><i class="fas fa-arrow-up"></i> Ø§Ù„Ù…ØµØ¯Ø±: ${esc(from)}</div>
            <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed var(--border-color);"><span style="color:var(--text-muted)">Ù‚Ø¨Ù„:</span><span style="font-weight:700">${fmtBal(fromBefore, fromCur)}</span></div>
            <div style="display:flex; justify-content:space-between; padding:4px 0; color:var(--danger);"><span>Ø¨Ø¹Ø¯:</span><span style="font-weight:800">${fmtBal(fromAfter, fromCur)}</span></div>
        </div>
        <div style="background:var(--bg-card); border-radius:10px; padding:12px; border:1px solid var(--border-color);">
            <div style="font-weight:800; color:var(--success); margin-bottom:8px;"><i class="fas fa-arrow-down"></i> Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${esc(to)}</div>
            <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed var(--border-color);"><span style="color:var(--text-muted)">Ù‚Ø¨Ù„:</span><span style="font-weight:700">${fmtBal(toBefore, toCur)}</span></div>
            <div style="display:flex; justify-content:space-between; padding:4px 0; color:var(--success);"><span>Ø¨Ø¹Ø¯:</span><span style="font-weight:800">${fmtBal(toAfter, toCur)}</span></div>
        </div>
    </div>`;

    body += `<div style="padding:10px; background:var(--bg-card); border-radius:10px; border:1px solid var(--border-color); font-size:13px; display:grid; gap:5px;">
        <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-muted)">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙÙ‘Ù„:</span><span style="font-weight:800">${fmtBal(amount, fromCur)}</span></div>
        ${fee > 0 ? `<div style="display:flex; justify-content:space-between;"><span style="color:var(--text-muted)">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</span><span style="font-weight:700; color:var(--danger)">-${fmtBal(fee, fromCur)}</span></div>` : ''}
        ${fromCur !== toCur ? `<div style="display:flex; justify-content:space-between;"><span style="color:var(--text-muted)">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù:</span><span style="font-weight:700">1$ = ${rate}â‚ª</span></div>` : ''}
        <div style="display:flex; justify-content:space-between; padding-top:5px; border-top:1px dashed var(--border-color);"><span style="color:var(--text-muted)">Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„Ù…Ø³ØªÙ„Ù…:</span><span style="font-weight:800; color:var(--success)">${fmtBal(result, toCur)}</span></div>
    </div>`;

    body += `</div>`;

    document.getElementById("transferConfirmBody").innerHTML = body;
    document.getElementById("transferConfirmModal").style.display = "flex";
    document.getElementById("transferConfirmOkBtn").onclick = () => {
        document.getElementById("transferConfirmModal").style.display = "none";
        executeTransfer();
    };
}

function executeTransfer() {
    let from = document.getElementById("tfFromWallet").value;
    let to = document.getElementById("tfToWallet").value;
    let amount = parseFloat(document.getElementById("tfAmount").value);
    let fee = parseFloat(document.getElementById("tfFee").value) || 0;
    let rate = parseFloat(document.getElementById("tfRate").value) || 1;
    let result = parseFloat(document.getElementById("tfResult").value); 

    if(!amount || !from || !to) return notify("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    if(isNaN(result) || result < 0) return notify("Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ§ÙÙŠ ØºÙŠØ± ØµØ§Ù„Ø­Ø©", "error");
    if(from === to) return notify("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø­ÙØ¸Ø©", "error");

    let w = safeJSON(store.wallets, {});
    if(w[from].bal < amount) return notify("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ", "error");

    let fromCur = w[from].cur;
    let toCur = w[to].cur;

    w[from].bal -= amount;
    w[to].bal += result;

    let invest = safeJSON(store.invest, {});
    
    if(fromCur !== toCur) {
        let fromType = (fromCur === '$') ? 'd' : 's';
        let toType = (toCur === '$') ? 'd' : 's';
        invest.store[fromType] -= amount; 
        invest.store[toType] += result;
    } else {
        if(fee > 0) {
            if(fromCur === '$') invest.store.d -= fee;
            else invest.store.s -= fee;
        }
    }

    // â”€â”€â”€ Atomic: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    store.wallets = JSON.stringify(w); 
    store.invest  = JSON.stringify(invest);

    const _wIncsTransfer = {
        [from]: -amount,
        [to]:   +result
    };
    const _iIncsTransfer = {};
    if (fromCur !== toCur) {
        let _fType = (fromCur === '$') ? 'd' : 's';
        let _tType = (toCur   === '$') ? 'd' : 's';
        _iIncsTransfer[`store.${_fType}`] = -amount;
        _iIncsTransfer[`store.${_tType}`] = +result;
    } else if (fee > 0) {
        let _feeType = (fromCur === '$') ? 'd' : 's';
        _iIncsTransfer[`store.${_feeType}`] = -fee;
    }
    fbAtomicWalletInvest(_wIncsTransfer, _iIncsTransfer, w, invest);
    
    logAction(`ØªØ­ÙˆÙŠÙ„ Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}`, 'financial', {
        type: 'transfer', from: from, to: to, amount: amount, fee: fee, feeCur: fromCur, rate: rate, result: result, netAmount: amount - fee, fromCur: fromCur, toCur: toCur
    });

    refreshWallets(); refreshInvestment();  notify("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„");
    document.getElementById("tfAmount").value = "";
    document.getElementById("tfFee").value = "0";
    document.getElementById("tfResult").value = "";
}

async function setWallet(){ 
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
    
    let modWalletVal = document.getElementById("modWallet").value;
    let modAmountVal = parseFloat(document.getElementById("modAmount").value);
    
    if(!modWalletVal) return notify("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹", "error");
    if(isNaN(modAmountVal)) return notify("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯", "error");
    
    let syncType = await showPrompt("Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„", "Ø§Ø®ØªØ± Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", "", '<i class="fas fa-link"></i>', true, '<option value="open">Ù…ÙØªÙˆØ­ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙÙ‚Ø·)</option><option value="closed">Ù…ØºÙ„Ù‚ (Ø±Ø¨Ø· Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø­ØµØ© Ø´Ø±ÙŠÙƒ)</option>');
    if(!syncType) return;
    
    let targetShare = null;
    if(syncType === 'closed') {
        targetShare = await showPrompt("Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­ØµØ© Ù„Ù„Ø±Ø¨Ø·", "Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ§Ø±Ù‚ Ø¹Ù„ÙŠÙ‡Ø§:", "", '<i class="fas fa-chart-pie"></i>', true, '<option value="ahmad">Ø£Ø­Ù…Ø¯</option><option value="mohamed">Ù…Ø­Ù…Ø¯</option><option value="store">Ø§Ù„Ù…ØªØ¬Ø±</option>');
        if(!targetShare) return;
    }

    let reason = await showPrompt("Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±", "Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", "Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹ÙŠÙŠÙ†...", '<i class="fas fa-edit"></i>', false, "", true);
    if(!reason) return;
    
    let w=safeJSON(store.wallets, {}); 
    let before = w[modWalletVal].bal;
    let diff = parseFloat((modAmountVal - before).toFixed(2));
    
    let invest = safeJSON(store.invest, {});
    if(syncType === 'closed') {
        let cur = w[modWalletVal].cur === '$' ? 'd' : 's';
        if (invest[targetShare][cur] + diff < 0) {
            return notify(`Ø±ØµÙŠØ¯ Ø­ØµØ© ${targetShare} ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªØ­Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù‚ØµØ§Ù†!`, "error");
        }
        invest[targetShare][cur] = parseFloat((invest[targetShare][cur] + diff).toFixed(2));
        // invest Ø³ÙŠÙØ­ÙØ¸ Ø¨Ù€ fbAtomicWalletInvest Ø£Ø¯Ù†Ø§Ù‡
    }
    
    w[modWalletVal].bal = modAmountVal; 
    store.wallets = JSON.stringify(w);

    // â”€â”€â”€ Atomic: ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±ØµÙŠØ¯ + ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(syncType === 'closed') {
        const _cur = w[modWalletVal].cur === '$' ? 'd' : 's';
        store.invest = JSON.stringify(invest);
        fbAtomicWalletInvest(
            {},
            { [`${targetShare}.${_cur}`]: diff },
            w, invest
        );
        // Ø­ÙØ¸ Ø§Ù„Ù€ wallet Ø¨Ù€ set (Ù„ÙŠØ³ increment) Ù„Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙØ¹ÙŠÙÙ‘Ù†Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ù…Ø·Ù„Ù‚
        if (isDemoMode) {
            localStorage.setItem('demo_wallets', JSON.stringify(w));
        } else if (fbDocRef) {
            fbDocRef.update({ [`wallets.${modWalletVal}.bal`]: modAmountVal })
                .then(() => { lastServerState['wallets'] = JSON.parse(JSON.stringify(w)); updateSyncStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success"); })
                .catch(e => { console.error("setWallet error:", e); updateSyncStatus("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error"); });
        }
    } else {
        if (isDemoMode) {
            localStorage.setItem('demo_wallets', JSON.stringify(w));
        } else if (fbDocRef) {
            _startSyncTimer();
            fbDocRef.update({ [`wallets.${modWalletVal}.bal`]: modAmountVal })
                .then(() => { clearTimeout(_pendingWritesTimer); lastServerState['wallets'] = JSON.parse(JSON.stringify(w)); updateSyncStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success"); })
                .catch(e => { clearTimeout(_pendingWritesTimer); console.error("setWallet error:", e); updateSyncStatus("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error"); });
        }
    } 
    logAction(`ØªØ¹ÙŠÙŠÙ† Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© ${modWalletVal}`, 'financial', { type: 'manual', wallet: modWalletVal, reason: reason, before: before, after: modAmountVal, diff: diff, syncedShare: targetShare });
    refreshWallets(); refreshInvestment(); notify("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­"); 
}

async function setProfitShare() {
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
    let person = document.getElementById("setSharePerson").value;
    let currency = document.getElementById("setShareCurrency").value;
    let amount = parseFloat(document.getElementById("setShareAmount").value);

    if(isNaN(amount)) return notify("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯", "error");
    
    let syncType = await showPrompt("Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„", "Ø§Ø®ØªØ± Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", "", '<i class="fas fa-link"></i>', true, '<option value="open">Ù…ÙØªÙˆØ­ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØ© ÙÙ‚Ø·)</option><option value="closed">Ù…ØºÙ„Ù‚ (Ø±Ø¨Ø· Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù…Ø­ÙØ¸Ø©)</option>');
    if(!syncType) return;
    
    let targetWallet = null;
    if(syncType === 'closed') {
        let wallets=safeJSON(store.wallets, {});
        let opts = "";
        let expectedCurSymbol = currency === 'd' ? '$' : 'â‚ª';
        Object.keys(wallets).forEach(w => { if(wallets[w].cur === expectedCurSymbol) opts += `<option value="${w}">${w}</option>`; });
        if(!opts) return notify(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸ Ø¨Ø¹Ù…Ù„Ù‡ ${expectedCurSymbol}`, "error");
        
        targetWallet = await showPrompt("Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ø±Ø¨Ø·", `Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨Ø¹Ù…Ù„Ø© ${expectedCurSymbol}):`, "", '<i class="fas fa-wallet"></i>', true, opts);
        if(!targetWallet) return;
    }

    let reason = await showPrompt("Ø³Ø¨Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØ©", "Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¨Ø¨...", '<i class="fas fa-edit"></i>', false, "", true);
    if(!reason) return;

    let invest = safeJSON(store.invest, {});
    let before = invest[person][currency];
    let diff = parseFloat((amount - before).toFixed(2));
    
    let w = safeJSON(store.wallets, {});
    if(syncType === 'closed') {
        if (w[targetWallet].bal + diff < 0) {
            return notify(`Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªØ­Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù‚ØµØ§Ù†!`, "error");
        }
        w[targetWallet].bal = parseFloat((w[targetWallet].bal + diff).toFixed(2));
        // wallet Ø³ÙŠÙØ­ÙØ¸ Ø¨Ù€ fbAtomicWalletInvest Ø£Ø¯Ù†Ø§Ù‡
    }
    
    invest[person][currency] = amount;
    store.invest = JSON.stringify(invest);

    // â”€â”€â”€ Atomic: ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _iPIncs = { [`${person}.${currency}`]: diff };
    if (syncType === 'closed') {
        // Ø§Ù„Ù€ wallet ÙŠÙØ¹Ø¯ÙÙ‘Ù„ Ø£ÙŠØ¶Ø§Ù‹ Ø¨Ù€ increment Ø°Ø±ÙŠ
        const _walletCur = currency === 'd' ? '$' : 'â‚ª';
        const _wPIncs = { [targetWallet]: diff };
        store.wallets = JSON.stringify(w);
        fbAtomicWalletInvest(_wPIncs, _iPIncs, w, invest);
    } else {
        fbAtomicWalletInvest({}, _iPIncs, null, invest);
    }
    logAction(`ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ø­ØµØ© ${person}`, 'financial', { type: 'manual_invest', person: person, currency: currency, reason: reason, before: before, after: amount, diff: diff, syncedWallet: targetWallet });
    refreshInvestment(); refreshWallets(); notify("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­");
}

async function deleteWallet(){ 
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error"); 
    let targetWallet = document.getElementById("renameWalletSelect").value;
    if(!targetWallet) return notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø©", "error");
    
    let w=safeJSON(store.wallets, {}); 
    let wallet = w[targetWallet];
    if(!wallet) return;

    if (wallet.bal > 0) {
        let expectedCurSymbol = wallet.cur === '$' ? 'd' : 's';
        let targetShare = await showPrompt("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…ØµÙØ±", `Ø§Ù„Ù…Ø­ÙØ¸Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${fix(wallet.bal)}${wallet.cur}. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­ØµØ© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø®ØµÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù†Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù:`, "", '<i class="fas fa-chart-pie"></i>', true, '<option value="ahmad">Ø£Ø­Ù…Ø¯</option><option value="mohamed">Ù…Ø­Ù…Ø¯</option><option value="store">Ø§Ù„Ù…ØªØ¬Ø±</option>');
        if(!targetShare) return;

        let invest = safeJSON(store.invest, {});
        if(invest[targetShare][expectedCurSymbol] < wallet.bal) {
            return notify(`Ø±ØµÙŠØ¯ Ø­ØµØ© ${targetShare} ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø®ØµÙ…!`, "error");
        }

        let ok = await showConfirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©", `Ø³ÙŠØªÙ… Ø®ØµÙ… ${fix(wallet.bal)}${wallet.cur} Ù…Ù† Ø­ØµØ© ${targetShare} ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. ØªØ£ÙƒÙŠØ¯ØŸ`, "Ø­Ø°Ù ÙˆØ®ØµÙ…", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>');
        if(!ok) return;

        invest[targetShare][expectedCurSymbol] -= wallet.bal;
        store.invest = JSON.stringify(invest);
        // Atomic: Ø®ØµÙ… Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† Ø­ØµØ© Ø§Ù„Ø´Ø±ÙŠÙƒ
        fbAtomicWalletInvest({}, { [`${targetShare}.${expectedCurSymbol}`]: -wallet.bal }, null, invest);
    } else {
        let ok = await showConfirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©", `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù…Ø­ÙØ¸Ø© "${targetWallet}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`, "Ø­Ø°Ù", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>');
        if(!ok) return;
    }

    delete w[targetWallet]; 
    store.wallets = JSON.stringify(w); fbSave("wallets", w); 
    logAction(`Ø­Ø°Ù Ù…Ø­ÙØ¸Ø© ${targetWallet}`, 'danger'); 
    loadWallets(); refreshWallets(); refreshInvestment(); notify("ØªÙ… Ø§Ù„Ø­Ø°Ù"); 
    document.getElementById("renameWalletInput").value = "";
}

function exportData(){ if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; let exportObj = {}; ["users","wallets","purchases","invest","settings","generalNotes","todoList","activityLog","stock","services","discounts"].forEach(k=>{ if(store[k]) exportObj[k]=store[k]; }); let a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(exportObj)],{type:"application/json"})); a.download=`MegaBackup_${new Date().toLocaleDateString()}.json`; a.click(); logAction("ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", 'general'); }
function importData(){ 
    if(currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·","error");
    let f=document.getElementById("importFile").files[0];
    if(!f) return notify("Ø§Ø®ØªØ± Ù…Ù„Ù","error");
    let r=new FileReader(); 
    r.onload=async (e)=>{ 
        try{ 
            let d=JSON.parse(e.target.result);
            
            let ok = await showConfirm(
                "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©",
                "ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                "Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "Ø¥Ù„ØºØ§Ø¡",
                '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i>'
            );
            if(!ok) return;
            
            const SCALAR_IMPORT = ["wallets","invest","settings","services"];
            const ARRAY_IMPORT  = ["users","purchases","generalNotes","todoList","activityLog","stock","discounts"];
            
            // Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            let scalarUpdates = {};
            SCALAR_IMPORT.forEach(k => {
                if(d[k] !== undefined) {
                    let val = typeof d[k]==='string' ? JSON.parse(d[k]) : d[k];
                    store[k] = JSON.stringify(val);
                    scalarUpdates[k] = val;
                }
            });
            
            if(Object.keys(scalarUpdates).length > 0 && !isDemoMode && fbDocRef) {
                await fbDocRef.set(scalarUpdates, {merge:true});
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª ÙƒÙ€ Subcollections
            for(let k of ARRAY_IMPORT) {
                if(d[k] !== undefined) {
                    let arr = typeof d[k]==='string' ? JSON.parse(d[k]) : d[k];
                    if(!Array.isArray(arr)) continue;
                    // Ø¶Ù…Ø§Ù† IDs
                    arr.forEach(item => { if(!item.id) item.id = genId(); });
                    store[k] = JSON.stringify(arr);
                    if(!isDemoMode && fbDocRef) {
                        // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                        const collRef = fbDocRef.collection(k);
                        for(let i = 0; i < arr.length; i += 400) {
                            const batch = db.batch();
                            arr.slice(i, i+400).forEach(item => batch.set(collRef.doc(item.id), item));
                            await batch.commit();
                        }
                    } else if(isDemoMode) {
                        localStorage.setItem('demo_' + k, JSON.stringify(arr));
                    }
                }
            }
            
            // Ø¶Ù…Ø§Ù† ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© V2 Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
            if(!isDemoMode && fbDocRef) {
                await fbDocRef.set({ _v2migrated: true }, {merge:true});
            }
            
            notify("ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­"); 
            logAction("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", 'danger'); 
            setTimeout(() => location.reload(), 1500);
        }catch(err){ 
            console.error("importData error:", err);
            notify("Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯","error"); 
        } 
    }; 
    r.readAsText(f);
}

async function undoLastPurchase(){ 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return;
    
    let purchases = safeJSON(store.purchases, []);
    if(purchases.length === 0) return notify("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§", "error");
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù‡ÙŠ Ø§Ù„ØªÙŠ canBeUndone = true)
    let undoIdx = purchases.findIndex(x => x.canBeUndone);
    if (undoIdx === -1) {
        return notify("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø³ÙˆÙ‰ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù† Ø£Ø­Ø¯Ø« Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ ÙÙ‚Ø·", "error");
    }
    let lastP = purchases[undoIdx];
    
    let ok = await showConfirm("ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©", "Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ§Ù„Ø­ØµØµ ÙˆÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø¥Ù† ÙˆÙØ¬Ø¯). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ", "Ù†Ø¹Ù…ØŒ ØªØ±Ø§Ø¬Ø¹", "Ù„Ø§ØŒ Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-undo"></i>');
    if(!ok) return;
    
    purchases.splice(undoIdx, 1); // Remove the undoable purchase
    
    // â”€â”€â”€ Atomic: Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙØ¸Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let wallets = safeJSON(store.wallets, {});
    const _undoWalletIncs = {};
    if(lastP.wallet && wallets[lastP.wallet]) { 
        let paidVal = parseFloat(lastP.paid); 
        wallets[lastP.wallet].bal -= paidVal;
        _undoWalletIncs[lastP.wallet] = -paidVal;
    }
    
    // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯
    let undoUpdates = { purchases: purchases };
    store.wallets   = JSON.stringify(wallets);
    store.purchases = JSON.stringify(purchases);

    if (lastP.stockId) {
        let stockList = safeJSON(store.stock, []);
        let sItem = stockList.find(x => x.id === lastP.stockId);
        if (sItem) {
            sItem.soldProfiles = Math.max(0, (sItem.soldProfiles || 0) - 1);
            if (sItem.buyers && sItem.buyers.length > 0) sItem.buyers.pop();
            if (sItem.status === 'sold') { sItem.status = 'active'; delete sItem.soldDate; }
            store.stock = JSON.stringify(stockList);
            undoUpdates.stock = stockList;
        }
    }

    if (lastP.usedDiscountObj) {
        let dList = safeJSON(store.discounts, []);
        let existingIdx = dList.findIndex(x => x.id === lastP.usedDiscountObj.id);
        if (existingIdx !== -1) {
            dList[existingIdx].usedCount = Math.max(0, (dList[existingIdx].usedCount || 1) - 1);
        } else {
            let restoredCoupon = lastP.usedDiscountObj;
            restoredCoupon.usedCount = Math.max(0, (restoredCoupon.maxUses || 1) - 1);
            dList.unshift(restoredCoupon);
        }
        store.discounts = JSON.stringify(dList);
        undoUpdates.discounts = dList;
    }

    fbSaveMultiple(undoUpdates);

    // â”€â”€â”€ Atomic: Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø­ØµØµ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (lastP.investSnapshot) {
        // Ù†Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù€ snapshot Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ù€ invest Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ†Ø¹ÙƒØ³Ù‡
        let currentInvest = safeJSON(store.invest, {});
        store.invest = JSON.stringify(lastP.investSnapshot);
        lastServerState['invest'] = JSON.parse(JSON.stringify(lastP.investSnapshot));
        // Ù†Ø±Ø³Ù„ set ÙƒØ§Ù…Ù„ Ù„Ù„Ù€ invest Ù„Ø£Ù† Ø§Ù„Ù€ snapshot Ù‡Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        fbAtomicWalletInvest(
            _undoWalletIncs,
            {}, // invest Ø³ÙŠÙØ¹Ø§Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù€ fbDocRef.update Ø£Ø¯Ù†Ø§Ù‡
            wallets,
            lastP.investSnapshot
        );
        // Ø­ÙØ¸ invest snapshot Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„ÙŠØ³ increment) â€” Ø¢Ù…Ù† Ù„Ø£Ù†Ù‡ undo ÙˆÙ†Ø§Ø¯Ø±
        if (isDemoMode) {
            localStorage.setItem('demo_invest', JSON.stringify(lastP.investSnapshot));
        } else if (fbDocRef) {
            fbDocRef.update({ invest: lastP.investSnapshot }).catch(e => console.error("undo invest:", e));
        }
    } else {
        fbAtomicWalletInvest(_undoWalletIncs, {}, wallets, wallets);
    }
    
    logAction("ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡", 'financial', { type: 'undo', data: lastP, deducted: lastP.paid });
    
    currentPage.history = 1;
    loadPurchaseStock();
    refreshAll();  notify("ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"); 
}

async function clearHistory() {
    if(!currentUser || currentUser.role !== 'admin') return notify("Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·", "error");
    let res = await showConfirm("Ù…Ø³Ø­ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ø°Ø§ Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø£Ùˆ Ø§Ù„Ø­ØµØµ.", "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>', "Ù…Ø³Ø­ Ø£Ù‚Ø¯Ù… 50 Ø³Ø¬Ù„");
    if(!res) return;
    let purchases = safeJSON(store.purchases, []);
    if(res === 'third') {
        // Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù‡Ùˆ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ© (Ù…Ø±ØªØ¨Ø© Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        let toRemoveCount = Math.min(ITEMS_PER_PAGE, purchases.length);
        purchases.splice(purchases.length - toRemoveCount, toRemoveCount);
        logAction(`Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø³Ø­ Ø£Ù‚Ø¯Ù… ${toRemoveCount} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ`, 'danger');
    } else {
        purchases = [];
        logAction("Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ", 'danger');
    }
    store.purchases = JSON.stringify(purchases); fbSave("purchases", purchases);
    currentPage.history = 1;
    refreshAll(); notify("ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­");
}

function closeEditUserModal(e) { if(e === 'force' || e.target.id === 'editUserModal') document.getElementById("editUserModal").classList.add("hidden"); }

function openEditUserModal(id) {
    let users = safeJSON(store.users, []), u = users.find(x => x.id === id);
    if(!u) return;
    document.getElementById("editUserId").value = u.id;
    document.getElementById("editUserName").value = u.username;
    document.getElementById("editUserPassInput").value = "";
    document.getElementById("editUserRoleSelect").value = u.role;
    document.getElementById("editUserModal").classList.remove("hidden");
}

async function saveUserEdit() {
    let id = document.getElementById("editUserId").value;
    let newPass = document.getElementById("editUserPassInput").value.trim();
    let newRole = document.getElementById("editUserRoleSelect").value;
    let users = safeJSON(store.users, []);
    let index = users.findIndex(x => x.id === id);
    if(index === -1) return;
    
    if(newPass) users[index].password = newPass;
    if(users[index].username === currentUser.username && newRole !== 'admin') {
        let ok = await showConfirm("ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØªÙƒ", "Ø³ØªÙ‚Ù„Ù„ ØµÙ„Ø§Ø­ÙŠØªÙƒ Ù…Ù† Ø£Ø¯Ù…Ù†. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ", "Ù†Ø¹Ù…", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-exclamation-triangle"></i>');
        if(!ok) return;
    }
    let oldRole = users[index].role;
    users[index].role = newRole;
    store.users = JSON.stringify(users); fbSave("users", users);
    let changeDesc = [];
    if(newPass) changeDesc.push("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    if(oldRole !== newRole) changeDesc.push(`Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù† ${oldRole} Ø¥Ù„Ù‰ ${newRole}`);
    logAction(`ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${users[index].username}${changeDesc.length ? ' (' + changeDesc.join('ØŒ ') + ')' : ''}`, 'danger');
    document.getElementById("editUserModal").classList.add("hidden");
    renderUsersTable();  notify("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
}

function closeStockModal(e) { if(e === 'force' || e.target.id === 'stockModal') document.getElementById("stockModal").classList.add("hidden"); }

// --- MODIFIED STOCK FUNCTIONS ---

function openAddStockModal() {
    loadServices();
    loadWallets();
    
    document.getElementById("stockModalTitle").innerHTML = '<i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†';
    document.getElementById("stockIndexId").value = "new";
    
    document.getElementById("stService").value = "";
    document.getElementById("stCost").value = "";
    document.getElementById("stProfiles").value = "1";
    document.getElementById("stVendor").value = "";
    ["stEmail","stPass","stNotes"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("stDuration").value = "1";
    
    document.getElementById("stockPurchaseInputs").style.display = "block";
    document.getElementById("btnSaveStock").classList.remove("hidden");
    document.getElementById("btnUpdateNote").classList.add("hidden");
    
    let inputs = document.querySelectorAll("#stockModal input, #stockModal select, #stockModal textarea");
    inputs.forEach(inp => inp.disabled = false);

    document.getElementById("stockModal").classList.remove("hidden");
}

function verifyStockAdd() {
    let stService = document.getElementById("stService").value;
    let stCost = parseFloat(document.getElementById("stCost").value);
    let stWallet = document.getElementById("stWallet").value;

    if(!stService) return notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©", "error");
    if(isNaN(stCost) || stCost < 0) return notify("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "error");
    if(!stWallet) return notify("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¯ÙØ¹", "error");
    
    let wallets = safeJSON(store.wallets, {});
    let w = wallets[stWallet];
    
    if(w.bal < stCost) return notify("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± ÙƒØ§ÙÙŠ", "error");
    
    let wAfter = w.bal - stCost;
    let cleanName = stService + ((document.getElementById("stProfiles").value > 1) ? " Shared" : "");
    
    document.getElementById("stockConfirmBody").innerHTML = `
        <div style="display:grid; gap:8px;">
            <div><i class="fas fa-tag"></i> <b>Ø§Ù„Ø®Ø¯Ù…Ø©:</b> ${esc(cleanName)}</div>
            <div><i class="fas fa-wallet"></i> <b>Ø§Ù„Ù…Ø­ÙØ¸Ø©:</b> ${esc(stWallet)}</div>
            <hr style="margin:5px 0; border-top:1px dashed var(--border-color)">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                <span style="font-weight:bold">${fix(w.bal)} ${w.cur}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; color:var(--danger)">
                <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø®ØµÙ…Ù‡:</span>
                <span style="font-weight:bold">-${fix(stCost)} ${w.cur}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; color:var(--success); border-top:1px solid var(--border-color); padding-top:5px; margin-top:5px;">
                <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span>
                <span style="font-weight:bold">${fix(wAfter)} ${w.cur}</span>
            </div>
        </div>
    `;
    
    document.getElementById("stockConfirmModal").style.display = "flex";
    document.getElementById("stockConfirmOkBtn").onclick = () => {
        document.getElementById("stockConfirmModal").style.display = "none";
        executeStockAdd(stService, stCost, stWallet, wallets);
    };
}

function executeStockAdd(stService, stCost, stWallet, wallets) {
    let stProfiles = parseInt(document.getElementById("stProfiles").value) || 1;
    let w = wallets[stWallet];
    let wBefore = w.bal;
    
    w.bal -= stCost;
    
    let invest = safeJSON(store.invest, {});
    let shareType = (w.cur === '$') ? 'd' : 's';
    invest.store[shareType] -= stCost;
    
    let baseName = stService + (stProfiles > 1 ? " Shared" : "");
    let stock = safeJSON(store.stock, []);
    let activeStock = stock.filter(x => x.status === 'active');
    let finalName = baseName;
    let counter = 2;
    while(activeStock.some(x => (x.displayName || x.service) === finalName)) {
        finalName = baseName + counter;
        counter++;
    }

    let nd = new Date();
    let nmm = (nd.getMonth()+1).toString().padStart(2,'0');
    let ndd = nd.getDate().toString().padStart(2,'0');

    let s = {
        id: 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2,5),
        service: stService,
        displayName: finalName,
        totalProfiles: stProfiles,
        soldProfiles: 0,
        vendor: document.getElementById("stVendor").value,
        duration: document.getElementById("stDuration").value,
        email: document.getElementById("stEmail").value.trim(),
        pass: document.getElementById("stPass").value,
        notes: document.getElementById("stNotes").value,
        buyers: [],
        status: 'active',
        date: `${nd.getFullYear()}-${nmm}-${ndd}`,
        timestamp: nd.getTime(),
        cost: stCost,           
        costCurrency: w.cur,    
        sourceWallet: stWallet  
    };
    
    stock.unshift(s);
    
    store.stock = JSON.stringify(stock); fbSave("stock", stock);

    // â”€â”€â”€ Atomic: Ø®ØµÙ… Ø§Ù„ØªÙƒÙ„ÙØ© Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ­ØµØ© Ø§Ù„Ù…ØªØ¬Ø± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    store.wallets = JSON.stringify(wallets);
    store.invest  = JSON.stringify(invest);
    fbAtomicWalletInvest(
        { [stWallet]: -stCost },
        { [`store.${shareType}`]: -stCost },
        wallets, invest
    );
    
    logAction(`Ø´Ø±Ø§Ø¡ Ù…Ø®Ø²ÙˆÙ† Ø¬Ø¯ÙŠØ¯: ${s.displayName}`, 'financial', {
        type: 'stock_add',
        item: s.displayName,
        cost: stCost,
        currency: w.cur,
        wallet: stWallet,
        wBefore: wBefore,
        wAfter: w.bal
    });
    
    document.getElementById("stockModal").classList.add("hidden");
    currentPage.stock = 1;
    loadPurchaseStock();
    refreshAll();
    notify("ØªÙ… Ø´Ø±Ø§Ø¡ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­");
}

function updateStockNote() {
    let id = document.getElementById("stockIndexId").value;
    if (id === 'new') return;
    
    let stock = safeJSON(store.stock, []);
    let index = stock.findIndex(x => x.id === id);
    if(index === -1) return;

    stock[index].notes = document.getElementById("stNotes").value;
    
    store.stock = JSON.stringify(stock); fbSave("stock", stock);
    logAction(`ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${stock[index].displayName || stock[index].service}`, 'general');
    
    document.getElementById("stockModal").classList.add("hidden");
    refreshStock();
    notify("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª");
}

function switchStockTab(tab, btn) {
    currentStockTab = tab;
    document.querySelectorAll('#stock .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    if(tab === 'sold' && currentUser.role === 'admin') {
        document.getElementById('btnDeleteAllSold').classList.remove('hidden');
    } else {
        document.getElementById('btnDeleteAllSold').classList.add('hidden');
    }
    
    currentPage.stock = 1;
    refreshStock();
}

async function deleteAllSoldStock() {
    let res = await showConfirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ø§Ø¹", "Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ.", "Ø­Ø°Ù Ø§Ù„ÙƒÙ„", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>', "Ù…Ø³Ø­ Ø£Ù‚Ø¯Ù… ØµÙØ­Ø© Ù…Ø¨Ø§Ø¹Ø©");
    if(!res) return;
    
    let stock = safeJSON(store.stock, []);
    if(res === 'third') {
        let soldItems = stock.filter(s => s.status === 'sold');
        soldItems.sort((a, b) => a.timestamp - b.timestamp); 
        let toRemove = soldItems.slice(0, ITEMS_PER_PAGE).map(s => s.id);
        stock = stock.filter(s => !toRemove.includes(s.id));
        logAction("Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø­Ø°Ù Ø£Ù‚Ø¯Ù… 50 Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¨Ø§Ø¹", 'danger');
    } else {
        stock = stock.filter(s => s.status !== 'sold');
        logAction("Ù‚Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©", 'danger');
    }
    
    store.stock = JSON.stringify(stock); fbSave("stock", stock);
    currentPage.stock = 1;
    refreshStock();  notify("ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­");
}

async function deleteActiveStock(id) {
    let ok = await showConfirm("Ø­Ø°Ù Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ", "Ø­Ø°Ù", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>');
    if(!ok) return;
    
    let stock = safeJSON(store.stock, []);
    stock = stock.filter(x => x.id !== id);
    store.stock = JSON.stringify(stock); fbSave("stock", stock);
    logAction("Ø­Ø°Ù Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­", 'danger');
    refreshStock(); loadPurchaseStock(); notify("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
}

async function moveToSold(id) {
    let ok = await showConfirm("Ù†Ù‚Ù„ Ù„Ù„Ù…Ø¨Ø§Ø¹", "Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡ ÙˆØªÙ… Ø¨ÙŠØ¹ Ø¬Ø²Ø¡ Ù…Ù†Ù‡. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„Ù‡ Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø¨Ø§Ø¹ Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ", "Ù†Ù‚Ù„ Ù„Ù„Ø£Ø±Ø´ÙŠÙ", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-exchange-alt"></i>');
    if(!ok) return;
    
    let stock = safeJSON(store.stock, []);
    let idx = stock.findIndex(x => x.id === id);
    if(idx !== -1) {
        stock[idx].status = 'sold';
        let nd = new Date();
        let nmm = (nd.getMonth()+1).toString().padStart(2,'0');
        let ndd = nd.getDate().toString().padStart(2,'0');
        stock[idx].soldDate = `${nd.getFullYear()}-${nmm}-${ndd}`;
        store.stock = JSON.stringify(stock); fbSave("stock", stock);
        logAction("Ù†Ù‚Ù„ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ Ø¬Ø²Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ", 'danger');
        refreshStock(); loadPurchaseStock(); notify("ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­");
    }
}

function refreshStock() {
    let stock = safeJSON(store.stock, []);
    let tbody = document.getElementById("stockBody"); 
    let thead = document.getElementById("stockHead");
    if(!tbody || !thead) return;

    let isAdmin = currentUser && currentUser.role === 'admin';
    let canControl = isAdmin; 

    let searchTerm = document.getElementById("stockSearch").value.toLowerCase();
    
    let filtered = stock.filter(item => {
        let matchesTab = (currentStockTab === 'active') ? (item.status !== 'sold') : (item.status === 'sold');
        let matchesSearch = (item.displayName||item.service||'').toLowerCase().includes(searchTerm) || 
                            (item.email||'').toLowerCase().includes(searchTerm) ||
                            (item.vendor||'').toLowerCase().includes(searchTerm) ||
                            (item.buyers && item.buyers.some(b => b.toLowerCase().includes(searchTerm)));
        return matchesTab && matchesSearch;
    });

    filtered.sort((a, b) => b.timestamp - a.timestamp);

    renderPagination(filtered.length, 'stock', refreshStock, 'stockPagination');
    let paginated = filtered.slice((currentPage.stock - 1) * ITEMS_PER_PAGE, currentPage.stock * ITEMS_PER_PAGE);

    let headerHTML = "";
    if(currentStockTab === 'active') {
        headerHTML = `<tr>
            <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
            <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
            <th>Ø§Ù„Ø¨Ø§Ø¦Ø¹</th>
            <th>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
            ${canControl ? '<th>ØªØ­ÙƒÙ…</th>' : ''}
        </tr>`;
    } else {
        let delTh = isAdmin ? '<th>Ø­Ø°Ù</th>' : '';
        headerHTML = `<tr>
            <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
            <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
            <th>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
            ${delTh}
        </tr>`;
    }
    thead.innerHTML = headerHTML;

    let rows = "";
    paginated.forEach((item) => {
        let profStr = `${item.soldProfiles || 0}/${item.totalProfiles || 1}`;
        let timeBadge = "";
        let isExpired = false;
        
        let parsedDuration = parseInt(item.duration);
        if (parsedDuration === 0) {
            timeBadge = `<span class="badge badge-success">Ø¨Ø¯ÙˆÙ† Ù…Ø¯Ø©</span>`;
        } else {
            let purchaseDate = new Date(item.timestamp);
            let expiryDate = new Date(purchaseDate);
            expiryDate.setMonth(expiryDate.getMonth() + parsedDuration);
            if(expiryDate.getDate() !== purchaseDate.getDate()) expiryDate.setDate(0);
            
            let daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
            if (daysLeft <= 0) {
                isExpired = true;
                timeBadge = `<span class="badge badge-danger">Ù…Ù†ØªÙ‡ÙŠ</span>`;
            } else {
                timeBadge = `<span class="badge badge-warning">${daysLeft} ÙŠÙˆÙ…</span>`;
            }
        }

        if(currentStockTab === 'active') {
            let detailsBtn = `<button class="btn btn-primary" style="padding:5px 10px" onclick="editStock('${item.id}')"><i class="fas fa-eye"></i></button>`;
            let actionBtn = "";
            if(canControl) {
                if(isExpired) {
                    if((item.soldProfiles || 0) > 0) {
                        actionBtn = `<td><button class="btn btn-warning" style="padding:5px 10px;" onclick="moveToSold('${item.id}')"><i class="fas fa-exchange-alt"></i> Ù†Ù‚Ù„</button></td>`;
                    } else {
                        actionBtn = `<td><button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteActiveStock('${item.id}')"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button></td>`;
                    }
                } else {
                    actionBtn = `<td><button class="btn" style="padding:5px 10px; background:var(--success); color:#fff" onclick="sellStock('${item.id}')"><i class="fas fa-check"></i> Ø¨ÙŠØ¹</button></td>`;
                }
            }
            rows += `<tr>
                <td><span class="badge badge-info">${esc(item.displayName || item.service)}</span></td>
                <td class="wide-col" title="${esc(item.email)}">${esc(item.email)}</td>
                <td>${esc(item.vendor) || '-'}</td>
                <td class="eng-num" style="font-weight:bold;">${profStr}</td>
                <td class="eng-num">${timeBadge}</td>
                <td>${detailsBtn}</td>
                ${actionBtn}
            </tr>`;
        } else {
            let viewBtn = `<button class="btn btn-primary" style="padding:5px 10px" onclick="viewSoldDetails('${item.id}')"><i class="fas fa-eye"></i></button>`;
            let delCell = isAdmin ? `<td><button class="btn btn-danger" style="padding:5px 10px" onclick="deleteSoldStock('${item.id}')"><i class="fas fa-trash-alt"></i></button></td>` : '';
            
            rows += `<tr>
                <td><span class="badge badge-info">${esc(item.displayName || item.service)}</span></td>
                <td class="wide-col" title="${esc(item.email)}">${esc(item.email)}</td>
                <td class="eng-num" style="font-weight:bold;">${profStr}</td>
                <td class="eng-num">${item.soldDate || '-'}</td>
                <td class="eng-num">${timeBadge}</td>
                <td>${viewBtn}</td>
                ${delCell}
            </tr>`;
        }
    });
    let colSpan = currentStockTab === 'active' ? (canControl ? 7 : 6) : (isAdmin ? 7 : 6);
    tbody.innerHTML = rows || `<tr><td colspan='${colSpan}' style='text-align:center; padding:20px; color:var(--text-muted)'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
}

function filterStock() {
    refreshStock();
}

function editStock(id) {
    let stock = safeJSON(store.stock, []);
    let item = stock.find(x => x.id === id);
    if(!item) return;
    
    let isAdmin = currentUser.role === 'admin';

    loadServices();
    document.getElementById("stockModalTitle").innerHTML = isAdmin ? '<i class="fas fa-edit"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' : '<i class="fas fa-eye"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
    document.getElementById("stockIndexId").value = item.id;
    
    document.getElementById("stockPurchaseInputs").style.display = "none";
    document.getElementById("btnSaveStock").classList.add("hidden");
    document.getElementById("btnUpdateNote").classList.remove("hidden");
    
    let sel = document.getElementById("stService");
    sel.value = item.service;
    if(sel.value !== item.service) { 
         let o = document.createElement("option"); o.value=item.service; o.text=item.service; sel.appendChild(o);
         sel.value = item.service;
    }
    document.getElementById("stProfiles").value = item.totalProfiles || 1;
    document.getElementById("stVendor").value = item.vendor || "";
    document.getElementById("stDuration").value = item.duration;
    document.getElementById("stEmail").value = item.email;
    document.getElementById("stPass").value = item.pass;
    document.getElementById("stNotes").value = item.notes;

    let inputs = document.querySelectorAll("#stockModal input, #stockModal select");
    inputs.forEach(inp => inp.disabled = true);
    document.getElementById("stNotes").disabled = false;

    document.getElementById("stockModal").classList.remove("hidden");
}

function viewSoldDetails(id) {
    let stock = safeJSON(store.stock, []);
    let item = stock.find(x => x.id === id);
    if(!item) return;
    
    let body = document.getElementById("modalBody");
    body.innerHTML = "";
    
    body.innerHTML += row("Ø§Ù„Ø®Ø¯Ù…Ø©", esc(item.displayName || item.service));
    body.innerHTML += row("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", esc(item.email));
    body.innerHTML += row("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", esc(item.pass));
    body.innerHTML += row("Ø§Ù„Ø¨Ø§Ø¦Ø¹", esc(item.vendor) || "-");
    body.innerHTML += row("Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª", `${item.soldProfiles || 0} / ${item.totalProfiles || 1}`);
    body.innerHTML += row("ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡", (item.cost || 0) + " " + (item.costCurrency || ''));
    body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
    body.innerHTML += row("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹", item.soldDate);
    
    let buyersHtml = "";
    if(item.buyers && item.buyers.length > 0) {
        buyersHtml = item.buyers.map((b, idx) => `<div style="padding:8px 0; border-bottom:1px solid var(--border-color);">${idx+1}. ${esc(b)}</div>`).join('');
    } else {
        buyersHtml = "Ù…Ø¨Ø§Ø´Ø± (ÙŠØ¯ÙˆÙŠ)";
    }
    
    body.innerHTML += `<div class="detail-row" style="flex-direction:column; align-items:flex-start;">
        <span class="detail-label" style="margin-bottom:8px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ†):</span>
        <div style="background:var(--bg-input); width:100%; padding:10px; border-radius:8px; font-weight:bold; color:var(--primary);">${buyersHtml}</div>
    </div>`;

    body.innerHTML += `<div style="margin-top:10px; background:var(--bg-input); padding:10px; border-radius:8px; font-size:13px;"><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b><br>${esc(item.notes)||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>`;
    
    document.getElementById("detailsModal").classList.remove("hidden");
}

async function deleteSoldStock(id) {
    let ok = await showConfirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.", "Ø­Ø°Ù", "Ø¥Ù„ØºØ§Ø¡", '<i class="fas fa-trash-alt"></i>');
    if(!ok) return;
    
    let stock = safeJSON(store.stock, []);
    stock = stock.filter(x => x.id !== id);
    store.stock = JSON.stringify(stock); fbSave("stock", stock);
    logAction("Ø­Ø°Ù Ø³Ø¬Ù„ Ù…Ø¨Ø§Ø¹ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", 'danger');
    refreshStock();  notify("ØªÙ… Ø§Ù„Ø­Ø°Ù");
}

async function sellStock(id) {
    let stock = safeJSON(store.stock, []);
    let index = stock.findIndex(x => x.id === id);
    if(index === -1) return;
    let item = stock[index];
    
    let customerNum = await showPrompt("Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ ÙŠØ¯ÙˆÙŠØ§Ù‹", `ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ¹ Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${esc(item.displayName || item.service)}`, "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", '<i class="fas fa-shopping-cart"></i>');
    if (customerNum === null) return; 

    let buyerInfo = customerNum ? `ØªØ³Ø¬ÙŠÙ„ ÙŠØ¯ÙˆÙŠ: ${customerNum}` : "Ù…Ø¨Ø§Ø´Ø± (ÙŠØ¯ÙˆÙŠ)";
    if(!item.buyers) item.buyers = [];
    item.buyers.push(buyerInfo);

    item.soldProfiles = item.totalProfiles || 1;
    item.status = 'sold';
    
    let nd = new Date();
    let nmm = (nd.getMonth()+1).toString().padStart(2,'0');
    let ndd = nd.getDate().toString().padStart(2,'0');
    item.soldDate = `${nd.getFullYear()}-${nmm}-${ndd}`;
    
    stock[index] = item;
    store.stock = JSON.stringify(stock); fbSave("stock", stock);
    
    logAction(`ØªÙ… Ø¨ÙŠØ¹ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹: ${item.displayName || item.service}`, 'financial');
    refreshStock(); loadPurchaseStock();  notify("ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø¹");
}

function renderServicesSettings() {
    let list = safeJSON(store.services, []);
    let div = document.getElementById("servicesList");
    let isAdmin = currentUser.role === 'admin';
    div.innerHTML = "";
    
    let addArea = document.querySelector("#sec-manage-services .inner-box > div:first-child");
    if(addArea) addArea.style.display = isAdmin ? "flex" : "none";

    list.forEach((s, idx) => {
        let delIcon = isAdmin ? `<i class="fas fa-times" style="margin-right:8px; cursor:pointer; color:red" onclick="deleteService(${idx})"></i>` : '';
        div.innerHTML += `<span class="badge badge-info" style="padding:10px; font-size:14px;">${esc(s)} ${delIcon}</span>`;
    });
}
function addService() {
    let inp = document.getElementById("newServiceName");
    let val = inp.value.trim();
    if(!val) return notify("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©", "error");
    let list = safeJSON(store.services, []);
    if(list.includes(val)) return notify("Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹", "error");
    list.push(val);
    store.services = JSON.stringify(list); fbSave("services", list);
    logAction(`Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${val}`, 'general');
    renderServicesSettings();
    loadServices();
    loadPurchaseStock();
    notify("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­");
    inp.value = "";
}
function deleteService(idx) {
    let list = safeJSON(store.services, []);
    let removed = list.splice(idx, 1);
    store.services = JSON.stringify(list); fbSave("services", list);
    logAction(`Ø­Ø°Ù Ø®Ø¯Ù…Ø©: ${removed[0] || ''}`, 'danger');
    renderServicesSettings();
    loadServices();
    loadPurchaseStock();
    notify("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Flatpickr â€” ØªÙ‚ÙˆÙŠÙ… Ù…Ø®ØµØµ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fpFrom = null, fpTo = null;

function initDatePickers() {
    const commonCfg = {
        dateFormat: "Y-m-d",
        locale: {
            firstDayOfWeek: 0,
            weekdays: { shorthand: ['Ø£Ø­','Ø§Ø«','Ø«Ù„','Ø£Ø±','Ø®Ù…','Ø¬Ù…','Ø³Ø¨'], longhand: ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'] },
            months: { shorthand: ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'], longhand: ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'] }
        },
        disableMobile: true,
        onChange: () => { currentPage.history = 1; filterHistory(); }
    };
    if (document.getElementById("historyFromDate")) fpFrom = flatpickr("#historyFromDate", commonCfg);
    if (document.getElementById("historyToDate"))   fpTo   = flatpickr("#historyToDate",   commonCfg);
}

function clearDateFilter() {
    if (fpFrom) fpFrom.clear();
    if (fpTo)   fpTo.clear();
    currentPage.history = 1;
    filterHistory();
}

// --- Ù†Ø³Ø® Ù‚ÙŠÙ…Ø© Ø­Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© ---
function copyField(fieldId, btn) {
    let input = document.getElementById(fieldId);
    if (!input || !input.value) return notify("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù†Ø³Ø®", "error");
    navigator.clipboard.writeText(input.value).then(() => {
        let origHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = 'var(--success)';
        setTimeout(() => { btn.innerHTML = origHTML; btn.style.background = ''; }, 1500);
    }).catch(() => {
        // Fallback for older browsers
        input.disabled = false;
        input.select();
        document.execCommand('copy');
        input.disabled = true;
        let origHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = 'var(--success)';
        setTimeout(() => { btn.innerHTML = origHTML; btn.style.background = ''; }, 1500);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù…ÙŠØ²Ø© 2: ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø±
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDiscountBadge() {
    let badge = document.getElementById("discountBadge");
    if (!badge) return;
    let list = safeJSON(store.discounts, []);
    let now = new Date().getTime();
    let activeCount = list.filter(d => (d.usedCount || 0) < (d.maxUses || 1) && now < d.expiry).length;
    if (activeCount > 0) { badge.textContent = activeCount; badge.style.display = "inline"; }
    else { badge.style.display = "none"; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù…ÙŠØ²Ø© 3: ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¡ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateMonthSalesStat() {
    let p = safeJSON(store.purchases, []);
    let now = new Date();
    let mm = (now.getMonth() + 1).toString().padStart(2, '0');
    let yyyy = now.getFullYear().toString();
    let monthStr = `${yyyy}-${mm}`;
    let count = p.filter(x => x.date && x.date.startsWith(monthStr) && !x.isComp).length;
    let el = document.getElementById("statMonthSales");
    if (el) el.textContent = count;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù…ÙŠØ²Ø© 4: ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙƒÙ€ CSV
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportHistoryCSV() {
    if (currentUser && (currentUser.role === 'viewer' || currentUser.role === 'viewer_plus')) return notify("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©", "error");
    let p = safeJSON(store.purchases, []);
    let v = document.getElementById("historySearch").value.toLowerCase();
    let fromDate = document.getElementById("historyFromDate") ? document.getElementById("historyFromDate").value : "";
    let toDate = document.getElementById("historyToDate") ? document.getElementById("historyToDate").value : "";

    let filtered = p.slice().filter(item => {
        let matchesSearch = !v || (item.customer||'').toLowerCase().includes(v) || (item.sub||'').toLowerCase().includes(v);
        let matchesFrom = !fromDate || (item.date && item.date >= fromDate);
        let matchesTo = !toDate || (item.date && item.date <= toDate);
        return matchesSearch && matchesFrom && matchesTo;
    });

    if (filtered.length === 0) return notify("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±", "error");

    const headers = ["Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„Ø¹Ù…ÙŠÙ„", "Ø§Ù„Ø¬ÙˆØ§Ù„", "Ø§Ù„Ø®Ø¯Ù…Ø©", "Ø§Ù„Ù…Ø¯Ø©", "Ø§Ù„Ù…Ø¯ÙÙˆØ¹", "Ø§Ù„ØªÙƒÙ„ÙØ©", "Ø§Ù„Ù…Ø­ÙØ¸Ø©"];
    const rows = filtered.map(item => [
        item.date || '',
        item.customer || '',
        item.phone || '',
        item.sub || '',
        parseInt(item.duration) === 0 ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø¯Ø©' : (item.duration || '') + ' Ø´Ù‡Ø±',
        item.paid || '',
        item.cost || '',
        item.wallet || ''
    ]);

    let csvContent = '\uFEFF' + [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MegaStore_Archive_${new Date().toLocaleDateString('en-CA')}.csv`;
    a.click();
    logAction("ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙƒÙ€ CSV", 'general', { search: v || null, from: fromDate || null, to: toDate || null, count: filtered.length });
    notify("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù…Ø¤Ù‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© (30 Ø¯Ù‚ÙŠÙ‚Ø©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _sessionTimer = null;
const SESSION_MS = 30 * 60 * 1000;

function resetSessionTimer() {
    if (!currentUser) return;
    clearTimeout(_sessionTimer);
    _sessionTimer = setTimeout(async () => {
        let ok = await showConfirm(
            "Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©",
            "Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ø£ÙŠ Ù†Ø´Ø§Ø· Ù…Ù†Ø° 30 Ø¯Ù‚ÙŠÙ‚Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ",
            "Ø§Ù„Ø¨Ù‚Ø§Ø¡", "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
            '<i class="fas fa-clock"></i>'
        );
        if (ok) {
            resetSessionTimer();
        } else {
            logout();
        }
    }, SESSION_MS);
}

['mousemove','keydown','click','touchstart'].forEach(ev =>
    document.addEventListener(ev, () => { if(currentUser) resetSessionTimer(); }, { passive: true })
);

window.onload = init;
</script>
</body>
</html>

