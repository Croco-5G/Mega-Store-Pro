<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mega Store Pro | Queue Sync</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%236366f1' d='M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z'/%3E%3C/svg%3E">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f8fafc;
            --bg-sidebar: #0f172a;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --stat-card-border: rgba(255,255,255,0.8);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --yellow-bg: #fefce8;
            --yellow-border: #fde047;
            --yellow-text: #854d0e;
            --yellow-item-bg: #fffbeb;
            --yellow-item-border: #eab308;
            --yellow-item-text: #713f12;
            --yellow-btn-bg: #eab308;
            --yellow-btn-hover: #ca8a04;
        }
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --bg-sidebar: #020617;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --stat-card-border: #334155;
            --card-shadow: none;
            --yellow-bg: rgba(234, 179, 8, 0.1);
            --yellow-border: rgba(234, 179, 8, 0.3);
            --yellow-text: #fde047;
            --yellow-item-bg: rgba(234, 179, 8, 0.15);
            --yellow-item-border: #eab308;
            --yellow-item-text: #fef08a;
            --yellow-btn-bg: #eab308;
            --yellow-btn-hover: #ca8a04;
        }
        body.dark-mode .stat-icon[style*="#e0e7ff"] { background: rgba(99, 102, 241, 0.2) !important; color: #818cf8 !important; }
        body.dark-mode .stat-icon[style*="#dcfce7"] { background: rgba(16, 185, 129, 0.2) !important; color: #34d399 !important; }
        body.dark-mode .stat-icon[style*="#fef3c7"] { background: rgba(245, 158, 11, 0.2) !important; color: #fbbf24 !important; }
        
        * { box-sizing: border-box; font-family: 'Tajawal', 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html, body { width: 100%; height: 100%; overflow-x: hidden; position: relative; }
        body { background: var(--bg-body); margin: 0; color: var(--text-main); display: flex; min-height: 100vh; transition: background 0.3s, color 0.3s; }
        
        .sidebar { width: 280px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100dvh; right: 0; top: 0; z-index: 9999; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -5px 0 25px rgba(0,0,0,0.2); border-left: 1px solid var(--border-color); transform: translateX(0); padding-bottom: 20px; }
        
        .mobile-menu-btn { display: none; position: fixed; top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right)); z-index: 100000; background: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .mobile-menu-btn:active { transform: scale(0.95); }
        
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9990; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        
        .brand { padding: 30px 20px 5px 20px; text-align: center; font-size: 18px; font-weight: 900; background: linear-gradient(135deg, var(--primary), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
        
        .theme-switch-container { display: flex; justify-content: center; align-items: center; padding-bottom: 10px; gap: 10px; font-size: 13px; color: #94a3b8; }
        .theme-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .theme-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .menu-items { padding: 10px; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .sidebar button { width: 100%; padding: 14px 18px; margin-bottom: 5px; border: none; border-radius: 12px; background: transparent; color: #94a3b8; font-size: 15px; font-weight: 600; cursor: pointer; text-align: right; display: flex; align-items: center; gap: 12px; transition: all 0.3s; }
        .sidebar button:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .sidebar button.active { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }
        
        .main-content { flex: 1; margin-right: 280px; padding: 30px; transition: all 0.3s; width: 100%; max-width: 100%; filter: blur(0px); }
        body.locked .main-content, body.locked .sidebar, body.locked .mobile-menu-btn, body.locked #syncStatus { filter: blur(15px); pointer-events: none; user-select: none; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 20px; display: flex; align-items: center; gap: 15px; box-shadow: var(--card-shadow); border: 1px solid var(--stat-card-border); color: var(--text-main); }
        .stat-icon { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        
        .card { background: var(--bg-card); border-radius: 24px; padding: 35px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); margin-bottom: 30px; animation: fadeIn 0.5s ease-out; color: var(--text-main); position: relative; z-index: 1; }
        .inner-box { background: var(--bg-input) !important; border: 1px solid var(--border-color) !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h3 { font-size: 22px; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        h4 { color: var(--text-main); }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-muted); font-size: 14px; }
        
        input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: 15px; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-body); z-index: 200000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .login-card h2 { color: var(--primary); margin-bottom: 10px; }
        .login-card p { color: var(--text-muted); margin-bottom: 30px; font-size: 14px; }
        .login-card input { margin-bottom: 15px; border-radius: 12px; }
        
        .security-status-active { color: var(--success); font-weight: bold; }
        .security-status-banned { color: var(--danger); font-weight: bold; }
        
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        body.dark-mode .btn-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-warning { background: #fffbeb; color: #d97706; }
        body.dark-mode .btn-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .btn-warning:hover { background: #fef3c7; }
        .btn-whatsapp { background: #25D366; color: white; font-size: 12px; padding: 8px 12px; }
        .btn-whatsapp:hover { background: #128C7E; }
        
        .table-container { overflow-x: auto; border-radius: 15px; border: 1px solid var(--border-color); width: 100%; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); min-width: 600px; }
        th { background: var(--bg-input); padding: 16px; text-align: center; color: var(--text-muted); font-weight: 700; }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); text-align: center; color: var(--text-main); }
        tr.reminded { background-color: #dcfce7 !important; }
        body.dark-mode tr.reminded { background-color: rgba(16, 185, 129, 0.2) !important; }
        
        .chart-wrapper { position: relative; height: 300px; width: 100%; overflow: hidden; }
        .hidden { display: none !important; }
        
        #notification { position: fixed; bottom: 30px; left: 30px; padding: 16px 25px; border-radius: 16px; color: white; font-weight: 700; z-index: 100000; display: none; animation: slideIn 0.3s ease-out; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        #syncStatus { position: fixed; top: 20px; left: 30px; padding: 8px 15px; border-radius: 50px; font-size: 12px; font-weight: 700; z-index: 100000; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }
        .badge-success { background: #dcfce7; color: var(--success); }
        .badge-info { background: #e0e7ff; color: var(--primary); }
        .badge-danger { background: #fee2e2; color: var(--danger); }
        .badge-warning { background: #fef3c7; color: #d97706; }
        body.dark-mode .badge-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        body.dark-mode .badge-info { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
        body.dark-mode .badge-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        body.dark-mode .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        
        .yellow-section { background-color: var(--yellow-bg); border: 2px solid var(--yellow-border); border-radius: 20px; padding: 25px; color: var(--yellow-text); }
        .yellow-section h3 { color: var(--yellow-text) !important; }
        .yellow-section .btn-primary { background: var(--yellow-btn-bg); color: #fff; border: none; }
        .yellow-section .btn-primary:hover { background: var(--yellow-btn-hover); }
        
        .todo-item { display: flex; align-items: center; justify-content: space-between; background: var(--yellow-item-bg); padding: 15px; border-radius: 12px; border-right: 4px solid var(--yellow-item-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; color: var(--yellow-item-text); }
        #generalNotesBox .todo-item { background: var(--bg-input); border-right: 4px solid var(--primary); color: var(--text-main); }
        .todo-item > div:first-child { flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; padding-left: 15px; white-space: pre-wrap; }
        
        .settings-section, .github-section { background: var(--bg-input); padding: 20px; border-radius: 18px; border: 1px solid var(--border-color); margin-top: 20px; color: var(--text-main); }
        .github-section { background: #1e293b; color: white; }
        .github-section h3, .github-section h3 i { color: white !important; }
        .github-section label { color: #94a3b8; }
        .github-section input { background: #334155; border-color: #475569; color: white; }
        
        /* --- MOBILE FIXES --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); right: 0; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-right: 0; padding: 70px 15px 20px 15px; }
            .mobile-menu-btn { display: block !important; }
            .stats-grid { grid-template-columns: 1fr; }
            
            /* Force single column layout for grids */
            .card > div[style*="grid-template-columns"], 
            .inner-box[style*="grid-template-columns"], 
            .settings-section > div, 
            .github-section > div,
            #investment .inner-box > div { 
                grid-template-columns: 1fr !important; 
            }
            
            /* Stack flex containers vertically */
            .inner-box, 
            .github-section > div { 
                display: flex !important; 
                flex-direction: column !important; 
                align-items: stretch !important; 
                gap: 15px !important; 
                height: auto !important; 
                overflow: hidden !important; 
            }
            
            /* Full width elements */
            .inner-box input, .inner-box select, .inner-box button, .github-section button, .btn { 
                width: 100% !important; 
                margin: 0 !important; 
                box-sizing: border-box !important; 
            }
            
            /* --- INVESTMENT INPUT FIX (GRID) --- */
            /* هذا الجزء يصلح مشكلة خانة السحب */
            #investment .input-group > div {
                display: grid !important;
                grid-template-columns: 1fr 70px auto !important; /* المبلغ - العملة - الزر */
                gap: 5px !important;
                width: 100% !important;
            }
            
            /* إعادة ضبط العناصر داخل الجريد */
            #investment .input-group > div > input,
            #investment .input-group > div > select,
            #investment .input-group > div > button {
                width: 100% !important; /* تملأ خليتها في الشبكة */
                margin: 0 !important;
                flex: none !important;
            }

            /* إصلاح الخانات الأخرى (مثل شراء) لتبقى أفقية */
            #purchase .input-group > div { 
                display: flex !important; 
                flex-direction: row !important; 
                width: 100% !important; 
                gap: 10px !important; 
            }
            
            #purchase .input-group > div > input { 
                flex: 1 !important; 
                width: auto !important; 
                min-width: 0 !important; 
            }
            
            #purchase .input-group > div > select { 
                flex: 0 0 80px !important; 
                width: 80px !important; 
            }

            .github-section > div:last-child { flexDirection: column !important; }
            th, td { fontSize: 13px; padding: 10px; }
            #syncStatus { top: 15px; left: 15px; }
        }
    </style>
</head>

<body class="locked">

<div id="syncStatus"><i class="fas fa-cloud"></i> <span>جاري التحميل...</span></div>

<div id="loginLayer" class="login-overlay">
    <div id="cloudSetupCard" class="login-card hidden">
        <i class="fas fa-cloud-upload-alt" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
        <h2>الربط السحابي (أمان)</h2>
        <p>يجب ربط النظام بـ GitHub أولاً لجلب بيانات المستخدمين والتحقق منها.</p>
        <input id="loginGhUser" placeholder="Github Username">
        <input id="loginGhRepo" placeholder="Repository Name">
        <input id="loginGhToken" type="password" placeholder="Access Token">
        <button class="btn btn-primary" style="width:100%" onclick="setupCloudAndFetch()">
            <i class="fas fa-sync"></i> ربط ومزامنة
        </button>
        <p id="cloudMsg" style="margin-top:10px; font-size:12px; color:var(--text-muted)"></p>
    </div>

    <div id="loginCard" class="login-card hidden">
        <div class="brand" style="padding:0; margin-bottom:20px; background:none; -webkit-text-fill-color: initial; color:var(--primary)">
            <i class="fas fa-rocket"></i> MEGA STORE
        </div>
        <h2>تسجيل الدخول</h2>
        <p>يرجى إدخال بيانات الاعتماد للمتابعة</p>
        <input id="loginUser" placeholder="اسم المستخدم">
        <input id="loginPass" type="password" placeholder="كلمة المرور">
        <button class="btn btn-primary" style="width:100%" onclick="attemptLogin()">
            <i class="fas fa-sign-in-alt"></i> دخول
        </button>
    </div>
</div>

<button class="mobile-menu-btn" id="menuBtn" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="mySidebar">
    <div class="brand"><i class="fas fa-rocket"></i> MEGA STORE</div>
    <div class="theme-switch-container">
        <i class="fas fa-moon"></i>
        <label class="theme-switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
        <i class="fas fa-sun"></i>
    </div>
    <div id="currentUserDisplay" style="text-align:center; padding: 10px; font-size:12px; color: var(--text-muted);"></div>

    <div class="menu-items">
        <button onclick="showPage('purchase', this)" class="active" id="btnPurchase"><i class="fas fa-shopping-cart"></i> عملية شراء</button>
        <button onclick="showPage('expiring', this)" id="btnExpiring"><i class="fas fa-hourglass-half"></i> تنبيهات الانتهاء</button>
        <button onclick="showPage('wallets', this)" id="btnWallets"><i class="fas fa-wallet"></i> أرصدة المحافظ</button>
        <button onclick="showPage('history', this)" id="btnHistory"><i class="fas fa-history"></i> سجل العمليات</button>
        <button onclick="showPage('analytics', this)" id="btnAnalytics"><i class="fas fa-chart-bar"></i> الإحصائيات</button>
        <button onclick="showPage('investment', this)" id="btnInvestment"><i class="fas fa-chart-line"></i> توزيع الأرباح</button>
        <button onclick="showPage('generalNotes', this)" id="btnNotes"><i class="fas fa-sticky-note"></i> ملاحظات</button>
        <button onclick="showPage('security', this)" id="btnSecurity" class="hidden"><i class="fas fa-user-shield"></i> الأمان والمستخدمين</button>
        <button onclick="showPage('logs', this)" id="btnLogs" class="hidden"><i class="fas fa-clipboard-list"></i> حركات الموقع</button>
        <button onclick="showPage('backup', this)" id="btnBackup"><i class="fas fa-database"></i> النسخ الاحتياطي</button>
        <button onclick="showPage('modify', this)" id="btnSettings"><i class="fas fa-cog"></i> الإعدادات</button>
        <button onclick="logout()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</button>
    </div>
</div>

<div class="main-content">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e0e7ff; color: var(--primary);"><i class="fas fa-dollar-sign"></i></div>
            <div><label>إجمالي الدولار</label><div id="statDollar" style="font-size: 20px; font-weight: 800;">0.00 $</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #dcfce7; color: var(--success);"><i class="fas fa-coins"></i></div>
            <div><label>إجمالي الشيكل</label><div id="statShekel" style="font-size: 20px; font-weight: 800;">0.00 ₪</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fef3c7; color: var(--accent);"><i class="fas fa-shopping-bag"></i></div>
            <div><label>عمليات اليوم</label><div id="statSales" style="font-size: 20px; font-weight: 800;">0</div></div>
        </div>
    </div>

    <div id="notification"></div>

    <div id="purchase" class="card">
        <h3><i class="fas fa-cart-plus"></i> تسجيل اشتراك جديد</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group"><label>نوع الاشتراك</label><input id="sub" placeholder="مثال: نيتفليكس، يوتيوب..."></div>
            <div class="input-group"><label>اسم العميل</label><input id="customer" placeholder="اسم العميل"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group"><label>رقم جوال العميل</label><input id="customerPhone" placeholder="059xxxxxxx"></div>
            <div class="input-group"><label>مدة الاشتراك</label>
                <select id="subDuration">
                    <option value="1">1 شهر</option><option value="2">2 شهر</option><option value="3">3 شهور</option><option value="4">4 شهور</option><option value="5">5 شهور</option><option value="6">6 شهور</option><option value="7">7 شهور</option><option value="8">8 شهور</option><option value="9">9 شهور</option><option value="10">10 شهور</option><option value="11">11 شهر</option><option value="12">12 شهر (سنة)</option>
                </select>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
            <div class="input-group"><label>المبلغ المدفوع من العميل</label><div style="display:flex; gap:10px"><input type="number" id="paidAmount" placeholder="0.00"><select id="paidCurrency" style="width:120px"><option value="₪">₪ شيكل</option><option value="$">$ دولار</option></select></div></div>
            <div class="input-group"><label>التكلفة علينا</label><div style="display:flex; gap:10px"><input type="number" id="costAmount" placeholder="0.00"><select id="costCurrency" style="width:120px"><option value="$">$ دولار</option><option value="₪">₪ شيكل</option></select></div></div>
        </div>
        <div class="inner-box" style="padding: 25px; border-radius: 18px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-style: dashed;">
            <div><label>يُخصم من محفظة (المصدر):</label><select id="fromWallet"></select></div>
            <div><label>يُودع الربح في محفظة:</label><select id="wallet"></select></div>
        </div>
        <button class="btn btn-primary" id="btnSubmitPurchase" style="width:100%; margin-top:30px; padding: 16px;" onclick="addPurchase()"><i class="fas fa-check-circle"></i> إتمام العملية وحفظ البيانات</button>
    </div>

    <div id="security" class="card hidden">
        <h3><i class="fas fa-user-shield"></i> إدارة الأمان والمستخدمين</h3>
        <div class="inner-box" style="padding:25px; border-radius:20px; margin-bottom:30px;">
            <h4><i class="fas fa-user-plus"></i> إضافة مستخدم جديد</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                <input id="newUserName" placeholder="اسم المستخدم" style="border-radius:12px">
                <input id="newUserPass" placeholder="كلمة المرور" style="border-radius:12px">
                <select id="newUserRole" style="border-radius:12px">
                    <option value="viewer">مشاهد (Viewer)</option>
                    <option value="employee">موظف (Employee)</option>
                    <option value="admin">أدمن (Admin)</option>
                </select>
                <button class="btn btn-primary" onclick="addNewUser()">إضافة</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>اسم المستخدم</th><th>الصلاحية</th><th>الحالة</th><th>آخر دخول</th><th>الجهاز</th><th>تحكم</th></tr></thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logs" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3><i class="fas fa-clipboard-list"></i> سجل حركات الموقع (Audit Log)</h3>
            <button id="btnClearLogs" class="btn btn-danger hidden" onclick="clearLogs()"><i class="fas fa-trash"></i> مسح السجل بالكامل</button>
        </div>
        <p style="color:var(--text-muted); margin-bottom:20px;">يسجل هذا السجل جميع الإجراءات الحساسة والتعديلات مع التوقيت واسم المستخدم.</p>
        <div class="table-container">
            <table>
                <thead><tr><th style="width:200px">التاريخ والوقت</th><th style="width:150px">المستخدم</th><th>تفاصيل الحركة</th></tr></thead>
                <tbody id="logsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="expiring" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin-bottom:0"><i class="fas fa-hourglass-half"></i> اشتراكات تنتهي قريباً</h3>
            <button id="btnHideExpired" class="btn btn-danger" onclick="deleteExpired()" style="padding: 8px 15px; font-size:13px; background:#ef4444; color:white;"><i class="fas fa-eye-slash"></i> إخفاء المنتهي</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>الخدمة</th><th>اسم العميل</th><th>رقم الجوال</th><th>ينتهي بتاريخ</th><th>المتبقي</th><th>مراسلة</th></tr></thead>
                <tbody id="expiringBody"></tbody>
            </table>
        </div>
    </div>

    <div id="analytics" class="card hidden">
        <h3><i class="fas fa-chart-bar"></i> الإحصائيات</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div class="inner-box" style="padding: 20px; border-radius: 20px;"><div class="chart-wrapper"><canvas id="profitChart"></canvas></div></div>
            <div class="inner-box" style="padding: 20px; border-radius: 20px;"><div class="chart-wrapper"><canvas id="salesChart"></canvas></div></div>
        </div>
    </div>

    <div id="wallets" class="card hidden">
        <h3><i class="fas fa-wallet"></i> توزيع السيولة</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>المحفظة</th><th>العملة</th><th style="text-align:center">الرصيد</th><th>الحالة</th></tr></thead>
                <tbody id="walletList"></tbody>
            </table>
        </div>
    </div>

    <div id="history" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
            <h3><i class="fas fa-list-ul"></i> الأرشيف المالي</h3>
            <div style="display:flex; gap:10px">
                <button id="btnUndo" class="btn btn-primary" onclick="undoLastPurchase()"><i class="fas fa-undo"></i> تراجع</button>
                <button id="btnClearHistory" class="btn btn-danger" onclick="clearHistory()"><i class="fas fa-trash"></i> مسح الكل</button>
            </div>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="historySearch" onkeyup="filterHistory()" placeholder="ابحث باسم العميل..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>التاريخ</th><th>العميل</th><th>الجوال</th><th>الخدمة</th><th>المدة</th><th>الدفع</th><th>التكلفة</th><th>المحفظة</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <div id="investment" class="card hidden">
        <h3><i class="fas fa-chart-pie"></i> حصص الشركاء</h3>
        <div id="investBox" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
        <div class="inner-box" style="margin-top:40px; padding:30px; border-radius:20px;">
            <h4 style="margin-top:0; color:var(--danger)"><i class="fas fa-external-link-alt"></i> طلب سحب أرباح</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                <div class="input-group"><label>سحب من حصة أحمد</label><div style="display:flex; gap:5px"><input id="withdrawAhmad" type="number" placeholder="0.00"><select id="curAhmad" style="width:70px"><option value="d">$</option><option value="s">₪</option></select><button class="btn btn-danger" onclick="withdrawPartial('ahmad')">سحب</button></div></div>
                <div class="input-group"><label>سحب من حصة محمد</label><div style="display:flex; gap:5px"><input id="withdrawMohamed" type="number" placeholder="0.00"><select id="curMohamed" style="width:70px"><option value="d">$</option><option value="s">₪</option></select><button class="btn btn-danger" onclick="withdrawPartial('mohamed')">سحب</button></div></div>
                <div class="input-group"><label>سحب من حصة المتجر</label><div style="display:flex; gap:5px"><input id="withdrawStore" type="number" placeholder="0.00"><select id="curStore" style="width:70px"><option value="d">$</option><option value="s">₪</option></select><button class="btn btn-danger" onclick="withdrawPartial('store')">سحب</button></div></div>
            </div>
        </div>
    </div>

    <div id="modify" class="card hidden">
        <h3><i class="fas fa-key"></i> تغيير كلمة المرور</h3>
        <div class="inner-box" style="padding:20px; border-radius:15px; margin-bottom:40px">
            <input type="password" id="changePassInput" placeholder="كلمة المرور الجديدة" style="margin-bottom:10px">
            <button class="btn btn-primary" onclick="changeMyPassword()">تحديث كلمة المرور</button>
        </div>

        <div id="sec-manual-wallet">
            <h3 style="margin-top:0"><i class="fas fa-edit"></i> التحكم اليدوي بالأرصدة</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="input-group"><label>المحفظة</label><select id="modWallet"></select></div>
                <div class="input-group"><label>المبلغ</label><input id="modAmount" type="number" placeholder="0.00"></div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:40px">
                <button class="btn btn-primary" onclick="addToWallet()">إضافة</button>
                <button class="btn btn-danger" onclick="subtractFromWallet()">خصم</button>
                <button class="btn btn-primary" style="background:#0ea5e9" onclick="setWallet()">تعيين مباشر</button>
                <button class="btn btn-warning" onclick="toggleWalletStatus()"><i class="fas fa-toggle-on"></i> تغيير الحالة</button>
                <button class="btn btn-danger" onclick="deleteWallet()">حذف المحفظة</button>
            </div>
        </div>

        <div id="sec-manage-wallets">
            <h3><i class="fas fa-plus-circle"></i> إدارة المحافظ</h3>
            <div class="inner-box" style="display:flex; gap:15px; padding:20px; border-radius:15px; margin-bottom:40px">
                <input id="newWalletName" placeholder="اسم المحفظة الجديدة">
                <select id="newWalletCurrency" style="width:150px"><option value="$">$ دولار</option><option value="₪">₪ شيكل</option></select>
                <button class="btn btn-primary" onclick="addNewWallet()">إنشاء</button>
            </div>
        </div>

        <div id="sec-rename-wallet">
            <h3><i class="fas fa-edit"></i> تعديل اسم محفظة</h3>
            <div class="inner-box" style="display:flex; gap:15px; padding:20px; border-radius:15px; margin-bottom:40px">
                <select id="renameWalletSelect" style="width:200px"></select>
                <input id="renameWalletInput" placeholder="الاسم الجديد للمحفظة">
                <button class="btn btn-warning" onclick="renameWallet()">تغيير الاسم</button>
            </div>
        </div>

        <div id="sec-profit-settings">
            <h3><i class="fas fa-percent"></i> إعدادات توزيع الأرباح</h3>
            <div class="settings-section" style="margin-bottom:40px; margin-top:0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="input-group"><label>نسبة أحمد (%)</label><input type="number" id="setAhmadProp" placeholder="35"></div>
                    <div class="input-group"><label>نسبة محمد (%)</label><input type="number" id="setMohamedProp" placeholder="35"></div>
                    <div class="input-group"><label>نسبة المتجر (%)</label><input type="number" id="setStoreProp" placeholder="30"></div>
                </div>
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="setDeductCost" style="width: 20px; height: 20px;">
                    <label for="setDeductCost" style="margin-bottom: 0;">خصم التكاليف من الإجمالي قبل توزيع الربح؟</label>
                </div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
                <div class="input-group">
                    <label>سعر صرف الدولار الثابت (مقابل الشيكل)</label>
                    <div style="display:flex; align-items:center; gap:10px">
                        <input type="number" id="setExchangeRate" placeholder="أدخل السعر (مثلاً 3.5)">
                        <small style="color:var(--text-muted); width: 100%;">اتركه 0 أو فارغاً للسؤال كل مرة.</small>
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveProfitSettings()">حفظ إعدادات النظام</button>
            </div>
        </div>

        <div class="github-section" style="margin-bottom:40px; margin-top:0;">
            <h3><i class="fab fa-github"></i> إعدادات الربط السحابي (GitHub)</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                <div class="input-group"><label>اسم المستخدم</label><input id="ghUser"></div>
                <div class="input-group"><label>المستودع</label><input id="ghRepo"></div>
                <div class="input-group"><label>Token</label><input id="ghToken" type="password"></div>
                <div class="input-group"><label>اسم الملف</label><input id="ghFile" value="db.json"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button class="btn btn-primary" onclick="saveGithubSettings()">حفظ الإعدادات</button>
                <button class="btn btn-warning" onclick="fetchFromGithub()"><i class="fas fa-download"></i> سحب</button>
                <button class="btn btn-success" style="background:var(--success); color:#fff" onclick="pushToGithub()"><i class="fas fa-upload"></i> رفع</button>
            </div>
        </div>

        <div class="yellow-section" id="sec-todo">
            <h3><i class="fas fa-tasks"></i> قائمة المهام (To-Do)</h3>
            <div style="display:flex; gap:15px; margin-bottom:20px">
                <input id="todoInput" placeholder="اكتب المهمة...">
                <button class="btn btn-primary" onclick="addTodo()">إضافة</button>
            </div>
            <div id="todoBox"></div>
        </div>
    </div>

    <div id="generalNotes" class="card hidden">
        <h3><i class="fas fa-pen-fancy"></i> المفكرة</h3>
        <div style="display:flex; gap:15px">
            <textarea id="gnText" placeholder="اكتب ملاحظة..." style="height: 60px;"></textarea>
            <button class="btn btn-primary" onclick="addGeneralNote()">حفظ</button>
        </div>
        <div id="generalNotesBox" style="margin-top:30px;"></div>
    </div>

    <div id="backup" class="card hidden">
        <h3><i class="fas fa-shield-alt"></i> حماية البيانات</h3>
        <div style="text-align:center; padding:40px; border:2px dashed var(--border-color); border-radius:30px">
            <i class="fas fa-cloud-download-alt" style="font-size:50px; color:var(--primary); margin-bottom:20px"></i>
            <p style="color:var(--text-main)">احتفظ بنسخة احتياطية من بياناتك دائماً.</p>
            <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> تحميل النسخة الاحتياطية</button>
            <div style="margin: 30px 0; border-top:1px solid var(--border-color)"></div>
            <div class="inner-box" style="border:none; padding:0; display:flex; gap:15px; align-items:center;">
                <input type="file" id="importFile" style="width:auto; margin-bottom:10px">
                <button class="btn btn-danger" style="background:var(--bg-input); color:var(--text-muted); border:1px solid var(--border-color)" onclick="importData()">استعادة بيانات</button>
            </div>
        </div>
    </div>

</div>

<script>
const fix=n=>Number(n).toFixed(2);
let myProfitChart = null;
let mySalesChart = null;
let currentUser = null; 

let ghConfig = {
    user: localStorage.getItem("gh_user") || "",
    repo: localStorage.getItem("gh_repo") || "",
    token: localStorage.getItem("gh_token") || "",
    file: localStorage.getItem("gh_file") || "db.json",
    sha: ""
};

// --- QUEUE SYSTEM VARS ---
let isSyncing = false; // هل يتم الرفع الآن؟
let syncPending = false; // هل هناك طلب معلق؟

const DEFAULT_USER = {
    username: "Mohamed Ahmed",
    password: "0000",
    role: "admin", 
    status: "active",
    lastLogin: "-",
    deviceInfo: "-"
};

function updateSyncStatus(msg, type="loading") {
    const el = document.getElementById("syncStatus");
    if(type==="loading") {
        el.innerHTML = `<i class="fas fa-circle-notch fa-spin" style="color:var(--primary)"></i> <span>${msg}</span>`;
    } else if (type==="success") {
        el.innerHTML = `<i class="fas fa-check" style="color:var(--success)"></i> <span>${msg}</span>`;
        setTimeout(() => el.innerHTML = `<i class="fas fa-cloud"></i> <span>متزامن</span>`, 3000);
    } else if (type==="error") {
        el.innerHTML = `<i class="fas fa-times" style="color:var(--danger)"></i> <span>${msg}</span>`;
    } else {
        el.innerHTML = `<i class="fas fa-cloud"></i> <span>${msg}</span>`;
    }
}

function logAction(actionDescription) {
    if(!currentUser) return;
    let logs = JSON.parse(localStorage.activityLog || "[]");
    logs.unshift({
        user: currentUser.username,
        action: actionDescription,
        time: new Date().toLocaleString("ar-EG")
    });
    if(logs.length > 500) logs = logs.slice(0, 500);
    localStorage.activityLog = JSON.stringify(logs);
    if(document.getElementById("logs").classList.contains("hidden") === false) refreshLogs();
}

function init(){
    if(!localStorage.users) localStorage.users = JSON.stringify([DEFAULT_USER]);
    if(!localStorage.wallets){
        localStorage.wallets=JSON.stringify({
            "جوال باي — سعاد":{bal:0, cur:"₪", active:true},
            "جوال باي — محمد":{bal:0, cur:"₪", active:true},
            "بال باي — أحمد":{bal:0, cur:"₪", active:true},
            "بايننس — احمد":{bal:0, cur:"$", active:true}
        });
    }
    if(!localStorage.purchases) localStorage.purchases="[]";
    if(!localStorage.invest) localStorage.invest=JSON.stringify({ahmad:{d:0,s:0},mohamed:{d:0,s:0},store:{d:0,s:0}});
    if(!localStorage.generalNotes) localStorage.generalNotes="[]";
    if(!localStorage.todoList) localStorage.todoList="[]";
    if(!localStorage.settings) localStorage.settings = JSON.stringify({ahmad: 35, mohamed: 35, store: 30, deductCost: true, exchangeRate: 0});
    if(!localStorage.activityLog) localStorage.activityLog = "[]";

    if(localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        document.getElementById("darkModeToggle").checked = true;
    }
    
    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) {
        document.getElementById("cloudSetupCard").classList.remove("hidden");
        document.getElementById("loginCard").classList.add("hidden");
    } else {
        fetchFromGithub(true);
    }
}

async function setupCloudAndFetch() {
    const u = document.getElementById("loginGhUser").value.trim();
    const r = document.getElementById("loginGhRepo").value.trim();
    const t = document.getElementById("loginGhToken").value.trim();
    if(!u || !r || !t) { document.getElementById("cloudMsg").innerText = "يرجى تعبئة جميع الحقول"; return; }
    localStorage.setItem("gh_user", u); localStorage.setItem("gh_repo", r);
    localStorage.setItem("gh_token", t); localStorage.setItem("gh_file", "db.json");
    ghConfig = { user: u, repo: r, token: t, file: "db.json", sha: "" };
    document.getElementById("cloudMsg").innerText = "جاري الاتصال والتحقق...";
    await fetchFromGithub(true);
}

async function fetchFromGithub(triggerLogin = false) {
    updateSyncStatus("فحص البيانات السحابية...");
    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;
    try {
        const response = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' }, cache: "no-store" });
        if (response.status === 404) {
            console.log("File not found");
            if(triggerLogin) {
                 await pushToGithub(true);
                 document.getElementById("cloudSetupCard").classList.add("hidden");
                 document.getElementById("loginCard").classList.remove("hidden");
            }
            return;
        }
        if (!response.ok) throw new Error("API Error");
        const data = await response.json();
        ghConfig.sha = data.sha;
        const db = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        if(db.users) localStorage.users = JSON.stringify(db.users);
        if(db.wallets) localStorage.wallets = JSON.stringify(db.wallets);
        if(db.purchases) localStorage.purchases = JSON.stringify(db.purchases);
        if(db.invest) localStorage.invest = JSON.stringify(db.invest);
        if(db.settings) localStorage.settings = JSON.stringify(db.settings);
        if(db.generalNotes) localStorage.generalNotes = JSON.stringify(db.generalNotes);
        if(db.todoList) localStorage.todoList = JSON.stringify(db.todoList);
        if(db.activityLog) localStorage.activityLog = JSON.stringify(db.activityLog);
        updateSyncStatus("متزامن", "success");
        if(triggerLogin) {
            document.getElementById("cloudSetupCard").classList.add("hidden");
            document.getElementById("loginCard").classList.remove("hidden");
        } else { refreshAll(); }
    } catch (error) {
        console.error(error);
        updateSyncStatus("خطأ في الاتصال", "error");
        document.getElementById("cloudMsg").innerText = "فشل الاتصال بـ GitHub. تأكد من البيانات.";
    }
}

async function attemptLogin() {
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value.trim();
    let users = JSON.parse(localStorage.users || "[]");
    let userObj = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);

    if (userObj) {
        // --- SUPER ADMIN FIX ---
        if(userObj.username === "Mohamed Ahmed") {
            userObj.role = "admin"; userObj.status = "active";
            localStorage.users = JSON.stringify(users);
        }
        // -----------------------

        if(userObj.status === "banned") { alert("تم حظر هذا الحساب. راجع المسؤول."); return; }
        currentUser = userObj;
        userObj.lastLogin = new Date().toLocaleString("ar-EG");
        userObj.deviceInfo = getOS();
        localStorage.users = JSON.stringify(users);
        
        logAction("تسجيل دخول للنظام");

        updateSyncStatus("تحديث الصلاحيات سحابياً...", "loading");
        await pushToGithub(); 
        document.getElementById("loginLayer").style.display = "none";
        document.body.classList.remove("locked");
        loadWallets(); loadProfitSettings(); loadGithubInputs(); refreshAll(); applyRBAC();
        document.getElementById("currentUserDisplay").innerHTML = `مرحباً، ${currentUser.username} (${getRoleName(currentUser.role)})`;
    } else { alert("بيانات الدخول غير صحيحة"); }
}

function getOS() {
    let platform = window.navigator.platform, os = null;
    if (['Macintosh', 'MacIntel'].indexOf(platform) !== -1) os = 'Mac OS';
    else if (['iPhone', 'iPad'].indexOf(platform) !== -1) os = 'iOS';
    else if (['Win32', 'Win64', 'Windows'].indexOf(platform) !== -1) os = 'Windows';
    else if (/Android/.test(window.navigator.userAgent)) os = 'Android';
    else if (/Linux/.test(platform)) os = 'Linux';
    return os || "Unknown";
}

function logout() { location.reload(); }
function getRoleName(role) { return role==='admin'?'أدمن':role==='employee'?'موظف':'مشاهد'; }

function applyRBAC() {
    const role = currentUser.role;
    
    document.getElementById("btnSecurity").classList.add("hidden");
    document.getElementById("btnBackup").classList.add("hidden");
    document.getElementById("btnLogs").classList.remove("hidden");
    document.getElementById("btnSettings").classList.remove("hidden");
    document.getElementById("btnClearLogs").classList.add("hidden");

    if (role === 'admin') {
        document.getElementById("btnSecurity").classList.remove("hidden");
        document.getElementById("btnBackup").classList.remove("hidden");
        document.getElementById("btnClearLogs").classList.remove("hidden"); 
        
        document.getElementById("sec-manual-wallet").classList.remove("hidden");
        document.getElementById("sec-manage-wallets").classList.remove("hidden");
        document.getElementById("sec-rename-wallet").classList.remove("hidden");
        document.getElementById("sec-profit-settings").classList.remove("hidden");
        document.getElementById("sec-todo").classList.remove("hidden");
        document.getElementById("btnUndo").classList.remove("hidden");
        document.getElementById("btnClearHistory").classList.remove("hidden");
        document.getElementById("btnHideExpired").classList.remove("hidden");
    } 
    else if (role === 'employee') {
        document.getElementById("sec-manual-wallet").classList.remove("hidden");
        document.getElementById("sec-manage-wallets").classList.remove("hidden");
        document.getElementById("sec-rename-wallet").classList.remove("hidden");
        document.getElementById("sec-profit-settings").classList.remove("hidden");
        document.getElementById("sec-todo").classList.remove("hidden");
        document.getElementById("btnUndo").classList.remove("hidden");
        document.getElementById("btnHideExpired").classList.remove("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
    }
    else if (role === 'viewer') {
        document.getElementById("btnPurchase").classList.add("hidden");
        document.getElementById("sec-manual-wallet").classList.add("hidden");
        document.getElementById("sec-manage-wallets").classList.add("hidden");
        document.getElementById("sec-rename-wallet").classList.add("hidden");
        document.getElementById("sec-profit-settings").classList.add("hidden");
        document.getElementById("sec-todo").classList.add("hidden");
        
        document.getElementById("btnUndo").classList.add("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
        document.getElementById("btnHideExpired").classList.add("hidden");
        
        document.querySelector("#generalNotes textarea").style.display = "none";
        document.querySelector("#generalNotes button").style.display = "none";

        showPage('history', document.getElementById('btnHistory'));
    }
}

function renderUsersTable() {
    if(currentUser.role !== 'admin') return;
    const users = JSON.parse(localStorage.users);
    const tbody = document.getElementById("usersTableBody"); tbody.innerHTML = "";
    users.forEach((u, index) => {
        let actions = "";
        if(u.username !== currentUser.username) {
            let banBtn = u.status === 'active' ? `<button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="toggleBan(${index})">حظر</button>` : `<button class="btn btn-success" style="padding:5px 10px; font-size:12px; background:var(--success); color:white" onclick="toggleBan(${index})">فك حظر</button>`;
            actions = `<div style="display:flex; gap:5px; justify-content:center"><button class="btn btn-primary" style="padding:5px 10px; font-size:12px" onclick="editUserPass(${index})"><i class="fas fa-key"></i></button><button class="btn btn-warning" style="padding:5px 10px; font-size:12px" onclick="changeUserRole(${index})"><i class="fas fa-user-tag"></i></button>${banBtn}<button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="deleteUser(${index})"><i class="fas fa-trash"></i></button></div>`;
        } else { actions = "<small>الحساب الحالي</small>"; }
        tbody.innerHTML += `<tr><td>${u.username}</td><td><span class="badge badge-info">${getRoleName(u.role)}</span></td><td class="${u.status==='active'?'security-status-active':'security-status-banned'}">${u.status==='active'?'نشط':'محظور'}</td><td style="font-size:12px">${u.lastLogin}</td><td style="font-size:12px">${u.deviceInfo}</td><td>${actions}</td></tr>`;
    });
}

function refreshLogs() {
    let logs = JSON.parse(localStorage.activityLog || "[]");
    const tbody = document.getElementById("logsTableBody");
    tbody.innerHTML = "";
    logs.forEach(log => {
        tbody.innerHTML += `<tr><td style="direction:ltr; text-align:right">${log.time}</td><td><b>${log.user}</b></td><td>${log.action}</td></tr>`;
    });
}

function clearLogs() {
    if(currentUser.role !== 'admin') return notify("للأدمن فقط", "error");
    if(confirm("هل أنت متأكد من مسح سجل الحركات بالكامل؟")) {
        localStorage.activityLog = "[]";
        refreshLogs();
        logAction("قام الأدمن بمسح سجل الحركات");
        pushToGithub();
        notify("تم مسح السجل");
    }
}

function addNewUser() {
    const u = document.getElementById("newUserName").value.trim(), p = document.getElementById("newUserPass").value.trim(), r = document.getElementById("newUserRole").value;
    if(!u || !p) return notify("يرجى ملء البيانات", "error");
    let users = JSON.parse(localStorage.users);
    if(users.some(x => x.username.toLowerCase() === u.toLowerCase())) return notify("اسم المستخدم موجود", "error");
    users.push({ username: u, password: p, role: r, status: "active", lastLogin: "-", deviceInfo: "-" });
    localStorage.users = JSON.stringify(users);
    logAction(`إضافة مستخدم جديد: ${u} بصلاحية ${r}`);
    document.getElementById("newUserName").value = ""; document.getElementById("newUserPass").value = "";
    renderUsersTable(); pushToGithub(); notify("تم إضافة المستخدم");
}

function toggleBan(index) {
    let users = JSON.parse(localStorage.users);
    let newState = users[index].status === 'active' ? 'banned' : 'active';
    users[index].status = newState;
    localStorage.users = JSON.stringify(users);
    logAction(`تغيير حالة المستخدم ${users[index].username} إلى ${newState}`);
    renderUsersTable(); pushToGithub();
}

function deleteUser(index) {
    if(!confirm("حذف المستخدم نهائياً؟")) return;
    let users = JSON.parse(localStorage.users);
    logAction(`حذف المستخدم: ${users[index].username}`);
    users.splice(index, 1);
    localStorage.users = JSON.stringify(users);
    renderUsersTable(); pushToGithub();
}

function editUserPass(index) {
    let users = JSON.parse(localStorage.users);
    let newP = prompt(`كلمة المرور الجديدة للمستخدم ${users[index].username}:`);
    if(newP) {
        users[index].password = newP;
        localStorage.users = JSON.stringify(users);
        logAction(`تغيير كلمة مرور المستخدم: ${users[index].username}`);
        pushToGithub(); notify("تم تغيير كلمة المرور");
    }
}

function changeUserRole(index) {
    let users = JSON.parse(localStorage.users);
    let newR = prompt("أدخل نوع الصلاحية (admin, employee, viewer):", users[index].role);
    if(['admin','employee','viewer'].includes(newR)) {
        users[index].role = newR;
        localStorage.users = JSON.stringify(users);
        logAction(`تغيير صلاحية المستخدم ${users[index].username} إلى ${newR}`);
        renderUsersTable(); pushToGithub(); notify("تم تعديل الصلاحية");
    }
}

function changeMyPassword() {
    let newP = document.getElementById("changePassInput").value.trim();
    if(!newP) return notify("أدخل كلمة المرور الجديدة", "error");
    let users = JSON.parse(localStorage.users);
    let myIndex = users.findIndex(u => u.username === currentUser.username);
    if(myIndex !== -1) {
        users[myIndex].password = newP;
        currentUser.password = newP; 
        localStorage.users = JSON.stringify(users);
        document.getElementById("changePassInput").value = "";
        logAction("قام بتغيير كلمة المرور الخاصة به");
        pushToGithub(); notify("تم التغيير بنجاح");
    }
}

// --- QUEUE BASED SYNC ---
async function pushToGithub(force = false) {
    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) return;

    // اذا كان هناك عملية رفع جارية، قم بجدولة طلب جديد فقط
    if (isSyncing) {
        console.log("Sync already in progress, queuing next sync...");
        syncPending = true;
        updateSyncStatus("جارِ المزامنة (في الانتظار)...", "loading");
        return;
    }

    isSyncing = true;
    updateSyncStatus("جاري الحفظ...");

    const db = {
        users: JSON.parse(localStorage.users || "[]"),
        wallets: JSON.parse(localStorage.wallets || "{}"),
        purchases: JSON.parse(localStorage.purchases || "[]"),
        invest: JSON.parse(localStorage.invest || "{}"),
        settings: JSON.parse(localStorage.settings || "{}"),
        generalNotes: JSON.parse(localStorage.generalNotes || "[]"),
        todoList: JSON.parse(localStorage.todoList || "[]"),
        activityLog: JSON.parse(localStorage.activityLog || "[]"),
        lastUpdate: new Date().toISOString()
    };

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;

    const body = { message: "Update via MegaStore Audit", content: content };
    if (ghConfig.sha) body.sha = ghConfig.sha;

    try {
        const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        
        if (response.status === 409) {
            // Conflict! Fetch latest SHA and retry immediately
            console.log("Conflict detected, fetching latest SHA...");
            await fetchFromGithub(); // This updates ghConfig.sha
            // Retry the push logic manually inside catch/finally or let the pending flag handle it
            // Better to let the pending flag handle it by setting it true
            syncPending = true;
        } else if (!response.ok) {
            throw new Error("Failed");
        } else {
            const data = await response.json();
            ghConfig.sha = data.content.sha;
            updateSyncStatus("تم الحفظ سحابياً", "success");
        }
    } catch (error) { 
        console.error(error); 
        updateSyncStatus("فشل الرفع", "error"); 
    } finally {
        isSyncing = false;
        // If a new change happened while we were uploading, trigger sync again
        if (syncPending) {
            syncPending = false;
            setTimeout(() => pushToGithub(), 1000); // Small delay to be safe
        }
    }
}

function showPage(id, btn){
    if(currentUser) {
        if(currentUser.role === 'viewer' && (id === 'purchase' || id === 'security' || id === 'backup')) return notify("ليس لديك صلاحية", "error");
        if(currentUser.role === 'employee' && (id === 'security' || id === 'backup')) return notify("ليس لديك صلاحية", "error");
    }
    document.querySelectorAll(".card").forEach(x=>x.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    if(window.innerWidth <= 768) { let sidebar = document.getElementById("mySidebar"); if(sidebar.classList.contains("active")) toggleSidebar(); }
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    if(btn) btn.classList.add("active");
    
    if(id === 'generalNotes') refreshGeneralNotes();
    if(id === 'investment') refreshInvestment();
    if(id === 'history') refreshHistory();
    if(id === 'wallets') refreshWallets();
    if(id === 'expiring') refreshExpiring();
    if(id === 'analytics') refreshAnalytics();
    if(id === 'security') renderUsersTable();
    if(id === 'logs') refreshLogs();
}

function toggleSidebar() {
    let sidebar = document.getElementById("mySidebar"), overlay = document.querySelector(".sidebar-overlay"), btnIcon = document.querySelector("#menuBtn i");
    sidebar.classList.toggle("active"); overlay.classList.toggle("active");
    if(sidebar.classList.contains("active")){ btnIcon.classList.remove("fa-bars"); btnIcon.classList.add("fa-times"); } else { btnIcon.classList.remove("fa-times"); btnIcon.classList.add("fa-bars"); }
}

function notify(msg,type="success"){
    let n=document.getElementById("notification");
    n.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}"></i> ` + msg;
    n.style.background=type==="success"?"#10b981":"#ef4444";
    n.style.display="block"; setTimeout(()=>{n.style.display="none";},3000);
}

function loadWallets(){
    let wallets=JSON.parse(localStorage.wallets);
    const selects = [wallet, modWallet, fromWallet, renameWalletSelect];
    selects.forEach(s => { if(s) { s.innerHTML = ""; Object.keys(wallets).forEach(w=>{ let o=document.createElement("option"); o.value=w; o.text=w; s.appendChild(o); }); } });
}
function loadProfitSettings(){
    let s = JSON.parse(localStorage.settings);
    setAhmadProp.value = s.ahmad; setMohamedProp.value = s.mohamed; setStoreProp.value = s.store;
    setDeductCost.checked = s.deductCost; setExchangeRate.value = s.exchangeRate || 0;
}
function loadGithubInputs(){
    document.getElementById("ghUser").value = ghConfig.user; document.getElementById("ghRepo").value = ghConfig.repo;
    document.getElementById("ghToken").value = ghConfig.token; document.getElementById("ghFile").value = ghConfig.file;
}
function toggleDarkMode() { document.body.classList.toggle("dark-mode"); localStorage.setItem("darkMode", document.body.classList.contains("dark-mode")); }
function saveProfitSettings(){
    let a = +setAhmadProp.value, m = +setMohamedProp.value, s = +setStoreProp.value;
    if(a + m + s !== 100){ notify("مجموع النسب يجب أن يساوي 100%","error"); return; }
    localStorage.settings = JSON.stringify({ahmad: a, mohamed: m, store: s, deductCost: setDeductCost.checked, exchangeRate: +setExchangeRate.value});
    logAction("تعديل إعدادات توزيع الأرباح");
    pushToGithub(); notify("تم الحفظ");
}
function saveGithubSettings() {
    const u = document.getElementById("ghUser").value.trim(), r = document.getElementById("ghRepo").value.trim(), t = document.getElementById("ghToken").value.trim(), f = document.getElementById("ghFile").value.trim() || "db.json";
    if(!u || !r || !t) return notify("يرجى تعبئة جميع الحقول", "error");
    localStorage.setItem("gh_user", u); localStorage.setItem("gh_repo", r); localStorage.setItem("gh_token", t); localStorage.setItem("gh_file", f);
    ghConfig = {user: u, repo: r, token: t, file: f, sha: ""};
    logAction("تعديل إعدادات الربط السحابي");
    notify("تم الحفظ، جاري الاتصال...", "success"); fetchFromGithub();
}
function addPurchase(){
    if(currentUser.role === 'viewer') return;
    if(paidAmount.value === "" || costAmount.value === "") { notify("املأ البيانات","error"); return; }
    let paid=+paidAmount.value, cost=+costAmount.value, paidCur=paidCurrency.value, costCur=costCurrency.value, wallets=JSON.parse(localStorage.wallets), invest=JSON.parse(localStorage.invest), purchases=JSON.parse(localStorage.purchases), settings=JSON.parse(localStorage.settings), from=fromWallet.value, duration = +subDuration.value;
    if(wallets[from].bal < cost && wallets[from].cur == costCur){notify("رصيد غير كافي","error"); return;}
    let undoSnapshot = { wallets: JSON.parse(JSON.stringify(wallets)), invest: JSON.parse(JSON.stringify(invest)) };
    localStorage.setItem("lastUndoOp", JSON.stringify(undoSnapshot));
    wallets[from].bal -= cost;
    let rate = 0;
    if(settings.exchangeRate && settings.exchangeRate > 0) rate = settings.exchangeRate;
    else if (paidCur !== costCur) { rate = +prompt("سعر الصرف (1$ = ?₪):"); if(!rate && rate!==0) return; }
    if(costCur === '$') { if(invest.store.d >= cost) invest.store.d -= cost; else { let rem = cost - invest.store.d; invest.store.d = 0; if(rate===0) rate=+prompt("سعر الصرف للخصم من الشيكل:"); invest.store.s -= (rem * rate); } } else { if(invest.store.s >= cost) invest.store.s -= cost; else { let rem = cost - invest.store.s; invest.store.s = 0; if(rate===0) rate=+prompt("سعر الصرف للخصم من الدولار:"); invest.store.d -= (rem / rate); } }
    let profitBase = paid, costInPaidCurrency = 0;
    if(settings.deductCost){ if(paidCur === costCur){ profitBase = paid - cost; costInPaidCurrency = cost; } else { let costCv = (paidCur == "$") ? cost/rate : cost*rate; profitBase = paid - costCv; costInPaidCurrency = costCv; } }
    let aP = +(profitBase * (settings.ahmad/100)).toFixed(2), mP = +(profitBase * (settings.mohamed/100)).toFixed(2), sP = +(profitBase * (settings.store/100)).toFixed(2);
    if(paidCur=="$"){ invest.ahmad.d += aP; invest.mohamed.d += mP; invest.store.d += sP; if(settings.deductCost) invest.store.d += costInPaidCurrency; } else { invest.ahmad.s += aP; invest.mohamed.s += mP; invest.store.s += sP; if(settings.deductCost) invest.store.s += costInPaidCurrency; }
    wallets[wallet.value].bal += paid;
    let d = new Date(), exp = new Date(d); exp.setMonth(exp.getMonth() + duration);
    if(exp.getDate()!==d.getDate()) exp.setDate(0);
    purchases.push({ date: d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(), customer:customer.value||"عميل", phone:customerPhone.value||"-", sub:sub.value, duration: duration, paid:paid+paidCur, cost:cost+costCur, wallet:wallet.value, expiry: exp.getTime() });
    localStorage.wallets=JSON.stringify(wallets); localStorage.invest=JSON.stringify(invest); localStorage.purchases=JSON.stringify(purchases);
    logAction(`إضافة عملية شراء: ${sub.value} للعميل ${customer.value}`);
    refreshAll(); pushToGithub(); notify("تمت العملية");
    paidAmount.value=""; costAmount.value=""; customer.value=""; sub.value=""; customerPhone.value=""; subDuration.value="1";
}
function refreshAll(){
    refreshWallets(); refreshHistory(); refreshInvestment(); refreshGeneralNotes(); refreshTodoList(); refreshExpiring(); refreshAnalytics(); refreshLogs();
    let p = JSON.parse(localStorage.purchases);
    let todayStr = new Date().getFullYear() + '-' + (new Date().getMonth()+1) + '-' + new Date().getDate();
    document.getElementById("statSales").textContent = p.filter(x => x.date.includes(todayStr)).length;
}
function refreshExpiring() {
    let p = JSON.parse(localStorage.purchases), body = document.getElementById("expiringBody"); body.innerHTML = "";
    let now = new Date().getTime(), days3 = 3 * 86400000;
    let list = p.map((d, i) => ({ d, i })).filter(x => x.d.expiry && !x.d.expiryDismissed && (x.d.expiry - now < days3 && x.d.expiry - now > -2592000000));
    list.sort((a, b) => a.d.expiry - b.d.expiry);
    list.forEach(x => {
        let item = x.d, daysLeft = Math.ceil((item.expiry - now) / 86400000);
        let status = daysLeft <= 0 ? 'منتهي' : daysLeft + ' يوم';
        let wa = `https://wa.me/${item.phone.replace(/\D/g, '').replace(/^0/, '970')}?text=${encodeURIComponent(`مرحباً ${item.customer}، اشتراكك ${item.sub} ينتهي خلال ${status}. هل تود التجديد؟`)}`;
        body.innerHTML += `<tr class="${item.reminded?'reminded':''}"><td><b>${item.sub}</b></td><td>${item.customer}</td><td>${item.phone}</td><td>${new Date(item.expiry).toLocaleDateString('ar-EG')}</td><td><span class="badge ${daysLeft<=0?'badge-danger':'badge-warning'}">${status}</span></td><td><a href="${wa}" target="_blank" onclick="markAsReminded(${x.i})" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> تذكير</a></td></tr>`;
    });
    if(list.length===0) body.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:30px'>لا توجد تنبيهات</td></tr>";
}
function markAsReminded(i) { let p = JSON.parse(localStorage.purchases); p[i].reminded = true; localStorage.purchases = JSON.stringify(p); refreshExpiring(); pushToGithub(); }
function deleteExpired() { 
    if(currentUser.role === 'viewer') return; 
    if(!confirm("إخفاء المنتهي؟")) return; let p = JSON.parse(localStorage.purchases), now = new Date().getTime(); p.forEach(x => { if(x.expiry && x.expiry < now) x.expiryDismissed = true; }); 
    localStorage.purchases = JSON.stringify(p); logAction("إخفاء الاشتراكات المنتهية"); refreshAll(); pushToGithub(); 
}
function refreshWallets(){
    let w=JSON.parse(localStorage.wallets), td=0, ts=0; walletList.innerHTML="";
    for(let k in w){
        let act = w[k].active !== false;
        walletList.innerHTML+=`<tr><td><b>${k}</b></td><td><span class="badge ${w[k].cur=='$'?'badge-success':'badge-info'}">${w[k].cur}</span></td><td style="text-align:center; font-weight:800">${fix(w[k].bal)}</td><td>${act?'<i class="fas fa-check-circle" style="color:var(--success)"></i>':'<i class="fas fa-times-circle" style="color:var(--danger)"></i>'}</td></tr>`;
        if(w[k].cur=="$") td+=w[k].bal; else ts+=w[k].bal;
    }
    statDollar.textContent=fix(td)+" $"; statShekel.textContent=fix(ts)+" ₪";
}
function refreshHistory(){
    historyBody.innerHTML=""; 
    JSON.parse(localStorage.purchases).reverse().forEach(p=>{
        historyBody.innerHTML+=`<tr><td>${p.date}</td><td><b>${p.customer}</b></td><td>${p.phone}</td><td><span class="badge badge-info">${p.sub}</span></td><td>${p.duration||'-'} شهر</td><td style="color:var(--success)">${p.paid}</td><td style="color:var(--danger)">${p.cost}</td><td>${p.wallet}</td></tr>`;
    });
}
function filterHistory() { let v = document.getElementById("historySearch").value.toLowerCase(); document.querySelectorAll("#historyBody tr").forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? "" : "none"); }
function refreshInvestment(){
    let i=JSON.parse(localStorage.invest);
    investBox.innerHTML=`<div class="card" style="border-top:5px solid var(--success)"><div>حصة أحمد</div><div style="font-size:22px; font-weight:900">${fix(i.ahmad.d)}$ | ${fix(i.ahmad.s)}₪</div></div><div class="card" style="border-top:5px solid var(--accent)"><div>حصة محمد</div><div style="font-size:22px; font-weight:900">${fix(i.mohamed.d)}$ | ${fix(i.mohamed.s)}₪</div></div><div class="card" style="border-top:5px solid var(--primary)"><div>رأس مال المتجر</div><div style="font-size:22px; font-weight:900">${fix(i.store.d)}$ | ${fix(i.store.s)}₪</div></div>`;
}
function refreshAnalytics() {
    let invest = JSON.parse(localStorage.invest), purchases = JSON.parse(localStorage.purchases);
    if (myProfitChart) myProfitChart.destroy();
    myProfitChart = new Chart(document.getElementById('profitChart').getContext('2d'), { type: 'doughnut', data: { labels: ['أحمد', 'محمد', 'المتجر'], datasets: [{ data: [invest.ahmad.d*3.5+invest.ahmad.s, invest.mohamed.d*3.5+invest.mohamed.s, invest.store.d*3.5+invest.store.s], backgroundColor: ['#10b981', '#f59e0b', '#6366f1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false } });
    let months = {}, labels = [], data = [];
    for(let i=5; i>=0; i--){ let d = new Date(); d.setMonth(d.getMonth() - i); labels.push((d.getMonth()+1)+'/'+d.getFullYear()); months[labels[labels.length-1]] = 0; }
    purchases.forEach(p => { let d = new Date(p.date), k = (d.getMonth()+1)+'/'+d.getFullYear(); if(months[k] !== undefined) months[k]++; });
    labels.forEach(l => data.push(months[l]));
    if (mySalesChart) mySalesChart.destroy();
    mySalesChart = new Chart(document.getElementById('salesChart').getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'مبيعات', data: data, backgroundColor: '#6366f1', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
}
function addGeneralNote(){ let t=gnText.value.trim(); if(!t)return; let n=JSON.parse(localStorage.generalNotes); n.push({text:t, date:new Date().toLocaleString("ar-EG")}); localStorage.generalNotes=JSON.stringify(n); gnText.value=""; logAction("إضافة ملاحظة جديدة"); refreshGeneralNotes(); pushToGithub(); }
function refreshGeneralNotes(){ 
    let n=JSON.parse(localStorage.generalNotes); generalNotesBox.innerHTML=""; 
    n.forEach((x,i)=>{ 
        let delBtn = (currentUser.role === 'viewer') ? '' : `<i class="fas fa-trash" onclick="deleteNote(${i})" style="color:var(--danger); cursor:pointer"></i>`;
        generalNotesBox.innerHTML+=`<div class="todo-item" style="border-right-color:var(--primary)"><div><small>${x.date}</small><div>${x.text}</div></div>${delBtn}</div>`; 
    }); 
}
function deleteNote(i){ if(currentUser.role === 'viewer') return; let n=JSON.parse(localStorage.generalNotes); n.splice(i,1); localStorage.generalNotes=JSON.stringify(n); logAction("حذف ملاحظة"); refreshGeneralNotes(); pushToGithub(); }
function addTodo(){ let t=todoInput.value.trim(); if(!t)return; let l=JSON.parse(localStorage.todoList); l.push({text:t, date:new Date().toLocaleString("ar-EG")}); localStorage.todoList=JSON.stringify(l); todoInput.value=""; logAction("إضافة مهمة جديدة"); refreshTodoList(); pushToGithub(); }
function refreshTodoList(){ let l=JSON.parse(localStorage.todoList); todoBox.innerHTML=""; l.forEach((x,i)=>[ todoBox.innerHTML+=`<div class="todo-item"><div>${x.text}</div><button class="btn btn-primary" style="padding:5px 10px" onclick="completeTodo(${i})">تمت</button></div>` ]); }
function completeTodo(i){ let l=JSON.parse(localStorage.todoList); logAction(`إكمال مهمة: ${l[i].text}`); l.splice(i,1); localStorage.todoList=JSON.stringify(l); refreshTodoList(); pushToGithub(); }
function withdrawPartial(p){ 
    if(currentUser.role !== 'admin') return notify("للأدمن فقط","error");
    let input = document.getElementById(p==='ahmad'?'withdrawAhmad':p==='mohamed'?'withdrawMohamed':'withdrawStore'), cur = document.getElementById(p==='ahmad'?'curAhmad':p==='mohamed'?'curMohamed':'curStore').value;
    let val = +input.value, i = JSON.parse(localStorage.invest), k = cur === 'd' ? 'd' : 's';
    if(i[p][k] < val) { notify("رصيد غير كافي","error"); return; }
    i[p][k] -= val; localStorage.invest=JSON.stringify(i); refreshInvestment(); input.value=""; 
    logAction(`سحب أرباح بقيمة ${val}${cur} من حصة ${p}`);
    pushToGithub(); notify("تم السحب");
}
function addNewWallet(){ let n=newWalletName.value.trim(), c=newWalletCurrency.value, w=JSON.parse(localStorage.wallets); if(!n||w[n]) return notify("خطأ بالاسم","error"); w[n]={bal:0, cur:c, active:true}; localStorage.wallets=JSON.stringify(w); loadWallets(); refreshWallets(); newWalletName.value=""; logAction(`إنشاء محفظة جديدة: ${n}`); pushToGithub(); notify("تمت"); }
function renameWallet(){ let o=renameWalletSelect.value, n=renameWalletInput.value.trim(), w=JSON.parse(localStorage.wallets); if(!n||w[n]) return notify("خطأ","error"); w[n]=w[o]; delete w[o]; localStorage.wallets=JSON.stringify(w); let p=JSON.parse(localStorage.purchases); p.forEach(x=>{if(x.wallet===o)x.wallet=n}); localStorage.purchases=JSON.stringify(p); loadWallets(); refreshAll(); renameWalletInput.value=""; logAction(`تغيير اسم محفظة من ${o} إلى ${n}`); pushToGithub(); notify("تم"); }
function addToWallet(){ let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal += +modAmount.value; localStorage.wallets=JSON.stringify(w); logAction(`إضافة ${modAmount.value} لمحفظة ${modWallet.value}`); refreshWallets(); pushToGithub(); notify("تم"); }
function subtractFromWallet(){ let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal -= +modAmount.value; localStorage.wallets=JSON.stringify(w); logAction(`خصم ${modAmount.value} من محفظة ${modWallet.value}`); refreshWallets(); pushToGithub(); notify("تم"); }
function setWallet(){ let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal = +modAmount.value; localStorage.wallets=JSON.stringify(w); logAction(`تعيين رصيد محفظة ${modWallet.value} إلى ${modAmount.value}`); refreshWallets(); pushToGithub(); notify("تم"); }
function toggleWalletStatus(){ let n=modWallet.value, w=JSON.parse(localStorage.wallets); w[n].active = !(w[n].active!==false); localStorage.wallets=JSON.stringify(w); logAction(`تغيير حالة محفظة ${n}`); refreshWallets(); pushToGithub(); notify("تم"); }
function deleteWallet(){ if(!confirm("حذف؟"))return; let w=JSON.parse(localStorage.wallets); delete w[modWallet.value]; localStorage.wallets=JSON.stringify(w); logAction(`حذف محفظة ${modWallet.value}`); loadWallets(); refreshWallets(); pushToGithub(); }
function exportData(){ if(currentUser.role === 'viewer') return; let a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(localStorage)],{type:"application/json"})); a.download=`MegaBackup_${new Date().toLocaleDateString()}.json`; a.click(); logAction("تصدير نسخة احتياطية"); }
function importData(){ 
    if(currentUser.role !== 'admin') return notify("للأدمن فقط","error");
    let f=importFile.files[0], r=new FileReader(); 
    r.onload=async (e)=>{ try{ let d=JSON.parse(e.target.result); Object.keys(d).forEach(k=>localStorage.setItem(k,d[k])); notify("تم الاستعادة، جاري التحديث..."); logAction("استيراد بيانات من نسخة احتياطية"); await pushToGithub(true); location.reload(); }catch(err){notify("ملف تالف","error");} }; 
    if(f) r.readAsText(f); else notify("اختر ملف","error"); 
}
function undoLastPurchase(){ 
    if(currentUser.role === 'viewer') return;
    if(!localStorage.lastUndoOp)return notify("لا يوجد","error"); let u=JSON.parse(localStorage.lastUndoOp); localStorage.wallets=JSON.stringify(u.wallets); localStorage.invest=JSON.stringify(u.invest); let p=JSON.parse(localStorage.purchases); p.pop(); localStorage.purchases=JSON.stringify(p); localStorage.removeItem("lastUndoOp"); 
    logAction("تراجع عن آخر عملية شراء"); refreshAll(); pushToGithub(); notify("تم التراجع"); 
}
function clearHistory(){ if(currentUser.role !== 'admin') return notify("للأدمن فقط","error"); if(confirm("مسح الكل؟")){ localStorage.purchases="[]"; logAction("مسح سجل العمليات بالكامل"); refreshHistory(); pushToGithub(); } }

window.onload=init;
</script>
</body>
</html>
