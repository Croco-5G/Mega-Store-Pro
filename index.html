<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Store Pro | Cloud Sync</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%236366f1' d='M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z'/%3E%3C/svg%3E">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- تعريف المتغيرات (CSS Variables) --- */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            
            /* ألوان الوضع الفاتح (الأصلي) */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f8fafc;
            --bg-sidebar: #0f172a;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --stat-card-border: rgba(255,255,255,0.8);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* ألوان القسم الأصفر */
            --yellow-bg: #fefce8;
            --yellow-border: #fde047;
            --yellow-text: #854d0e;
            --yellow-item-bg: #fffbeb;
            --yellow-item-border: #eab308;
            --yellow-item-text: #713f12;
        }

        /* --- ألوان الوضع الليلي --- */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --bg-sidebar: #020617;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --stat-card-border: #334155;
            --card-shadow: none;

            /* تعديل القسم الأصفر لليلي */
            --yellow-bg: rgba(234, 179, 8, 0.1);
            --yellow-border: rgba(234, 179, 8, 0.3);
            --yellow-text: #fde047;
            --yellow-item-bg: rgba(234, 179, 8, 0.15);
            --yellow-item-border: #eab308;
            --yellow-item-text: #fef08a;
        }

        /* تعديل خاص لأيقونات الإحصائيات في الوضع الليلي فقط */
        body.dark-mode .stat-icon[style*="#e0e7ff"] { background: rgba(99, 102, 241, 0.2) !important; color: #818cf8 !important; }
        body.dark-mode .stat-icon[style*="#dcfce7"] { background: rgba(16, 185, 129, 0.2) !important; color: #34d399 !important; }
        body.dark-mode .stat-icon[style*="#fef3c7"] { background: rgba(245, 158, 11, 0.2) !important; color: #fbbf24 !important; }

        /* --- التنسيقات العامة --- */
        * { box-sizing: border-box; font-family: 'Tajawal', 'Plus Jakarta Sans', sans-serif; }

        body {
            background: var(--bg-body);
            margin: 0;
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            right: 0;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: -5px 0 25px rgba(0,0,0,0.2);
            border-left: 1px solid var(--border-color);
        }

        .brand {
            padding: 25px 20px 10px 20px; 
            text-align: center;
            font-size: 20px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        /* Toggle Switch Styles */
        .theme-switch-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 20px;
            gap: 10px;
            font-size: 13px;
            color: #94a3b8;
        }
        
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .theme-switch input { display: none; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Menu */
        .menu-items { padding: 10px; flex-grow: 1; overflow-y: auto; }

        .sidebar button {
            width: 100%;
            padding: 14px 18px;
            margin-bottom: 5px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: #94a3b8;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .sidebar button:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .sidebar button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 30px;
            transition: all 0.3s;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--stat-card-border);
            color: var(--text-main);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 35px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-out;
            color: var(--text-main);
        }
        
        .inner-box {
            background: var(--bg-input) !important;
            border: 1px solid var(--border-color) !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h3 { font-size: 22px; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        h4 { color: var(--text-main); }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-muted); font-size: 14px; }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-main);
            font-size: 15px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        body.dark-mode .btn-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-warning { background: #fffbeb; color: #d97706; }
        body.dark-mode .btn-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .btn-warning:hover { background: #fef3c7; }
        
        .btn-whatsapp { background: #25D366; color: white; font-size: 12px; padding: 8px 12px; }
        .btn-whatsapp:hover { background: #128C7E; }

        .table-container { overflow-x: auto; border-radius: 15px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        th { background: var(--bg-input); padding: 16px; text-align: center; color: var(--text-muted); font-weight: 700; }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); text-align: center; color: var(--text-main); }

        .hidden { display: none; }

        #notification {
            position: fixed; bottom: 30px; left: 30px; padding: 16px 25px; border-radius: 16px; color: white; font-weight: 700; z-index: 2000; display: none; animation: slideIn 0.3s ease-out; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
        }
        
        #syncStatus {
            position: fixed; top: 20px; left: 30px; padding: 8px 15px; border-radius: 50px; font-size: 12px; font-weight: 700; z-index: 2000; 
            background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; transition: all 0.3s;
        }

        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }

        .badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }
        .badge-success { background: #dcfce7; color: var(--success); }
        .badge-info { background: #e0e7ff; color: var(--primary); }
        .badge-danger { background: #fee2e2; color: var(--danger); }
        .badge-warning { background: #fef3c7; color: #d97706; }
        
        body.dark-mode .badge-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        body.dark-mode .badge-info { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
        body.dark-mode .badge-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        body.dark-mode .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }

        .yellow-section {
            background-color: var(--yellow-bg);
            border: 2px solid var(--yellow-border);
            border-radius: 20px;
            padding: 25px;
            color: var(--yellow-text);
        }
        .yellow-section h3 { color: var(--yellow-text) !important; }
        
        .todo-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--yellow-item-bg);
            padding: 15px; border-radius: 12px;
            border-right: 4px solid var(--yellow-item-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px;
            color: var(--yellow-item-text);
        }
        #generalNotesBox .todo-item {
            background: var(--bg-input); 
            border-right: 4px solid var(--primary);
            color: var(--text-main);
        }

        .todo-item > div:first-child {
            flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; padding-left: 15px; white-space: pre-wrap;
        }

        .settings-section, .github-section {
            background: var(--bg-input);
            padding: 20px; border-radius: 18px;
            border: 1px solid var(--border-color);
            margin-top: 20px;
            color: var(--text-main);
        }
        
        .github-section {
            background: #1e293b; color: white; 
        }
        .github-section h3, .github-section h3 i { color: white !important; }
        .github-section label { color: #94a3b8; }
        .github-section input { background: #334155; border-color: #475569; color: white; }

    </style>
</head>

<body>

<div id="syncStatus"><i class="fas fa-cloud"></i> <span>جاهز</span></div>

<div class="sidebar">
    <div class="brand"><i class="fas fa-rocket"></i> MEGA STORE</div>
    
    <div class="theme-switch-container">
        <i class="fas fa-moon"></i>
        <label class="theme-switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
            <span class="slider"></span>
        </label>
        <i class="fas fa-sun"></i>
    </div>

    <div class="menu-items">
        <button onclick="showPage('purchase', this)" class="active"><i class="fas fa-shopping-cart"></i> عملية شراء</button>
        <button onclick="showPage('expiring', this)"><i class="fas fa-hourglass-half"></i> تنبيهات الانتهاء</button>
        <button onclick="showPage('wallets', this)"><i class="fas fa-wallet"></i> أرصدة المحافظ</button>
        <button onclick="showPage('history', this)"><i class="fas fa-history"></i> سجل العمليات</button>
        <button onclick="showPage('analytics', this)"><i class="fas fa-chart-bar"></i> الإحصائيات</button>
        <button onclick="showPage('investment', this)"><i class="fas fa-chart-line"></i> توزيع الأرباح</button>
        <button onclick="showPage('generalNotes', this)"><i class="fas fa-sticky-note"></i> ملاحظات</button>
        <button onclick="showPage('backup', this)"><i class="fas fa-database"></i> النسخ الاحتياطي</button>
        <button onclick="showPage('modify', this)"><i class="fas fa-cog"></i> الإعدادات</button>
    </div>
</div>

<div class="main-content">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e0e7ff; color: var(--primary);"><i class="fas fa-dollar-sign"></i></div>
            <div>
                <label>إجمالي الدولار</label>
                <div id="statDollar" style="font-size: 20px; font-weight: 800;">0.00 $</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #dcfce7; color: var(--success);"><i class="fas fa-coins"></i></div>
            <div>
                <label>إجمالي الشيكل</label>
                <div id="statShekel" style="font-size: 20px; font-weight: 800;">0.00 ₪</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fef3c7; color: var(--accent);"><i class="fas fa-shopping-bag"></i></div>
            <div>
                <label>عمليات اليوم</label>
                <div id="statSales" style="font-size: 20px; font-weight: 800;">0</div>
            </div>
        </div>
    </div>

    <div id="notification"></div>

    <div id="purchase" class="card">
        <h3><i class="fas fa-cart-plus"></i> تسجيل اشتراك جديد</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group">
                <label>نوع الاشتراك</label>
                <input id="sub" placeholder="مثال: نيتفليكس، يوتيوب...">
            </div>
            <div class="input-group">
                <label>اسم العميل</label>
                <input id="customer" placeholder="اسم العميل">
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group">
                <label>رقم جوال العميل</label>
                <input id="customerPhone" placeholder="059xxxxxxx">
            </div>
            <div class="input-group">
                <label>مدة الاشتراك</label>
                <select id="subDuration">
                    <option value="1">1 شهر</option>
                    <option value="2">2 شهر</option>
                    <option value="3">3 شهور</option>
                    <option value="4">4 شهور</option>
                    <option value="5">5 شهور</option>
                    <option value="6">6 شهور</option>
                    <option value="7">7 شهور</option>
                    <option value="8">8 شهور</option>
                    <option value="9">9 شهور</option>
                    <option value="10">10 شهور</option>
                    <option value="11">11 شهر</option>
                    <option value="12">12 شهر (سنة)</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
            <div class="input-group">
                <label>المبلغ المدفوع من العميل</label>
                <div style="display:flex; gap:10px">
                    <input type="number" id="paidAmount" placeholder="0.00">
                    <select id="paidCurrency" style="width:120px"><option value="₪">₪ شيكل</option><option value="$">$ دولار</option></select>
                </div>
            </div>
            <div class="input-group">
                <label>التكلفة علينا</label>
                <div style="display:flex; gap:10px">
                    <input type="number" id="costAmount" placeholder="0.00">
                    <select id="costCurrency" style="width:120px"><option value="$">$ دولار</option><option value="₪">₪ شيكل</option></select>
                </div>
            </div>
        </div>

        <div class="inner-box" style="padding: 25px; border-radius: 18px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-style: dashed;">
            <div>
                <label>يُخصم من محفظة (المصدر):</label>
                <select id="fromWallet"></select>
            </div>
            <div>
                <label>يُودع الربح في محفظة:</label>
                <select id="wallet"></select>
            </div>
        </div>

        <button class="btn btn-primary" style="width:100%; margin-top:30px; padding: 16px;" onclick="addPurchase()">
            <i class="fas fa-check-circle"></i> إتمام العملية وحفظ البيانات
        </button>
    </div>

    <div id="expiring" class="card hidden">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin-bottom:0"><i class="fas fa-hourglass-half"></i> اشتراكات تنتهي قريباً</h3>
            <button class="btn btn-danger" onclick="deleteExpired()" style="padding: 8px 15px; font-size:13px; background:#ef4444; color:white;">
                <i class="fas fa-trash-alt"></i> حذف المنتهي
            </button>
        </div>

        <p style="color:var(--text-muted); margin-bottom:20px">يتم عرض الاشتراكات المتبقي لها 3 أيام أو أقل، أو التي انتهت بالفعل.</p>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>الخدمة</th>
                        <th>اسم العميل</th>
                        <th>رقم الجوال</th>
                        <th>ينتهي بتاريخ</th>
                        <th>المتبقي</th>
                        <th>مراسلة</th>
                    </tr>
                </thead>
                <tbody id="expiringBody"></tbody>
            </table>
        </div>
    </div>

    <div id="analytics" class="card hidden">
        <h3><i class="fas fa-chart-bar"></i> الإحصائيات والرسوم البيانية</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div class="inner-box" style="padding: 20px; border-radius: 20px;">
                <h4 style="text-align:center; margin-bottom:15px">توزيع الأرباح الكلية</h4>
                <canvas id="profitChart" style="max-height: 300px;"></canvas>
            </div>
            <div class="inner-box" style="padding: 20px; border-radius: 20px;">
                <h4 style="text-align:center; margin-bottom:15px">عدد المبيعات آخر 6 شهور</h4>
                <canvas id="salesChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <div id="wallets" class="card hidden">
        <h3><i class="fas fa-wallet"></i> توزيع السيولة في المحافظ</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>المحفظة</th><th>العملة</th><th style="text-align:center">الرصيد</th><th>الحالة</th></tr>
                </thead>
                <tbody id="walletList"></tbody>
            </table>
        </div>
    </div>

    <div id="history" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
            <h3><i class="fas fa-list-ul"></i> الأرشيف المالي</h3>
            <div style="display:flex; gap:10px">
                <button class="btn btn-primary" onclick="undoLastPurchase()"><i class="fas fa-undo"></i> تراجع</button>
                <button class="btn btn-danger" onclick="clearHistory()"><i class="fas fa-trash"></i> مسح الكل</button>
            </div>
        </div>

        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="historySearch" onkeyup="filterHistory()" placeholder="ابحث باسم العميل، الخدمة، أو المحفظة..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>العميل</th>
                        <th>الجوال</th>
                        <th>الخدمة</th>
                        <th>المدة</th>
                        <th>الدفع</th>
                        <th>التكلفة</th>
                        <th>المحفظة</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <div id="investment" class="card hidden">
        <h3><i class="fas fa-chart-pie"></i> حصص الشركاء والاستثمار</h3>
        <div id="investBox" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
        
        <div class="inner-box" style="margin-top:40px; padding:30px; border-radius:20px;">
            <h4 style="margin-top:0; color:var(--danger)"><i class="fas fa-external-link-alt"></i> طلب سحب أرباح</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                <div class="input-group">
                    <label>سحب من حصة أحمد</label>
                    <div style="display:flex; gap:5px">
                        <input id="withdrawAhmad" type="number" placeholder="0.00">
                        <select id="curAhmad" style="width:70px"><option value="d">$</option><option value="s">₪</option></select>
                        <button class="btn btn-danger" onclick="withdrawPartial('ahmad')">سحب</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>سحب من حصة محمد</label>
                    <div style="display:flex; gap:5px">
                        <input id="withdrawMohamed" type="number" placeholder="0.00">
                        <select id="curMohamed" style="width:70px"><option value="d">$</option><option value="s">₪</option></select>
                        <button class="btn btn-danger" onclick="withdrawPartial('mohamed')">سحب</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>سحب من حصة المتجر</label>
                    <div style="display:flex; gap:5px">
                        <input id="withdrawStore" type="number" placeholder="0.00">
                        <select id="curStore" style="width:70px"><option value="d">$</option><option value="s">₪</option></select>
                        <button class="btn btn-danger" onclick="withdrawPartial('store')">سحب</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modify" class="card hidden">
        
        <h3 style="margin-top:0"><i class="fas fa-edit"></i> التحكم اليدوي بالأرصدة</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
            <div class="input-group"><label>المحفظة</label><select id="modWallet"></select></div>
            <div class="input-group"><label>المبلغ</label><input id="modAmount" type="number" placeholder="0.00"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:40px">
            <button class="btn btn-primary" onclick="addToWallet()">إضافة</button>
            <button class="btn btn-danger" onclick="subtractFromWallet()">خصم</button>
            <button class="btn btn-primary" style="background:#0ea5e9" onclick="setWallet()">تعيين مباشر</button>
            <button class="btn btn-warning" onclick="toggleWalletStatus()">
                <i class="fas fa-toggle-on"></i> تغيير الحالة (نشط/معطل)
            </button>
            <button class="btn btn-danger" onclick="deleteWallet()">حذف المحفظة</button>
        </div>

        <h3><i class="fas fa-plus-circle"></i> إدارة المحافظ</h3>
        <div class="inner-box" style="display:flex; gap:15px; padding:20px; border-radius:15px; margin-bottom:40px">
            <input id="newWalletName" placeholder="اسم المحفظة الجديدة">
            <select id="newWalletCurrency" style="width:150px"><option value="$">$ دولار</option><option value="₪">₪ شيكل</option></select>
            <button class="btn btn-primary" onclick="addNewWallet()">إنشاء</button>
        </div>

        <h3><i class="fas fa-edit"></i> تعديل اسم محفظة</h3>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:10px">تنبيه: سيتم نقل الرصيد وتحديث سجل العمليات القديم للاسم الجديد.</p>
        <div class="inner-box" style="display:flex; gap:15px; padding:20px; border-radius:15px; margin-bottom:40px">
            <select id="renameWalletSelect" style="width:200px"></select>
            <input id="renameWalletInput" placeholder="الاسم الجديد للمحفظة">
            <button class="btn btn-warning" onclick="renameWallet()">تغيير الاسم</button>
        </div>

        <h3><i class="fas fa-percent"></i> إعدادات توزيع الأرباح</h3>
        <div class="settings-section" style="margin-bottom:40px; margin-top:0;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="input-group">
                    <label>نسبة أحمد (%)</label>
                    <input type="number" id="setAhmadProp" placeholder="35">
                </div>
                <div class="input-group">
                    <label>نسبة محمد (%)</label>
                    <input type="number" id="setMohamedProp" placeholder="35">
                </div>
                <div class="input-group">
                    <label>نسبة المتجر (%)</label>
                    <input type="number" id="setStoreProp" placeholder="30">
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="setDeductCost" style="width: 20px; height: 20px; cursor: pointer;">
                <label for="setDeductCost" style="margin-bottom: 0; cursor: pointer;">خصم التكاليف من الإجمالي قبل توزيع الربح؟</label>
            </div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
            
            <div class="input-group">
                <label>سعر صرف الدولار الثابت (مقابل الشيكل)</label>
                <div style="display:flex; align-items:center; gap:10px">
                    <input type="number" id="setExchangeRate" placeholder="أدخل السعر (مثلاً 3.5)">
                    <small style="color:var(--text-muted); width: 100%;">اتركه 0 أو فارغاً إذا كنت تريد أن يسألك النظام في كل مرة.</small>
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveProfitSettings()">حفظ إعدادات النظام</button>
        </div>

        <div class="github-section" style="margin-bottom:40px; margin-top:0;">
            <h3><i class="fab fa-github"></i> إعدادات الربط السحابي (GitHub)</h3>
            <p style="color:#94a3b8; font-size:14px; margin-bottom:15px">اربط الموقع بمستودع خاص لحفظ البيانات بشكل دائم وآمن على السحابة.</p>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                <div class="input-group">
                    <label>اسم المستخدم (Username)</label>
                    <input id="ghUser" placeholder="ex: myname">
                </div>
                <div class="input-group">
                    <label>اسم المستودع (Repo)</label>
                    <input id="ghRepo" placeholder="ex: my-shop">
                </div>
                <div class="input-group">
                    <label>المفتاح السري (Token)</label>
                    <input id="ghToken" type="password" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div class="input-group">
                    <label>اسم الملف (اختياري)</label>
                    <input id="ghFile" placeholder="db.json" value="db.json">
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button class="btn btn-primary" onclick="saveGithubSettings()">حفظ إعدادات الربط</button>
                <button class="btn btn-warning" onclick="fetchFromGithub()"><i class="fas fa-download"></i> سحب البيانات الآن</button>
                <button class="btn btn-success" style="background:var(--success); color:#fff" onclick="pushToGithub()"><i class="fas fa-upload"></i> رفع البيانات الآن</button>
            </div>
        </div>

        <div class="yellow-section">
            <h3><i class="fas fa-tasks"></i> قائمة المهام (To-Do)</h3>
            <div style="display:flex; gap:15px; margin-bottom:20px">
                <input id="todoInput" placeholder="اكتب المهمة...">
                <button class="btn btn-primary" onclick="addTodo()">إضافة</button>
            </div>
            <div id="todoBox"></div>
        </div>
    </div>

    <div id="generalNotes" class="card hidden">
        <h3><i class="fas fa-pen-fancy"></i> المفكرة</h3>
        <div style="display:flex; gap:15px">
            <textarea id="gnText" placeholder="اكتب ملاحظة..." style="height: 60px;"></textarea>
            <button class="btn btn-primary" onclick="addGeneralNote()">حفظ</button>
        </div>
        <div id="generalNotesBox" style="margin-top:30px;"></div>
    </div>

    <div id="backup" class="card hidden">
        <h3><i class="fas fa-shield-alt"></i> حماية البيانات</h3>
        <div style="text-align:center; padding:40px; border:2px dashed var(--border-color); border-radius:30px">
            <i class="fas fa-cloud-download-alt" style="font-size:50px; color:var(--primary); margin-bottom:20px"></i>
            <p style="color:var(--text-main)">احتفظ بنسخة احتياطية من بياناتك دائماً.</p>
            <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> تحميل النسخة الاحتياطية</button>
            <div style="margin: 30px 0; border-top:1px solid var(--border-color)"></div>
            <input type="file" id="importFile" style="width:auto; margin-bottom:10px">
            <br>
            <button class="btn btn-danger" style="background:var(--bg-input); color:var(--text-muted); border:1px solid var(--border-color)" onclick="importData()">استعادة بيانات</button>
        </div>
    </div>

</div>

<script>
const fix=n=>Number(n).toFixed(2);
let myProfitChart = null;
let mySalesChart = null;

// --- GITHUB INTEGRATION VARS ---
let ghConfig = {
    user: localStorage.getItem("gh_user") || "",
    repo: localStorage.getItem("gh_repo") || "",
    token: localStorage.getItem("gh_token") || "",
    file: localStorage.getItem("gh_file") || "db.json",
    sha: "" // Needed for updates
};

function updateSyncStatus(msg, type="loading") {
    const el = document.getElementById("syncStatus");
    if(type==="loading") {
        el.innerHTML = `<i class="fas fa-circle-notch fa-spin" style="color:var(--primary)"></i> <span>${msg}</span>`;
    } else if (type==="success") {
        el.innerHTML = `<i class="fas fa-check" style="color:var(--success)"></i> <span>${msg}</span>`;
        setTimeout(() => el.innerHTML = `<i class="fas fa-cloud"></i> <span>متزامن</span>`, 3000);
    } else if (type==="error") {
        el.innerHTML = `<i class="fas fa-times" style="color:var(--danger)"></i> <span>${msg}</span>`;
    } else {
        el.innerHTML = `<i class="fas fa-cloud"></i> <span>${msg}</span>`;
    }
}

async function fetchFromGithub() {
    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) {
        updateSyncStatus("غير متصل", "idle");
        return;
    }
    
    updateSyncStatus("جاري سحب البيانات...");
    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;
    
    try {
        const response = await fetch(url, {
            headers: { 
                'Authorization': `token ${ghConfig.token}`,
                'Accept': 'application/vnd.github.v3+json'
            },
            cache: "no-store"
        });

        if (response.status === 404) {
            updateSyncStatus("الملف غير موجود (سيرفع جديد)", "idle");
            return; // File doesn't exist yet
        }
        
        if (!response.ok) throw new Error("GitHub API Error");

        const data = await response.json();
        ghConfig.sha = data.sha;
        
        // Decode Content
        const content = decodeURIComponent(escape(atob(data.content)));
        const db = JSON.parse(content);

        // Update LocalStorage
        if(db.wallets) localStorage.wallets = JSON.stringify(db.wallets);
        if(db.purchases) localStorage.purchases = JSON.stringify(db.purchases);
        if(db.invest) localStorage.invest = JSON.stringify(db.invest);
        if(db.settings) localStorage.settings = JSON.stringify(db.settings);
        if(db.generalNotes) localStorage.generalNotes = JSON.stringify(db.generalNotes);
        if(db.todoList) localStorage.todoList = JSON.stringify(db.todoList);

        // Refresh UI
        loadWallets();
        loadProfitSettings();
        refreshAll();
        updateSyncStatus("تم التحديث", "success");

    } catch (error) {
        console.error(error);
        updateSyncStatus("فشل الاتصال", "error");
        notify("فشل سحب البيانات من GitHub، تأكد من الإعدادات", "error");
    }
}

async function pushToGithub() {
    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) {
        notify("يرجى ضبط إعدادات GitHub أولاً", "error");
        return;
    }

    updateSyncStatus("جاري الحفظ...");

    // Prepare Data
    const db = {
        wallets: JSON.parse(localStorage.wallets || "{}"),
        purchases: JSON.parse(localStorage.purchases || "[]"),
        invest: JSON.parse(localStorage.invest || "{}"),
        settings: JSON.parse(localStorage.settings || "{}"),
        generalNotes: JSON.parse(localStorage.generalNotes || "[]"),
        todoList: JSON.parse(localStorage.todoList || "[]"),
        lastUpdate: new Date().toISOString()
    };

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;

    const body = {
        message: "Update data via MegaStore App",
        content: content
    };
    if (ghConfig.sha) body.sha = ghConfig.sha;

    try {
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${ghConfig.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) throw new Error("Failed to upload");

        const data = await response.json();
        ghConfig.sha = data.content.sha;
        updateSyncStatus("تم الحفظ سحابياً", "success");

    } catch (error) {
        console.error(error);
        // If failed due to SHA mismatch, try to fetch first then push again? 
        // For simplicity:
        updateSyncStatus("فشل الرفع", "error");
        notify("فشل رفع البيانات، ربما يوجد تعارض. حاول سحب البيانات أولاً.", "error");
    }
}

function saveGithubSettings() {
    const u = document.getElementById("ghUser").value.trim();
    const r = document.getElementById("ghRepo").value.trim();
    const t = document.getElementById("ghToken").value.trim();
    const f = document.getElementById("ghFile").value.trim() || "db.json";

    if(!u || !r || !t) return notify("يرجى تعبئة جميع الحقول", "error");

    localStorage.setItem("gh_user", u);
    localStorage.setItem("gh_repo", r);
    localStorage.setItem("gh_token", t);
    localStorage.setItem("gh_file", f);
    
    ghConfig.user = u;
    ghConfig.repo = r;
    ghConfig.token = t;
    ghConfig.file = f;

    notify("تم حفظ الإعدادات، جاري الاتصال...", "success");
    fetchFromGithub();
}

function loadGithubInputs() {
    document.getElementById("ghUser").value = ghConfig.user;
    document.getElementById("ghRepo").value = ghConfig.repo;
    document.getElementById("ghToken").value = ghConfig.token;
    document.getElementById("ghFile").value = ghConfig.file;
}

// --- END GITHUB INTEGRATION ---

function init(){
    if(!localStorage.wallets){
        localStorage.wallets=JSON.stringify({
            "جوال باي — سعاد":{bal:0, cur:"₪", active:true},
            "جوال باي — محمد":{bal:0, cur:"₪", active:true},
            "بال باي — أحمد":{bal:0, cur:"₪", active:true},
            "بايننس — احمد":{bal:0, cur:"$", active:true}
        });
    }
    if(!localStorage.purchases) localStorage.purchases="[]";
    if(!localStorage.invest) localStorage.invest=JSON.stringify({ahmad:{d:0,s:0},mohamed:{d:0,s:0},store:{d:0,s:0}});
    if(!localStorage.generalNotes) localStorage.generalNotes="[]";
    if(!localStorage.todoList) localStorage.todoList="[]";
    
    // إعدادات افتراضية للنسب + سعر الصرف
    if(!localStorage.settings) {
        localStorage.settings = JSON.stringify({ahmad: 35, mohamed: 35, store: 30, deductCost: true, exchangeRate: 0});
    }
    
    loadWallets();
    loadProfitSettings();
    loadGithubInputs(); // Load GH inputs
    
    // Check Dark Mode
    if(localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        document.getElementById("darkModeToggle").checked = true;
    }

    // Attempt Initial Sync
    if(ghConfig.token) {
        fetchFromGithub();
    } else {
        refreshAll();
    }
}

// TOGGLE DARK MODE FUNCTION
function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
}

// FILTER HISTORY FUNCTION
function filterHistory() {
    let input = document.getElementById("historySearch").value.toLowerCase();
    let rows = document.querySelectorAll("#historyBody tr");
    rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
}

function showPage(id, btn){
    document.querySelectorAll(".card").forEach(x=>x.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    if(btn) btn.classList.add("active");
    
    // تحديث المحتوى عند الدخول للصفحة فوراً
    if(id === 'generalNotes') refreshGeneralNotes();
    if(id === 'investment') refreshInvestment();
    if(id === 'history') refreshHistory();
    if(id === 'wallets') refreshWallets();
    if(id === 'expiring') refreshExpiring();
    if(id === 'analytics') refreshAnalytics();
}

function notify(msg,type="success"){
    let n=document.getElementById("notification");
    n.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}"></i> ` + msg;
    n.style.background=type==="success"?"#10b981":"#ef4444";
    n.style.display="block";
    setTimeout(()=>{n.style.display="none";},3000);
}

function loadWallets(){
    let wallets=JSON.parse(localStorage.wallets);
    const selects = [wallet, modWallet, fromWallet, renameWalletSelect];
    selects.forEach(s => {
        if(s) {
            s.innerHTML = "";
            Object.keys(wallets).forEach(w=>{
                let o=document.createElement("option"); o.value=w; o.text=w;
                s.appendChild(o);
            });
        }
    });
}

function loadProfitSettings(){
    let s = JSON.parse(localStorage.settings);
    setAhmadProp.value = s.ahmad;
    setMohamedProp.value = s.mohamed;
    setStoreProp.value = s.store;
    setDeductCost.checked = s.deductCost;
    setExchangeRate.value = s.exchangeRate || 0;
}

function saveProfitSettings(){
    let a = +setAhmadProp.value;
    let m = +setMohamedProp.value;
    let s = +setStoreProp.value;
    if(a + m + s !== 100){ notify("مجموع النسب يجب أن يساوي 100%","error"); return; }
    
    localStorage.settings = JSON.stringify({
        ahmad: a, 
        mohamed: m, 
        store: s, 
        deductCost: setDeductCost.checked,
        exchangeRate: +setExchangeRate.value
    });
    pushToGithub(); // AUTO SAVE
    notify("تم حفظ إعدادات النظام بنجاح");
}

function addPurchase(){
    if(paidAmount.value === "" || costAmount.value === "") { 
        notify("يرجى ملء كافة البيانات (يمكن استخدام 0)","error"); 
        return; 
    }

    let paid=+paidAmount.value; 
    let cost=+costAmount.value;
    let paidCur=paidCurrency.value; 
    let costCur=costCurrency.value;
    let wallets=JSON.parse(localStorage.wallets);
    let invest=JSON.parse(localStorage.invest);
    let purchases=JSON.parse(localStorage.purchases);
    let settings=JSON.parse(localStorage.settings);
    let from=fromWallet.value;
    let duration = +subDuration.value; // عدد الأشهر

    // التحقق من الرصيد في المحفظة
    if(wallets[from].bal < cost && wallets[from].cur == costCur){notify("رصيد المحفظة المصدر غير كافي","error"); return;}

    let undoSnapshot = {
        wallets: JSON.parse(JSON.stringify(wallets)), 
        invest: JSON.parse(JSON.stringify(invest))
    };
    localStorage.setItem("lastUndoOp", JSON.stringify(undoSnapshot));
    
    // 1. خصم التكلفة من المحفظة المحددة (Cash Deduction)
    wallets[from].bal -= cost;

    // الحصول على سعر الصرف
    let rate = 0;
    if(settings.exchangeRate && settings.exchangeRate > 0) {
        rate = settings.exchangeRate;
    } else if (paidCur !== costCur) { // نطلب السعر فقط إذا اختلفت العملات واحتجنا التحويل
        rate = +prompt("سعر الصرف الحالي (1 دولار كم يساوي شيكل؟)");
        if(!rate && rate !== 0) { notify("تم إلغاء العملية: لم يتم إدخال سعر الصرف", "error"); return; }
    }

    // 2. خصم التكلفة من استثمار المتجر (Capital Deduction)
    // المنطق: الخصم يكون بعملة التكلفة، وإذا لم يكفِ الرصيد نحول من العملة الأخرى
    if(costCur === '$') {
        // التكلفة بالدولار
        if(invest.store.d >= cost) {
            invest.store.d -= cost;
        } else {
            // الدولار لا يكفي، نأخذ الموجود ونخصم الباقي من الشيكل
            let remainder = cost - invest.store.d;
            invest.store.d = 0;
            // تحويل الباقي لشيكل (دولار * سعر الصرف = شيكل)
            // ملاحظة: نحتاج سعر صرف هنا حتى لو كانت عملة الدفع دولار، لأننا سنخصم من الشيكل
            if(rate === 0) rate = +prompt("رصيد استثمار الدولار لا يكفي. أدخل سعر الصرف للخصم من الشيكل:");
            invest.store.s -= (remainder * rate); 
        }
    } else {
        // التكلفة بالشيكل
        if(invest.store.s >= cost) {
            invest.store.s -= cost;
        } else {
            // الشيكل لا يكفي، نأخذ الموجود ونخصم الباقي من الدولار
            let remainder = cost - invest.store.s;
            invest.store.s = 0;
            // تحويل الباقي لدولار (شيكل / سعر الصرف = دولار)
            if(rate === 0) rate = +prompt("رصيد استثمار الشيكل لا يكفي. أدخل سعر الصرف للخصم من الدولار:");
            invest.store.d -= (remainder / rate);
        }
    }

    // 3. حساب وتوزيع الأرباح + استرداد التكلفة (Profit Distribution & Reimbursement)
    let profitBase = paid;
    let costInPaidCurrency = 0;

    if(settings.deductCost){
        if(paidCur === costCur){
            // العملات متطابقة
            profitBase = paid - cost;
            costInPaidCurrency = cost;
        } else {
            // العملات مختلفة: نحول التكلفة لعملة العميل
            let costConverted = 0;
            if(paidCur == "$") { // العميل دفع دولار، التكلفة شيكل
                costConverted = cost / rate; 
            } else { // العميل دفع شيكل، التكلفة دولار
                costConverted = cost * rate; 
            }
            profitBase = paid - costConverted;
            costInPaidCurrency = costConverted;
        }
    }

    // حساب حصص الربح
    let aProfit = +(profitBase * (settings.ahmad/100)).toFixed(2);
    let mProfit = +(profitBase * (settings.mohamed/100)).toFixed(2);
    let sProfit = +(profitBase * (settings.store/100)).toFixed(2);

    // التوزيع يعتمد كلياً على عملة الدفع (paidCur)
    if(paidCur=="$"){
        invest.ahmad.d += aProfit; 
        invest.mohamed.d += mProfit; 
        invest.store.d += sProfit;
        // استرداد رأس مال المتجر بنفس عملة الدفع
        if(settings.deductCost) invest.store.d += costInPaidCurrency;
    } else {
        invest.ahmad.s += aProfit; 
        invest.mohamed.s += mProfit; 
        invest.store.s += sProfit;
        // استرداد رأس مال المتجر بنفس عملة الدفع
        if(settings.deductCost) invest.store.s += costInPaidCurrency;
    }

    // إضافة المبلغ المقبوض للمحفظة المستلمة
    wallets[wallet.value].bal += paid;

    // --- حساب تاريخ الانتهاء (المنطق الجديد الذكي) ---
    let d = new Date(); 
    let expiryDate = new Date(d); 
    let currentDay = expiryDate.getDate();
    expiryDate.setMonth(expiryDate.getMonth() + duration);
    if (expiryDate.getDate() !== currentDay) {
        expiryDate.setDate(0); 
    }
    let expiryTimestamp = expiryDate.getTime();
    // ------------------------------------------------

    let dateStr = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();

    let pObj={
        date: dateStr, 
        customer:customer.value || "عميل عابر",
        phone:customerPhone.value || "-",
        sub:sub.value, 
        duration: duration,
        paid:paid+paidCur, 
        cost:cost+costCur, 
        wallet:wallet.value,
        expiry: expiryTimestamp
    };
    purchases.push(pObj);

    localStorage.wallets=JSON.stringify(wallets);
    localStorage.invest=JSON.stringify(invest);
    localStorage.purchases=JSON.stringify(purchases);

    refreshAll(); 
    pushToGithub(); // AUTO SAVE
    notify("تم تسجيل العملية بنجاح");
    paidAmount.value=""; costAmount.value=""; customer.value=""; sub.value=""; customerPhone.value=""; subDuration.value="1";
}

function refreshAll(){
    refreshWallets(); refreshHistory(); refreshInvestment(); refreshGeneralNotes(); refreshTodoList(); refreshExpiring();
    let p = JSON.parse(localStorage.purchases);
    let todayStr = new Date().getFullYear() + '-' + (new Date().getMonth()+1) + '-' + new Date().getDate();
    document.getElementById("statSales").textContent = p.filter(x => x.date.includes(todayStr) || x.date.includes(new Date().toLocaleDateString("ar-EG"))).length;
}

function refreshExpiring() {
    let p = JSON.parse(localStorage.purchases);
    let expiringBody = document.getElementById("expiringBody");
    expiringBody.innerHTML = "";
    
    let now = new Date().getTime();
    let threeDaysInMs = 3 * 24 * 60 * 60 * 1000;

    let list = p.filter(item => {
        if(!item.expiry) return false;
        let diff = item.expiry - now;
        // عرض ما تبقى له 3 أيام أو انتهى خلال آخر 30 يوم
        return diff < threeDaysInMs && diff > -(30 * 24 * 60 * 60 * 1000); 
    });

    list.sort((a, b) => a.expiry - b.expiry);

    list.forEach(item => {
        let expDate = new Date(item.expiry);
        let dateStr = expDate.getFullYear() + '-' + (expDate.getMonth()+1) + '-' + expDate.getDate();
        let daysLeft = Math.ceil((item.expiry - now) / (1000 * 60 * 60 * 24));
        
        let badgeClass = daysLeft <= 0 ? 'badge-danger' : 'badge-warning';
        let statusText = daysLeft <= 0 ? 'منتهي' : daysLeft + ' يوم';

        // --- WhatsApp Logic ---
        let currentHour = new Date().getHours();
        let greeting = currentHour < 12 ? "صباح الخير" : "مساء الخير";
        let message = `${greeting} ${item.customer}، حابّين نخبّرك أن اشتراكك في ${item.sub} متبقّي على إنتهائه ${statusText}، هل عجبتك الخدمة و حابب تجدد اشتراكك مرة تانية؟`;
        
        // --- Smart Phone Number Parsing ---
        let cleanPhone = item.phone.replace(/\D/g, ''); // تنظيف من الرموز
        let finalPhone = cleanPhone;

        // اذا يبدأ بـ 0 (مثل 059)، نحذف الـ 0 ونضيف 970
        if (cleanPhone.startsWith('0')) {
            finalPhone = '970' + cleanPhone.substring(1);
        }
        // لو الرقم أصلاً فيه مقدمة دولية (مثل 972 أو 970) نتركه كما هو
        // هذا يحل المشكلة تبعت التكرار

        let waLink = `https://wa.me/${finalPhone}?text=${encodeURIComponent(message)}`;
        
        expiringBody.innerHTML += `
            <tr>
                <td><b>${item.sub}</b></td>
                <td>${item.customer}</td>
                <td>${item.phone}</td>
                <td>${dateStr}</td>
                <td><span class="badge ${badgeClass}">${statusText}</span></td>
                <td>
                    <a href="${waLink}" target="_blank" class="btn btn-whatsapp" style="text-decoration:none; border-radius:8px">
                        <i class="fab fa-whatsapp"></i> تذكير
                    </a>
                </td>
            </tr>
        `;
    });
    
    if(list.length === 0) {
        expiringBody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:30px'>لا توجد اشتراكات تنتهي قريباً</td></tr>";
    }
}

// Function to delete expired subscriptions
function deleteExpired() {
    if(!confirm("هل أنت متأكد؟ سيتم حذف الاشتراكات المنتهية من السجل نهائياً!")) return;

    let p = JSON.parse(localStorage.purchases);
    let now = new Date().getTime();

    // Keep subscriptions that are NOT expired (expiry > now)
    let newP = p.filter(item => {
        if(!item.expiry) return true; // Keep if no expiry
        return item.expiry > now; // Keep if future
    });

    localStorage.purchases = JSON.stringify(newP);
    refreshAll();
    pushToGithub(); // Auto save
    notify("تم حذف الاشتراكات المنتهية");
}

function refreshWallets(){
    let w=JSON.parse(localStorage.wallets); walletList.innerHTML="";
    let td=0; let ts=0;
    for(let k in w){
        let isActive = (w[k].active !== false); 
        
        let statusHtml = isActive 
            ? `<span style="color:var(--success); font-weight:800; display:flex; align-items:center; gap:5px"><i class="fas fa-check-circle"></i> نشط</span>` 
            : `<span style="color:var(--danger); font-weight:800; display:flex; align-items:center; gap:5px"><i class="fas fa-times-circle"></i> معطل</span>`;

        walletList.innerHTML+=`<tr>
            <td><b>${k}</b></td>
            <td><span class="badge ${w[k].cur=='$'?'badge-success':'badge-info'}">${w[k].cur=='$'?'دولار':'شيكل'}</span></td>
            <td style="text-align:center; font-weight:800">${fix(w[k].bal)}</td>
            <td>${statusHtml}</td>
        </tr>`;
        
        if(w[k].cur=="$") td+=w[k].bal; else ts+=w[k].bal;
    }
    statDollar.textContent=fix(td)+" $"; statShekel.textContent=fix(ts)+" ₪";
}

function refreshHistory(){
    historyBody.innerHTML=""; 
    JSON.parse(localStorage.purchases).reverse().forEach(p=>{
        let durationTxt = p.duration ? (p.duration + " شهر") : "-";
        historyBody.innerHTML+=`<tr><td>${p.date}</td><td><b>${p.customer}</b></td><td>${p.phone}</td><td><span class="badge badge-info">${p.sub}</span></td><td>${durationTxt}</td><td style="color:var(--success)">${p.paid}</td><td style="color:var(--danger)">${p.cost}</td><td>${p.wallet}</td></tr>`;
    });
    // Re-apply filter if text exists
    let searchVal = document.getElementById("historySearch");
    if(searchVal && searchVal.value) filterHistory();
}

function refreshInvestment(){
    let i=JSON.parse(localStorage.invest);
    investBox.innerHTML=`
        <div class="card" style="border-top:5px solid var(--success)"><div>حصة أحمد</div><div style="font-size:22px; font-weight:900">${fix(i.ahmad.d)}$ | ${fix(i.ahmad.s)}₪</div></div>
        <div class="card" style="border-top:5px solid var(--accent)"><div>حصة محمد</div><div style="font-size:22px; font-weight:900">${fix(i.mohamed.d)}$ | ${fix(i.mohamed.s)}₪</div></div>
        <div class="card" style="border-top:5px solid var(--primary)"><div>رأس مال المتجر</div><div style="font-size:22px; font-weight:900">${fix(i.store.d)}$ | ${fix(i.store.s)}₪</div></div>`;
}

function refreshAnalytics() {
    let invest = JSON.parse(localStorage.invest);
    let purchases = JSON.parse(localStorage.purchases);

    // 1. Profit Chart (Pie)
    let rate = 3.5; 
    let aTotal = invest.ahmad.d * rate + invest.ahmad.s;
    let mTotal = invest.mohamed.d * rate + invest.mohamed.s;
    let sTotal = invest.store.d * rate + invest.store.s;

    if (myProfitChart) myProfitChart.destroy();
    let ctxP = document.getElementById('profitChart').getContext('2d');
    myProfitChart = new Chart(ctxP, {
        type: 'doughnut',
        data: {
            labels: ['أحمد', 'محمد', 'المتجر'],
            datasets: [{
                data: [aTotal, mTotal, sTotal],
                backgroundColor: ['#10b981', '#f59e0b', '#6366f1'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // 2. Sales Chart (Bar - Last 6 Months)
    let months = {};
    let labels = [];
    let data = [];
    
    for(let i=5; i>=0; i--){
        let d = new Date();
        d.setMonth(d.getMonth() - i);
        let key = (d.getMonth()+1) + '/' + d.getFullYear();
        months[key] = 0;
        labels.push(key);
    }

    purchases.forEach(p => {
        let d = new Date(p.date); 
        let key = (d.getMonth()+1) + '/' + d.getFullYear();
        if(months[key] !== undefined) months[key]++;
    });

    labels.forEach(l => data.push(months[l]));

    if (mySalesChart) mySalesChart.destroy();
    let ctxS = document.getElementById('salesChart').getContext('2d');
    mySalesChart = new Chart(ctxS, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'عدد العمليات',
                data: data,
                backgroundColor: '#6366f1',
                borderRadius: 5
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}

function addGeneralNote(){
    let t=gnText.value.trim(); if(!t) return;
    let n=JSON.parse(localStorage.generalNotes);
    n.push({text:t, date:new Date().toLocaleString("ar-EG")});
    localStorage.generalNotes=JSON.stringify(n);
    gnText.value=""; refreshGeneralNotes(); 
    pushToGithub(); // AUTO SAVE
    notify("تم الحفظ");
}

function refreshGeneralNotes(){
    let n=JSON.parse(localStorage.generalNotes); generalNotesBox.innerHTML="";
    n.forEach((x,i)=>{
        generalNotesBox.innerHTML+=`<div class="todo-item" style="border-right-color:var(--primary)"><div><small>${x.date}</small><div>${x.text}</div></div><i class="fas fa-trash" onclick="deleteNote(${i})" style="color:var(--danger); cursor:pointer"></i></div>`;
    });
}

function deleteNote(i){
    let n=JSON.parse(localStorage.generalNotes); n.splice(i,1);
    localStorage.generalNotes=JSON.stringify(n); refreshGeneralNotes();
    pushToGithub(); // AUTO SAVE
}

function addTodo(){
    let t=todoInput.value.trim(); if(!t) return;
    let l=JSON.parse(localStorage.todoList);
    l.push({text:t, date:new Date().toLocaleString("ar-EG")});
    localStorage.todoList=JSON.stringify(l); todoInput.value=""; refreshTodoList();
    pushToGithub(); // AUTO SAVE
}

function refreshTodoList(){
    let l=JSON.parse(localStorage.todoList); todoBox.innerHTML="";
    l.forEach((x,i)=>[
        todoBox.innerHTML+=`<div class="todo-item"><div>${x.text}</div><button class="btn btn-primary" style="padding:5px 10px" onclick="completeTodo(${i})">تمت</button></div>`
    ]);
}

function completeTodo(i){
    let l=JSON.parse(localStorage.todoList); l.splice(i,1);
    localStorage.todoList=JSON.stringify(l); refreshTodoList();
    pushToGithub(); // AUTO SAVE
}

function withdrawPartial(person){
    let input, cur;
    
    if(person === 'ahmad') {
        input = withdrawAhmad; cur = curAhmad.value;
    } else if(person === 'mohamed') {
        input = withdrawMohamed; cur = curMohamed.value;
    } else if(person === 'store') {
        input = withdrawStore; cur = curStore.value;
    }

    let val = +input.value;
    let i = JSON.parse(localStorage.invest);
    let k = cur === 'd' ? 'd' : 's';
    
    if(i[person][k] < val) { notify("رصيد غير كافي","error"); return; }
    
    i[person][k] -= val;
    localStorage.invest=JSON.stringify(i); 
    refreshInvestment(); 
    input.value=""; 
    pushToGithub(); // AUTO SAVE
    notify("تم السحب");
}

function addNewWallet(){
    let n=newWalletName.value.trim(); let c=newWalletCurrency.value;
    let w=JSON.parse(localStorage.wallets);
    if(!n || w[n]) return notify("اسم غير صالح","error");
    w[n]={bal:0, cur:c, active:true}; localStorage.wallets=JSON.stringify(w);
    loadWallets(); refreshWallets(); newWalletName.value=""; 
    pushToGithub(); // AUTO SAVE
    notify("تمت الإضافة");
}

function renameWallet(){
    let oldName = renameWalletSelect.value;
    let newName = renameWalletInput.value.trim();
    
    if(!newName) return notify("يرجى كتابة اسم جديد", "error");
    
    let w = JSON.parse(localStorage.wallets);
    if(w[newName]) return notify("هذا الاسم موجود مسبقاً", "error");
    
    // نقل البيانات للاسم الجديد
    w[newName] = w[oldName];
    delete w[oldName];
    localStorage.wallets = JSON.stringify(w);
    
    // تحديث سجل المشتريات بالاسم الجديد (لكي لا يظهر اسم قديم في السجل)
    let p = JSON.parse(localStorage.purchases);
    p.forEach(item => {
        if(item.wallet === oldName) item.wallet = newName;
    });
    localStorage.purchases = JSON.stringify(p);
    
    loadWallets();
    refreshAll();
    renameWalletInput.value = "";
    pushToGithub(); // AUTO SAVE
    notify("تم تغيير اسم المحفظة بنجاح");
}

function addToWallet(){
    let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal += +modAmount.value;
    localStorage.wallets=JSON.stringify(w); refreshWallets(); 
    pushToGithub(); // AUTO SAVE
    notify("تمت الإضافة");
}

function subtractFromWallet(){
    let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal -= +modAmount.value;
    localStorage.wallets=JSON.stringify(w); refreshWallets(); 
    pushToGithub(); // AUTO SAVE
    notify("تم الخصم");
}

function setWallet(){
    let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal = +modAmount.value;
    localStorage.wallets=JSON.stringify(w); refreshWallets(); 
    pushToGithub(); // AUTO SAVE
    notify("تم التعيين");
}

function toggleWalletStatus(){
    let name = modWallet.value;
    if(!name) return;
    let w = JSON.parse(localStorage.wallets);
    
    let currentStatus = (w[name].active !== false);
    w[name].active = !currentStatus;
    
    localStorage.wallets = JSON.stringify(w);
    refreshWallets();
    pushToGithub(); // AUTO SAVE
    notify(`تم تغيير حالة المحفظة إلى: ${w[name].active ? "نشط" : "معطل"}`);
}

function deleteWallet(){
    if(!confirm("حذف المحفظة؟")) return;
    let w=JSON.parse(localStorage.wallets); delete w[modWallet.value];
    localStorage.wallets=JSON.stringify(w); loadWallets(); refreshWallets();
    pushToGithub(); // AUTO SAVE
}

function exportData(){
    let a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([JSON.stringify(localStorage)],{type:"application/json"}));
    a.download=`MegaStore_Backup_${new Date().toLocaleDateString()}.json`; a.click();
}

function importData(){
    let f=importFile.files[0]; 
    if(!f) return notify("يرجى اختيار ملف أولاً", "error");

    let r=new FileReader();
    r.onload=async (e)=>{
        try {
            let d=JSON.parse(e.target.result);
            
            // 1. استعادة البيانات محلياً
            Object.keys(d).forEach(k => localStorage.setItem(k, d[k]));
            
            // 2. تحديث متغيرات الكونفج فوراً من اللوكال ستورج الجديد
            ghConfig.user = localStorage.getItem("gh_user") || "";
            ghConfig.repo = localStorage.getItem("gh_repo") || "";
            ghConfig.token = localStorage.getItem("gh_token") || "";
            ghConfig.file = localStorage.getItem("gh_file") || "db.json";

            notify("تم استعادة البيانات محلياً، جاري المزامنة مع GitHub...", "success");

            // 3. محاولة الرفع المباشر إلى GitHub
            if(ghConfig.token && ghConfig.user && ghConfig.repo) {
                updateSyncStatus("جاري رفع النسخة المستعادة...", "loading");
                
                // خطوة مهمة: جلب الـ SHA للملف الموجود في Github أولاً لضمان الكتابة فوقه
                try {
                    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;
                    const resp = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}` } });
                    if(resp.ok) {
                        const json = await resp.json();
                        ghConfig.sha = json.sha; // تحديث الـ SHA
                    }
                } catch(err) { console.log("New file creation likely"); }

                await pushToGithub(); 
            }

            // 4. تحديث الصفحة بعد انتهاء العمليات
            setTimeout(() => {
                location.reload();
            }, 1500);

        } catch (error) {
            console.error(error);
            notify("حدث خطأ في استعادة الملف", "error");
        }
    };
    r.readAsText(f);
}

function undoLastPurchase(){
    if(!localStorage.lastUndoOp) return notify("لا توجد عملية للتراجع عنها","error");
    
    let undoOp = JSON.parse(localStorage.lastUndoOp);
    
    localStorage.wallets=JSON.stringify(undoOp.wallets);
    localStorage.invest=JSON.stringify(undoOp.invest);
    
    let p=JSON.parse(localStorage.purchases); 
    if(p.length > 0) p.pop();
    localStorage.purchases=JSON.stringify(p);
    
    localStorage.removeItem("lastUndoOp");
    
    refreshAll(); 
    pushToGithub(); // AUTO SAVE
    notify("تم التراجع واستعادة البيانات");
}

function clearHistory(){
    if(confirm("مسح السجل بالكامل؟")){ localStorage.purchases="[]"; refreshHistory(); pushToGithub(); }
}

window.onload=init;
</script>

</body>
</html>
