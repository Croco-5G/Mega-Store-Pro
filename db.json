{"wallets":{"USD — موقع Z2U":{"bal":20.9,"cur":"$"},"جوال باي - سعاد":{"bal":105,"cur":"₪","status":"active","active":true},"جوال باي - محمد":{"bal":0,"cur":"₪"},"بنك الاستثمار الفلسطيني - سعاد":{"bal":0,"cur":"$","active":false},"بايننس - أحمد":{"bal":1.2199999999999989,"cur":"$"},"بنك فلسطين - نسيم":{"bal":0,"cur":"$","active":false},"بال باي - أحمد":{"bal":40,"cur":"₪"}},"purchases":[{"date":"2026-2-4","customer":"Maha","phone":"+972593442178","sub":"ChatGPT","duration":1,"paid":"20₪","cost":"1.1$","wallet":"بال باي - أحمد","expiry":1772614706423},{"date":"2026-2-4","customer":"أحمد","phone":"+972594293040","sub":"ChatGPT","duration":1,"paid":"20₪","cost":"1.1$","wallet":"بال باي - أحمد","expiry":1772614836515},{"date":"2026-2-4","customer":"هاجر","phone":"+972597364302","sub":"ChatGPT","duration":1,"paid":"20₪","cost":"1.1$","wallet":"بال باي - أحمد","expiry":1772614890463},{"date":"2026-2-5","customer":"Malak","phone":"+972599142832","sub":"ChatGPT","duration":12,"paid":"137₪","cost":"15.6$","wallet":"جوال باي - سعاد","expiry":1801818294619},{"date":"2026-2-6","customer":"أحمد","phone":"+972594293040","sub":"ChatGPT","duration":1,"paid":"0₪","cost":"1.1$","wallet":"جوال باي - محمد","expiry":1772788017312},{"date":"2026-2-6","customer":"نحن","phone":"-","sub":"ChatGPT","duration":1,"paid":"0₪","cost":"1.1$","wallet":"جوال باي - محمد","expiry":1772788050340},{"date":"2026-2-6","customer":"Nour","phone":"+972598646619","sub":"ChatGPT","duration":1,"paid":"10₪","cost":"1.1$","wallet":"بال باي - أحمد","expiry":1772788126954},{"date":"2026-2-8","customer":"إسماعيل","phone":"+972595564147","sub":"Telegram","duration":1,"paid":"10₪","cost":"1.1$","wallet":"بال باي - أحمد","expiry":1772961108553}],"invest":{"ahmad":{"d":0,"s":52.14},"mohamed":{"d":0,"s":52.14},"store":{"d":22.120000000000008,"s":40.383}},"settings":{"ahmad":35,"mohamed":35,"store":30,"deductCost":true,"exchangeRate":3.15},"generalNotes":[{"text":"تورطنا بحسابين تعويض ب2.2 دولار واحد للتجربة و واحد تعويض لأحد العملاء","date":"٥‏/٢‏/٢٠٢٦ ٦:٤٣:٤٤ م"},{"text":"تم تعويض الحساب من Esha577","date":"٨‏/٢‏/٢٠٢٦ ٨:٣٩:٤٩ م"},{"text":"في حساب شات تم شراءه في 8 شهر 2 و في الحساب الذي تم تعويضه واحد لازم ينخصم من المتجر و واحد مخصوم من الاصل وقت ما عوضنا وقت البيع خلي اول حساب تم بيعه تكلفته 0$ و الاخر تكلفته 1.1$ من محفظة الموقع","date":"٩‏/٢‏/٢٠٢٦ ١٢:٢٠:٢٦ م"},{"text":"<!DOCTYPE html>\n<html lang=\"ar\" dir=\"rtl\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Mega Store Pro | Cloud Sync</title>\n    <link href=\"https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Tajawal:wght@400;500;700;900&display=swap\" rel=\"stylesheet\">\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n    <style>\n        :root {\n            --primary: #6366f1;\n            --primary-dark: #4f46e5;\n            --accent: #f59e0b;\n            --success: #10b981;\n            --danger: #ef4444;\n            --bg-main: #f8fafc;\n            --sidebar-bg: #0f172a;\n            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);\n            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        }\n\n        * { box-sizing: border-box; font-family: 'Tajawal', 'Plus Jakarta Sans', sans-serif; }\n\n        body {\n            background: var(--bg-main);\n            margin: 0;\n            color: #1e293b;\n            display: flex;\n            min-height: 100vh;\n            overflow-x: hidden;\n        }\n\n        /* --- Sidebar --- */\n        .sidebar {\n            width: 280px;\n            background: var(--sidebar-bg);\n            color: white;\n            display: flex;\n            flex-direction: column;\n            position: fixed;\n            height: 100vh;\n            right: 0;\n            z-index: 1000;\n            transition: var(--transition);\n            box-shadow: -5px 0 25px rgba(0,0,0,0.2);\n        }\n\n        .brand {\n            padding: 40px 20px;\n            text-align: center;\n            font-size: 24px;\n            font-weight: 900;\n            background: linear-gradient(135deg, var(--primary), #a855f7);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            letter-spacing: -1px;\n        }\n\n        .menu-items { padding: 10px; flex-grow: 1; overflow-y: auto; }\n\n        .sidebar button {\n            width: 100%;\n            padding: 14px 18px;\n            margin-bottom: 5px;\n            border: none;\n            border-radius: 12px;\n            background: transparent;\n            color: #94a3b8;\n            font-size: 15px;\n            font-weight: 600;\n            cursor: pointer;\n            text-align: right;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            transition: var(--transition);\n        }\n\n        .sidebar button:hover { background: rgba(255,255,255,0.05); color: #fff; }\n        .sidebar button.active {\n            background: var(--primary);\n            color: white;\n            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);\n        }\n\n        /* --- Main Content --- */\n        .main-content {\n            flex: 1;\n            margin-right: 280px;\n            padding: 30px;\n            transition: var(--transition);\n        }\n\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n\n        .stat-card {\n            background: white;\n            padding: 20px;\n            border-radius: 20px;\n            display: flex;\n            align-items: center;\n            gap: 15px;\n            box-shadow: var(--card-shadow);\n            border: 1px solid rgba(255,255,255,0.8);\n        }\n\n        .stat-icon {\n            width: 50px;\n            height: 50px;\n            border-radius: 15px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 20px;\n        }\n\n        .card {\n            background: white;\n            border-radius: 24px;\n            padding: 35px;\n            box-shadow: var(--card-shadow);\n            border: 1px solid #eef2f6;\n            margin-bottom: 30px;\n            animation: fadeIn 0.5s ease-out;\n        }\n\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(10px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n\n        h3 { font-size: 22px; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: #0f172a; }\n\n        .input-group { margin-bottom: 15px; }\n        label { display: block; margin-bottom: 8px; font-weight: 600; color: #64748b; font-size: 14px; }\n\n        input, select, textarea {\n            width: 100%;\n            padding: 12px 16px;\n            border-radius: 12px;\n            border: 2px solid #f1f5f9;\n            background: #f8fafc;\n            font-size: 15px;\n            transition: var(--transition);\n        }\n\n        input:focus { border-color: var(--primary); background: white; outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }\n\n        .btn {\n            padding: 12px 24px;\n            border-radius: 12px;\n            font-weight: 700;\n            cursor: pointer;\n            transition: var(--transition);\n            border: none;\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n        }\n\n        .btn-primary { background: var(--primary); color: white; }\n        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }\n        .btn-danger { background: #fff1f2; color: var(--danger); }\n        .btn-danger:hover { background: var(--danger); color: white; }\n        .btn-warning { background: #fffbeb; color: #d97706; }\n        .btn-warning:hover { background: #fef3c7; }\n\n        .table-container { overflow-x: auto; border-radius: 15px; border: 1px solid #f1f5f9; }\n        table { width: 100%; border-collapse: collapse; background: white; }\n        th { background: #f8fafc; padding: 16px; text-align: right; color: #64748b; font-weight: 700; }\n        td { padding: 16px; border-bottom: 1px solid #f1f5f9; }\n\n        .hidden { display: none; }\n\n        #notification {\n            position: fixed;\n            bottom: 30px;\n            left: 30px;\n            padding: 16px 25px;\n            border-radius: 16px;\n            color: white;\n            font-weight: 700;\n            z-index: 2000;\n            display: none;\n            animation: slideIn 0.3s ease-out;\n            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);\n        }\n        \n        #syncStatus {\n            position: fixed;\n            top: 20px;\n            left: 30px;\n            padding: 8px 15px;\n            border-radius: 50px;\n            font-size: 12px;\n            font-weight: 700;\n            z-index: 2000;\n            background: white;\n            box-shadow: 0 5px 15px rgba(0,0,0,0.1);\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            transition: all 0.3s;\n        }\n\n        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }\n        @keyframes spin { 100% { transform: rotate(360deg); } }\n\n        .badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }\n        .badge-success { background: #dcfce7; color: var(--success); }\n        .badge-info { background: #e0e7ff; color: var(--primary); }\n        .badge-danger { background: #fee2e2; color: var(--danger); }\n        .badge-warning { background: #fef3c7; color: #d97706; }\n\n        .todo-item {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            background: #fff;\n            padding: 15px;\n            border-radius: 12px;\n            border-right: 4px solid var(--accent);\n            box-shadow: 0 2px 5px rgba(0,0,0,0.05);\n            margin-bottom: 10px;\n        }\n        \n        /* --- كود التعديل الجديد لضبط النصوص الطويلة --- */\n        .todo-item > div:first-child {\n            flex: 1;            /* يأخذ المساحة المتبقية */\n            min-width: 0;       /* ضروري جداً لتفعيل الالتفاف داخل الفليكس */\n            word-wrap: break-word; \n            overflow-wrap: break-word; \n            word-break: break-word; /* يكسر الكلمات الطويلة جداً */\n            padding-left: 15px; /* مسافة بين النص والزر */\n            white-space: pre-wrap; /* يحافظ على التنسيق والأسطر الجديدة */\n        }\n        /* --------------------------------------------- */\n        \n        .yellow-section {\n            background-color: #fefce8;\n            border: 2px solid #fde047;\n            border-radius: 20px;\n            padding: 25px;\n            color: #854d0e;\n        }\n        .yellow-section h3 { color: #854d0e; }\n        .yellow-section input { background: #fff; border-color: #fde047; }\n        .yellow-section .btn-primary { background: #eab308; color: #fff; }\n        .yellow-section .btn-primary:hover { background: #ca8a04; }\n        .yellow-section .todo-item { background: #fffbeb; border-right: 4px solid #eab308; color: #713f12; }\n\n        .settings-section {\n            background: #f8fafc;\n            padding: 20px;\n            border-radius: 18px;\n            border: 1px solid #e2e8f0;\n            margin-top: 20px;\n        }\n        \n        .github-section {\n            background: #1e293b;\n            color: white;\n            padding: 25px;\n            border-radius: 18px;\n            margin-bottom: 25px;\n        }\n        .github-section input {\n            background: #334155;\n            border-color: #475569;\n            color: white;\n        }\n        .github-section input:focus {\n            border-color: var(--primary);\n            background: #334155;\n        }\n        .github-section label { color: #94a3b8; }\n    </style>\n</head>\n\n<body>\n\n<div id=\"syncStatus\"><i class=\"fas fa-cloud\"></i> <span>جاهز</span></div>\n\n<div class=\"sidebar\">\n    <div class=\"brand\"><i class=\"fas fa-rocket\"></i> MEGA STORE</div>\n    <div class=\"menu-items\">\n        <button onclick=\"showPage('purchase', this)\" class=\"active\"><i class=\"fas fa-shopping-cart\"></i> عملية شراء</button>\n        <button onclick=\"showPage('expiring', this)\"><i class=\"fas fa-hourglass-half\"></i> تنبيهات الانتهاء</button>\n        <button onclick=\"showPage('wallets', this)\"><i class=\"fas fa-wallet\"></i> أرصدة المحافظ</button>\n        <button onclick=\"showPage('history', this)\"><i class=\"fas fa-history\"></i> سجل العمليات</button>\n        <button onclick=\"showPage('analytics', this)\"><i class=\"fas fa-chart-bar\"></i> الإحصائيات</button>\n        <button onclick=\"showPage('investment', this)\"><i class=\"fas fa-chart-line\"></i> توزيع الأرباح</button>\n        <button onclick=\"showPage('modify', this)\"><i class=\"fas fa-cog\"></i> الإعدادات</button>\n        <button onclick=\"showPage('generalNotes', this)\"><i class=\"fas fa-sticky-note\"></i> ملاحظات</button>\n        <button onclick=\"showPage('backup', this)\"><i class=\"fas fa-database\"></i> النسخ الاحتياطي</button>\n    </div>\n</div>\n\n<div class=\"main-content\">\n    \n    <div class=\"stats-grid\">\n        <div class=\"stat-card\">\n            <div class=\"stat-icon\" style=\"background: #e0e7ff; color: var(--primary);\"><i class=\"fas fa-dollar-sign\"></i></div>\n            <div>\n                <label>إجمالي الدولار</label>\n                <div id=\"statDollar\" style=\"font-size: 20px; font-weight: 800;\">0.00 $</div>\n            </div>\n        </div>\n        <div class=\"stat-card\">\n            <div class=\"stat-icon\" style=\"background: #dcfce7; color: var(--success);\"><i class=\"fas fa-coins\"></i></div>\n            <div>\n                <label>إجمالي الشيكل</label>\n                <div id=\"statShekel\" style=\"font-size: 20px; font-weight: 800;\">0.00 ₪</div>\n            </div>\n        </div>\n        <div class=\"stat-card\">\n            <div class=\"stat-icon\" style=\"background: #fef3c7; color: var(--accent);\"><i class=\"fas fa-shopping-bag\"></i></div>\n            <div>\n                <label>عمليات اليوم</label>\n                <div id=\"statSales\" style=\"font-size: 20px; font-weight: 800;\">0</div>\n            </div>\n        </div>\n    </div>\n\n    <div id=\"notification\"></div>\n\n    <div id=\"purchase\" class=\"card\">\n        <h3><i class=\"fas fa-cart-plus\"></i> تسجيل اشتراك جديد</h3>\n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n            <div class=\"input-group\">\n                <label>نوع الاشتراك</label>\n                <input id=\"sub\" placeholder=\"مثال: نيتفليكس، يوتيوب...\">\n            </div>\n            <div class=\"input-group\">\n                <label>اسم العميل</label>\n                <input id=\"customer\" placeholder=\"اسم العميل\">\n            </div>\n        </div>\n        \n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n            <div class=\"input-group\">\n                <label>رقم جوال العميل</label>\n                <input id=\"customerPhone\" placeholder=\"059xxxxxxx\">\n            </div>\n            <div class=\"input-group\">\n                <label>مدة الاشتراك</label>\n                <select id=\"subDuration\">\n                    <option value=\"1\">1 شهر</option>\n                    <option value=\"2\">2 شهر</option>\n                    <option value=\"3\">3 شهور</option>\n                    <option value=\"4\">4 شهور</option>\n                    <option value=\"5\">5 شهور</option>\n                    <option value=\"6\">6 شهور</option>\n                    <option value=\"7\">7 شهور</option>\n                    <option value=\"8\">8 شهور</option>\n                    <option value=\"9\">9 شهور</option>\n                    <option value=\"10\">10 شهور</option>\n                    <option value=\"11\">11 شهر</option>\n                    <option value=\"12\">12 شهر (سنة)</option>\n                </select>\n            </div>\n        </div>\n\n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;\">\n            <div class=\"input-group\">\n                <label>المبلغ المدفوع من العميل</label>\n                <div style=\"display:flex; gap:10px\">\n                    <input type=\"number\" id=\"paidAmount\" placeholder=\"0.00\">\n                    <select id=\"paidCurrency\" style=\"width:120px\"><option value=\"₪\">₪ شيكل</option><option value=\"$\">$ دولار</option></select>\n                </div>\n            </div>\n            <div class=\"input-group\">\n                <label>التكلفة علينا</label>\n                <div style=\"display:flex; gap:10px\">\n                    <input type=\"number\" id=\"costAmount\" placeholder=\"0.00\">\n                    <select id=\"costCurrency\" style=\"width:120px\"><option value=\"$\">$ دولار</option><option value=\"₪\">₪ شيكل</option></select>\n                </div>\n            </div>\n        </div>\n\n        <div style=\"background: #f8fafc; padding: 25px; border-radius: 18px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border: 1px dashed #cbd5e1;\">\n            <div>\n                <label>يُخصم من محفظة (المصدر):</label>\n                <select id=\"fromWallet\"></select>\n            </div>\n            <div>\n                <label>يُودع الربح في محفظة:</label>\n                <select id=\"wallet\"></select>\n            </div>\n        </div>\n\n        <button class=\"btn btn-primary\" style=\"width:100%; margin-top:30px; padding: 16px;\" onclick=\"addPurchase()\">\n            <i class=\"fas fa-check-circle\"></i> إتمام العملية وحفظ البيانات\n        </button>\n    </div>\n\n    <div id=\"expiring\" class=\"card hidden\">\n        <h3><i class=\"fas fa-hourglass-half\"></i> اشتراكات تنتهي قريباً (أقل من 3 أيام)</h3>\n        <p style=\"color:#64748b; margin-bottom:20px\">يتم عرض الاشتراكات المتبقي لها 3 أيام أو أقل، أو التي انتهت بالفعل.</p>\n        <div class=\"table-container\">\n            <table>\n                <thead>\n                    <tr>\n                        <th>الخدمة</th>\n                        <th>اسم العميل</th>\n                        <th>رقم الجوال</th>\n                        <th>ينتهي بتاريخ</th>\n                        <th>المتبقي (أيام)</th>\n                    </tr>\n                </thead>\n                <tbody id=\"expiringBody\"></tbody>\n            </table>\n        </div>\n    </div>\n\n    <div id=\"analytics\" class=\"card hidden\">\n        <h3><i class=\"fas fa-chart-bar\"></i> الإحصائيات والرسوم البيانية</h3>\n        <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;\">\n            <div style=\"background: #f8fafc; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0;\">\n                <h4 style=\"text-align:center; margin-bottom:15px\">توزيع الأرباح الكلية</h4>\n                <canvas id=\"profitChart\" style=\"max-height: 300px;\"></canvas>\n            </div>\n            <div style=\"background: #f8fafc; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0;\">\n                <h4 style=\"text-align:center; margin-bottom:15px\">عدد المبيعات آخر 6 شهور</h4>\n                <canvas id=\"salesChart\" style=\"max-height: 300px;\"></canvas>\n            </div>\n        </div>\n    </div>\n\n    <div id=\"wallets\" class=\"card hidden\">\n        <h3><i class=\"fas fa-wallet\"></i> توزيع السيولة في المحافظ</h3>\n        <div class=\"table-container\">\n            <table>\n                <thead>\n                    <tr><th>المحفظة</th><th>العملة</th><th style=\"text-align:center\">الرصيد</th><th>الحالة</th></tr>\n                </thead>\n                <tbody id=\"walletList\"></tbody>\n            </table>\n        </div>\n    </div>\n\n    <div id=\"history\" class=\"card hidden\">\n        <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:25px\">\n            <h3><i class=\"fas fa-list-ul\"></i> الأرشيف المالي</h3>\n            <div style=\"display:flex; gap:10px\">\n                <button class=\"btn btn-primary\" onclick=\"undoLastPurchase()\"><i class=\"fas fa-undo\"></i> تراجع</button>\n                <button class=\"btn btn-danger\" onclick=\"clearHistory()\"><i class=\"fas fa-trash\"></i> مسح الكل</button>\n            </div>\n        </div>\n        <div class=\"table-container\">\n            <table>\n                <thead>\n                    <tr>\n                        <th>التاريخ</th>\n                        <th>العميل</th>\n                        <th>الجوال</th>\n                        <th>الخدمة</th>\n                        <th>المدة</th>\n                        <th>الدفع</th>\n                        <th>التكلفة</th>\n                        <th>المحفظة</th>\n                    </tr>\n                </thead>\n                <tbody id=\"historyBody\"></tbody>\n            </table>\n        </div>\n    </div>\n\n    <div id=\"investment\" class=\"card hidden\">\n        <h3><i class=\"fas fa-chart-pie\"></i> حصص الشركاء والاستثمار</h3>\n        <div id=\"investBox\" style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;\"></div>\n        \n        <div style=\"margin-top:40px; background:#fff7ed; padding:30px; border-radius:20px; border: 1px solid #ffedd5;\">\n            <h4 style=\"margin-top:0; color:#9a3412\"><i class=\"fas fa-external-link-alt\"></i> طلب سحب أرباح</h4>\n            <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px\">\n                <div class=\"input-group\">\n                    <label>سحب من حصة أحمد</label>\n                    <div style=\"display:flex; gap:5px\">\n                        <input id=\"withdrawAhmad\" type=\"number\" placeholder=\"0.00\">\n                        <select id=\"curAhmad\" style=\"width:70px\"><option value=\"d\">$</option><option value=\"s\">₪</option></select>\n                        <button class=\"btn btn-danger\" onclick=\"withdrawPartial('ahmad')\">سحب</button>\n                    </div>\n                </div>\n                <div class=\"input-group\">\n                    <label>سحب من حصة محمد</label>\n                    <div style=\"display:flex; gap:5px\">\n                        <input id=\"withdrawMohamed\" type=\"number\" placeholder=\"0.00\">\n                        <select id=\"curMohamed\" style=\"width:70px\"><option value=\"d\">$</option><option value=\"s\">₪</option></select>\n                        <button class=\"btn btn-danger\" onclick=\"withdrawPartial('mohamed')\">سحب</button>\n                    </div>\n                </div>\n                <div class=\"input-group\">\n                    <label>سحب من حصة المتجر</label>\n                    <div style=\"display:flex; gap:5px\">\n                        <input id=\"withdrawStore\" type=\"number\" placeholder=\"0.00\">\n                        <select id=\"curStore\" style=\"width:70px\"><option value=\"d\">$</option><option value=\"s\">₪</option></select>\n                        <button class=\"btn btn-danger\" onclick=\"withdrawPartial('store')\">سحب</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div id=\"modify\" class=\"card hidden\">\n        \n        <div class=\"github-section\">\n            <h3><i class=\"fab fa-github\"></i> إعدادات الربط السحابي (GitHub)</h3>\n            <p style=\"color:#94a3b8; font-size:14px; margin-bottom:15px\">اربط الموقع بمستودع خاص لحفظ البيانات بشكل دائم وآمن على السحابة.</p>\n            <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px\">\n                <div class=\"input-group\">\n                    <label>اسم المستخدم (Username)</label>\n                    <input id=\"ghUser\" placeholder=\"ex: myname\">\n                </div>\n                <div class=\"input-group\">\n                    <label>اسم المستودع (Repo)</label>\n                    <input id=\"ghRepo\" placeholder=\"ex: my-shop\">\n                </div>\n                <div class=\"input-group\">\n                    <label>المفتاح السري (Token)</label>\n                    <input id=\"ghToken\" type=\"password\" placeholder=\"ghp_xxxxxxxxxxxx\">\n                </div>\n                <div class=\"input-group\">\n                    <label>اسم الملف (اختياري)</label>\n                    <input id=\"ghFile\" placeholder=\"db.json\" value=\"db.json\">\n                </div>\n            </div>\n            <div style=\"display:flex; gap:10px; margin-top:15px\">\n                <button class=\"btn btn-primary\" onclick=\"saveGithubSettings()\">حفظ إعدادات الربط</button>\n                <button class=\"btn btn-warning\" onclick=\"fetchFromGithub()\"><i class=\"fas fa-download\"></i> سحب البيانات الآن</button>\n                <button class=\"btn btn-success\" style=\"background:var(--success); color:#fff\" onclick=\"pushToGithub()\"><i class=\"fas fa-upload\"></i> رفع البيانات الآن</button>\n            </div>\n        </div>\n        <h3><i class=\"fas fa-percent\"></i> إعدادات توزيع الأرباح</h3>\n        <div class=\"settings-section\">\n            <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;\">\n                <div class=\"input-group\">\n                    <label>نسبة أحمد (%)</label>\n                    <input type=\"number\" id=\"setAhmadProp\" placeholder=\"35\">\n                </div>\n                <div class=\"input-group\">\n                    <label>نسبة محمد (%)</label>\n                    <input type=\"number\" id=\"setMohamedProp\" placeholder=\"35\">\n                </div>\n                <div class=\"input-group\">\n                    <label>نسبة المتجر (%)</label>\n                    <input type=\"number\" id=\"setStoreProp\" placeholder=\"30\">\n                </div>\n            </div>\n            <div style=\"margin-top: 15px; display: flex; align-items: center; gap: 10px;\">\n                <input type=\"checkbox\" id=\"setDeductCost\" style=\"width: 20px; height: 20px; cursor: pointer;\">\n                <label for=\"setDeductCost\" style=\"margin-bottom: 0; cursor: pointer;\">خصم التكاليف من الإجمالي قبل توزيع الربح؟</label>\n            </div>\n            \n            <hr style=\"margin: 20px 0; border: 0; border-top: 1px solid #cbd5e1;\">\n            \n            <div class=\"input-group\">\n                <label>سعر صرف الدولار الثابت (مقابل الشيكل)</label>\n                <div style=\"display:flex; align-items:center; gap:10px\">\n                    <input type=\"number\" id=\"setExchangeRate\" placeholder=\"أدخل السعر (مثلاً 3.5)\">\n                    <small style=\"color:#64748b; width: 100%;\">اتركه 0 أو فارغاً إذا كنت تريد أن يسألك النظام في كل مرة.</small>\n                </div>\n            </div>\n\n            <button class=\"btn btn-primary\" style=\"margin-top: 20px;\" onclick=\"saveProfitSettings()\">حفظ إعدادات النظام</button>\n        </div>\n\n        <h3 style=\"margin-top:40px\"><i class=\"fas fa-edit\"></i> تعديل اسم محفظة</h3>\n        <p style=\"color:#64748b; font-size:14px; margin-bottom:10px\">تنبيه: سيتم نقل الرصيد وتحديث سجل العمليات القديم للاسم الجديد.</p>\n        <div style=\"display:flex; gap:15px; background:#f1f5f9; padding:20px; border-radius:15px\">\n            <select id=\"renameWalletSelect\" style=\"width:200px\"></select>\n            <input id=\"renameWalletInput\" placeholder=\"الاسم الجديد للمحفظة\">\n            <button class=\"btn btn-warning\" onclick=\"renameWallet()\">تغيير الاسم</button>\n        </div>\n\n        <h3 style=\"margin-top:40px\"><i class=\"fas fa-plus-circle\"></i> إدارة المحافظ</h3>\n        <div style=\"display:flex; gap:15px; background:#f1f5f9; padding:20px; border-radius:15px\">\n            <input id=\"newWalletName\" placeholder=\"اسم المحفظة الجديدة\">\n            <select id=\"newWalletCurrency\" style=\"width:150px\"><option value=\"$\">$ دولار</option><option value=\"₪\">₪ شيكل</option></select>\n            <button class=\"btn btn-primary\" onclick=\"addNewWallet()\">إنشاء</button>\n        </div>\n\n        <h3 style=\"margin-top:40px\"><i class=\"fas fa-edit\"></i> التحكم اليدوي بالأرصدة</h3>\n        <div style=\"display:grid; grid-template-columns: 1fr 1fr; gap:20px\">\n            <div class=\"input-group\"><label>المحفظة</label><select id=\"modWallet\"></select></div>\n            <div class=\"input-group\"><label>المبلغ</label><input id=\"modAmount\" type=\"number\" placeholder=\"0.00\"></div>\n        </div>\n        <div style=\"display:flex; gap:10px; flex-wrap:wrap\">\n            <button class=\"btn btn-primary\" onclick=\"addToWallet()\">إضافة</button>\n            <button class=\"btn btn-danger\" onclick=\"subtractFromWallet()\">خصم</button>\n            <button class=\"btn btn-primary\" style=\"background:#0ea5e9\" onclick=\"setWallet()\">تعيين مباشر</button>\n            <button class=\"btn btn-warning\" onclick=\"toggleWalletStatus()\">\n                <i class=\"fas fa-toggle-on\"></i> تغيير الحالة (نشط/معطل)\n            </button>\n            <button class=\"btn btn-danger\" onclick=\"deleteWallet()\">حذف المحفظة</button>\n        </div>\n\n        <div class=\"yellow-section\" style=\"margin-top:50px;\">\n            <h3><i class=\"fas fa-tasks\"></i> قائمة المهام (To-Do)</h3>\n            <div style=\"display:flex; gap:15px; margin-bottom:20px\">\n                <input id=\"todoInput\" placeholder=\"اكتب المهمة...\">\n                <button class=\"btn btn-primary\" onclick=\"addTodo()\">إضافة</button>\n            </div>\n            <div id=\"todoBox\"></div>\n        </div>\n    </div>\n\n    <div id=\"generalNotes\" class=\"card hidden\">\n        <h3><i class=\"fas fa-pen-fancy\"></i> المفكرة</h3>\n        <div style=\"display:flex; gap:15px\">\n            <textarea id=\"gnText\" placeholder=\"اكتب ملاحظة...\" style=\"height: 60px;\"></textarea>\n            <button class=\"btn btn-primary\" onclick=\"addGeneralNote()\">حفظ</button>\n        </div>\n        <div id=\"generalNotesBox\" style=\"margin-top:30px;\"></div>\n    </div>\n\n    <div id=\"backup\" class=\"card hidden\">\n        <h3><i class=\"fas fa-shield-alt\"></i> حماية البيانات</h3>\n        <div style=\"text-align:center; padding:40px; border:2px dashed #e2e8f0; border-radius:30px\">\n            <i class=\"fas fa-cloud-download-alt\" style=\"font-size:50px; color:var(--primary); margin-bottom:20px\"></i>\n            <p>احتفظ بنسخة احتياطية من بياناتك دائماً.</p>\n            <button class=\"btn btn-primary\" onclick=\"exportData()\"><i class=\"fas fa-download\"></i> تحميل النسخة الاحتياطية</button>\n            <div style=\"margin: 30px 0; border-top:1px solid #e2e8f0\"></div>\n            <input type=\"file\" id=\"importFile\" style=\"width:auto; margin-bottom:10px\">\n            <br>\n            <button class=\"btn btn-danger\" style=\"background:#f1f5f9; color:#64748b\" onclick=\"importData()\">استعادة بيانات</button>\n        </div>\n    </div>\n\n</div>\n\n<script>\nconst fix=n=>Number(n).toFixed(2);\nlet myProfitChart = null;\nlet mySalesChart = null;\n\n// --- GITHUB INTEGRATION VARS ---\nlet ghConfig = {\n    user: localStorage.getItem(\"gh_user\") || \"\",\n    repo: localStorage.getItem(\"gh_repo\") || \"\",\n    token: localStorage.getItem(\"gh_token\") || \"\",\n    file: localStorage.getItem(\"gh_file\") || \"db.json\",\n    sha: \"\" // Needed for updates\n};\n\nfunction updateSyncStatus(msg, type=\"loading\") {\n    const el = document.getElementById(\"syncStatus\");\n    if(type===\"loading\") {\n        el.innerHTML = `<i class=\"fas fa-circle-notch fa-spin\" style=\"color:var(--primary)\"></i> <span>${msg}</span>`;\n    } else if (type===\"success\") {\n        el.innerHTML = `<i class=\"fas fa-check\" style=\"color:var(--success)\"></i> <span>${msg}</span>`;\n        setTimeout(() => el.innerHTML = `<i class=\"fas fa-cloud\"></i> <span>متزامن</span>`, 3000);\n    } else if (type===\"error\") {\n        el.innerHTML = `<i class=\"fas fa-times\" style=\"color:var(--danger)\"></i> <span>${msg}</span>`;\n    } else {\n        el.innerHTML = `<i class=\"fas fa-cloud\"></i> <span>${msg}</span>`;\n    }\n}\n\nasync function fetchFromGithub() {\n    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) {\n        updateSyncStatus(\"غير متصل\", \"idle\");\n        return;\n    }\n    \n    updateSyncStatus(\"جاري سحب البيانات...\");\n    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;\n    \n    try {\n        const response = await fetch(url, {\n            headers: { \n                'Authorization': `token ${ghConfig.token}`,\n                'Accept': 'application/vnd.github.v3+json'\n            },\n            cache: \"no-store\"\n        });\n\n        if (response.status === 404) {\n            updateSyncStatus(\"الملف غير موجود (سيرفع جديد)\", \"idle\");\n            return; // File doesn't exist yet\n        }\n        \n        if (!response.ok) throw new Error(\"GitHub API Error\");\n\n        const data = await response.json();\n        ghConfig.sha = data.sha;\n        \n        // Decode Content\n        const content = decodeURIComponent(escape(atob(data.content)));\n        const db = JSON.parse(content);\n\n        // Update LocalStorage\n        if(db.wallets) localStorage.wallets = JSON.stringify(db.wallets);\n        if(db.purchases) localStorage.purchases = JSON.stringify(db.purchases);\n        if(db.invest) localStorage.invest = JSON.stringify(db.invest);\n        if(db.settings) localStorage.settings = JSON.stringify(db.settings);\n        if(db.generalNotes) localStorage.generalNotes = JSON.stringify(db.generalNotes);\n        if(db.todoList) localStorage.todoList = JSON.stringify(db.todoList);\n\n        // Refresh UI\n        loadWallets();\n        loadProfitSettings();\n        refreshAll();\n        updateSyncStatus(\"تم التحديث\", \"success\");\n\n    } catch (error) {\n        console.error(error);\n        updateSyncStatus(\"فشل الاتصال\", \"error\");\n        notify(\"فشل سحب البيانات من GitHub، تأكد من الإعدادات\", \"error\");\n    }\n}\n\nasync function pushToGithub() {\n    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) {\n        notify(\"يرجى ضبط إعدادات GitHub أولاً\", \"error\");\n        return;\n    }\n\n    updateSyncStatus(\"جاري الحفظ...\");\n\n    // Prepare Data\n    const db = {\n        wallets: JSON.parse(localStorage.wallets || \"{}\"),\n        purchases: JSON.parse(localStorage.purchases || \"[]\"),\n        invest: JSON.parse(localStorage.invest || \"{}\"),\n        settings: JSON.parse(localStorage.settings || \"{}\"),\n        generalNotes: JSON.parse(localStorage.generalNotes || \"[]\"),\n        todoList: JSON.parse(localStorage.todoList || \"[]\"),\n        lastUpdate: new Date().toISOString()\n    };\n\n    const content = btoa(unescape(encodeURIComponent(JSON.stringify(db))));\n    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;\n\n    const body = {\n        message: \"Update data via MegaStore App\",\n        content: content\n    };\n    if (ghConfig.sha) body.sha = ghConfig.sha;\n\n    try {\n        const response = await fetch(url, {\n            method: 'PUT',\n            headers: {\n                'Authorization': `token ${ghConfig.token}`,\n                'Content-Type': 'application/json',\n                'Accept': 'application/vnd.github.v3+json'\n            },\n            body: JSON.stringify(body)\n        });\n\n        if (!response.ok) throw new Error(\"Failed to upload\");\n\n        const data = await response.json();\n        ghConfig.sha = data.content.sha;\n        updateSyncStatus(\"تم الحفظ سحابياً\", \"success\");\n\n    } catch (error) {\n        console.error(error);\n        // If failed due to SHA mismatch, try to fetch first then push again? \n        // For simplicity:\n        updateSyncStatus(\"فشل الرفع\", \"error\");\n        notify(\"فشل رفع البيانات، ربما يوجد تعارض. حاول سحب البيانات أولاً.\", \"error\");\n    }\n}\n\nfunction saveGithubSettings() {\n    const u = document.getElementById(\"ghUser\").value.trim();\n    const r = document.getElementById(\"ghRepo\").value.trim();\n    const t = document.getElementById(\"ghToken\").value.trim();\n    const f = document.getElementById(\"ghFile\").value.trim() || \"db.json\";\n\n    if(!u || !r || !t) return notify(\"يرجى تعبئة جميع الحقول\", \"error\");\n\n    localStorage.setItem(\"gh_user\", u);\n    localStorage.setItem(\"gh_repo\", r);\n    localStorage.setItem(\"gh_token\", t);\n    localStorage.setItem(\"gh_file\", f);\n    \n    ghConfig.user = u;\n    ghConfig.repo = r;\n    ghConfig.token = t;\n    ghConfig.file = f;\n\n    notify(\"تم حفظ الإعدادات، جاري الاتصال...\", \"success\");\n    fetchFromGithub();\n}\n\nfunction loadGithubInputs() {\n    document.getElementById(\"ghUser\").value = ghConfig.user;\n    document.getElementById(\"ghRepo\").value = ghConfig.repo;\n    document.getElementById(\"ghToken\").value = ghConfig.token;\n    document.getElementById(\"ghFile\").value = ghConfig.file;\n}\n\n// --- END GITHUB INTEGRATION ---\n\nfunction init(){\n    if(!localStorage.wallets){\n        localStorage.wallets=JSON.stringify({\n            \"جوال باي — سعاد\":{bal:0, cur:\"₪\", active:true},\n            \"جوال باي — محمد\":{bal:0, cur:\"₪\", active:true},\n            \"بال باي — أحمد\":{bal:0, cur:\"₪\", active:true},\n            \"بايننس — احمد\":{bal:0, cur:\"$\", active:true}\n        });\n    }\n    if(!localStorage.purchases) localStorage.purchases=\"[]\";\n    if(!localStorage.invest) localStorage.invest=JSON.stringify({ahmad:{d:0,s:0},mohamed:{d:0,s:0},store:{d:0,s:0}});\n    if(!localStorage.generalNotes) localStorage.generalNotes=\"[]\";\n    if(!localStorage.todoList) localStorage.todoList=\"[]\";\n    \n    // إعدادات افتراضية للنسب + سعر الصرف\n    if(!localStorage.settings) {\n        localStorage.settings = JSON.stringify({ahmad: 35, mohamed: 35, store: 30, deductCost: true, exchangeRate: 0});\n    }\n    \n    loadWallets();\n    loadProfitSettings();\n    loadGithubInputs(); // Load GH inputs\n    \n    // Attempt Initial Sync\n    if(ghConfig.token) {\n        fetchFromGithub();\n    } else {\n        refreshAll();\n    }\n}\n\nfunction showPage(id, btn){\n    document.querySelectorAll(\".card\").forEach(x=>x.classList.add(\"hidden\"));\n    document.getElementById(id).classList.remove(\"hidden\");\n    document.querySelectorAll(\".sidebar button\").forEach(b => b.classList.remove(\"active\"));\n    if(btn) btn.classList.add(\"active\");\n    \n    // تحديث المحتوى عند الدخول للصفحة فوراً\n    if(id === 'generalNotes') refreshGeneralNotes();\n    if(id === 'investment') refreshInvestment();\n    if(id === 'history') refreshHistory();\n    if(id === 'wallets') refreshWallets();\n    if(id === 'expiring') refreshExpiring();\n    if(id === 'analytics') refreshAnalytics();\n}\n\nfunction notify(msg,type=\"success\"){\n    let n=document.getElementById(\"notification\");\n    n.innerHTML = `<i class=\"fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}\"></i> ` + msg;\n    n.style.background=type===\"success\"?\"#10b981\":\"#ef4444\";\n    n.style.display=\"block\";\n    setTimeout(()=>{n.style.display=\"none\";},3000);\n}\n\nfunction loadWallets(){\n    let wallets=JSON.parse(localStorage.wallets);\n    const selects = [wallet, modWallet, fromWallet, renameWalletSelect];\n    selects.forEach(s => {\n        if(s) {\n            s.innerHTML = \"\";\n            Object.keys(wallets).forEach(w=>{\n                let o=document.createElement(\"option\"); o.value=w; o.text=w;\n                s.appendChild(o);\n            });\n        }\n    });\n}\n\nfunction loadProfitSettings(){\n    let s = JSON.parse(localStorage.settings);\n    setAhmadProp.value = s.ahmad;\n    setMohamedProp.value = s.mohamed;\n    setStoreProp.value = s.store;\n    setDeductCost.checked = s.deductCost;\n    setExchangeRate.value = s.exchangeRate || 0;\n}\n\nfunction saveProfitSettings(){\n    let a = +setAhmadProp.value;\n    let m = +setMohamedProp.value;\n    let s = +setStoreProp.value;\n    if(a + m + s !== 100){ notify(\"مجموع النسب يجب أن يساوي 100%\",\"error\"); return; }\n    \n    localStorage.settings = JSON.stringify({\n        ahmad: a, \n        mohamed: m, \n        store: s, \n        deductCost: setDeductCost.checked,\n        exchangeRate: +setExchangeRate.value\n    });\n    pushToGithub(); // AUTO SAVE\n    notify(\"تم حفظ إعدادات النظام بنجاح\");\n}\n\nfunction addPurchase(){\n    if(paidAmount.value === \"\" || costAmount.value === \"\") { \n        notify(\"يرجى ملء كافة البيانات (يمكن استخدام 0)\",\"error\"); \n        return; \n    }\n\n    let paid=+paidAmount.value; \n    let cost=+costAmount.value;\n    let paidCur=paidCurrency.value; \n    let costCur=costCurrency.value;\n    let wallets=JSON.parse(localStorage.wallets);\n    let invest=JSON.parse(localStorage.invest);\n    let purchases=JSON.parse(localStorage.purchases);\n    let settings=JSON.parse(localStorage.settings);\n    let from=fromWallet.value;\n    let duration = +subDuration.value; // عدد الأشهر\n\n    // التحقق من الرصيد في المحفظة\n    if(wallets[from].bal < cost && wallets[from].cur == costCur){notify(\"رصيد المحفظة المصدر غير كافي\",\"error\"); return;}\n\n    let undoSnapshot = {\n        wallets: JSON.parse(JSON.stringify(wallets)), \n        invest: JSON.parse(JSON.stringify(invest))\n    };\n    localStorage.setItem(\"lastUndoOp\", JSON.stringify(undoSnapshot));\n    \n    // 1. خصم التكلفة من المحفظة المحددة (Cash Deduction)\n    wallets[from].bal -= cost;\n\n    // الحصول على سعر الصرف\n    let rate = 0;\n    if(settings.exchangeRate && settings.exchangeRate > 0) {\n        rate = settings.exchangeRate;\n    } else if (paidCur !== costCur) { // نطلب السعر فقط إذا اختلفت العملات واحتجنا التحويل\n        rate = +prompt(\"سعر الصرف الحالي (1 دولار كم يساوي شيكل؟)\");\n        if(!rate && rate !== 0) { notify(\"تم إلغاء العملية: لم يتم إدخال سعر الصرف\", \"error\"); return; }\n    }\n\n    // 2. خصم التكلفة من استثمار المتجر (Capital Deduction)\n    // المنطق: الخصم يكون بعملة التكلفة، وإذا لم يكفِ الرصيد نحول من العملة الأخرى\n    if(costCur === '$') {\n        // التكلفة بالدولار\n        if(invest.store.d >= cost) {\n            invest.store.d -= cost;\n        } else {\n            // الدولار لا يكفي، نأخذ الموجود ونخصم الباقي من الشيكل\n            let remainder = cost - invest.store.d;\n            invest.store.d = 0;\n            // تحويل الباقي لشيكل (دولار * سعر الصرف = شيكل)\n            // ملاحظة: نحتاج سعر صرف هنا حتى لو كانت عملة الدفع دولار، لأننا سنخصم من الشيكل\n            if(rate === 0) rate = +prompt(\"رصيد استثمار الدولار لا يكفي. أدخل سعر الصرف للخصم من الشيكل:\");\n            invest.store.s -= (remainder * rate); \n        }\n    } else {\n        // التكلفة بالشيكل\n        if(invest.store.s >= cost) {\n            invest.store.s -= cost;\n        } else {\n            // الشيكل لا يكفي، نأخذ الموجود ونخصم الباقي من الدولار\n            let remainder = cost - invest.store.s;\n            invest.store.s = 0;\n            // تحويل الباقي لدولار (شيكل / سعر الصرف = دولار)\n            if(rate === 0) rate = +prompt(\"رصيد استثمار الشيكل لا يكفي. أدخل سعر الصرف للخصم من الدولار:\");\n            invest.store.d -= (remainder / rate);\n        }\n    }\n\n    // 3. حساب وتوزيع الأرباح + استرداد التكلفة (Profit Distribution & Reimbursement)\n    let profitBase = paid;\n    let costInPaidCurrency = 0;\n\n    if(settings.deductCost){\n        if(paidCur === costCur){\n            // العملات متطابقة\n            profitBase = paid - cost;\n            costInPaidCurrency = cost;\n        } else {\n            // العملات مختلفة: نحول التكلفة لعملة العميل\n            let costConverted = 0;\n            if(paidCur == \"$\") { // العميل دفع دولار، التكلفة شيكل\n                costConverted = cost / rate; \n            } else { // العميل دفع شيكل، التكلفة دولار\n                costConverted = cost * rate; \n            }\n            profitBase = paid - costConverted;\n            costInPaidCurrency = costConverted;\n        }\n    }\n\n    // حساب حصص الربح\n    let aProfit = +(profitBase * (settings.ahmad/100)).toFixed(2);\n    let mProfit = +(profitBase * (settings.mohamed/100)).toFixed(2);\n    let sProfit = +(profitBase * (settings.store/100)).toFixed(2);\n\n    // التوزيع يعتمد كلياً على عملة الدفع (paidCur)\n    if(paidCur==\"$\"){\n        invest.ahmad.d += aProfit; \n        invest.mohamed.d += mProfit; \n        invest.store.d += sProfit;\n        // استرداد رأس مال المتجر بنفس عملة الدفع\n        if(settings.deductCost) invest.store.d += costInPaidCurrency;\n    } else {\n        invest.ahmad.s += aProfit; \n        invest.mohamed.s += mProfit; \n        invest.store.s += sProfit;\n        // استرداد رأس مال المتجر بنفس عملة الدفع\n        if(settings.deductCost) invest.store.s += costInPaidCurrency;\n    }\n\n    // إضافة المبلغ المقبوض للمحفظة المستلمة\n    wallets[wallet.value].bal += paid;\n\n    // --- حساب تاريخ الانتهاء (المنطق الجديد الذكي) ---\n    let d = new Date(); \n    let expiryDate = new Date(d); \n    let currentDay = expiryDate.getDate();\n    expiryDate.setMonth(expiryDate.getMonth() + duration);\n    if (expiryDate.getDate() !== currentDay) {\n        expiryDate.setDate(0); \n    }\n    let expiryTimestamp = expiryDate.getTime();\n    // ------------------------------------------------\n\n    let dateStr = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();\n\n    let pObj={\n        date: dateStr, \n        customer:customer.value || \"عميل عابر\",\n        phone:customerPhone.value || \"-\",\n        sub:sub.value, \n        duration: duration,\n        paid:paid+paidCur, \n        cost:cost+costCur, \n        wallet:wallet.value,\n        expiry: expiryTimestamp\n    };\n    purchases.push(pObj);\n\n    localStorage.wallets=JSON.stringify(wallets);\n    localStorage.invest=JSON.stringify(invest);\n    localStorage.purchases=JSON.stringify(purchases);\n\n    refreshAll(); \n    pushToGithub(); // AUTO SAVE\n    notify(\"تم تسجيل العملية بنجاح\");\n    paidAmount.value=\"\"; costAmount.value=\"\"; customer.value=\"\"; sub.value=\"\"; customerPhone.value=\"\"; subDuration.value=\"1\";\n}\n\nfunction refreshAll(){\n    refreshWallets(); refreshHistory(); refreshInvestment(); refreshGeneralNotes(); refreshTodoList(); refreshExpiring();\n    let p = JSON.parse(localStorage.purchases);\n    let todayStr = new Date().getFullYear() + '-' + (new Date().getMonth()+1) + '-' + new Date().getDate();\n    document.getElementById(\"statSales\").textContent = p.filter(x => x.date.includes(todayStr) || x.date.includes(new Date().toLocaleDateString(\"ar-EG\"))).length;\n}\n\nfunction refreshExpiring() {\n    let p = JSON.parse(localStorage.purchases);\n    let expiringBody = document.getElementById(\"expiringBody\");\n    expiringBody.innerHTML = \"\";\n    \n    let now = new Date().getTime();\n    let threeDaysInMs = 3 * 24 * 60 * 60 * 1000;\n\n    let list = p.filter(item => {\n        if(!item.expiry) return false;\n        let diff = item.expiry - now;\n        // عرض ما تبقى له 3 أيام أو انتهى خلال آخر 30 يوم\n        return diff < threeDaysInMs && diff > -(30 * 24 * 60 * 60 * 1000); \n    });\n\n    list.sort((a, b) => a.expiry - b.expiry);\n\n    list.forEach(item => {\n        let expDate = new Date(item.expiry);\n        let dateStr = expDate.getFullYear() + '-' + (expDate.getMonth()+1) + '-' + expDate.getDate();\n        let daysLeft = Math.ceil((item.expiry - now) / (1000 * 60 * 60 * 24));\n        \n        let badgeClass = daysLeft <= 0 ? 'badge-danger' : 'badge-warning';\n        let statusText = daysLeft <= 0 ? 'منتهي' : daysLeft + ' يوم';\n\n        expiringBody.innerHTML += `\n            <tr>\n                <td><b>${item.sub}</b></td>\n                <td>${item.customer}</td>\n                <td><a href=\"https://wa.me/970${item.phone.replace(/^0/,'').replace(/\\D/g,'')}\" target=\"_blank\" style=\"text-decoration:none; color:var(--success)\"><i class=\"fab fa-whatsapp\"></i> ${item.phone}</a></td>\n                <td>${dateStr}</td>\n                <td><span class=\"badge ${badgeClass}\">${statusText}</span></td>\n            </tr>\n        `;\n    });\n    \n    if(list.length === 0) {\n        expiringBody.innerHTML = \"<tr><td colspan='5' style='text-align:center; padding:30px'>لا توجد اشتراكات تنتهي قريباً</td></tr>\";\n    }\n}\n\nfunction refreshWallets(){\n    let w=JSON.parse(localStorage.wallets); walletList.innerHTML=\"\";\n    let td=0; let ts=0;\n    for(let k in w){\n        let isActive = (w[k].active !== false); \n        \n        let statusHtml = isActive \n            ? `<span style=\"color:var(--success); font-weight:800; display:flex; align-items:center; gap:5px\"><i class=\"fas fa-check-circle\"></i> نشط</span>` \n            : `<span style=\"color:var(--danger); font-weight:800; display:flex; align-items:center; gap:5px\"><i class=\"fas fa-times-circle\"></i> معطل</span>`;\n\n        walletList.innerHTML+=`<tr>\n            <td><b>${k}</b></td>\n            <td><span class=\"badge ${w[k].cur=='$'?'badge-success':'badge-info'}\">${w[k].cur=='$'?'دولار':'شيكل'}</span></td>\n            <td style=\"text-align:center; font-weight:800\">${fix(w[k].bal)}</td>\n            <td>${statusHtml}</td>\n        </tr>`;\n        \n        if(w[k].cur==\"$\") td+=w[k].bal; else ts+=w[k].bal;\n    }\n    statDollar.textContent=fix(td)+\" $\"; statShekel.textContent=fix(ts)+\" ₪\";\n}\n\nfunction refreshHistory(){\n    historyBody.innerHTML=\"\"; \n    JSON.parse(localStorage.purchases).reverse().forEach(p=>{\n        let durationTxt = p.duration ? (p.duration + \" شهر\") : \"-\";\n        historyBody.innerHTML+=`<tr><td>${p.date}</td><td><b>${p.customer}</b></td><td>${p.phone}</td><td><span class=\"badge badge-info\">${p.sub}</span></td><td>${durationTxt}</td><td style=\"color:var(--success)\">${p.paid}</td><td style=\"color:var(--danger)\">${p.cost}</td><td>${p.wallet}</td></tr>`;\n    });\n}\n\nfunction refreshInvestment(){\n    let i=JSON.parse(localStorage.invest);\n    investBox.innerHTML=`\n        <div class=\"card\" style=\"border-top:5px solid var(--success)\"><div>حصة أحمد</div><div style=\"font-size:22px; font-weight:900\">${fix(i.ahmad.d)}$ | ${fix(i.ahmad.s)}₪</div></div>\n        <div class=\"card\" style=\"border-top:5px solid var(--accent)\"><div>حصة محمد</div><div style=\"font-size:22px; font-weight:900\">${fix(i.mohamed.d)}$ | ${fix(i.mohamed.s)}₪</div></div>\n        <div class=\"card\" style=\"border-top:5px solid var(--primary)\"><div>رأس مال المتجر</div><div style=\"font-size:22px; font-weight:900\">${fix(i.store.d)}$ | ${fix(i.store.s)}₪</div></div>`;\n}\n\nfunction refreshAnalytics() {\n    let invest = JSON.parse(localStorage.invest);\n    let purchases = JSON.parse(localStorage.purchases);\n\n    // 1. Profit Chart (Pie)\n    let rate = 3.5; \n    let aTotal = invest.ahmad.d * rate + invest.ahmad.s;\n    let mTotal = invest.mohamed.d * rate + invest.mohamed.s;\n    let sTotal = invest.store.d * rate + invest.store.s;\n\n    if (myProfitChart) myProfitChart.destroy();\n    let ctxP = document.getElementById('profitChart').getContext('2d');\n    myProfitChart = new Chart(ctxP, {\n        type: 'doughnut',\n        data: {\n            labels: ['أحمد', 'محمد', 'المتجر'],\n            datasets: [{\n                data: [aTotal, mTotal, sTotal],\n                backgroundColor: ['#10b981', '#f59e0b', '#6366f1'],\n                borderWidth: 0\n            }]\n        },\n        options: { responsive: true, maintainAspectRatio: false }\n    });\n\n    // 2. Sales Chart (Bar - Last 6 Months)\n    let months = {};\n    let labels = [];\n    let data = [];\n    \n    for(let i=5; i>=0; i--){\n        let d = new Date();\n        d.setMonth(d.getMonth() - i);\n        let key = (d.getMonth()+1) + '/' + d.getFullYear();\n        months[key] = 0;\n        labels.push(key);\n    }\n\n    purchases.forEach(p => {\n        let d = new Date(p.date); \n        let key = (d.getMonth()+1) + '/' + d.getFullYear();\n        if(months[key] !== undefined) months[key]++;\n    });\n\n    labels.forEach(l => data.push(months[l]));\n\n    if (mySalesChart) mySalesChart.destroy();\n    let ctxS = document.getElementById('salesChart').getContext('2d');\n    mySalesChart = new Chart(ctxS, {\n        type: 'bar',\n        data: {\n            labels: labels,\n            datasets: [{\n                label: 'عدد العمليات',\n                data: data,\n                backgroundColor: '#6366f1',\n                borderRadius: 5\n            }]\n        },\n        options: { \n            responsive: true, \n            maintainAspectRatio: false,\n            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }\n        }\n    });\n}\n\nfunction addGeneralNote(){\n    let t=gnText.value.trim(); if(!t) return;\n    let n=JSON.parse(localStorage.generalNotes);\n    n.push({text:t, date:new Date().toLocaleString(\"ar-EG\")});\n    localStorage.generalNotes=JSON.stringify(n);\n    gnText.value=\"\"; refreshGeneralNotes(); \n    pushToGithub(); // AUTO SAVE\n    notify(\"تم الحفظ\");\n}\n\nfunction refreshGeneralNotes(){\n    let n=JSON.parse(localStorage.generalNotes); generalNotesBox.innerHTML=\"\";\n    n.forEach((x,i)=>{\n        generalNotesBox.innerHTML+=`<div class=\"todo-item\" style=\"border-right-color:var(--primary)\"><div><small>${x.date}</small><div>${x.text}</div></div><i class=\"fas fa-trash\" onclick=\"deleteNote(${i})\" style=\"color:var(--danger); cursor:pointer\"></i></div>`;\n    });\n}\n\nfunction deleteNote(i){\n    let n=JSON.parse(localStorage.generalNotes); n.splice(i,1);\n    localStorage.generalNotes=JSON.stringify(n); refreshGeneralNotes();\n    pushToGithub(); // AUTO SAVE\n}\n\nfunction addTodo(){\n    let t=todoInput.value.trim(); if(!t) return;\n    let l=JSON.parse(localStorage.todoList);\n    l.push({text:t, date:new Date().toLocaleString(\"ar-EG\")});\n    localStorage.todoList=JSON.stringify(l); todoInput.value=\"\"; refreshTodoList();\n    pushToGithub(); // AUTO SAVE\n}\n\nfunction refreshTodoList(){\n    let l=JSON.parse(localStorage.todoList); todoBox.innerHTML=\"\";\n    l.forEach((x,i)=>[\n        todoBox.innerHTML+=`<div class=\"todo-item\"><div>${x.text}</div><button class=\"btn btn-primary\" style=\"padding:5px 10px\" onclick=\"completeTodo(${i})\">تمت</button></div>`\n    ]);\n}\n\nfunction completeTodo(i){\n    let l=JSON.parse(localStorage.todoList); l.splice(i,1);\n    localStorage.todoList=JSON.stringify(l); refreshTodoList();\n    pushToGithub(); // AUTO SAVE\n}\n\nfunction withdrawPartial(person){\n    let input, cur;\n    \n    if(person === 'ahmad') {\n        input = withdrawAhmad; cur = curAhmad.value;\n    } else if(person === 'mohamed') {\n        input = withdrawMohamed; cur = curMohamed.value;\n    } else if(person === 'store') {\n        input = withdrawStore; cur = curStore.value;\n    }\n\n    let val = +input.value;\n    let i = JSON.parse(localStorage.invest);\n    let k = cur === 'd' ? 'd' : 's';\n    \n    if(i[person][k] < val) { notify(\"رصيد غير كافي\",\"error\"); return; }\n    \n    i[person][k] -= val;\n    localStorage.invest=JSON.stringify(i); \n    refreshInvestment(); \n    input.value=\"\"; \n    pushToGithub(); // AUTO SAVE\n    notify(\"تم السحب\");\n}\n\nfunction addNewWallet(){\n    let n=newWalletName.value.trim(); let c=newWalletCurrency.value;\n    let w=JSON.parse(localStorage.wallets);\n    if(!n || w[n]) return notify(\"اسم غير صالح\",\"error\");\n    w[n]={bal:0, cur:c, active:true}; localStorage.wallets=JSON.stringify(w);\n    loadWallets(); refreshWallets(); newWalletName.value=\"\"; \n    pushToGithub(); // AUTO SAVE\n    notify(\"تمت الإضافة\");\n}\n\nfunction renameWallet(){\n    let oldName = renameWalletSelect.value;\n    let newName = renameWalletInput.value.trim();\n    \n    if(!newName) return notify(\"يرجى كتابة اسم جديد\", \"error\");\n    \n    let w = JSON.parse(localStorage.wallets);\n    if(w[newName]) return notify(\"هذا الاسم موجود مسبقاً\", \"error\");\n    \n    // نقل البيانات للاسم الجديد\n    w[newName] = w[oldName];\n    delete w[oldName];\n    localStorage.wallets = JSON.stringify(w);\n    \n    // تحديث سجل المشتريات بالاسم الجديد (لكي لا يظهر اسم قديم في السجل)\n    let p = JSON.parse(localStorage.purchases);\n    p.forEach(item => {\n        if(item.wallet === oldName) item.wallet = newName;\n    });\n    localStorage.purchases = JSON.stringify(p);\n    \n    loadWallets();\n    refreshAll();\n    renameWalletInput.value = \"\";\n    pushToGithub(); // AUTO SAVE\n    notify(\"تم تغيير اسم المحفظة بنجاح\");\n}\n\nfunction addToWallet(){\n    let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal += +modAmount.value;\n    localStorage.wallets=JSON.stringify(w); refreshWallets(); \n    pushToGithub(); // AUTO SAVE\n    notify(\"تمت الإضافة\");\n}\n\nfunction subtractFromWallet(){\n    let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal -= +modAmount.value;\n    localStorage.wallets=JSON.stringify(w); refreshWallets(); \n    pushToGithub(); // AUTO SAVE\n    notify(\"تم الخصم\");\n}\n\nfunction setWallet(){\n    let w=JSON.parse(localStorage.wallets); w[modWallet.value].bal = +modAmount.value;\n    localStorage.wallets=JSON.stringify(w); refreshWallets(); \n    pushToGithub(); // AUTO SAVE\n    notify(\"تم التعيين\");\n}\n\nfunction toggleWalletStatus(){\n    let name = modWallet.value;\n    if(!name) return;\n    let w = JSON.parse(localStorage.wallets);\n    \n    let currentStatus = (w[name].active !== false);\n    w[name].active = !currentStatus;\n    \n    localStorage.wallets = JSON.stringify(w);\n    refreshWallets();\n    pushToGithub(); // AUTO SAVE\n    notify(`تم تغيير حالة المحفظة إلى: ${w[name].active ? \"نشط\" : \"معطل\"}`);\n}\n\nfunction deleteWallet(){\n    if(!confirm(\"حذف المحفظة؟\")) return;\n    let w=JSON.parse(localStorage.wallets); delete w[modWallet.value];\n    localStorage.wallets=JSON.stringify(w); loadWallets(); refreshWallets();\n    pushToGithub(); // AUTO SAVE\n}\n\nfunction exportData(){\n    let a=document.createElement(\"a\");\n    a.href=URL.createObjectURL(new Blob([JSON.stringify(localStorage)],{type:\"application/json\"}));\n    a.download=`MegaStore_Backup_${new Date().toLocaleDateString()}.json`; a.click();\n}\n\nfunction importData(){\n    let f=importFile.files[0]; \n    if(!f) return notify(\"يرجى اختيار ملف أولاً\", \"error\");\n\n    let r=new FileReader();\n    r.onload=async (e)=>{\n        try {\n            let d=JSON.parse(e.target.result);\n            \n            // 1. استعادة البيانات محلياً\n            Object.keys(d).forEach(k => localStorage.setItem(k, d[k]));\n            \n            // 2. تحديث متغيرات الكونفج فوراً من اللوكال ستورج الجديد\n            ghConfig.user = localStorage.getItem(\"gh_user\") || \"\";\n            ghConfig.repo = localStorage.getItem(\"gh_repo\") || \"\";\n            ghConfig.token = localStorage.getItem(\"gh_token\") || \"\";\n            ghConfig.file = localStorage.getItem(\"gh_file\") || \"db.json\";\n\n            notify(\"تم استعادة البيانات محلياً، جاري المزامنة مع GitHub...\", \"success\");\n\n            // 3. محاولة الرفع المباشر إلى GitHub\n            if(ghConfig.token && ghConfig.user && ghConfig.repo) {\n                updateSyncStatus(\"جاري رفع النسخة المستعادة...\", \"loading\");\n                \n                // خطوة مهمة: جلب الـ SHA للملف الموجود في Github أولاً لضمان الكتابة فوقه\n                try {\n                    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;\n                    const resp = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}` } });\n                    if(resp.ok) {\n                        const json = await resp.json();\n                        ghConfig.sha = json.sha; // تحديث الـ SHA\n                    }\n                } catch(err) { console.log(\"New file creation likely\"); }\n\n                await pushToGithub(); \n            }\n\n            // 4. تحديث الصفحة بعد انتهاء العمليات\n            setTimeout(() => {\n                location.reload();\n            }, 1500);\n\n        } catch (error) {\n            console.error(error);\n            notify(\"حدث خطأ في استعادة الملف\", \"error\");\n        }\n    };\n    r.readAsText(f);\n}\n\nfunction undoLastPurchase(){\n    if(!localStorage.lastUndoOp) return notify(\"لا توجد عملية للتراجع عنها\",\"error\");\n    \n    let undoOp = JSON.parse(localStorage.lastUndoOp);\n    \n    localStorage.wallets=JSON.stringify(undoOp.wallets);\n    localStorage.invest=JSON.stringify(undoOp.invest);\n    \n    let p=JSON.parse(localStorage.purchases); \n    if(p.length > 0) p.pop();\n    localStorage.purchases=JSON.stringify(p);\n    \n    localStorage.removeItem(\"lastUndoOp\");\n    \n    refreshAll(); \n    pushToGithub(); // AUTO SAVE\n    notify(\"تم التراجع واستعادة البيانات\");\n}\n\nfunction clearHistory(){\n    if(confirm(\"مسح السجل بالكامل؟\")){ localStorage.purchases=\"[]\"; refreshHistory(); pushToGithub(); }\n}\n\nwindow.onload=init;\n</script>\n\n</body>\n</html>","date":"١٠‏/٢‏/٢٠٢٦ ١١:٥٩:٤١ ص"}],"todoList":[],"lastUpdate":"2026-02-10T09:59:41.284Z"}